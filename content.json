{"meta":{"title":"Spike World","subtitle":"","description":"","author":"Spike1337","url":"https://spike1337.github.io","root":"/"},"pages":[{"title":"ä¹¦å•","date":"2023-08-22T01:36:55.577Z","updated":"2023-08-22T01:36:55.577Z","comments":false,"path":"books/index.html","permalink":"https://spike1337.github.io/books/index.html","excerpt":"","text":""},{"title":"Repositories","date":"2023-08-22T01:36:55.579Z","updated":"2023-08-22T01:36:55.579Z","comments":false,"path":"repository/index.html","permalink":"https://spike1337.github.io/repository/index.html","excerpt":"","text":""},{"title":"å‹æƒ…é“¾æ¥","date":"2023-08-22T01:36:55.578Z","updated":"2023-08-22T01:36:55.578Z","comments":true,"path":"links/index.html","permalink":"https://spike1337.github.io/links/index.html","excerpt":"","text":""},{"title":"å…³äº","date":"2023-08-22T07:12:37.136Z","updated":"2023-08-22T07:12:37.136Z","comments":false,"path":"about/index.html","permalink":"https://spike1337.github.io/about/index.html","excerpt":"","text":"Hi there ğŸ‘‹, I am Spike I am aâ€¦ ğŸƒ Database kernal Developer Skills ğŸš€ Language: C/C++, Python, Shell, SQL, rust ğŸ”¥ Backend: PostgreSQL, GreenPlum Current Develop direction ğŸ˜‡ Storage &amp; Transaction Othersâ€¦ ğŸ’– Anime: Space Cowboy ğŸ’– Movie: Interstellar ğŸ’– Games: FPS ã•ã„ã“ã†!"},{"title":"åˆ†ç±»","date":"2023-08-22T01:36:55.577Z","updated":"2023-08-22T01:36:55.577Z","comments":false,"path":"categories/index.html","permalink":"https://spike1337.github.io/categories/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2023-08-22T01:36:55.581Z","updated":"2023-08-22T01:36:55.581Z","comments":false,"path":"tags/index.html","permalink":"https://spike1337.github.io/tags/index.html","excerpt":"","text":""},{"title":"","date":"2023-08-22T10:07:12.797Z","updated":"2023-08-22T10:07:12.797Z","comments":true,"path":"self/one-light.css","permalink":"https://spike1337.github.io/self/one-light.css","excerpt":"","text":"/** * One Light theme for prism.js * Based on Atom's One Light theme: https://github.com/atom/atom/tree/master/packages/one-light-syntax */ /** * One Light colours (accurate as of commit eb064bf on 19 Feb 2021) * From colors.less * --mono-1: hsl(230, 8%, 24%); * --mono-2: hsl(230, 6%, 44%); * --mono-3: hsl(230, 4%, 64%) * --hue-1: hsl(198, 99%, 37%); * --hue-2: hsl(221, 87%, 60%); * --hue-3: hsl(301, 63%, 40%); * --hue-4: hsl(119, 34%, 47%); * --hue-5: hsl(5, 74%, 59%); * --hue-5-2: hsl(344, 84%, 43%); * --hue-6: hsl(35, 99%, 36%); * --hue-6-2: hsl(35, 99%, 40%); * --syntax-fg: hsl(230, 8%, 24%); * --syntax-bg: hsl(230, 1%, 98%); * --syntax-gutter: hsl(230, 1%, 62%); * --syntax-guide: hsla(230, 8%, 24%, 0.2); * --syntax-accent: hsl(230, 100%, 66%); * From syntax-variables.less * --syntax-selection-color: hsl(230, 1%, 90%); * --syntax-gutter-background-color-selected: hsl(230, 1%, 90%); * --syntax-cursor-line: hsla(230, 8%, 24%, 0.05); */ code[class*=\"language-\"], pre[class*=\"language-\"] { background: hsl(230, 1%, 98%); color: hsl(230, 8%, 24%); font-family: \"Fira Code\", \"Fira Mono\", Menlo, Consolas, \"DejaVu Sans Mono\", monospace; direction: ltr; text-align: left; white-space: pre; word-spacing: normal; word-break: normal; line-height: 1.5; -moz-tab-size: 2; -o-tab-size: 2; tab-size: 2; -webkit-hyphens: none; -moz-hyphens: none; -ms-hyphens: none; hyphens: none; } /* Selection */ code[class*=\"language-\"]::-moz-selection, code[class*=\"language-\"] *::-moz-selection, pre[class*=\"language-\"] *::-moz-selection { background: hsl(230, 1%, 90%); color: inherit; } code[class*=\"language-\"]::selection, code[class*=\"language-\"] *::selection, pre[class*=\"language-\"] *::selection { background: hsl(230, 1%, 90%); color: inherit; } /* Code blocks */ pre[class*=\"language-\"] { padding: 1em; margin: 0.5em 0; overflow: auto; border-radius: 0.3em; } /* Inline code */ :not(pre) > code[class*=\"language-\"] { padding: 0.2em 0.3em; border-radius: 0.3em; white-space: normal; } .token.comment, .token.prolog, .token.cdata { color: hsl(230, 4%, 64%); } .token.doctype, .token.punctuation, .token.entity { color: hsl(230, 8%, 24%); } .token.attr-name, .token.class-name, .token.boolean, .token.constant, .token.number, .token.atrule { color: hsl(35, 99%, 36%); } .token.keyword { color: hsl(301, 63%, 40%); } .token.property, .token.tag, .token.symbol, .token.deleted, .token.important { color: hsl(5, 74%, 59%); } .token.selector, .token.string, .token.char, .token.builtin, .token.inserted, .token.regex, .token.attr-value, .token.attr-value > .token.punctuation { color: hsl(119, 34%, 47%); } .token.variable, .token.operator, .token.function { color: hsl(221, 87%, 60%); } .token.url { color: hsl(198, 99%, 37%); } /* HTML overrides */ .token.attr-value > .token.punctuation.attr-equals, .token.special-attr > .token.attr-value > .token.value.css { color: hsl(230, 8%, 24%); } /* CSS overrides */ .language-css .token.selector { color: hsl(5, 74%, 59%); } .language-css .token.property { color: hsl(230, 8%, 24%); } .language-css .token.function, .language-css .token.url > .token.function { color: hsl(198, 99%, 37%); } .language-css .token.url > .token.string.url { color: hsl(119, 34%, 47%); } .language-css .token.important, .language-css .token.atrule .token.rule { color: hsl(301, 63%, 40%); } /* JS overrides */ .language-javascript .token.operator { color: hsl(301, 63%, 40%); } .language-javascript .token.template-string > .token.interpolation > .token.interpolation-punctuation.punctuation { color: hsl(344, 84%, 43%); } /* JSON overrides */ .language-json .token.operator { color: hsl(230, 8%, 24%); } .language-json .token.null.keyword { color: hsl(35, 99%, 36%); } /* MD overrides */ .language-markdown .token.url, .language-markdown .token.url > .token.operator, .language-markdown .token.url-reference.url > .token.string { color: hsl(230, 8%, 24%); } .language-markdown .token.url > .token.content { color: hsl(221, 87%, 60%); } .language-markdown .token.url > .token.url, .language-markdown .token.url-reference.url { color: hsl(198, 99%, 37%); } .language-markdown .token.blockquote.punctuation, .language-markdown .token.hr.punctuation { color: hsl(230, 4%, 64%); font-style: italic; } .language-markdown .token.code-snippet { color: hsl(119, 34%, 47%); } .language-markdown .token.bold .token.content { color: hsl(35, 99%, 36%); } .language-markdown .token.italic .token.content { color: hsl(301, 63%, 40%); } .language-markdown .token.strike .token.content, .language-markdown .token.strike .token.punctuation, .language-markdown .token.list.punctuation, .language-markdown .token.title.important > .token.punctuation { color: hsl(5, 74%, 59%); } /* General */ .token.bold { font-weight: bold; } .token.comment, .token.italic { font-style: italic; } .token.entity { cursor: help; } .token.namespace { opacity: 0.8; } /* Plugin overrides */ /* Selectors should have higher specificity than those in the plugins' default stylesheets */ /* Show Invisibles plugin overrides */ .token.token.tab:not(:empty):before, .token.token.cr:before, .token.token.lf:before, .token.token.space:before { color: hsla(230, 8%, 24%, 0.2); } /* Toolbar plugin overrides */ /* Space out all buttons and move them away from the right edge of the code block */ div.code-toolbar > .toolbar.toolbar > .toolbar-item { margin-right: 0.4em; } /* Styling the buttons */ div.code-toolbar > .toolbar.toolbar > .toolbar-item > button, div.code-toolbar > .toolbar.toolbar > .toolbar-item > a, div.code-toolbar > .toolbar.toolbar > .toolbar-item > span { background: hsl(230, 1%, 90%); color: hsl(230, 6%, 44%); padding: 0.1em 0.4em; border-radius: 0.3em; } div.code-toolbar > .toolbar.toolbar > .toolbar-item > button:hover, div.code-toolbar > .toolbar.toolbar > .toolbar-item > button:focus, div.code-toolbar > .toolbar.toolbar > .toolbar-item > a:hover, div.code-toolbar > .toolbar.toolbar > .toolbar-item > a:focus, div.code-toolbar > .toolbar.toolbar > .toolbar-item > span:hover, div.code-toolbar > .toolbar.toolbar > .toolbar-item > span:focus { background: hsl(230, 1%, 78%); /* custom: darken(--syntax-bg, 20%) */ color: hsl(230, 8%, 24%); } /* Line Highlight plugin overrides */ /* The highlighted line itself */ .line-highlight.line-highlight { background: hsla(230, 8%, 24%, 0.05); } /* Default line numbers in Line Highlight plugin */ .line-highlight.line-highlight:before, .line-highlight.line-highlight[data-end]:after { background: hsl(230, 1%, 90%); color: hsl(230, 8%, 24%); padding: 0.1em 0.6em; border-radius: 0.3em; box-shadow: 0 2px 0 0 rgba(0, 0, 0, 0.2); /* same as Toolbar plugin default */ } /* Hovering over a linkable line number (in the gutter area) */ /* Requires Line Numbers plugin as well */ pre[id].linkable-line-numbers.linkable-line-numbers span.line-numbers-rows > span:hover:before { background-color: hsla(230, 8%, 24%, 0.05); } /* Line Numbers and Command Line plugins overrides */ /* Line separating gutter from coding area */ .line-numbers.line-numbers .line-numbers-rows, .command-line .command-line-prompt { border-right-color: hsla(230, 8%, 24%, 0.2); } /* Stuff in the gutter */ .line-numbers .line-numbers-rows > span:before, .command-line .command-line-prompt > span:before { color: hsl(230, 1%, 62%); } /* Match Braces plugin overrides */ /* Note: Outline colour is inherited from the braces */ .rainbow-braces .token.token.punctuation.brace-level-1, .rainbow-braces .token.token.punctuation.brace-level-5, .rainbow-braces .token.token.punctuation.brace-level-9 { color: hsl(5, 74%, 59%); } .rainbow-braces .token.token.punctuation.brace-level-2, .rainbow-braces .token.token.punctuation.brace-level-6, .rainbow-braces .token.token.punctuation.brace-level-10 { color: hsl(119, 34%, 47%); } .rainbow-braces .token.token.punctuation.brace-level-3, .rainbow-braces .token.token.punctuation.brace-level-7, .rainbow-braces .token.token.punctuation.brace-level-11 { color: hsl(221, 87%, 60%); } .rainbow-braces .token.token.punctuation.brace-level-4, .rainbow-braces .token.token.punctuation.brace-level-8, .rainbow-braces .token.token.punctuation.brace-level-12 { color: hsl(301, 63%, 40%); } /* Diff Highlight plugin overrides */ /* Taken from https://github.com/atom/github/blob/master/styles/variables.less */ pre.diff-highlight > code .token.token.deleted:not(.prefix), pre > code.diff-highlight .token.token.deleted:not(.prefix) { background-color: hsla(353, 100%, 66%, 0.15); } pre.diff-highlight > code .token.token.deleted:not(.prefix)::-moz-selection, pre.diff-highlight > code .token.token.deleted:not(.prefix) *::-moz-selection, pre > code.diff-highlight .token.token.deleted:not(.prefix)::-moz-selection, pre > code.diff-highlight .token.token.deleted:not(.prefix) *::-moz-selection { background-color: hsla(353, 95%, 66%, 0.25); } pre.diff-highlight > code .token.token.deleted:not(.prefix)::selection, pre.diff-highlight > code .token.token.deleted:not(.prefix) *::selection, pre > code.diff-highlight .token.token.deleted:not(.prefix)::selection, pre > code.diff-highlight .token.token.deleted:not(.prefix) *::selection { background-color: hsla(353, 95%, 66%, 0.25); } pre.diff-highlight > code .token.token.inserted:not(.prefix), pre > code.diff-highlight .token.token.inserted:not(.prefix) { background-color: hsla(137, 100%, 55%, 0.15); } pre.diff-highlight > code .token.token.inserted:not(.prefix)::-moz-selection, pre.diff-highlight > code .token.token.inserted:not(.prefix) *::-moz-selection, pre > code.diff-highlight .token.token.inserted:not(.prefix)::-moz-selection, pre > code.diff-highlight .token.token.inserted:not(.prefix) *::-moz-selection { background-color: hsla(135, 73%, 55%, 0.25); } pre.diff-highlight > code .token.token.inserted:not(.prefix)::selection, pre.diff-highlight > code .token.token.inserted:not(.prefix) *::selection, pre > code.diff-highlight .token.token.inserted:not(.prefix)::selection, pre > code.diff-highlight .token.token.inserted:not(.prefix) *::selection { background-color: hsla(135, 73%, 55%, 0.25); } /* Previewers plugin overrides */ /* Based on https://github.com/atom-community/atom-ide-datatip/blob/master/styles/atom-ide-datatips.less and https://github.com/atom/atom/blob/master/packages/one-light-ui */ /* Border around popup */ .prism-previewer.prism-previewer:before, .prism-previewer-gradient.prism-previewer-gradient div { border-color: hsl(0, 0, 95%); } /* Angle and time should remain as circles and are hence not included */ .prism-previewer-color.prism-previewer-color:before, .prism-previewer-gradient.prism-previewer-gradient div, .prism-previewer-easing.prism-previewer-easing:before { border-radius: 0.3em; } /* Triangles pointing to the code */ .prism-previewer.prism-previewer:after { border-top-color: hsl(0, 0, 95%); } .prism-previewer-flipped.prism-previewer-flipped.after { border-bottom-color: hsl(0, 0, 95%); } /* Background colour within the popup */ .prism-previewer-angle.prism-previewer-angle:before, .prism-previewer-time.prism-previewer-time:before, .prism-previewer-easing.prism-previewer-easing { background: hsl(0, 0%, 100%); } /* For angle, this is the positive area (eg. 90deg will display one quadrant in this colour) */ /* For time, this is the alternate colour */ .prism-previewer-angle.prism-previewer-angle circle, .prism-previewer-time.prism-previewer-time circle { stroke: hsl(230, 8%, 24%); stroke-opacity: 1; } /* Stroke colours of the handle, direction point, and vector itself */ .prism-previewer-easing.prism-previewer-easing circle, .prism-previewer-easing.prism-previewer-easing path, .prism-previewer-easing.prism-previewer-easing line { stroke: hsl(230, 8%, 24%); } /* Fill colour of the handle */ .prism-previewer-easing.prism-previewer-easing circle { fill: transparent; }"},{"title":"404 Not Foundï¼šè¯¥é¡µæ— æ³•æ˜¾ç¤º","date":"2023-08-22T01:36:55.568Z","updated":"2023-08-22T01:36:55.568Z","comments":false,"path":"/404.html","permalink":"https://spike1337.github.io/404.html","excerpt":"","text":""}],"posts":[{"title":"Butterflyä¸»é¢˜Markdownæ ·å¼æµ‹è¯•","slug":"butterfly-test","date":"2023-08-22T06:37:00.000Z","updated":"2023-08-24T01:24:06.741Z","comments":true,"path":"2023/08/22/butterfly-test/","link":"","permalink":"https://spike1337.github.io/2023/08/22/butterfly-test/","excerpt":"","text":"H1æ ‡é¢˜ è¿™æ˜¯ä¸€äº›æ–‡å­—æ ·å¼ã€‚ Here are some text styles. H2æ ‡é¢˜ H3æ ‡é¢˜ H4æ ‡é¢˜ æ–œä½“ ç²—ä½“ ä»£ç  è¡Œå†…ä»£ç  rm -rf /root/ ä»£ç é«˜äº® 123456789class foo&#123;private: int id; std::string text;public: void print_text(void);&#125;; 1234567def fib(n): a, b = 0, 1 while a &lt; n: print(a, end=&#x27; &#x27;) a, b = b, a+b print()fib(1000) è¡¨æ ¼ key value comment key1 value1 comment1 key2 value2 comment2 key3 value3 comment3 åˆ—è¡¨ æœ‰åºåˆ—è¡¨ comment1 comment2 comment3 æ— åºåˆ—è¡¨ function1 function2 function3 function4 å›¾ç‰‡ å‹¾é€‰æ¡† todo 1 todo 2 emoji ğŸ˜¢ è¿™æ˜¯ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ï¼ ä¾¿ç­¾ æç¤º è¿™æ˜¯ä¸€ä¸ªæç¤º æ³¨æ„ è¿™æ˜¯ä¸€ä¸ªè­¦å‘Š è­¦å‘Š è¿™æ˜¯ä¸€ä¸ªå±é™©ä¿¡å· æˆåŠŸ è¿™æ˜¯ä¸€ä¸ªæˆåŠŸä¿¡å·","categories":[{"name":"demo","slug":"demo","permalink":"https://spike1337.github.io/categories/demo/"}],"tags":[{"name":"demo","slug":"demo","permalink":"https://spike1337.github.io/tags/demo/"}]},{"title":"Cæ ‡å‡†åº“ Â· æ–‡ä»¶è®¿é—® Â· statx","slug":"statx","date":"2023-07-25T06:41:21.000Z","updated":"2023-08-22T01:36:55.571Z","comments":true,"path":"2023/07/25/statx/","link":"","permalink":"https://spike1337.github.io/2023/07/25/statx/","excerpt":"","text":"æœ€è¿‘å¼€å‘é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæƒ³è¦è·å–æŸä¸ªæ–‡ä»¶æ¯«ç§’çº§çš„ä¿®æ”¹æ—¶é—´ã€‚ä¼—æ‰€å‘¨çŸ¥Cæ ‡å‡†åº“ä¸­æä¾›çš„statå‡½æ•°åªèƒ½è·å–åˆ°ç§’çº§çš„ä¿®æ”¹æ—¶é—´st_mtimeã€‚ç›¸å…³çš„ä¿¡æ¯ç¿»äº†ä¸ªéï¼Œæœ€ç»ˆè¿˜æ˜¯ç¥å¥‡çš„ChatGPTç»™æˆ‘äº†ç­”æ¡ˆï¼š Linux 4.11åŠæ›´é«˜ç‰ˆæœ¬ï¼Œæ”¯æŒstatxæä¾›äº†æ¯«ç§’çº§çš„æ–‡ä»¶ä¿®æ”¹æ—¶é—´ SYNOPSIS STRUCT 1234567891011121314151617181920212223242526272829303132333435363738struct statx &#123; __u32 stx_mask; /* Mask of bits indicating filled fields */ __u32 stx_blksize; /* Block size for filesystem I/O */ __u64 stx_attributes; /* Extra file attribute indicators */ __u32 stx_nlink; /* Number of hard links */ __u32 stx_uid; /* User ID of owner */ __u32 stx_gid; /* Group ID of owner */ __u16 stx_mode; /* File type and mode */ __u64 stx_ino; /* Inode number */ __u64 stx_size; /* Total size in bytes */ __u64 stx_blocks; /* Number of 512B blocks allocated */ __u64 stx_attributes_mask; /* Mask to show what&#x27;s supported in stx_attributes */ /* The following fields are file timestamps */ struct statx_timestamp stx_atime; /* Last access */ struct statx_timestamp stx_btime; /* Creation */ struct statx_timestamp stx_ctime; /* Last status change */ struct statx_timestamp stx_mtime; /* Last modification */ /* If this file represents a device, then the next two fields contain the ID of the device */ __u32 stx_rdev_major; /* Major ID */ __u32 stx_rdev_minor; /* Minor ID */ /* The next two fields contain the ID of the device containing the filesystem where the file resides */ __u32 stx_dev_major; /* Major ID */ __u32 stx_dev_minor; /* Minor ID */ __u64 stx_mnt_id; /* Mount ID */ /* Direct I/O alignment restrictions */ __u32 stx_dio_mem_align; __u32 stx_dio_offset_align;&#125;; å…¶ä¸­å››ä¸ªstatx_timestampå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ¯«ç§’çº§æ—¶é—´æˆ³ 12345struct statx_timestamp &#123; __s64 tv_sec; // ç§’æ•°æ—¶é—´æˆ³ __u32 tv_nsec; // tv_srchiå‘¨çš„çº³ç§’æ•° __s32 __reserved; // ä¿ç•™ç²¾åº¦&#125;; FUNCTION å‡½æ•°statxä½äºCæ ‡å‡†åº“ Standard C library (libc, -lc)ï¼Œå‡½æ•°çš„å£°æ˜å’Œä½¿ç”¨å¦‚ä¸‹ 123456#define _GNU_SOURCE#include &lt;fcntl.h&gt;#include &lt;sys/stat.h&gt;int statx(int dirfd, const char *restrict pathname, int flags, unsigned int mask, struct statx *restrict statxbuf); RETURN å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œè¿”å›0ï¼Œå¦åˆ™è¿”å›-1å¹¶è®¾ç½®errno æ›´è¯¦ç»†çš„ä¿¡æ¯è¯·ç§»æ­¥ LINUX MANUAL PAGE Example æˆ‘è‡ªå·±æµ‹è¯•çš„ä¸€ä¸ªç®€å•ä¾‹å­ 1234567891011121314151617181920212223242526272829303132333435363738#include &lt;error.h&gt;#include &lt;fcntl.h&gt;#include &lt;stdint.h&gt;#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;sys/stat.h&gt;#include &lt;time.h&gt;#include &lt;unistd.h&gt;int main() &#123; const char *filename = &quot;tmp_file&quot;; // statx ç»“æ„ä½“ struct statx buffer; // AT_FDCWD åœ¨å½“å‰ç›®å½•ä¸‹è¿è¡Œ // STATX_MTIME è·å–ä¿®æ”¹æ—¶é—´ // AT_SYMLINK_NOFOLLOW å¦‚æœæ˜¯é“¾æ¥åˆ™è¿”å›é“¾æ¥æœ¬èº«ä¿¡æ¯ int result = statx(AT_FDCWD, filename, AT_SYMLINK_NOFOLLOW, STATX_MTIME, &amp;buffer); if (result == -1) &#123; fprintf(stderr, &quot;Error: %m\\n&quot;); return 1; &#125; // buffer.stx_mtime è®°å½•æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ // tv_sec æ˜¯ç§’çº§, tv_nsec æ˜¯æ¯«ç§’çº§ int64_t sec = buffer.stx_mtime.tv_sec; int micro_sec = buffer.stx_mtime.tv_nsec / 1000; char time_str[128]; strftime(time_str, 128, &quot;%Y-%m-%d %H:%M:%S&quot;, localtime(&amp;sec)); fprintf(stdout, &quot;Modification time of file %s is %s.%d\\n&quot;, filename, time_str, micro_sec); return 0;&#125; Linuxæµ‹è¯•ç”¨ä¾‹ https://kgithub.com/torvalds/linux/blob/master/samples/vfs/test-statx.c","categories":[{"name":"Linux","slug":"Linux","permalink":"https://spike1337.github.io/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"https://spike1337.github.io/tags/Linux/"},{"name":"libc","slug":"libc","permalink":"https://spike1337.github.io/tags/libc/"},{"name":"file access","slug":"file-access","permalink":"https://spike1337.github.io/tags/file-access/"}]},{"title":"PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆä¸‰ï¼‰Â· å…ƒç»„çš„æ’å…¥","slug":"tuple_insert","date":"2023-07-13T11:02:08.000Z","updated":"2023-08-24T01:54:58.113Z","comments":true,"path":"2023/07/13/tuple_insert/","link":"","permalink":"https://spike1337.github.io/2023/07/13/tuple_insert/","excerpt":"","text":"å…ƒç»„æ’å…¥ å…ƒç»„çš„æ’å…¥ä¸»è¦ç”±å‡½æ•°heap_insertæ¥å®Œæˆï¼Œä¸»è¦åˆ†ä¸ºå‡ æ­¥ï¼š åˆå§‹åŒ–å…ƒç»„å¤´ HeapTupleHeader è·å–å¯ç”¨çš„page åˆ¤æ–­å…ƒç»„å¯è§æ€§å’Œäº‹åŠ¡å†²çª å°†å…ƒç»„å†™å…¥å¯ç”¨çš„pageï¼Œå¹¶æ ‡è®°page dirty å†™wal åˆå§‹åŒ–å…ƒç»„çš„å…ƒæ•°æ® åœ¨heap_prepare_insertä¸­å®Œæˆï¼Œæ¥å£æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹æºç  123456789101112131415161718192021222324252627282930313233static HeapTupleheap_prepare_insert(Relation relation, HeapTuple tup, TransactionId xid, CommandId cid, int options)&#123; /* è®¡ç®—å…ƒç»„çš„infomask &amp; infomask2 */ tup-&gt;t_data-&gt;t_infomask &amp;= ~(HEAP_XACT_MASK); tup-&gt;t_data-&gt;t_infomask2 &amp;= ~(HEAP2_XACT_MASK); tup-&gt;t_data-&gt;t_infomask |= HEAP_XMAX_INVALID; /* è®¾ç½®xminï¼Œä¹Ÿå°±æ˜¯å…ƒç»„æ’å…¥çš„äº‹åŠ¡å· */ HeapTupleHeaderSetXmin(tup-&gt;t_data, xid); if (options &amp; HEAP_INSERT_FROZEN) HeapTupleHeaderSetXminFrozen(tup-&gt;t_data); /* è®¾ç½®cidã€xmaxå’Œtableoidï¼Œç”±äºæ˜¯å…ƒç»„æ’å…¥ï¼Œåˆ™å°†xmaxè®¾ç½®ä¸º0 */ HeapTupleHeaderSetCmin(tup-&gt;t_data, cid); HeapTupleHeaderSetXmax(tup-&gt;t_data, 0); tup-&gt;t_tableOid = RelationGetRelid(relation); /* åˆ¤æ–­æ˜¯å¦ä¸ºTOASTå…ƒç»„ */ if (relation-&gt;rd_rel-&gt;relkind != RELKIND_RELATION &amp;&amp; relation-&gt;rd_rel-&gt;relkind != RELKIND_MATVIEW) &#123; Assert(!HeapTupleHasExternal(tup)); return tup; &#125; else if (HeapTupleHasExternal(tup) || tup-&gt;t_len &gt; TOAST_TUPLE_THRESHOLD) /* TOASTå…ƒç»„ï¼Œè°ƒç”¨ç›¸åº”çš„æ’å…¥æ¥å£ */ return heap_toast_insert_or_update(relation, tup, NULL, options); else /* å¦åˆ™ç›´æ¥è¿”å›å‡†å¤‡å¥½çš„tup */ return tup;&#125; è·å–å¯ç”¨çš„page åœ¨RelationGetBufferForTupleä¸­å®Œæˆã€‚ relationæ˜¯ç›®æ ‡è¡¨å¯¹è±¡ï¼Œlenæ˜¯tupleæ’å…¥éœ€è¦çš„é•¿åº¦ã€‚otherBufferç”¨äºå…ƒç»„updateæ—¶æ›¿æ¢æ—§çš„bufferï¼Œoptionsæ˜¯å†™å…¥çš„é€‰é¡¹ï¼Œbistateè¡¨ç¤ºæ‰¹é‡æ’å…¥å¯¹è±¡çš„çŠ¶æ€ï¼Œvmbufferå’Œvmbuffer_otherç”¨äºå¯è§æ€§æ˜ å°„ 12345BufferRelationGetBufferForTuple(Relation relation, Size len, Buffer otherBuffer, int options, BulkInsertState bistate, Buffer *vmbuffer, Buffer *vmbuffer_other) é€šè¿‡å¡«å……å› å­ï¼Œè®¡ç®—ç©ºé—²ç©ºé—´ã€‚ å¡«å……å› å­FillFactoræ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”ï¼Œé™åˆ¶äº†æˆ‘ä»¬å¯¹äºpageçš„ä½¿ç”¨ç‡ 1234567891011// è¿™é‡Œä½¿ç”¨äº†é»˜è®¤å¡«å……ç™¾åˆ†æ¯”, HEAP_DEFAULT_FILLFACTOR = 100, ä¹Ÿå°±æ˜¯å®Œå…¨å¡«å……saveFreeSpace = RelationGetTargetPageFreeSpace(relation, HEAP_DEFAULT_FILLFACTOR);// æ²¡æœ‰tupleçš„pageä¸­ä¹Ÿå¯èƒ½æœ‰line pointerï¼Œæ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªè¿‘ä¼¼å€¼nearlyEmptyFreeSpace = MaxHeapTupleSize - (MaxHeapTuplesPerPage / 8 * sizeof(ItemIdData));if (len + saveFreeSpace &gt; nearlyEmptyFreeSpace) targetFreeSpace = Max(len, nearlyEmptyFreeSpace);else targetFreeSpace = len + saveFreeSpace; å°è¯•ä»cacheä¸­è·å–è¡¨æœ€è¿‘ä½¿ç”¨çš„pageï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•é€šè¿‡FSMè·å–æ»¡è¶³æ’å…¥æ¡ä»¶çš„page 12345678910if (bistate &amp;&amp; bistate-&gt;current_buf != InvalidBuffer) targetBlock = BufferGetBlockNumber(bistate-&gt;current_buf);else targetBlock = RelationGetTargetBlock(relation);if (targetBlock == InvalidBlockNumber &amp;&amp; use_fsm)&#123; // cacheä¸­æ²¡æœ‰ç›®æ ‡pageï¼Œè®©FSMæ¥æä¾›ä¸€ä¸ªåˆå§‹ç›®æ ‡page targetBlock = GetPageWithFreeSpace(relation, targetFreeSpace);&#125; æ¥ä¸‹æ¥æˆ‘ä»¬æ‹¿ç€ä¹‹å‰è·å–åˆ°çš„blockï¼Œå»è·å–å¯¹åº”çš„buffer 123456789101112131415if (otherBuffer == InvalidBuffer)&#123; // æ²¡æœ‰otherbuffer, ç®€å•æ’å…¥è¯­å¥, è·å–buffer buffer = ReadBufferBI(relation, targetBlock, RBM_NORMAL, bistate); if (PageIsAllVisible(BufferGetPage(buffer))) visibilitymap_pin(relation, targetBlock, vmbuffer); if ((options &amp; HEAP_INSERT_FROZEN) &amp;&amp; (PageGetMaxOffsetNumber(BufferGetPage(buffer)) == 0)) visibilitymap_pin(relation, targetBlock, vmbuffer); LockBuffer(buffer, BUFFER_LOCK_EXCLUSIVE);&#125;page = BufferGetPage(buffer); å¦‚æœæ‹¿åˆ°çš„pageæœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†è·å–å¯ç”¨pageçš„æ­¥éª¤ï¼Œç›´æ¥è¿”å›å°±å¯ä»¥äº† 12345678// æ£€æŸ¥pageæ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œå¦‚æœæœ‰åˆ™è¿”å›å½“å‰pagepageFreeSpace = PageGetHeapFreeSpace(page);if (targetFreeSpace &lt;= pageFreeSpace)&#123; /* use this page as future insert target, too */ RelationSetTargetBlock(relation, targetBlock); return buffer;&#125; å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œæˆ‘ä»¬éœ€è¦å»å¯»æ‰¾ä¸‹ä¸€ä¸ªblock 123456789101112131415161718192021222324252627// å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„æ‰¹é‡æ“ä½œ, åˆ™è¿˜æœ‰å…¶ä»–çš„æœªä½¿ç”¨çš„page, æˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸‹ä¸€ä¸ªpageif (bistate &amp;&amp; bistate-&gt;next_free != InvalidBlockNumber)&#123; targetBlock = bistate-&gt;next_free; if (bistate-&gt;next_free &gt;= bistate-&gt;last_free) &#123; bistate-&gt;next_free = InvalidBlockNumber; bistate-&gt;last_free = InvalidBlockNumber; &#125; else bistate-&gt;next_free++;&#125;// å¦‚æœæ²¡æœ‰è¿›è¡Œæ‰¹é‡æ“ä½œ, è¿™ä¸ªæ—¶å€™å°±è¦é—®ä¸€é—®FSMçš„æ„è§else if (!use_fsm)&#123; // æ²¡æœ‰FSM, åªèƒ½è·³å‡ºå¾ªç¯å»æ‰©é¡µ break;&#125;else&#123; // é€šè¿‡FSMå¯»æ‰¾ä¸‹ä¸€ä¸ªåˆé€‚çš„page targetBlock = RecordAndGetPageWithFreeSpace(relation, targetBlock, pageFreeSpace, targetFreeSpace);&#125; å¦‚æœä»¥ä¸Šå¾ªç¯ä¸­æ²¡æœ‰æ‰¾åˆ°ç©ºé—²bufferï¼Œæˆ‘ä»¬åªèƒ½è¿›å…¥æ‰©é¡µçš„é€»è¾‘æ¥æ–°å¢ä¸€ä¸ªpageç”¨æ¥æ’å…¥ 1234567// æ‰©é¡µå¹¶è¿”å›æ–°å¢çš„page, æ‰©é¡µçš„å…·ä½“é€»è¾‘æˆ‘ä»¬åœ¨è¿™å°±ä¸è¯¦ç»†ä»‹ç»äº†// ç®€å•æ¥è¯´å°±æ˜¯ç»™relationåŠ Exclusiveé”, ç„¶ååˆå§‹åŒ–ä¸€ä¸ªæ–°çš„pageè¿›å»buffer = RelationAddBlocks(relation, bistate, num_pages, use_fsm, &amp;unlockedTargetBuffer);targetBlock = BufferGetBlockNumber(buffer);page = BufferGetPage(buffer); æ–°å¢çš„é¡µæˆ‘ä»¬å†æ¥æ£€æŸ¥ä¸‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œå¦‚æœæœ‰çš„è¯å°±èƒ½è¿”å›ä½¿ç”¨äº† 1234567891011121314151617pageFreeSpace = PageGetHeapFreeSpace(page);if (len &gt; pageFreeSpace)&#123; if (unlockedTargetBuffer) &#123; if (otherBuffer != InvalidBuffer) LockBuffer(otherBuffer, BUFFER_LOCK_UNLOCK); UnlockReleaseBuffer(buffer); goto loop; &#125; elog(PANIC, &quot;tuple is too big: size %zu&quot;, len);&#125;RelationSetTargetBlock(relation, targetBlock);return buffer; å†™å…¥æ•°æ® å†™å…¥æ•°æ®æ˜¯ç”±æ¥å£RelationPutHeapTupleæ¥å®Œæˆ 12345678910111213141516171819202122232425262728voidRelationPutHeapTuple(Relation relation, Buffer buffer, HeapTuple tuple, bool token)&#123; Page pageHeader; OffsetNumber offnum; ... pageHeader = BufferGetPage(buffer); // å°†å…ƒç»„æ’å…¥åˆ°pageä¸­ offnum = PageAddItem(pageHeader, (Item) tuple-&gt;t_data, tuple-&gt;t_len, InvalidOffsetNumber, false, true); // è®°å½•å½“å‰çš„ä½ç½®åˆ°å…ƒç»„çš„t_selfä¸­ ItemPointerSet(&amp;(tuple-&gt;t_self), BufferGetBlockNumber(buffer), offnum); // å°†å½“å‰çš„ä½ç½®ä¹Ÿè®°å½•åˆ°å…ƒç»„çš„ctidä¸­ if (!token) &#123; ItemId itemId = PageGetItemId(pageHeader, offnum); HeapTupleHeader item = (HeapTupleHeader) PageGetItem(pageHeader, itemId); item-&gt;t_ctid = tuple-&gt;t_self; &#125;&#125; è¿™é‡Œä¸»è¦çš„å·¥ä½œéƒ½æœ‰å‡½æ•°PageAddItemæ¥å®Œæˆï¼ŒPageAddItemæ˜¯ä¸€ä¸ªå®ï¼Œå†…éƒ¨è°ƒç”¨PageAddItemExtendedï¼Œæˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹è¿™ä¸ªæ¥å£ pageæ˜¯æ’å…¥çš„é¡µé¢ï¼Œitemçš„æ’å…¥çš„æ•°æ®æŒ‡é’ˆï¼Œsizeçš„æ’å…¥æ•°æ®çš„å¤§å°ã€‚offsetNumberæ˜¯å…ƒç»„åœ¨é¡µé¢ä¸­çš„åç§»é‡ï¼Œå¦‚æœæ’å…¥æˆåŠŸåˆ™ä¼šè¢«è¿”å›ã€‚flagsæ˜¯æ’å…¥çš„é€‰é¡¹ 123456OffsetNumberPageAddItemExtended(Page page, Item item, Size size, OffsetNumber offsetNumber, int flags) é¦–å…ˆæˆ‘ä»¬åœ¨pageä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªslotçš„ä½ç½®ï¼Œå¦‚æœä¹‹åæ²¡æœ‰æ‰¾åˆ°ç©ºä½™çš„slotï¼Œæˆ‘ä»¬å°±ä¼šä½¿ç”¨è¿™ä¸ªä½ç½®æ¥æ’å…¥å…ƒç»„ 1234567891011121314151617181920limit = OffsetNumberNext(PageGetMaxOffsetNumber(page));// å¦‚æœpageæœ‰free line pointer, ä¹Ÿå°±æ˜¯pd_flagsä¸­åŒ…å«PD_HAS_FREE_LINESæ ‡è®°// åˆ™å»è¡ŒæŒ‡é’ˆæ•°ç»„ä¸­å¯»æ‰¾free slotif (PageHasFreeLinePointers(page))&#123; // æ‰«æPageHeaderçš„è¡ŒæŒ‡é’ˆæ•°ç»„ï¼ŒæŸ¥æ‰¾æ ‡è®°ä¸º LP_UNUSEDçš„ itemId for (offsetNumber = FirstOffsetNumber; offsetNumber &lt; limit; offsetNumber++) &#123; if (!ItemIdIsUsed(itemId) &amp;&amp; !ItemIdHasStorage(itemId)) break; &#125;&#125;else&#123; // æ²¡æœ‰free line pointer, ä½¿ç”¨limit offsetNumber = limit;&#125; æ¥ä¸‹æ¥æˆ‘ä»¬è®¡ç®—pageçš„pd_lowerå’Œpg_upperæŒ‡é’ˆæŒ‡å‘çš„offset 12345678if (offsetNumber == limit || needshuffle) lower = phdr-&gt;pd_lower + sizeof(ItemIdData);else lower = phdr-&gt;pd_lower;alignedSize = MAXALIGN(size);upper = (int) phdr-&gt;pd_upper - (int) alignedSize; æœ€åæˆ‘ä»¬å°±å¯ä»¥æŠŠå…ƒç»„æ’å…¥åˆ°pageä¸­äº† 12345678910111213141516// å¦‚æœå·²ç»æœ‰äº†å¯¹åº”çš„è¡ŒæŒ‡é’ˆ, åˆ™é‡æ–°è®¾ç½®è¡ŒæŒ‡é’ˆä¸­çš„å€¼å’Œæ ‡è®°itemId = PageGetItemId(page, offsetNumber);if (needshuffle) memmove(itemId + 1, itemId, (limit - offsetNumber) * sizeof(ItemIdData));ItemIdSetNormal(itemId, upper, size);// å°†æ•°æ®æ’å…¥åˆ°å¯¹åº”çš„offsetmemcpy((char *) page + upper, item, size);// æ›´æ–°PageHeaderä¸­çš„upperå’ŒloweræŒ‡é’ˆphdr-&gt;pd_lower = (LocationIndex) lower;phdr-&gt;pd_upper = (LocationIndex) upper; ###WAL logå’Œç»Ÿè®¡ä¿¡æ¯ å°†å…ƒç»„çœŸæ­£æ’å…¥åˆ°pageä¹‹åï¼Œæˆ‘ä»¬ä¼šå†™WAL logå¹¶æ›´æ–°ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ã€‚è¿™ä¸¤å—æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œè¯¦ç»†çš„æè¿°äº†","categories":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/categories/PostgreSQL/"}],"tags":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/tags/PostgreSQL/"},{"name":"storage","slug":"storage","permalink":"https://spike1337.github.io/tags/storage/"}]},{"title":"PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆäºŒï¼‰Â· å…ƒç»„çš„ç»„ç»‡ç»“æ„","slug":"tuple_manager_2","date":"2023-07-11T10:35:06.000Z","updated":"2023-08-24T01:55:05.462Z","comments":true,"path":"2023/07/11/tuple_manager_2/","link":"","permalink":"https://spike1337.github.io/2023/07/11/tuple_manager_2/","excerpt":"","text":"ä¸Šæ¬¡æˆ‘ä»¬ç®€å•çœ‹äº†ä¸‹PostgreSQLä¸­é¡µé¢çš„ç»„ç»‡ç»“æ„ï¼Œä»‹ç»äº†PageHeaderå’Œè¡ŒæŒ‡é’ˆçš„ç»“æ„ã€‚è¿™æ¬¡æˆ‘ä»¬æ¥çœ‹çœ‹å…ƒç»„çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯tupleçš„æˆå‘˜å˜é‡ Tupleçš„ç»“æ„ å…ƒç»„çš„ç»“æ„å¦‚ä¸‹ 1234567typedef struct HeapTupleData&#123; uint32 t_len; ItemPointerData t_self; Oid t_tableOid; HeapTupleHeader t_data;&#125; HeapTupleData; t_lenï¼Œå…ƒç»„t_dataå­—æ®µçš„é•¿åº¦ t_selfï¼Œè®°å½•å…ƒç»„è‡ªå·±çš„ä½ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€åœ¨çš„blockä¿¡æ¯ï¼Œå’Œå…ƒç»„åœ¨é¡µé¢ä¸­çš„offset t_tableOidï¼Œå…ƒç»„æ‰€åœ¨è¡¨çš„oid t_dataï¼Œå…ƒç»„çš„å…ƒæ•°æ®ä¿¡æ¯å’Œå…·ä½“å­˜å‚¨çš„æ•°æ® HeapTupleHeader å­˜å‚¨å…ƒç»„çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œç»“æ„å¦‚ä¸‹ 1234567891011121314struct HeapTupleHeaderData&#123; union &#123; HeapTupleFields t_heap; DatumTupleFields t_datum; &#125; t_choice; ItemPointerData t_ctid; uint16 t_infomask2; uint16 t_infomask; uint8 t_hoff; bits8 t_bits[FLEXIBLE_ARRAY_MEMBER];&#125;; t_heapï¼Œå…ƒç»„äº‹åŠ¡ç›¸å…³çš„åŸŸ t_datumï¼Œå…ƒç»„æ•°æ®ç›¸å…³çš„åŸŸ t_cidï¼ŒHOTå…ƒç»„ä¼šæŒ‡å‘æœ€æ–°çš„å…ƒç»„ä½ç½®ï¼Œå¦åˆ™æŒ‡å‘è‡ªå·±çš„ä½ç½® t_infomask2ï¼Œå…ƒç»„çš„å±æ€§æ•°ï¼Œå’Œä¸€äº›æ ‡è®°ä½ t_infomaskï¼Œå…ƒç»„çš„æ ‡è®°ä½ã€‚è¿™äº›æ ‡è®°æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œä»‹ç»äº† t_hoffï¼Œheaderçš„æ•´ä½“å¤§å° t_bitsï¼ŒNULLå€¼åˆ—çš„æ•°ç»„ t_bitsæ•°ç»„ä¹‹åå­˜æ”¾çš„å°±æ˜¯å…ƒç»„çš„æ•°æ® HeapTupleFields å…ƒç»„äº‹åŠ¡ç›¸å…³çš„åŸŸ 1234567891011typedef struct HeapTupleFields&#123; TransactionId t_xmin; TransactionId t_xmax; union &#123; CommandId t_cid; TransactionId t_xvac; &#125; t_field3;&#125; HeapTupleFields; t_xminï¼Œå…ƒç»„æ’å…¥çš„äº‹åŠ¡å· t_xmaxï¼Œå…ƒç»„åˆ é™¤çš„äº‹åŠ¡å· t_cidï¼Œå‘½ä»¤idï¼Œè¡¨ç¤ºå½“å‰äº‹åŠ¡ä¸­æ‰§è¡Œçš„ä¿®æ”¹è¯¥å…ƒç»„çš„å‘½ä»¤çš„id t_xvacï¼Œvacuum fullæ“ä½œçš„äº‹åŠ¡å· DatumTupleFields å…ƒç»„æ•°æ®ç›¸å…³çš„åŸŸ 1234567typedef struct DatumTupleFields&#123; int32 datum_len_; /* varlena header (do not touch directly!) */ int32 datum_typmod; /* -1, or identifier of a record type */ Oid datum_typeid; /* composite type OID, or RECORDOID */&#125; DatumTupleFields; datum_len_ï¼Œå˜é•¿æ•°æ®ç±»å‹çš„é•¿åº¦ datum_typmodï¼Œæ•°æ®ç±»å‹ datum_typeidï¼Œå¤åˆç±»å‹çš„ç±»å‹oid","categories":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/categories/PostgreSQL/"}],"tags":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/tags/PostgreSQL/"},{"name":"storage","slug":"storage","permalink":"https://spike1337.github.io/tags/storage/"}]},{"title":"PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆä¸€ï¼‰Â· é¡µçš„ç»„ç»‡ç»“æ„","slug":"tuple_manager_1","date":"2023-07-10T09:47:33.000Z","updated":"2023-08-24T01:55:01.531Z","comments":true,"path":"2023/07/10/tuple_manager_1/","link":"","permalink":"https://spike1337.github.io/2023/07/10/tuple_manager_1/","excerpt":"","text":"å¼€ä¸ªæ–°å‘ï¼Œç®€å•å†™ä¸€å†™PostgreSQLä¸­çš„å…ƒç»„ç®¡ç†ã€‚ å¯¹äºæ•´ä¸ªå­˜å‚¨æ¶æ„ï¼Œå„ç§PostgreSQLçš„ç›¸å…³ä¹¦ç±å·²ç»ä»‹ç»çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å†é‡å¤é€ è½®å­äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä¸»è¦åŸºäºé¢å‘å¯¹è±¡ï¼ˆå¤§é›¾ï¼‰ï¼Œæ¥çœ‹çœ‹å…ƒç»„è¿™ä¸ªå¯¹è±¡ï¼Œæœ‰å“ªäº›æˆå‘˜å˜é‡ï¼Œåˆæœ‰å“ªäº›æˆå‘˜å‡½æ•° å…ƒç»„(Tuple)æ˜¯PostgreSQLä¸­æ•°æ®çš„åŸºæœ¬å­˜å‚¨å•å…ƒï¼ŒPageåˆæ˜¯å­˜å‚¨å…ƒç»„çš„åŸºæœ¬è½½ä½“ï¼Œæ‰€ä»¥è¿™ç¬¬ä¸€ç¯‡æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹Pageçš„ç»“æ„ Pageçš„ç»“æ„ Pageçš„ç»“æ„å¯ä»¥ç®€å•çœ‹ä¸‹å›¾æ‰€ç¤º pageçš„é»˜è®¤å¤§å°ä¸º8kã€‚æ¯ä¸ªé¡µé¢çš„èµ·å§‹ä½ç½®æœ‰å¤§å°ä¸º24ä¸ªå­—èŠ‚çš„PageHeaderï¼Œè®°å½•è¯¥pageç›¸å…³çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚PageHeaderä¸­çš„pd_lowerå’Œpd_upperåˆ†åˆ«æŒ‡å‘äº†é¡µé¢ç©ºé—²ç©ºé—´çš„é¦–å°¾ã€‚ è¿™é‡Œæ¯ä¸€ä¸ªtupleå­˜å‚¨ä¸€æ¡æ•°æ®è®°å½•ï¼Œä»æ•°æ®é¡µåº•éƒ¨å¼€å§‹å‘å‰ä¾æ¬¡å­˜å‚¨ã€‚è¿™äº›å…ƒç»„åœ¨é¡µé¢ä¸­çš„ä½ç½®å­˜å‚¨åœ¨è¡ŒæŒ‡é’ˆline pointerä¸­ï¼Œæ¯ä¸ªè¡ŒæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªtupleã€‚è¡ŒæŒ‡é’ˆä»å‰å‘åä¾æ¬¡å­˜å‚¨ï¼Œå½¢æˆä¸€ä¸ªç®€å•çš„æ•°æ®ã€‚è¡ŒæŒ‡é’ˆä¸­è¿˜å­˜æ”¾äº†å…ƒç»„çš„çŠ¶æ€å’Œå¤§å°ä¿¡æ¯ï¼Œæ‰®æ¼”å…ƒç»„åœ¨é¡µé¢ä¸­çš„ç´¢å¼•çš„è§’è‰²ã€‚è¡ŒæŒ‡é’ˆå’Œtupleä¸­é—´çš„éƒ¨åˆ†ä¸ºé¡µé¢çš„ç©ºé—²ç©ºé—´ã€‚ æˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹PageHeaderå­˜å‚¨äº†ä»€ä¹ˆå…ƒæ•°æ® PageHeader 123456789101112typedef struct PageHeaderData&#123; PageXLogRecPtr pd_lsn; uint16 pd_checksum; uint16 pd_flags; LocationIndex pd_lower; LocationIndex pd_upper; LocationIndex pd_special; uint16 pd_pagesize_version; TransactionId pd_prune_xid; ItemIdData pd_linp[FLEXIBLE_ARRAY_MEMBER];&#125; PageHeaderData; pd_lsnï¼Œè®°å½•äº†è¯¥é¡µé¢æœ€åä¸€æ¬¡æ›´æ”¹çš„WAL logçš„lsn pg_checksumï¼Œé¡µé¢æ ¡éªŒå’Œ pd_flagsï¼Œé¡µé¢çš„æ ‡è®°ä¸ºï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ ‡è®° PD_HAS_FREE_LINESï¼Œé¡µé¢ä¸­æ˜¯å¦æœ‰unused line pointer. è¿™ä¸ªunusedçš„æ¦‚å¿µæˆ‘ä»¬ä¹‹ååœ¨çœ‹åˆ°line pointeræ—¶ä¼šä»‹ç» PD_PAGE_FULLï¼Œé¡µé¢æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ç»™æ–°çš„tuple PD_ALL_VISIBLEï¼Œé¡µé¢ä¸­çš„æ‰€æœ‰å…ƒç»„æ˜¯å¦å¯¹å½“å‰å’Œä¹‹åçš„æ‰€æœ‰äº‹åŠ¡å¯è§ pd_lowerï¼ŒæŒ‡å‘ç©ºé—²ç©ºé—´çš„èµ·å§‹ä½ç½® pd_upperï¼ŒæŒ‡å‘ç©ºé—²ç©ºé—´çš„ç»“æŸä½ç½® pd_specialï¼ŒæŒ‡å‘ç‰¹æ®Šç©ºé—´çš„èµ·å§‹ä½ç½® pd_pagesize_versionï¼Œé¡µé¢å¸ƒå±€çš„ç‰ˆæœ¬å· pd_prune_xidï¼Œç”¨äºé¡µé¢å…ƒç»„æ¸…ç†æ—¶çš„æ ‡è®°ä½ï¼Œè®°å½•äº†æœ€æ—§çš„å¯æ¸…ç†çš„äº‹åŠ¡å·ã€‚æ²¡æœ‰åˆ™ä¸º0 pg_linpï¼Œé¡µé¢è¡ŒæŒ‡é’ˆæ•°ç»„ é¡µé¢çš„è¡ŒæŒ‡é’ˆç»“æ„ è¡ŒæŒ‡é’ˆæ˜¯ä¸€ä¸ª32ä½å¤§å°çš„ç´¢å¼•ç»“æ„ï¼Œå¦‚ä¸‹ï¼š 123456typedef struct ItemIdData&#123; unsigned lp_off:15, lp_flags:2, lp_len:15;&#125; ItemIdData; lp_offï¼Œè®°å½•äº†tupleåœ¨é¡µé¢ä¸­çš„offset lp_lenï¼Œè®°å½•äº†tupleçš„size lp_flagsï¼Œæ˜¯ä¸€ä¸ªtupleçŠ¶æ€çš„ç®€å•æ ‡è®°ï¼Œæ–¹ä¾¿åœ¨æ‰«æå…ƒç»„æ—¶åšä¸€ä¸ªåˆæ­¥ç­›é€‰ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªæ ‡è®° LP_UNUSEDï¼Œå…ƒç»„æœªä½¿ç”¨ï¼Œå¯ä»¥ç«‹åˆ»è¢«é‡ç”¨ LP_NORMALï¼Œå…ƒç»„çŠ¶æ€æ­£å¸¸ LP_REDIRECTï¼Œå…ƒç»„è¢«é‡å®šå‘äº†ã€‚ç”¨äºPGçš„HOTé“¾çš„å¤´éƒ¨å’Œä¸­é—´å…ƒç»„ LP_DEADï¼Œå…ƒç»„å·²æ­»ï¼Œä½†ç©ºé—´å¯èƒ½è¿˜æ²¡æœ‰å›æ”¶","categories":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/categories/PostgreSQL/"}],"tags":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/tags/PostgreSQL/"},{"name":"storage","slug":"storage","permalink":"https://spike1337.github.io/tags/storage/"}]},{"title":"Linux Â· å·¥å…· Â· devtodo Â· ç®€æ´çš„ç»ˆç«¯todoå·¥å…·","slug":"devtodo-manual","date":"2023-02-07T02:23:30.000Z","updated":"2023-08-22T06:03:21.632Z","comments":true,"path":"2023/02/07/devtodo-manual/","link":"","permalink":"https://spike1337.github.io/2023/02/07/devtodo-manual/","excerpt":"","text":"devtodoæ˜¯ä¸€æ¬¾è¿è¡Œäºç»ˆç«¯çš„todoå·¥å…·ï¼Œç®€æ´æ˜¯å®ƒçš„æœ€å¤§ä¼˜åŠ¿ã€‚devtodo ç›®å‰å·²è¢«è®¸å¤š Linux å‘è¡Œç‰ˆçš„è½¯ä»¶ä»“åº“æ”¶å½•ï¼Œå¯ä»¥ä»è½¯ä»¶ä»“åº“ä¸­å®‰è£…å®ƒï¼Œä¹Ÿå¯ä»¥ä»å®ƒçš„é¡¹ç›®ä¸»é¡µdevtodoä¸‹è½½æœ€æ–°ç‰ˆæœ¬ç¼–è¯‘å®‰è£…ã€‚ å¿«é€Ÿä¸Šæ‰‹ 123456$ todo # æ˜¾ç¤º todo list$ tda # æ·»åŠ ä¸€é¡¹ todoï¼Œä¹Ÿå¯ä»¥ç”¨ todo -a å‘½ä»¤$ tde &lt;index&gt; # ä¿®æ”¹ç¬¬ index æ¡ todo$ tdd &lt;index&gt; # æ ‡è®°ç¬¬ index æ¡ todo å·²ç»å®Œæˆ$ tdr &lt;index&gt; # åˆ é™¤ç¬¬ index æ¡ todo$ todo -A # æ˜¾ç¤ºæ‰€æœ‰çš„ todo æ¡ç›®ï¼ŒåŒ…æ‹¬å®Œæˆçš„ä»¥åŠæœªå®Œæˆçš„ å‘½ä»¤å±•ç¤º todo æ˜¾ç¤ºtodo listã€‚æŒ‰ä¼˜å…ˆçº§é¡ºåºæ’åˆ— 123456$ todo1.test 12.test 23.test 34.test 4 tda æ·»åŠ ä¸€é¡¹todoã€‚è®¾å®štodoå†…å®¹ï¼Œå¹¶è®¾ç½®todoä¼˜å…ˆçº§ 12345678$ tdaEnter text for the item you are adding.text&gt; test 11. veryhigh 2. high 3. medium 4. low 5. verylowEnter a priority from those listed above.priority&gt; 1Index of new item is 1 tde k ä¿®æ”¹ç¬¬ k æ¡ todoã€‚å¯ä»¥é‡æ–°ç¼–è¾‘todoå†…å®¹ï¼Œå¹¶è°ƒæ•´todoä¼˜å…ˆçº§ 1234567$ tde 1Modify the text of the item you are editing.text&gt; test modify 11. veryhigh 2. high 3. medium 4. low 5. verylowEnter a priority from those listed above.priority&gt; 1 tdd k æ ‡è®°ç¬¬ k æ¡ todo å·²å®Œæˆï¼Œå¯ä»¥è®¾å®šå®Œæˆçš„commentä¿¡æ¯ 123$ tdd 1comment&gt; done tdr k åˆ é™¤ç¬¬ k æ¡ todo 12$ tdr k todo -A æŸ¥çœ‹æ‰€æœ‰çš„ todo notesï¼Œä¸åŒ…æ‹¬è¢«åˆ é™¤é¡¹ 123- 2.test 2 3.test 3 4.test 4 è¿›é˜¶é…ç½® å…¨å±€todo notsè®°å½• é»˜è®¤çš„devtodoæ˜¯åœ¨æ‰§è¡Œtdaæ—¶ï¼Œåœ¨æ‰§è¡Œç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶.todoæ¥è®°å½•todo notesï¼Œæ‰§è¡Œå…¶ä»–æ“ä½œæ—¶ä¹Ÿæ˜¯è¯»å–æ‰§è¡Œç›®å½•ä¸‹çš„.todoæ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯æ¯ä¸ªæ‰§è¡Œç›®å½•æœ‰è‡ªå·±çš„todo listã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå…¨å±€çš„todo listï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨-Gå‚æ•°ã€‚ 1-G, --global Use the database specified by the --global-database option. Defaults to ~/.todo_global. -Gå‚æ•°ä½¿ç”¨ ~/.todo_globalä½œä¸ºå­˜å‚¨todo notesçš„æ•°æ®åº“ï¼Œè¿™æ ·æˆ‘ä»¬çš„todoå°±å¯ä»¥åœ¨å…¨å±€èŒƒå›´å†…ä½¿ç”¨ã€‚ä½œä¸ºæ‡’ç‹—æˆ‘å°±ç›´æ¥å°†-Gå‚æ•°å†™å…¥äº†alias 12345alias todo=&quot;todo -G&quot;alias tda=&quot;tda -G&quot;alias tdd=&quot;tdd -G&quot;alias tde=&quot;tde -G&quot;alias tdr=&quot;tdr -G&quot; å½“ç„¶ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨é»˜è®¤çš„~/.todo_globalæ–‡ä»¶ä½œä¸ºå…¨å±€æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥é€šè¿‡--global-databaseæŒ‡å®šå…¨å±€æ•°æ®åº“çš„æ–‡ä»¶ã€‚ 1--global-database ARG Specify the database to use if the -G (--global) parameter is used.","categories":[{"name":"Linux","slug":"Linux","permalink":"https://spike1337.github.io/categories/Linux/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"https://spike1337.github.io/tags/Linux/"},{"name":"tools","slug":"tools","permalink":"https://spike1337.github.io/tags/tools/"}]},{"title":"PostgreSQL Â· æºç è§£æ Â· MVCCæœºåˆ¶","slug":"mvcc-source-code","date":"2023-02-06T06:36:45.000Z","updated":"2023-08-24T01:54:42.631Z","comments":true,"path":"2023/02/06/mvcc-source-code/","link":"","permalink":"https://spike1337.github.io/2023/02/06/mvcc-source-code/","excerpt":"","text":"PostgreSQLé‡‡ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰æ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚æ£€ç´¢æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½åªæ˜¯ä¸€æ®µæ—¶é—´ä¹‹å‰çš„æ•°æ®å¿«ç…§ã€‚MVCCå¹¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„å¹¶å‘æ§åˆ¶æƒ…å†µï¼Œéœ€è¦ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“çš„é”æœºåˆ¶æ¥ä¿è¯äº‹åŠ¡çš„å¹¶å‘ï¼Œå› æ­¤åœ¨PostgreSQLé‡Œä¹Ÿæœ‰è¡¨å’Œè¡Œçº§åˆ«çš„é”å®šæœºåˆ¶ã€‚æ­¤å¤–PostgreSQLè¿˜æä¾›äº†ä¼šè¯é”æœºåˆ¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒä¸€æ¬¡å¯¹æŸä¸ªå¯¹è±¡åŠ é”ä¿è¯å¯¹äºå¤šä¸ªäº‹åŠ¡éƒ½æœ‰æ•ˆã€‚ äº‹åŠ¡éš”ç¦»çº§åˆ« æ ‡å‡†äº‹åŠ¡éš”ç¦»çº§åˆ« ä¸‰ä¸ªå¿…é¡»åœ¨å¹¶è¡Œçš„äº‹åŠ¡ä¹‹é—´é¿å…çš„ç°è±¡ï¼š è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªæœªæäº¤çš„å¹¶è¡Œäº‹åŠ¡å†™çš„æ•°æ® ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€ä¸ªæ•°æ®å‰åè¯»å–ä¸¤æ¬¡ï¼Œå‘ç°è¯¥æ•°æ®å·²ç»è¢«å¦ä¸€ä¸ªå·²æäº¤çš„æ•°æ®ä¿®æ”¹è¿‡ å¹»è¯»ï¼šäº‹åŠ¡Aè¯»å–æŸä¸€èŒƒå›´å†…çš„æ•°æ®è¡Œæ—¶ï¼Œäº‹åŠ¡Båœ¨è¯¥èŒƒå›´å†…æ’å…¥æ–°è¡Œï¼Œå½“äº‹åŠ¡Aå†æ¬¡è¯»å–è¯¥èŒƒå›´å†…çš„æ•°æ®æ—¶æ— æ³•æŸ¥è¯¢åˆ°æ–°å¢çš„æ•°æ® å››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š éš”ç¦»çº§åˆ« è„è¯» ä¸å¯é‡å¤è¯» å¹»è¯» è¯»æœªæäº¤ â­• â­• â­• è¯»å·²æäº¤ âŒ â­• â­• å¯é‡å¤è¯» âŒ âŒ â­• å¯ä¸²è¡ŒåŒ– âŒ âŒ âŒ PostgreSQLçš„éš”ç¦»çº§åˆ« åœ¨PostgreSQLä¸­ï¼Œå¯ä»¥è¯·æ±‚ä»¥ä¸Šå››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„ä»»æ„ä¸€ç§ã€‚ä½†æ˜¯åœ¨å†…éƒ¨ï¼Œåªæœ‰ä¸¤ç§ç‹¬ç«‹çš„éš”ç¦»çº§åˆ«ï¼šè¯»å·²æäº¤å’Œå¯ä¸²è¡ŒåŒ–ã€‚å³é€‰æ‹©è¯»æœªæäº¤çš„éš”ç¦»çº§åˆ«ï¼Œå®é™…ç”¨çš„æ˜¯è¯»å·²æäº¤ã€‚ä¸‹é¢ä»‹ç»PostgreSQLå®šä¹‰çš„ä¸¤ç§éš”ç¦»çº§åˆ«ï¼š è¯»å·²æäº¤ï¼šç¼ºçœéš”ç¦»çº§åˆ«ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è¿è¡Œåœ¨è¿™ä¸ªéš”ç¦»çº§åˆ«æ—¶ï¼Œä¸€ä¸ªSELECTæŸ¥è¯¢åªèƒ½çœ‹åˆ°æŸ¥è¯¢å¼€å§‹ä¹‹å‰æäº¤çš„æ•°æ®ã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡åœ¨å¯¹åŒä¸€å…ƒç»„è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡å›æ»šï¼Œåˆ™å¿½ç•¥å…¶ä½œç”¨ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ç»§ç»­æ›´æ–°è¯¥å…ƒç»„ï¼›ç¬¬äºŒä¸ªäº‹åŠ¡åˆ™ç­‰å¾…ç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤æˆ–å›æ»šã€‚å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤ï¼Œç³»ç»Ÿé‡æ–°è®¡ç®—æŸ¥è¯¢æ¡ä»¶ï¼Œå¦‚æœç¬¦åˆåˆ™ç»§ç»­æ›´æ–°æ“ä½œã€‚ å¯ä¸²è¡ŒåŒ–ï¼šæä¾›äº†æœ€ä¸¥æ ¼çš„äº‹åŠ¡éš”ç¦»ã€‚æ¨¡æ‹Ÿä¸²è¡Œçš„äº‹åŠ¡æ‰§è¡Œã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡åœ¨å¯¹åŒä¸€å…ƒç»„è¿›è¡Œæ›´æ–°ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡åˆ™ç­‰å¾…ç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤æˆ–å›æ»šã€‚å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡å›æ»šï¼Œåˆ™å¿½ç•¥å…¶ä½œç”¨ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ç»§ç»­æ›´æ–°è¯¥å…ƒç»„ï¼›å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆå¯ä¸²è¡ŒåŒ–äº‹åŠ¡å›æ»šï¼Œä»å¤´å¼€å§‹è¿›è¡Œæ•´ä¸ªäº‹åŠ¡ã€‚ åœ¨PostgreSQLç³»ç»Ÿä¸­ï¼Œäº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ‰€æ¶‰åŠçš„æœ€å°å¯¹è±¡æ˜¯å…ƒç»„ï¼Œæ‰€ä»¥å¯¹å…ƒç»„çš„æ“ä½œéœ€è¦å®æ–½è®¿é—®æ§åˆ¶ã€‚è¿™ä¸ªæ“ä½œæ˜¯é€šè¿‡é”æ“ä½œä»¥åŠMVCCç›¸å…³çš„æ“ä½œæ¥å®ç°çš„ MVCCæ¶æ„ åœ¨å†…éƒ¨ï¼ŒPostgreSQLåˆ©ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼ŒMultiVersion Concurrency Controlï¼‰æ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚å³å½“æ£€ç´¢æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„åªæ˜¯ä¸€æ®µæ—¶é—´ä¹‹å‰çš„äº‹åŠ¡å¿«ç…§ï¼Œè€Œä¸æ˜¯æ•°æ®çš„å½“å‰çŠ¶æ€ã€‚è¿™æ ·å¯¹æ¯ä¸ªæ•°æ®åº“ä¼šè¯è¿›è¡Œäº‹åŠ¡éš”ç¦»ï¼Œå°±å¯ä»¥é¿å…ä¸€ä¸ªäº‹åŠ¡çœ‹åˆ°å…¶ä»–å¹¶å‘æ—¶çš„æ›´æ–°å¯¼è‡´ä¸ä¸€è‡´çš„æ•°æ® å…ƒç»„ç›¸å…³æ•°æ®ç»“æ„ åœ¨PostgreSQLç³»ç»Ÿä¸­ï¼Œæ›´æ–°æ•°æ®å¹¶ä¸æ˜¯ç”¨æ–°å€¼è¦†ç›–æ—§å€¼ï¼Œè€Œæ˜¯åœ¨è¡¨ä¸­å¼€è¾Ÿä¸€ç‰‡ç©ºé—´æ¥å­˜æ”¾æ–°çš„å…ƒç»„ï¼Œæ–°å€¼ä¸æ—§å€¼åŒæ—¶å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œåªæ˜¯é€šè¿‡è®¾ç½®ä¸€äº›å‚æ•°è®©ç³»ç»Ÿå¯ä»¥è¯†åˆ«ä»–ä»¬ å…ƒç»„çš„äº‹åŠ¡å’Œå‘½ä»¤æ§åˆ¶ä¿¡æ¯å­˜å‚¨åœ¨HeapTupleFieldsä¸­ 1234567891011typedef struct HeapTupleFields&#123; TransactionId t_xmin; // åˆ›å»ºæ­¤tupleçš„XID TransactionId t_xmax; // åˆ é™¤æ­¤tupleçš„XID union &#123; CommandId t_cid; // åˆ›å»ºæˆ–åˆ é™¤tupleçš„CIDï¼Œä¹Ÿå¯èƒ½äºŒè€…éƒ½ä¿å­˜ TransactionId t_xvac; // æ¸…ç†æ“ä½œçš„äº‹åŠ¡ID &#125;t_field3;&#125; HeapTupleFields; å¦‚æœä¸€ä¸ªäº‹åŠ¡ç¡®å®åˆ›å»ºå¹¶åˆ é™¤äº†åŒä¸€ä¸ªå…ƒç»„ï¼Œåˆ™ä½¿ç”¨ä¸€ä¸ªCombo Command ID æ¥ä¿å­˜Cminå’ŒCmax å…ƒç»„çš„ç›¸å…³æ§åˆ¶ä¿¡æ¯å­˜å‚¨åœ¨å…ƒç»„çš„å¤´éƒ¨HeapTupleHeaderDataä¸­ 1234567891011121314struct HeapTupleHeaderData&#123; union &#123; HeapTupleFields t_heap; DatumTupleFields t_datum; &#125; t_choice; ItemPointerData t_ctid; // æœ¬å…ƒç»„æˆ–æ›´æ–°å…ƒç»„çš„å½“å‰TID uint16 t_infomask2; // å±æ€§ã€æ ‡è®°ä½æ•°é‡æ ‡è®°ä½ uint16 t_infomask; // å…ƒç»„äº‹åŠ¡ä¿¡æ¯æ ‡è®°ä½ uint8 t_hoff; // å¤´éƒ¨é•¿åº¦ bits8 t_bits[FLEXIBLE_ARRAY_MEMBER]; // æ ‡è®°ä½œç”¨çš„å¡«å……ä½&#125;; å…¶ä¸­ï¼Œt_ctidå½“å…ƒç»„è¢«ä¿å­˜åœ¨ç£ç›˜ä¸­æ—¶è¢«åˆå§‹åŒ–ä¸ºè‡ªå·±çš„å®é™…å­˜å‚¨ä½ç½®ã€‚å¦‚æœå…ƒç»„è¢«æ›´æ–°ï¼Œt_cidæŒ‡å‘æ›´æ–°åçš„æ–°å…ƒç»„ã€‚å¦‚æœè¦æ‰¾åˆ°æŸä¸ªå…ƒç»„çš„æœ€æ–°ç‰ˆæœ¬ï¼Œåªéœ€éå†ç”±t_ctidæ„æˆçš„é“¾è¡¨å³å¯ t_infomaskå­—æ®µè¡¨ç¤ºå½“å‰å…ƒç»„çš„äº‹åŠ¡ä¿¡æ¯ 1234567891011121314151617181920212223242526#define HEAP_HASNULL 0x0001 // ç©ºå­—æ®µæ ‡è®°ä½#define HEAP_HASVARWIDTH 0x0002 // å˜é•¿å­—æ®µæ ‡è®°ä½#define HEAP_HASEXTERNAL 0x0004 // å¤–éƒ¨å­˜å‚¨å­—æ®µæ ‡è®°ä½#define HEAP_HASOID_OLD 0x0008 // æœ‰OIDå­—æ®µ#define HEAP_XMAX_KEYSHR_LOCK 0x0010 // xmaxæ˜¯å…±äº«é”#define HEAP_COMBOCID 0x0020 // t_cidæ˜¯combo cid#define HEAP_XMAX_EXCL_LOCK 0x0040 // xmaxæ˜¯æ’ä»–é”#define HEAP_XMAX_LOCK_ONLY 0x0080 // xmaxå¦‚æœæœ‰æ•ˆåˆ™åªæ˜¯ä¸€ä¸ªé” // xmax is a shared locker#define HEAP_XMAX_SHR_LOCK (HEAP_XMAX_EXCL_LOCK | HEAP_XMAX_KEYSHR_LOCK)#define HEAP_LOCK_MASK (HEAP_XMAX_SHR_LOCK | HEAP_XMAX_EXCL_LOCK | \\ HEAP_XMAX_KEYSHR_LOCK)#define HEAP_XMIN_COMMITTED 0x0100 // t_xminå·²æäº¤#define HEAP_XMIN_INVALID 0x0200 // t_xminæ— æ•ˆ/ä¸­æ–­#define HEAP_XMIN_FROZEN (HEAP_XMIN_COMMITTED|HEAP_XMIN_INVALID)#define HEAP_XMAX_COMMITTED 0x0400 // t_xmaxå·²æäº¤#define HEAP_XMAX_INVALID 0x0800 // t_xmaxæ— æ•ˆ/ä¸­æ–­#define HEAP_XMAX_IS_MULTI 0x1000 // t_xmaxæ˜¯ç»„åˆäº‹åŠ¡#define HEAP_UPDATED 0x2000 // æ›´æ–°åçš„æ–°å…ƒç»„#define HEAP_MOVED_OFF 0x4000 // è¢«ä¹‹å‰ç‰ˆæœ¬çš„VACUUM FULLç§»åˆ°å…¶ä»–åœ°æ–¹ï¼Œç”¨ä»¥å…¼å®¹äºŒè¿›åˆ¶å‡çº§#define HEAP_MOVED_IN 0x8000 // è¢«ä¹‹å‰ç‰ˆæœ¬çš„VACUUM FULLä»å…¶ä»–åœ°æ–¹ç§»å…¥ï¼Œç”¨ä»¥å…¼å®¹äºŒè¿›åˆ¶å‡çº§#define HEAP_MOVED (HEAP_MOVED_OFF | HEAP_MOVED_IN)#define HEAP_XACT_MASK 0xFFF0 // å¯è§æ€§ç›¸å…³æ ‡è®° MVCC MVCCåŸºæœ¬åŸç†å¦‚å›¾ã€‚æœ‰ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡T1ï¼ŒT2ï¼ŒT1å°†å…ƒç»„Cæ›´æ–°ä¸ºCâ€˜ï¼Œä½†å¹¶æ²¡æœ‰æäº¤ã€‚æ­¤æ—¶T2è¦å¯¹è¯¥å…ƒç»„è¿›è¡ŒæŸ¥è¯¢ï¼Œä¼šé€šè¿‡Cå’ŒCâ€™çš„å¤´éƒ¨ä¿¡æ¯çš„Xminå’ŒXmaxä»¥åŠt_infomaskæ¥åˆ¤æ–­å“ªä¸ªä¸ºå¯¹å½“å‰äº‹åŠ¡çš„æœ‰æ•ˆç‰ˆæœ¬ MVCCä¸å¿«ç…§ è®¨è®ºMVCCçš„åˆ¤æ–­é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å¿«ç…§ï¼ˆsnapshotï¼‰ å¿«ç…§ï¼ˆsnapshotï¼‰è®°å½•äº†æ•°æ®åº“å½“å‰æŸä¸ªæ—¶åˆ»çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼Œé€šè¿‡å¿«ç…§ç¡®å®šæŸä¸ªå…ƒç»„çš„ç‰ˆæœ¬å¯¹äºå½“å‰å¿«ç…§æ˜¯å¦å¯è§ã€‚å¿«ç…§å®šä¹‰åœ¨SnapshotDataä¸­ 123456789101112131415161718192021222324252627282930typedef struct SnapshotData&#123; SnapshotType snapshot_type; // å¿«ç…§ç±»å‹ TransactionId xmin; // æ‰€æœ‰XID &lt; xminå¯¹å½“å‰å¿«ç…§å¯è§ TransactionId xmax; // æ‰€æœ‰XID &gt;= xmaxå¯¹å½“å‰å¿«ç…§å¯è§ TransactionId *xip; // å½“å‰æ´»è·ƒäº‹åŠ¡çš„é“¾è¡¨ uint32 xcnt; // å½“å‰æ´»è·ƒäº‹åŠ¡é“¾è¡¨é•¿åº¦ TransactionId *subxip; // å½“å‰æ´»è·ƒå­äº‹åŠ¡é“¾è¡¨ int32 subxcnt; // å½“å‰æ´»è·ƒå­äº‹åŠ¡é“¾è¡¨çš„é•¿åº¦ bool suboverflowed; // æ´»è·ƒå­äº‹åŠ¡æ•°ç»„æ˜¯å¦ç§»é™¤ bool takenDuringRecovery; // æ˜¯å¦æ˜¯åœ¨Recoveryä¸­çš„å¿«ç…§ bool copied; // é™æ€å¿«ç…§åˆ™ä¸ºfalse CommandId curcid; // æ‰€æœ‰CID &lt; curcidæ˜¯å¯è§çš„ // HeapTupleSatisfiesDirtyä¸­çš„é¢å¤–è¿”å›å€¼ï¼Œå¹¶æ²¡æœ‰åœ¨MVCCå¿«ç…§ä¸­ä½¿ç”¨ uint32 speculativeToken; // ç”±å¿«ç…§ç®¡ç†å™¨ä½¿ç”¨çš„ä¿¡æ¯ uint32 active_count; // åœ¨æ´»è·ƒå¿«ç…§é“¾è¡¨é‡Œçš„å¼•ç”¨è®¡æ•° uint32 regd_count; // åœ¨å·²æ³¨å†Œçš„å¿«ç…§é“¾è¡¨é‡Œçš„å¼•ç”¨è®¡æ•° pairingheap_node ph_node; // å·²æ³¨å†Œçš„å¿«ç…§é“¾è¡¨ TimestampTz whenTaken; // è®°å½•å¿«ç…§çš„æ—¶é—´æˆ³ XLogRecPtr lsn; // è®°å½•å¿«ç…§æ—¶åœ¨WALä¸­çš„ä½ç½®&#125; SnapshotData; åœ¨PostgreSQLä¸­æœ‰é»˜è®¤çš„7ç§å½¢å¼å¿«ç…§ï¼ˆ15.1ï¼‰ï¼Œåˆ†åˆ«æ˜¯ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061typedef enum SnapshotType&#123; // å…ƒç»„å¯¹äºç»™å®šçš„MVCCå¿«ç…§æœ‰æ•ˆ SNAPSHOT_MVCC = 0, // å…ƒç»„å¯¹äºè‡ªèº«æœ‰æ•ˆ SNAPSHOT_SELF, // ä»»ä½•å…ƒç»„éƒ½æ˜¯å¯è§çš„ SNAPSHOT_ANY, // å…ƒç»„ä½œä¸ºTOASTè¡Œ æœ‰æ•ˆ SNAPSHOT_TOAST, // ä¸‹é¢ä¸‰ä¸ªä¸å¤ªå¥½è§£é‡Šï¼Œç›´æ¥è´´åŸæ–‡ /*------------------------------------------------------------------------- * A tuple is visible iff the tuple is valid including effects of open * transactions. * * Here, we consider the effects of: * - all committed and in-progress transactions (as of the current instant) * - previous commands of this transaction * - changes made by the current command * * This is essentially like SNAPSHOT_SELF as far as effects of the current * transaction and committed/aborted xacts are concerned. However, it * also includes the effects of other xacts still in progress. * * A special hack is that when a snapshot of this type is used to * determine tuple visibility, the passed-in snapshot struct is used as an * output argument to return the xids of concurrent xacts that affected * the tuple. snapshot-&gt;xmin is set to the tuple&#x27;s xmin if that is * another transaction that&#x27;s still in progress; or to * InvalidTransactionId if the tuple&#x27;s xmin is committed good, committed * dead, or my own xact. Similarly for snapshot-&gt;xmax and the tuple&#x27;s * xmax. If the tuple was inserted speculatively, meaning that the * inserter might still back down on the insertion without aborting the * whole transaction, the associated token is also returned in * snapshot-&gt;speculativeToken. See also InitDirtySnapshot(). * ------------------------------------------------------------------------- */ SNAPSHOT_DIRTY, /* * A tuple is visible iff it follows the rules of SNAPSHOT_MVCC, but * supports being called in timetravel context (for decoding catalog * contents in the context of logical decoding). */ // å…ƒç»„å¯¹MVCCå¿«ç…§æœ‰æ•ˆï¼Œä¸”æ”¯æŒé€»è¾‘å¤åˆ¶ SNAPSHOT_HISTORIC_MVCC, /* * A tuple is visible iff the tuple might be visible to some transaction; * false if it&#x27;s surely dead to everyone, i.e., vacuumable. * * For visibility checks snapshot-&gt;min must have been set up with the xmin * horizon to use. */ // å…ƒç»„å¯¹æŸäº›äº‹åŠ¡å¯è§ï¼Œå¦‚æœå¯¹æ‰€æœ‰äº‹åŠ¡éƒ½æ˜¯dead tupleï¼Œä¹Ÿå°±æ˜¯vacuumableï¼Œåˆ™è¿”å›false SNAPSHOT_NON_VACUUMABLE&#125; SnapshotType; MVCCæœºåˆ¶çš„å®ç° ä»¥å‡½æ•°HeapTupleSatisfiesSelfä¸ºä¾‹ï¼Œä¸‹é¢ä»‹ç»MVCCæœºåˆ¶çš„å…·ä½“å®ç°ã€‚å¦‚æœè¿”å›å€¼ä¸ºTrueï¼Œåˆ™è¯¥å…ƒç»„æ˜¯å¯è§çš„ã€‚åˆ¤æ–­æ—¶ä¼šè€ƒè™‘ä¸‰ä¸ªæ–¹é¢çš„å› ç´ ï¼šæ‰€æœ‰å·²æäº¤çš„äº‹åŠ¡ï¼Œå½“å‰äº‹åŠ¡å‰çš„æ‰€æœ‰å‘½ä»¤ä»¥åŠå½“å‰å‘½ä»¤å‰çš„æ‰€æœ‰æ“ä½œã€‚æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š æ£€æŸ¥Xminæ˜¯å¦ä¸ºå·²æäº¤ï¼Œå¦‚æœå…ƒç»„çš„Xminè¿˜æœªæäº¤ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465// Xminæœªæäº¤if (!HeapTupleHeaderXminCommitted(tuple))&#123; // Xminæ— æ•ˆï¼Œå…ƒç»„ä¸å¯è§ if (HeapTupleHeaderXminInvalid(tuple)) return false; // å…¼å®¹äºŒè¿›åˆ¶å‡çº§ if (tuple-&gt;t_infomask &amp; HEAP_MOVED_OFF) &#123; ... &#125; // å…¼å®¹äºŒè¿›åˆ¶å‡çº§ else if (tuple-&gt;t_infomask &amp; HEAP_MOVED_IN) &#123; ... &#125; // Xminä¸ºå½“å‰äº‹åŠ¡ else if (TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmin(tuple))) &#123; // Xmaxæ— æ•ˆï¼Œåˆ™XIDæ— æ•ˆï¼Œå¯è§ if (tuple-&gt;t_infomask &amp; HEAP_XMAX_INVALID) return true; // Xmaxè¢«é”å®šï¼Œå³å…ƒç»„è¢«é”å®šï¼Œå¯è§ if (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask)) return true; // Xmaxæ˜¯ç»„åˆäº‹åŠ¡ if (tuple-&gt;t_infomask &amp; HEAP_XMAX_IS_MULTI) &#123; xmax = HeapTupleGetUpdateXid(tuple); // æ›´æ–°å­äº‹åŠ¡å¿…é¡»å·²å›æ»šï¼Œå› ä¸ºå‰ææ˜¯Xminæœªæäº¤ if (!TransactionIdIsCurrentTransactionId(xmax)) return true; else return false; &#125; // Xmaxä¸ºå½“å‰äº‹åŠ¡ if (!TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmax(tuple))) &#123; // åˆ é™¤å­äº‹åŠ¡å¿…é¡»å·²ç»ˆæ­¢ SetHintBits(tuple, buffer, HEAP_XMAX_INVALID, InvalidTransactionId); return true; &#125; return false; &#125; // Xminæ­£åœ¨æŸä¸ªåç«¯è¿›ç¨‹ä¸­è¿è¡Œ else if (TransactionIdIsInProgress(HeapTupleHeaderGetRawXmin(tuple))) return false; // Xminå·²ç»è¢«æäº¤ else if (TransactionIdDidCommit(HeapTupleHeaderGetRawXmin(tuple))) SetHintBits(tuple, buffer, HEAP_XMIN_COMMITTED, HeapTupleHeaderGetRawXmin(tuple)); else &#123; // å¦åˆ™ä¸€å®šæ˜¯ä¸­æ­¢æˆ–å´©æºƒ SetHintBits(tuple, buffer, HEAP_XMIN_INVALID, InvalidTransactionId); return false; &#125;&#125; Xminå·²æäº¤ã€‚å¦‚æœXmaxæ— æ•ˆæˆ–ä¸­æ–­ï¼Œå…ƒç»„å¯è§ 12if (tuple-&gt;t_infomask &amp; HEAP_XMAX_INVALID) return true; Xminå·²æäº¤ï¼ŒXmaxå·²æäº¤ 1234567if (tuple-&gt;t_infomask &amp; HEAP_XMAX_COMMITTED)&#123; // å¦‚æœXmaxè¢«é”å®šï¼Œå¯è§ if (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask)) return true; return false;&#125; Xminå·²æäº¤ï¼ŒXmaxä¸ºç»„åˆäº‹åŠ¡ 12345678910111213141516171819202122if (tuple-&gt;t_infomask &amp; HEAP_XMAX_IS_MULTI)&#123; TransactionId xmax; // Xmaxè¢«é”å®šï¼Œå¯è§ if (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask)) return true; xmax = HeapTupleGetUpdateXid(tuple); // Xmaxæ˜¯å½“å‰äº‹åŠ¡ if (TransactionIdIsCurrentTransactionId(xmax)) return false; // Xmaxæ­£åœ¨è¢«æŸä¸ªåç«¯è¿›ç¨‹æ‰§è¡Œ if (TransactionIdIsInProgress(xmax)) return true; // Xmaxå·²ç»è¢«æäº¤ if (TransactionIdDidCommit(xmax)) return false; // å¦åˆ™äº‹åŠ¡è¢«ä¸­æ–­æˆ–å´©æºƒ return true;&#125; Xminå·²æäº¤ï¼ŒXmaxä¸æ˜¯ç»„åˆäº‹åŠ¡ 12345678910111213141516171819202122232425// Xmaxæ˜¯å½“å‰äº‹åŠ¡if (TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmax(tuple)))&#123; if (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask)) return true; return false;&#125;// Xmaxæ­£åœ¨è¢«æŸä¸ªåç«¯è¿›ç¨‹æ‰§è¡Œif (TransactionIdIsInProgress(HeapTupleHeaderGetRawXmax(tuple))) return true;// Xmaxå·²ç»è¢«æäº¤if (!TransactionIdDidCommit(HeapTupleHeaderGetRawXmax(tuple)))&#123; // it must have aborted or crashed SetHintBits(tuple, buffer, HEAP_XMAX_INVALID, InvalidTransactionId); return true;&#125;// Xmaxè¢«é”å®šif (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))&#123; SetHintBits(tuple, buffer, HEAP_XMAX_INVALID, InvalidTransactionId); return true;&#125; SNAPSHOT_SELFæ‰€å¯¹åº”çš„MVCCåˆ¤æ–­æœºåˆ¶å¦‚ä¸Šï¼Œå…¶ä»–snapshotç±»å‹å¯¹åº”çš„åˆ¤æ–­é€»è¾‘ç±»ä¼¼ï¼Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†","categories":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/categories/PostgreSQL/"}],"tags":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/tags/PostgreSQL/"},{"name":"transaction","slug":"transaction","permalink":"https://spike1337.github.io/tags/transaction/"},{"name":"MVCC","slug":"MVCC","permalink":"https://spike1337.github.io/tags/MVCC/"}]},{"title":"PostgreSQL Â· æºç è§£æ Â· WALæ—¥å¿—","slug":"pg-wal-source-code","date":"2023-02-03T05:44:58.000Z","updated":"2023-08-24T01:54:50.544Z","comments":true,"path":"2023/02/03/pg-wal-source-code/","link":"","permalink":"https://spike1337.github.io/2023/02/03/pg-wal-source-code/","excerpt":"","text":"Postgresql ä½¿ç”¨ wal æ—¥å¿—ä¿å­˜æ¯ä¸€æ¬¡çš„æ•°æ®ä¿®æ”¹ï¼Œè¿™æ ·ä¿è¯äº†æ•°æ®åº“å³ä½¿æ„å¤–å®•æœºï¼Œä¹Ÿèƒ½åˆ©ç”¨å®ƒå‡†ç¡®çš„æ¢å¤æ•°æ®ã€‚wal æ—¥å¿—ä¹Ÿå«åš xlogï¼Œåœ¨ 9.4 ç‰ˆæœ¬ä¹‹åä½œäº†é‡å¤§æ›´æ–°ï¼Œæœ¬ç¯‡åªè®²è§£æœ€æ–°ç‰ˆçš„æ ¼å¼ã€‚wal æ—¥å¿—è¢«ç”¨äºå¤šä¸ªæ–¹é¢ï¼Œæ¯”å¦‚ä¿®æ”¹æ•°æ®ï¼Œä¿®æ”¹ç´¢å¼•ç­‰ï¼Œæ¯ç§ç”¨é€”çš„æ ¼å¼éƒ½ä¸ç›¸åŒï¼Œä½†æ˜¯æ„å»ºæ–¹å¼æ˜¯ç›¸åŒçš„ã€‚ WALæ—¥å¿—æ–‡ä»¶ WALæ®µæ–‡ä»¶ WALæ—¥å¿—æ–‡ä»¶å­˜æ”¾åœ¨sd_walç›®å½•ä¸‹ï¼Œæ¯ä¸ªæ–‡ä»¶å¤§å°é»˜è®¤ä¸º16Mï¼š 1234567-rw------- 1 zhangze zhangze 16777216 Oct 8 10:57 0000000100000000000000B6-rw------- 1 zhangze zhangze 16777216 Oct 8 10:57 0000000100000000000000B7-rw------- 1 zhangze zhangze 16777216 Oct 8 10:57 0000000100000000000000B8-rw------- 1 zhangze zhangze 16777216 Oct 8 10:57 0000000100000000000000B9-rw------- 1 zhangze zhangze 16777216 Oct 8 10:57 0000000100000000000000BA-rw------- 1 zhangze zhangze 16777216 Oct 8 10:57 0000000100000000000000BBdrwx------ 2 zhangze zhangze 68 Oct 8 10:53 archive_status æ–‡ä»¶åç”±16è¿›åˆ¶çš„24ä¸ªå­—ç¬¦ç»„æˆï¼Œæ¯8ä¸ªå­—ç¬¦ä¸ºä¸€ç»„ï¼Œæ¯ç»„æ„ä¹‰å¦‚ä¸‹ï¼š 1200000001 00000000 000000B6 æ—¶é—´çº¿ LogID LogSeg æ—¶é—´çº¿ï¼šæ—¶é—´çº¿IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0xFFFFFFFFã€‚æ•°æ®åº“å»ºå¥½åçš„ç¬¬ä¸€ä¸ªWALæ—¥å¿—æ–‡ä»¶çš„æ—¶é—´çº¿IDä»1å¼€å§‹ LogIDï¼šé€»è¾‘æ–‡ä»¶IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0xFFFFFFFF LogSegï¼šç‰©ç†æ–‡ä»¶IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0x000000FFã€‚æ•°æ®åº“å»ºå¥½åçš„ç¬¬ä¸€ä¸ªWALæ—¥å¿—æ–‡ä»¶çš„LogSegä»1å¼€å§‹ï¼Œè¾¾åˆ°æœ€å¤§å€¼ï¼ˆ0xFFï¼‰åä»0å¼€å§‹ã€‚ LSNå³æ—¥å¿—åºåˆ—å·ï¼Œè¡¨ç¤ºXLogè®°å½•åœ¨äº‹åŠ¡æ—¥å¿—æ–‡ä»¶ä¸­çš„åç§»ï¼Œä¸ºuint64å€¼ã€‚LSNç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯é€»è¾‘æ–‡ä»¶IDï¼Œç‰©ç†æ–‡ä»¶IDå’Œæ–‡ä»¶å†…åç§»é‡ã€‚LSNæ‰“å°å‡ºæ¥æ˜¯ä¸¤ä¸ª8ä½çš„åå…­è¿›åˆ¶æ•°ï¼Œå¦‚16/B374D848ã€‚ç”±ä¸“é—¨çš„ç±»å‹pg_lsnæ¥å­˜æ”¾LSNæ•°æ® PG WALæ–‡ä»¶åå­—çš„å‘½åæ–¹æ³•æ˜¯åœ¨XLogFileNameå®é‡Œå®šä¹‰çš„ã€‚ 1234567891011121314#define XLogSegmentsPerXLogId(wal_segsz_bytes) \\ (UINT64CONST(0x100000000) / (wal_segsz_bytes))#define XLogFileName(fname, tli, logSegNo, wal_segsz_bytes) \\ snprintf(fname, MAXFNAMELEN, &quot;%08X%08X%08X&quot;, tli, \\ (uint32) ((logSegNo) / XLogSegmentsPerXLogId(wal_segsz_bytes)), \\ (uint32) ((logSegNo) % XLogSegmentsPerXLogId(wal_segsz_bytes)))#define XLogFileNameById(fname, tli, log, seg) \\ snprintf(fname, MAXFNAMELEN, &quot;%08X%08X%08X&quot;, tli, log, seg)#define IsXLogFileName(fname) \\ (strlen(fname) == XLOG_FNAME_LEN &amp;&amp; \\ strspn(fname, &quot;0123456789ABCDEF&quot;) == XLOG_FNAME_LEN) WALæ–‡ä»¶å†…éƒ¨ç»“æ„ æ¯ä¸ªWALæ®µæ–‡ä»¶ç”±å¤šä¸ª8kbå¤§å°çš„pageç»„æˆï¼Œæ¯ä¸ªPageä¸­å­˜æ”¾ç€PageHeaderä¿¡æ¯ï¼Œä»¥åŠå¤šæ¡WAL Record Pageç»“æ„ æ¯ä¸ªpageçš„ç»„ç»‡æ–¹å¼å¦‚ä¸‹å›¾ï¼š PageHeaderï¼šåœ¨wal pageçš„ç»„æˆä¸­æœ‰ä¸¤ç§pageheaderç»“æ„ï¼ŒXLogPageHeaderDataå’ŒXLogLongPageHeaderDataã€‚æ¯ä¸ªWALæ®µçš„ç¬¬ä¸€ä¸ªPageçš„Headeråº”ä¸ºLongHeader Remain dataï¼šå­˜å‚¨ç€ä¸Šä¸€ä¸ªpageä¸­æœ€åä¸€ä¸ªRecordæ²¡æœ‰å­˜å®Œçš„æ•°æ®ï¼Œå¤§å°ä¸ºxlp_rem_lenï¼Œå¯¹åº”pageçš„ä¸å®Œæ•´Record Recordï¼šå­˜å‚¨å…·ä½“çš„WAL Record æ— æ•°æ®åŒºåŸŸï¼šä¸€ä¸ªWAL Recordçš„å¤´éƒ¨ä¿¡æ¯ä¸å…è®¸è·¨é¡µï¼Œå¦‚æœå‰©ä½™ç©ºé—´ä¸å¤Ÿå­˜å‚¨å¤´éƒ¨ä¿¡æ¯ï¼Œåˆ™èˆå¼ƒè¿™éƒ¨åˆ†ç©ºé—´ Recordç»“æ„ æ¯ä¸ªWAL Recordçš„ç»“æ„å¦‚ä¸‹å›¾ï¼Œç»¿è‰²éƒ¨åˆ†ä¸ºæ•°æ®æè¿°ç»“æ„ï¼Œé»„è‰²éƒ¨åˆ†æ˜¯å®é™…ä¿å­˜çš„æ•°æ® XLogRecordï¼šä¸€ä¸ªWALè®°å½•çš„å…¥å£ï¼Œè§£æWALæ—¶ï¼Œä»è¿™ä¸ªç»“æ„ä½“å…¥æ‰‹ Blockï¼šç¬¬ä¸€ä¸ªè™šçº¿æ¡†ç§°ä¸ºä¸€ä¸ªBLOCKï¼Œç”¨ä»¥æè¿°Bufferç›¸å…³çš„æ•°æ®ç»“æ„ã€‚é€šè¿‡XLogRegisterBuffer()å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ä¸­ XLogRecordBlockHeaderï¼šä¸€ä¸ªBLOCKçš„å¤´éƒ¨ä¿¡æ¯ XLogRecordBlockImageHeaderï¼šå¦‚æœè¯¥WALæ˜¯fpwè®°å½•ï¼Œè¯¥ç»“æ„å­˜æ”¾fpwç›¸å…³ä¿¡æ¯ fpwï¼šFull_page_writeï¼Œå…·ä½“è§æ•´é¡µå†™å…¥ XLogRecordBlockCompressHeaderï¼šè®°å½•holeçš„å¤§å° holeï¼šæ•°æ®æ–‡ä»¶çš„pageä¸­ï¼Œå¯èƒ½ä¼šæœ‰ä¸€å—ç©ºç™½åŒºåŸŸï¼Œå³pointerå’Œtupleä¹‹é—´çš„åŒºåŸŸï¼Œç§°ä¸ºhole RelFilenodeï¼šæ­¤ç»“æ„è®°å½•äº†æ­¤blockæ‰€å±çš„å…³ç³» BlockNumberï¼šæ­¤blockè®°å½•çš„pageçš„å—å· XLogRecordDataHeader(Long/short)ï¼šå½“main dataçš„å¤§å°å¤§äº255æ—¶ï¼Œä½¿ç”¨Long Header buffer dataï¼šç¬¬äºŒä¸ªè™šçº¿æ¡†éƒ¨åˆ†ï¼ŒåŒ…æ‹¬page dataå’Œtuple data page dataï¼šç”±XLogRegisterBuffer()å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ï¼Œå­˜æ”¾buffer pageä¿¡æ¯ tuple dataï¼šç”±XLogRegisterBufData()å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ï¼Œå­˜å‚¨äº†å®é™…çš„buffæ•°æ®å’Œå˜æ›´æ•°æ®ã€‚ main dataï¼šä¿å­˜ébufferæ€§çš„æ•°æ®ï¼Œç”±XLogRegisterData()å‡½æ•°åˆ°WALè®°å½•ï¼Œä¾‹å¦‚ç‰¹æ®Šç»“æ„ä½“ï¼Œæ—§å…ƒç»„æˆ–key WALæ—¥å¿—å†™å…¥å®ç° å½“æ•°æ®åº“æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼š changeå‘ç”Ÿæ—¶ï¼šå…ˆè¦å°†å˜æ›´åå†…å®¹è®¡å…¥wal bufferä¸­ï¼Œå†å°†å˜æ›´åçš„æ•°æ®å†™å…¥data bufferï¼› commitå‘ç”Ÿæ—¶ï¼šwal bufferä¸­æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ï¼› checkpointå‘ç”Ÿæ—¶ï¼šå°†æ‰€æœ‰data bufferåˆ·æ–°çš„ç£ç›˜ã€‚ WALæ—¥å¿—æœºåˆ¶å°±æ˜¯å…ˆå°†å˜æ›´å†…å®¹å­˜æ”¾åˆ°wal bufferï¼Œcommitåå°†wal bufferåˆ·å…¥ç£ç›˜çš„è¿‡ç¨‹ã€‚è¿‡ç¨‹ä¸­ä¸»è¦çš„å‡½æ•°å¦‚ä¸‹ï¼š 123456789XLogBeginInsert(); // è¡¨ç¤ºå¼€å§‹æ„å»º xlogXLogRegisterData(); // å°†WALè®°å½•çš„ç‰¹æ®Šç»“æ„ä½“æ•°æ®æ³¨å†Œåˆ°WALï¼Œæ¯”å¦‚heap_insertä¸­çš„xl_heap_insertç»“æ„ä½“XLogRegisterBuffer(); // å°†æ¶‰åŠåˆ°çš„bufæ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚heap_insertä¸­pageé¡µèµ‹äºˆregbuf-&gt;pageXLogRegisterBufData(); // å°†å…ƒç»„å†…å®¹æ³¨å†Œåˆ°WALè®°å½•ï¼Œæ¯”å¦‚insertè¯­å¥çš„å…ƒç»„æ•°æ®ç­‰XLogSetRecordFlags();XLogInsert(); XLogRecordAssemble(); XLogInsertRecord(); // æ ¹æ®å½“å‰çš„æ•°æ®åº“çŠ¶æ€ï¼ŒæŠŠä¸Šè¿°å‡½æ•°æ³¨å†Œçš„æ•°æ®è¿›è¡Œç­›é€‰ç»„è£…ï¼Œæœ€ç»ˆå½¢æˆå®Œæ•´çš„walè®°å½•å¹¶å†™å…¥åˆ°walbuffPageSetLSN æ•´é¡µå†™å…¥(Full_Write_Page) å¦‚æœæ•°æ®åº“ç³»ç»Ÿåœ¨å†™å…¥è„é¡µçš„è¿‡ç¨‹ä¸­å‡ºç°æ•…éšœï¼Œä¼šå¯¼è‡´ç£ç›˜ä¸Šçš„é¡µé¢æ•°æ®æŸåï¼Œè€ŒXLOGæ˜¯æ— æ³•åœ¨æŸåçš„é¡µé¢ä¸Šé‡æ”¾çš„ï¼Œéœ€è¦æ•´é¡µå†™å…¥æ¥æ¢å¤ã€‚ å¦‚æœå¯ç”¨æ•´é¡µå†™å…¥ï¼ŒPostgreSQLä¼šåœ¨æ¯ä¸ªæ£€æŸ¥ç‚¹åï¼Œæ¯ä¸ªé¡µé¢ç¬¬ä¸€æ¬¡å˜æ›´å‘ç”Ÿå‰ï¼Œå°†æ•´ä¸ªé¡µé¢ä»¥åŠHeaderä¿¡æ¯ä½œä¸ºä¸€æ¡XLogå†™å…¥ï¼Œè¿™ä¸ªåŠŸèƒ½é»˜è®¤å¼€å¯ã€‚åœ¨æ•°æ®åº“æ¢å¤è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ£€æŸ¥åˆ°ä¸€æ¡XLogæ˜¯ä¸€ä¸ªç”¨æ¥æ•´é¡µå†™å…¥çš„å¤‡ä»½åŒºå—ï¼Œä¼šä½¿ç”¨å¦ä¸€æ¡é‡æ”¾è§„åˆ™ï¼šXLogä¼šç›´æ¥è¦†ç›–å½“å‰é¡µé¢ï¼Œæ— è§†é¡µé¢å’ŒXLogè®°å½•ä¸­çš„LSNï¼Œç„¶åå°†é¡µé¢çš„LSNæ›´æ–°ä¸ºXLogè®°å½•çš„LSN å…·ä½“æ•°æ®ç»“æ„ XLog Page XLogPageHeaderData XLogæ—¥å¿—åˆ†ä¸ºå¾ˆå¤šé€»è¾‘æ®µæ–‡ä»¶ï¼Œæ¯ä¸ªæ®µæ–‡ä»¶åˆ†æˆè®¸å¤šä¸ªé¡µé¢ï¼Œæ¯ä¸ªé¡µé¢çš„å¤§å°ä¸ºä¸€ä¸ªå—çš„å¤§å°ã€‚æ¯ä¸ªæ—¥å¿—é¡µé¢éƒ½æœ‰ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼š 1234567891011typedef struct XLogPageHeaderData&#123; uint16 xlp_magic; // æ ¡éªŒä½ï¼Œæ£€éªŒWALçš„ç‰ˆæœ¬ä¿¡æ¯ uint16 xlp_info; // æ ‡è®°ä½ TimeLineID xlp_tli; // é¡µé¢ç¬¬ä¸€æ¡è®°å½•çš„æ—¶é—´åºåˆ— XLogRecPtr xlp_pageaddr; // XLogé¡µé¢çš„åœ°å€ // å½“å‰é¡µé¢æ²¡æœ‰è¶³å¤Ÿç©ºé—´ç”¨äºè®°å½•æ—¶ï¼Œç»§ç»­åœ¨ä¸‹ä¸€é¡µè®°å½• // è®°å½•äº†å‰ä¸€é¡µçš„å‰©ä½™å­—èŠ‚æ•°ï¼ŒåŒ…æ‹¬å¤‡ä»½å—æ•°æ®ï¼Œå³è¯¥è®°å½•åœ¨æœ¬é¡µç»§ç»­å­˜å‚¨å ç”¨çš„ç©ºé—´å¤§å° uint32 xlp_rem_len;&#125; XLogPageHeaderData; å…¶ä¸­ï¼Œæ ‡è®°ä½xlp_infoåªä½¿ç”¨æœ€ä½ä¸¤ä½ï¼Œ0è¡¨æ˜è¯¥é¡µçš„ç¬¬ä¸€ä¸ªXLogè®°å½•æ¥ç€ä¸Šä¸€é¡µçš„æœ€åä¸€ä¸ªXLogè®°å½•ï¼Œ1è¡¨ç¤ºè¯¥é¡µæ˜¯è¯¥XLogæ–‡ä»¶çš„é¦–é¡µ XLogLongPageHeaderData å¦‚æœé¡µé¢æ˜¯è¯¥æ—¥å¿—æ–‡ä»¶çš„é¦–é¡µï¼Œé‚£ä¹ˆåœ¨åŸå¤´éƒ¨ä¿¡æ¯çš„åŸºç¡€ä¸Šä¼šä½¿ç”¨ä¸€ä¸ªé•¿çš„å¤´éƒ¨ä¿¡æ¯ 1234567typedef struct XLogLongPageHeaderData&#123; XLogPageHeaderData std; // æ ‡å‡†çš„å¤´éƒ¨ä¿¡æ¯ï¼Œå³ XLogPageHeaderData uint64 xlp_sysid; // pg_controlä¸­çš„ç³»ç»Ÿæ ‡è¯†ç¬¦ uint32 xlp_seg_size; // æ ¡éªŒä½ï¼Œæ®µçš„å¤§å° uint32 xlp_XLog_blcksz; // æ ¡éªŒä½ï¼Œå—çš„å¤§å°&#125; XLogLongPageHeaderData; å¯¹äºé•¿çš„XLogæ—¥å¿—è®°å½•ï¼Œå…è®¸å°†æ²¡æœ‰è¶³å¤Ÿç©ºé—´å­˜å‚¨çš„æ•°æ®å­˜å‚¨åˆ°ä¸‹ä¸€ä¸ªé¡µé¢ï¼Œä½†ä¸å…è®¸Recordå¤´éƒ¨ä¿¡æ¯è¢«åˆ†å¼€å­˜å‚¨åˆ°ä¸¤ä¸ªä¸åŒé¡µé¢ã€‚å¦‚æœå‰©ä½™ç©ºé—´å·²ç»ä¸è¶³ä»¥å­˜å‚¨ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼Œé‚£ä¹ˆå‰©ä½™ç©ºé—´å°†è¢«èˆå¼ƒï¼Œå°†è¿™ä¸ªXLogè®°å½•å­˜å‚¨åˆ°æ–°çš„ä¸‹ä¸€ä¸ªé¡µé¢ä¸­ XLog Record XLogRecord ç»“æ„XLogRecordè®°å½•äº†XLogçš„ç›¸å…³æ§åˆ¶ä¿¡æ¯ï¼Œä¸€ä¸ªXLogè®°å½•æœ€å¤šå¯ä»¥é™„3ä¸ªå¤‡ä»½å—ï¼Œ æ¯ä¸ªå—å¯¹åº”ä¸€ä¸ªç£ç›˜å¤§å°çš„æ•°æ®ï¼Œé•¿åº¦ä¸º8kb 12345678910typedef struct XLogRecord&#123; uint32 xl_tot_len; // æ•´æ¡è®°å½•çš„é•¿åº¦ TransactionId xl_xid; // äº‹åŠ¡ID XLogRecPtr xl_prev; // æŒ‡å‘æ—¥å¿—ä¸­çš„å‰ä¸€ä¸ªè®°å½• uint8 xl_info; // ä¿¡æ¯æ ‡è®°ä½ RmgrId xl_rmid; // èµ„æºç®¡ç†å™¨ pg_crc32c xl_crc; // æœ¬è®°å½•çš„CRCæ ¡éªŒç &#125; XLogRecord; å…¶ä¸­ï¼Œèµ„æºç®¡ç†å™¨å·ä¸»è¦ç”¨äºæ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ•°æ®åº“ç³»ç»Ÿéœ€è¦å°†è®°å½•çš„æ—¥å¿—æ•°æ®åˆ†ç±»ï¼Œä¸ºå®ƒä»¬åˆ†é…å¯¹åº”çš„èµ„æºç®¡ç†å™¨å·ã€‚è¯»å–æ—¥å¿—è®°å½•æ—¶ï¼Œç»“åˆèµ„æºç®¡ç†å™¨å·å’Œä¿¡æ¯æ ‡å¿—ä½ï¼Œèƒ½å¤Ÿç›´åˆ°æ•°æ®åº“å¯¹æºæ•°æ®åšçš„æ˜¯å“ªç§æ“ä½œï¼Œä»è€Œè¿…é€Ÿæ­£ç¡®çš„è°ƒç”¨å¯¹åº”çš„å‡½æ•°ã€‚å…±æœ‰16ç§èµ„æº ä¿¡æ¯æ ‡å¿—ä½çš„é«˜4ä½ç”±èµ„æºç®¡ç†å™¨ä½¿ç”¨ï¼Œæ ‡è¯†è¯¥æ—¥å¿—æ˜¯å“ªç§ç±»å‹çš„æ—¥å¿—ã€‚ä½4ä½è¡¨ç¤ºå¯¹åº”çš„å—æ˜¯å¦éœ€è¦å¤‡ä»½ XLogRecordBlockHeader å­˜æ”¾blockçš„ç›¸å…³ä¿¡æ¯ 123456789typedef struct XLogRecordBlockHeader&#123; uint8 id; // å—å¼•ç”¨ID uint8 fork_flags; // åœ¨å…³ç³»ä¸­ä½¿ç”¨çš„forkå’Œflags uint16 data_length; // payloadå­—èŠ‚å¤§å° //å¦‚æœè®¾ç½®äº† BKPBLOCK_HAS_IMAGE,åç»­ä¸ºXLogRecordBlockImageHeaderç»“æ„ä½“ï¼Œå¦åˆ™ä¸ºRelFileNode //ä¹‹åä¸ºBlockNumber&#125; XLogRecordBlockHeader; XLogRecordBlockImageHeader å­˜æ”¾æ•´é¡µå†™å…¥çš„ç›¸å…³ä¿¡æ¯ 123456typedef struct XLogRecordBlockImageHeader&#123; uint16 length; // pageå¤§å° uint16 hole_offset; // holeä¹‹å‰çš„é•¿åº¦ uint8 bimg_info; // æ ‡è®°ä½ï¼Œæ˜¯å¦å‹ç¼©&#125; XLogRecordBlockImageHeader; XLogRecordBlockCompressHeader å­˜æ”¾pageä¸­çš„holeå¤§å° 1234typedef struct XLogRecordBlockCompressHeader&#123; uint16 hole_length; // holeå¤§å°&#125; XLogRecordBlockCompressHeader; XLog Data XLogRecordDataHeader WAL Recordçš„æ•°æ®éƒ¨åˆ†çš„headerä¿¡æ¯ 12345678910typedef struct XLogRecordDataHeaderShort&#123; uint8 id; uint8 data_length;&#125;XLogRecordDataHeaderShort;typedef struct XLogRecordDataHeaderLong&#123; uint8 id;&#125;XLogRecordDataHeaderLong; XLogRecData XLogæ—¥å¿—è®°å½•ä¸­çš„æ•°æ®ä¿¡æ¯å­˜å‚¨åœ¨ç»“æ„XLogRecDataä¸­ 123456typedef struct XLogRecData&#123; struct XLogRecData *next; // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ char *data; // æ•°æ® uint32 len; // æ•°æ®é•¿åº¦&#125; XLogRecData; XLogæ§åˆ¶ç»“æ„ XLogCtlData åœ¨å…±äº«å†…å­˜ä¸­ç”¨ç»“æ„XLogCtlDataä¿å­˜XLogä¿¡æ¯ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970typedef struct XLogCtlData&#123; XLogCtlInsert Insert; // æ’å…¥ä¸€æ¡æ—¥å¿—åï¼Œæœ€æ–°çš„ç›¸å…³ä¿¡æ¯ // ä»¥ä¸‹å—info_lckä¿æŠ¤ XLogwrtRqst LogwrtRqst; // å°†æ—¥å¿—å†™å…¥å’ŒåŒæ­¥çš„ä½ç½® XLogRecPtr RedoRecPtr; // æœ€è¿‘çš„ Insert-&gt;RedoRecPtr å‰¯æœ¬ FullTransactionId ckptFullXid; // æœ€æ–°æ£€æŸ¥ç‚¹çš„nextXID XLogRecPtr asyncXactLSN; // æœ€æ–°å¼‚æ­¥æäº¤/ä¸­æ–­çš„LSN XLogRecPtr replicationSlotMinLSN; // æ‰€æœ‰ç¼“å†²åŒºæ‰€éœ€çš„æœ€è€çš„LSN XLogSegNo lastRemovedSegNo; // æœ€åçš„åˆ é™¤/å›æ”¶çš„XLogæ®µ // ç”¨äºä¸éœ€è¦è®°å½•æ—¥å¿—çš„å…³ç³»çš„å‡çš„LSN XLogRecPtr unloggedLSN; slock_t ulsn_lck; // åˆ‡æ¢åæœ€æ–°çš„XLogçš„æ—¶é—´å’ŒLSNï¼Œå—XLogWriteLockä¿æŠ¤ pg_time_t lastSegSwitchTime; XLogRecPtr lastSegSwitchLSN; // å·²ç»å†™å…¥å’ŒåŒæ­¥çš„ä½ç½®ï¼Œå—info_lckæˆ–XLogWriteLockä¿æŠ¤ XLogwrtResult LogwrtResult; // ç¼“å­˜ä¸­çš„æœ€ååˆå§‹åŒ–é¡µé¢ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚ä½ç½®+1 XLogRecPtr InitializedUpTo; // è¿™äº›å€¼åœ¨å¯åŠ¨åä¸ä¼šä¿®æ”¹ï¼Œå°½ç®¡æŒ‡å‘çš„é¡µé¢å’Œxlblocksé€šå¸¸ä¼šæ”¹å˜ // xlblockså— XLogBufMappingLock ä¿æŠ¤ char *pages; // æœªå†™å…¥XLogé¡µé¢çš„ç¼“å†²åŒº XLogRecPtr *xlblocks; // ç¼“å†²åŒºå†…å®¹å¯¹åº”çš„XLogæ–‡ä»¶çš„å†…éƒ¨æŒ‡é’ˆ int XLogCacheBlck; // XLogæœ€å¤§ç¼“å†²åŒºçš„ä¸‹æ ‡ // ThisTimeLineID çš„å…±äº«å‰¯æœ¬ï¼Œåœ¨å®Œæˆæ¢å¤åä¸è¦ä¿®æ”¹ TimeLineID ThisTimeLineID; TimeLineID PrevTimeLineID; // æ ‡è®°æˆ‘ä»¬æ˜¯å¦å¤„äºå´©æºƒæˆ–æ¢å¤çŠ¶æ€ï¼Œå—info_lockä¿æŠ¤ RecoveryState SharedRecoveryState; bool SharedHotStandbyActive; // æŒ‡ç¤ºXLogå†™å…¥æ˜¯å¦å¤„äºèŠ‚èƒ½æ¨¡å¼ï¼Œå—info_lockä¿æŠ¤ bool XLogWriterSleeping; // ç­‰å¾…å”¤é†’ï¼Œå¦‚æœå‡ºç°å‡ºå‘æ–‡ä»¶ï¼Œåˆ™å”¤é†’å¯åŠ¨è¿›ç¨‹ä»¥ç»§ç»­æ‰§è¡ŒXLogé‡æ”¾ Latch recoveryWakeupLatch; // åœ¨æ¢å¤æœŸé—´ä¿ç•™æœ€åæ£€æŸ¥ç‚¹è®°å½•çš„å‰¯æœ¬ï¼Œå—info_lckä¿æŠ¤ XLogRecPtr lastCheckPointRecPtr; XLogRecPtr lastCheckPointEndPtr; CheckPoint lastCheckPoint; XLogRecPtr lastReplayedEndRecPtr; // æŒ‡å‘æˆåŠŸé‡æ”¾çš„æœ€åä¸€æ¡è®°å½•çš„ç»“å°¾+1 TimeLineID lastReplayedTLI; XLogRecPtr replayEndRecPtr; // å¦‚æœæ­£å¤„äºredoå‡½æ•°å›æ”¾è®°å½•æœŸé—´ï¼Œåˆ™æŒ‡å‘æ­£åœ¨æ¢å¤è®°å½•çš„ç»“å°¾+1 // å¦åˆ™ç­‰äºlastReplayedEndRecPtr TimeLineID replayEndTLI; TimestampTz recoveryLastXTime; // é‡æ”¾ï¼ˆæ­£åœ¨é‡æ”¾ï¼‰çš„æœ€åä¸€ä¸ªCOMMIT/ABORTè®°å½•çš„æ—¶é—´æˆ³ // å¼€å§‹é‡æ”¾å½“å‰XLogæ•°æ®å—çš„æ—¶é—´æˆ³ TimestampTz currentChunkStartTime; bool recoveryPause; // æ˜¯å¦æš‚åœæ¢å¤ // æŒ‡å‘æœ€åé‡æ”¾çš„XLog_FPW_CHANGEè®°å½•çš„èµ·å§‹ç‚¹ // ç”¨äºç¦ç”¨full_page_writes XLogRecPtr lastFpwDisableRecPtr; slock_t info_lck; // å…±äº«é”&#125; XLogCtlData; Register_buffer 1234567891011121314151617typedef struct&#123; bool in_use; // is this slot in use? uint8 flags; // REGBUF_* flags RelFileNode rnode; // æŒ‡å®šæ‰€å±è¡¨çš„å­˜å‚¨ç›®å½• ForkNumber forkno; // å“ªç§æ–‡ä»¶ç±»å‹ BlockNumber block; // å—ç¼–å· Page page; // å¯¹åº”çš„åŸå§‹æ•°æ®é¡µ uint32 rdata_len; // ç§æœ‰æ•°æ®é“¾è¡¨çš„é•¿åº¦æ€»å’Œ XLogRecData *rdata_head; // ç§æœ‰æ•°æ®é“¾è¡¨å¤´éƒ¨èŠ‚ç‚¹ XLogRecData *rdata_tail; // ç§æœ‰æ•°æ®é“¾è¡¨å°¾éƒ¨èŠ‚ç‚¹ XLogRecData bkp_rdatas[2]; // å­˜å‚¨ç€å‹ç¼©åæˆ–å¿½ç•¥ç©ºé—²æ•°æ®çš„æ•°æ®ï¼Œå¦‚æœæœ‰ç©ºé—²ä½ç½®ä¸”æ²¡æœ‰å‹ç¼©ï¼Œé‚£ä¹ˆæ•°æ®ä¼šè¢«åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œå­˜å‚¨åœ¨ä¸¤ä¸ªæ•°ç»„å…ƒç´ é‡Œ char compressed_page[PGLZ_MAX_BLCKSZ]; // å¦‚æœå¼€å¯äº†å‹ç¼©ï¼Œé‚£ä¹ˆå­˜å‚¨ç€å‹ç¼©åçš„æ•°æ®&#125; registered_buffer; é‡è¦å…¨å±€å˜é‡ 1234567891011121314static XLogRecData *mainrdata_head;static XLogRecData *mainrdata_last = (XLogRecData *) &amp;mainrdata_head;/*ä½¿ç”¨XLogRegisterBufferæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°registered_buffersæ•°ç»„é‡Œ*/static registered_buffer *registered_buffers;/* * ä½¿ç”¨XLogRegisterBufDataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œå¹¶é“¾æ¥ä¸ºé“¾è¡¨ï¼Œä½¿ç”¨registered_bufferç»“æ„é‡Œçš„rdata_headå’Œ * rdata_tailä½œä¸ºé“¾è¡¨çš„é¦–å°¾ã€‚ * * ä½¿ç”¨XLogRegisterDataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œå¹¶ä½¿ç”¨mainrdata_headå’Œmainrdata_lastataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œ * å¹¶é“¾æ¥ä¸ºé“¾è¡¨ï¼Œä½¿ç”¨registered_bufferç»“æ„é‡Œçš„rdata_headå’Œrdata_tailä½œä¸ºé“¾è¡¨çš„é¦–å°¾ã€‚ */static XLogRecData *rdatas; å…·ä½“å‡½æ•°ä»£ç  XLogBeginInsert å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯æ£€éªŒè°ƒç”¨ç¯å¢ƒæ˜¯å¦æ­£ç¡®ï¼Œåˆ¤æ–­å½“å‰æ˜¯å¦å¯ä»¥æ‰§è¡Œxlogæ’å…¥ï¼Œå¹¶è®¾ç½®å¼€å§‹æ„é€ WALè®°å½•çš„æ ‡è®°ï¼Œæ ‡å¿—walæ’å…¥å¼€å§‹ã€‚ 1234567891011Assert(max_registered_block_id == 0);Assert(mainrdata_last == (XLogRecData *) &amp;mainrdata_head);Assert(mainrdata_len == 0);if (!XLogInsertAllowed()) elog(ERROR, &quot;cannot make new WAL entries during recovery&quot;);if (begininsert_called) elog(ERROR, &quot;XLogBeginInsert was already called&quot;);begininsert_called = true; XLogRegisterData å°†æœ¬æ¡walè®°å½•çš„ç‰¹æ®Šç»“æ„ä½“æ•°æ®æ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚XLOG_HEAP_INSERTå­ç±»å‹çš„xl_heap_insertç»“æ„ä½“ã€‚ å°†ä¸€äº›æ—§å…ƒç»„æ•°æ®æ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚æ‰§è¡Œupdateè¯­å¥çš„æ—§å…ƒç»„æ•°æ®ã€deleteè¯­å¥çš„æ—§å…ƒç»„æ•°æ®ã€‚ 12345678910111213141516// æ£€æŸ¥æ˜¯å¦å·²ç»å¼€å§‹æ„é€ WALAssert(begininsert_called);// æ£€æŸ¥æ•°æ®é‡æ˜¯å¦è¶…è¿‡é™åˆ¶å€¼if (num_rdatas &gt;= max_rdatas) elog(ERROR, &quot;too much WAL data&quot;);rdata = &amp;rdatas[num_rdatas++];rdata-&gt;data = data;rdata-&gt;len = len;// ä½¿ç”¨ mainrdata_last æŒ‡é’ˆè·Ÿè¸ªé“¾æ¡çš„ç»“æŸç‚¹,åœ¨è¿™é‡Œä¸éœ€è¦æ¸…é™¤nextå˜é‡mainrdata_last-&gt;next = rdata;mainrdata_last = rdata;mainrdata_len += len; XLogRegisterBuffer å°†æ¶‰åŠåˆ°çš„buffæ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚insertè¯­å¥çš„ç›®æ ‡buffã€updateè¯­å¥çš„ç›®æ ‡buffå’Œæºbuff 12345678910111213141516171819// æ‰¾åˆ°registered_bufferæ•°ç»„ä¸­ç¬¬ä¸€ä¸ªç©ºçš„çš„ä½ç½®if (block_id &gt;= max_registered_block_id)&#123; if (block_id &gt;= max_registered_buffers) elog(ERROR, &quot;too many registered buffers&quot;); max_registered_block_id = block_id + 1;&#125;// å°†è¿™ä¸ªbufferçš„æ•°æ®å¡«å……regbuf = &amp;registered_buffers[block_id];BufferGetTag(buffer, &amp;regbuf-&gt;rnode, &amp;regbuf-&gt;forkno, &amp;regbuf-&gt;block);regbuf-&gt;page = BufferGetPage(buffer);regbuf-&gt;flags = flags;regbuf-&gt;rdata_tail = (XLogRecData *) &amp;regbuf-&gt;rdata_head;regbuf-&gt;rdata_len = 0;// å°†ç¼“å†²åŒºæ ‡è®°ä¸ºå·²ä½¿ç”¨regbuf-&gt;in_use = true; XLogRegisterBufData å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯å°†å…ƒç»„å†…å®¹æ³¨å†Œåˆ°WALè®°å½•ä¸­ã€‚éœ€è¦å‚æ•°block idï¼Œè¿™ä¸ªidå¿…é¡»æ˜¯å·²ç»é€šè¿‡XLogRegisterBufferæ³¨å†Œçš„block 1234567891011121314151617// è¯»å–å·²ç»æ³¨å†Œçš„ç¼“å†²åŒºç»“æ„regbuf = &amp;registered_buffers[block_id];if (!regbuf-&gt;in_use) elog(ERROR, &quot;no block with id %d registered with WAL insertion&quot;, block_id);// è¯»å–bufferæ•°æ®if (num_rdatas &gt;= max_rdatas) elog(ERROR, &quot;too much WAL data&quot;);rdata = &amp;rdatas[num_rdatas++];rdata-&gt;data = data;rdata-&gt;len = len;regbuf-&gt;rdata_tail-&gt;next = rdata;regbuf-&gt;rdata_tail = rdata;regbuf-&gt;rdata_len += len; XLogInsert æ’å…¥WALçš„æ“ä½œç”±å‡½æ•°XLogInsertå®Œæˆï¼Œæ ¹æ®Rdataé“¾è¡¨å’Œç›¸åº”çš„èµ„æºç®¡ç†å™¨infoå‘WALæ—¥å¿—æ–‡ä»¶ä¸­æ’å…¥ä¸€æ¡WALè®°å½•ã€‚äº‹åŠ¡æ‰§è¡Œæ’å…¥ï¼Œåˆ é™¤ï¼Œæ›´æ–°ï¼Œæäº¤ï¼Œç»ˆæ­¢æˆ–å›æ»šå‘½ä»¤æ—¶éƒ½éœ€è¦è°ƒç”¨æ­¤å‡½æ•° åˆ¤æ–­è°ƒç”¨æ—¶æ˜¯å¦è®¾ç½®äº†rmgræ ‡è®°ä½ï¼š 1234if ((info &amp; ~(XLR_RMGR_INFO_MASK | XLR_SPECIAL_REL_UPDATE | XLR_CHECK_CONSISTENCY)) != 0) elog(PANIC, &quot;invalid xlog info mask %02X&quot;, info); å¦‚æœå¤„äºbootstrapæ¨¡å¼ï¼Œé™¤äº†XLogèµ„æºå¤–ï¼Œä¸éœ€è¦å®é™…è®°å½•å†…å®¹ï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªæ£€æŸ¥ç‚¹çš„æŒ‡é’ˆ 123456if (IsBootstrapProcessingMode() &amp;&amp; rmid != RM_XLog_ID)&#123; XLogResetInsertion(); EndPos = SizeOfXLogLongPHD; return EndPos;&#125; ç»„åˆæˆå®Œæ•´çš„WALè®°å½•å¹¶å†™å…¥WALæ—¥å¿— 12345678910111213141516do&#123; XLogRecPtr RedoRecPtr; bool doPageWrites; XLogRecPtr fpw_lsn; XLogRecData *rdt; GetFullPageWriteInfo(&amp;RedoRecPtr, &amp;doPageWrites); // è°ƒç”¨å‡½æ•°ç»„è£…æ³¨å†Œçš„æ•°æ® rdt = XLogRecordAssemble(rmid, info, RedoRecPtr, doPageWrites, &amp;fpw_lsn); // å°†ç»„è£…å¥½çš„æ•°æ®å†™å…¥åˆ°WALå†…å­˜ä¸­ EndPos = XLogInsertRecord(rdt, fpw_lsn, curinsert_flags);&#125; while (EndPos == InvalidXLogRecPtr); XLogRecordAssemble å‡½æ•°ç”¨äºå°†å·²æ³¨å†Œçš„æ•°æ®å’Œç¼“å†²åŒºé¡µé¢æ•°æ®ç»„è£…æˆä¸€æ¡WALè®°å½•ï¼Œå°†å…¶å†™å…¥åˆ°XLogRecDataé“¾è¡¨ä¸­ã€‚ æ‰§è¡Œåˆ°è¿™ä¸ªé˜¶æ®µï¼Œwalè®°å½•çš„æ•°æ®å­˜å‚¨åœ¨ï¼š mainrdata_head æ¯ä¸€ä¸ªæ³¨å†Œçš„buffçš„rdata_head æ¯ä¸€ä¸ªæ³¨å†Œçš„buffçš„pageå­—æ®µä¸­ å‡½æ•°æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š ä¿å­˜å¤´éƒ¨ä¿¡æ¯ 123456789101112131415XLogRecData *rdt; // XLogRecDataé“¾è¡¨æŒ‡é’ˆuint32 total_len = 0;int block_id;pg_crc32c rdata_crc;registered_buffer *prev_regbuf = NULL;XLogRecData *rdt_datas_last;XLogRecord *rechdr;char *scratch = hdr_scratch;rechdr = (XLogRecord *) scratch;scratch += SizeOfXLogRecord;hdr_rdt.next = NULL;rdt_datas_last = &amp;hdr_rdt;hdr_rdt.data = hdr_scratch; æ„é€ ä¿å­˜æ‰€æœ‰å—å…¬ç”¨çš„æ•°æ®éƒ¨åˆ†çš„rdataé“¾ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166*fpw_lsn = InvalidXLogRecPtr;for (block_id = 0; block_id &lt; max_registered_block_id; block_id++)&#123; registered_buffer *regbuf = &amp;registered_buffers[block_id]; XLogRecordBlockHeader bkpb; XLogRecordBlockImageHeader bimg; XLogRecordBlockCompressHeader cbimg = &#123;0&#125;; bool samerel; bool is_compressed = false; bool include_image; // è®¾ç½®blockå¤´éƒ¨ä¿¡æ¯ bkpb.id = block_id; bkpb.fork_flags = regbuf-&gt;forkno; bkpb.data_length = 0; // è®¾ç½®æ ‡è®°ä½ if ((regbuf-&gt;flags &amp; REGBUF_WILL_INIT) == REGBUF_WILL_INIT) bkpb.fork_flags |= BKPBLOCK_WILL_INIT; // æ‰§è¡Œfull_page_writeï¼Œå†™å…¥XLogRecordBlockImageHeader if (include_image) &#123; Page page = regbuf-&gt;page; // è·å–å¯¹åº”çš„page uint16 compressed_len = 0; // å‹ç¼©åçš„å¤§å° // pageéœ€è¦å¤‡ä»½ï¼Œè®¡ç®—ç©ºé—²ç©ºé—´å¤§å°å’Œåç§» // &quot;hole&quot;æŒ‡çš„æ˜¯pageä¸­çš„ç©ºç™½åŒºåŸŸ if (regbuf-&gt;flags &amp; REGBUF_STANDARD) &#123; // å¦‚æœé¡µé¢éµå¾ªæ ‡å‡†å¸ƒå±€ï¼Œlowerå’ŒupperæŒ‡é’ˆå°†è¢«è·³è¿‡ uint16 lower = ((PageHeader) page)-&gt;pd_lower; // è·å–lower uint16 upper = ((PageHeader) page)-&gt;pd_upper; // è·å–upper // åˆ¤æ–­pageä¸­æ˜¯å¦å­˜åœ¨&quot;hole&quot; if (lower &gt;= SizeOfPageHeaderData &amp;&amp; upper &gt; lower &amp;&amp; upper &lt;= BLCKSZ) &#123; // è®¡ç®—â€œholeâ€çš„é•¿åº¦çš„åç§»é‡ bimg.hole_offset = lower; cbimg.hole_length = upper - lower; &#125; else &#123; // æ²¡æœ‰å¯ä»¥ç§»é™¤çš„&quot;hole&quot; bimg.hole_offset = 0; cbimg.hole_length = 0; &#125; &#125; else &#123; // ä¸æ˜¯æ ‡å‡†çš„é¡µé¢å¸ƒå±€ï¼Œæ— æ³•å°è¯•ä¼°ç®—&quot;hole&quot; bimg.hole_offset = 0; cbimg.hole_length = 0; &#125; // å¯ç”¨WALå‹ç¼© if (wal_compression) &#123; is_compressed = XLogCompressBackupBlock(page, bimg.hole_offset, cbimg.hole_length, regbuf-&gt;compressed_page, &amp;compressed_len); // è°ƒç”¨XLogCompressBackupBlockå‹ç¼© &#125; // å¡«å……XLogRecordBlockHeaderç»“æ„ä½“çš„å‰©ä½™å­—æ®µ bkpb.fork_flags |= BKPBLOCK_HAS_IMAGE; // ä¸ºpageå†…å®¹æ„é€ XLogRecDataå…¥å£ rdt_datas_last-&gt;next = &amp;regbuf-&gt;bkp_rdatas[0]; rdt_datas_last = rdt_datas_last-&gt;next; // è®¾ç½®æ ‡è®° bimg.bimg_info = (cbimg.hole_length == 0) ? 0 : BKPIMAGE_HAS_HOLE; // åœ¨redoæœŸé—´,åœ¨è®¾ç½®äº†BKPIMAGE_APPLYæ ‡è®°çš„æƒ…å†µä¸‹full-pageæ‰ä¼šå›æ”¾. if (needs_backup) bimg.bimg_info |= BKPIMAGE_APPLY; // éœ€è¦å‹ç¼© if (is_compressed) &#123; bimg.length = compressed_len; // å‹ç¼©åçš„ç©ºé—´ bimg.bimg_info |= BKPIMAGE_IS_COMPRESSED; // å‹ç¼©æ ‡è®° rdt_datas_last-&gt;data = regbuf-&gt;compressed_page; // æ”¾åœ¨registered_bufferä¸­ rdt_datas_last-&gt;len = compressed_len; &#125; else &#123; // æ²¡æœ‰å‹ç¼©ï¼Œè®¡ç®—imageçš„å¤§å° bimg.length = BLCKSZ - cbimg.hole_length; // å¦‚æœæ²¡æœ‰&quot;hole&quot;å­˜åœ¨ if (cbimg.hole_length == 0) &#123; rdt_datas_last-&gt;data = page; // æ•°æ®æŒ‡é’ˆç›´æ¥æŒ‡å‘page rdt_datas_last-&gt;len = BLCKSZ; // å¤§å°ä¸ºblock size &#125; else &#123; // è·³è¿‡hole rdt_datas_last-&gt;data = page; // æ•°æ®æŒ‡é’ˆ rdt_datas_last-&gt;len = bimg.hole_offset;// è·å–holeçš„åç§» rdt_datas_last-&gt;next = &amp;regbuf-&gt;bkp_rdatas[1];// ç¬¬2éƒ¨åˆ† rdt_datas_last = rdt_datas_last-&gt;next; rdt_datas_last-&gt;data = page + (bimg.hole_offset + cbimg.hole_length);// æŒ‡é’ˆæŒ‡å‘ç¬¬äºŒéƒ¨åˆ† rdt_datas_last-&gt;len = BLCKSZ - (bimg.hole_offset + cbimg.hole_length);// è®¾ç½®é•¿åº¦ &#125; &#125; total_len += bimg.length; // è°ƒæ•´æ€»é•¿åº¦ &#125; // å¦‚æœéœ€è¦åŒ…å«æ•°æ® if (needs_data) &#123; // æŠŠè¯¥ç¼“å†²åŒºé“¾æ¥åˆ°è°ƒç”¨è€…æä¾›çš„rdataé“¾ä¸­ï¼Œæ„æˆä¸€ä¸ªæ•´ä½“çš„é“¾è¡¨ bkpb.fork_flags |= BKPBLOCK_HAS_DATA; bkpb.data_length = regbuf-&gt;rdata_len; total_len += regbuf-&gt;rdata_len; rdt_datas_last-&gt;next = regbuf-&gt;rdata_head; rdt_datas_last = regbuf-&gt;rdata_tail; &#125; // å¦‚æœå­˜åœ¨ä¸Šä¸€ä¸ªæ³¨å†Œçš„bufï¼Œè€Œä¸”RefFileNodeç›¸åŒ if (prev_regbuf &amp;&amp; RelFileNodeEquals(regbuf-&gt;rnode, prev_regbuf-&gt;rnode)) &#123; samerel = true; bkpb.fork_flags |= BKPBLOCK_SAME_REL; &#125; else samerel = false; // åˆ‡æ¢ä¸ºå½“å‰çš„æ³¨å†Œçš„buf prev_regbuf = regbuf; // æ‹·è´å¤´éƒ¨ä¿¡æ¯åˆ°scratchç¼“å†²åŒºä¸­ memcpy(scratch, &amp;bkpb, SizeOfXLogRecordBlockHeader); scratch += SizeOfXLogRecordBlockHeader; if (include_image) &#123; memcpy(scratch, &amp;bimg, SizeOfXLogRecordBlockImageHeader); scratch += SizeOfXLogRecordBlockImageHeader; // å‹ç¼©å­˜å‚¨,è¿½åŠ SizeOfXLogRecordBlockCompressHeader if (cbimg.hole_length != 0 &amp;&amp; is_compressed) &#123; memcpy(scratch, &amp;cbimg, SizeOfXLogRecordBlockCompressHeader); scratch += SizeOfXLogRecordBlockCompressHeader; &#125; &#125; // ä¸æ˜¯åŒä¸€ä¸ªRELï¼Œè¿½åŠ RelFileNode if (!samerel) &#123; memcpy(scratch, &amp;regbuf-&gt;rnode, sizeof(RelFileNode)); scratch += sizeof(RelFileNode); &#125; // è¿½åŠ BlockNumber memcpy(scratch, &amp;regbuf-&gt;block, sizeof(BlockNumber)); scratch += sizeof(BlockNumber);&#125; æ¥ä¸‹æ¥ç»„è£…XLog Record originæ ‡è®° 1234567if ((curinsert_flags &amp; XLog_INCLUDE_ORIGIN) &amp;&amp; replorigin_session_origin != InvalidRepOriginId)&#123; *(scratch++) = (char) XLR_BLOCK_ID_ORIGIN; memcpy(scratch, &amp;replorigin_session_origin, sizeof(replorigin_session_origin)); scratch += sizeof(replorigin_session_origin);&#125; æ¥ä¸‹æ¥ç»„è£…æ•°æ®ï¼ˆmain dataï¼‰ 12345678910111213141516171819202122if (mainrdata_len &gt; 0)&#123; // é•¿åº¦è¶…è¿‡255ï¼Œåˆ™ä½¿ç”¨Longæ ¼å¼ if (mainrdata_len &gt; 255) &#123; *(scratch++) = (char) XLR_BLOCK_ID_DATA_LONG; memcpy(scratch, &amp;mainrdata_len, sizeof(uint32)); scratch += sizeof(uint32); &#125; else &#123; *(scratch++) = (char) XLR_BLOCK_ID_DATA_SHORT; *(scratch++) = (uint8) mainrdata_len; &#125; rdt_datas_last-&gt;next = mainrdata_head; rdt_datas_last = mainrdata_last; total_len += mainrdata_len;&#125;rdt_datas_last-&gt;next = NULL;hdr_rdt.len = (scratch - hdr_scratch); // å¤´éƒ¨å¤§å°total_len += hdr_rdt.len; // æ€»é•¿åº¦ è®¡ç®—æ•°æ®çš„CRC 1234INIT_CRC32C(rdata_crc);COMP_CRC32C(rdata_crc, hdr_scratch + SizeOfXLogRecord, hdr_rdt.len - SizeOfXLogRecord);for (rdt = hdr_rdt.next; rdt != NULL; rdt = rdt-&gt;next) COMP_CRC32C(rdata_crc, rdt-&gt;data, rdt-&gt;len); æœ€åå¡«å……è®°å½•å¤´éƒ¨ä¿¡æ¯çš„å…¶ä»–åŸŸå­—æ®µ 12345678rechdr-&gt;xl_xid = GetCurrentTransactionIdIfAny();rechdr-&gt;xl_tot_len = total_len;rechdr-&gt;xl_info = info;rechdr-&gt;xl_rmid = rmid;rechdr-&gt;xl_prev = InvalidXLogRecPtr;rechdr-&gt;xl_crc = rdata_crc;return &amp;hdr_rdt; XLogInsertRecord å°†XLogRecordAssembleç»„è£…å¥½çš„è®°å½•æ’å…¥åˆ°WALå†…å­˜ä¸­ã€‚è¿‡ç¨‹åˆ†ä¸¤æ­¥ï¼š åœ¨å†…å­˜ä¸­ä¸ºWALè®°å½•ä¿ç•™è¶³å¤Ÿçš„ç©ºé—´ 12345678if (isLogSwitch) inserted = ReserveXLogSwitch(&amp;StartPos, &amp;EndPos, &amp;rechdr-&gt;xl_prev);else&#123; ReserveXLogInsertLocation(rechdr-&gt;xl_tot_len, &amp;StartPos, &amp;EndPos, &amp;rechdr-&gt;xl_prev); inserted = true;&#125; å°†è®°å½•å¤åˆ¶åˆ°WALå†…å­˜ä¸­ 1234567891011121314151617181920if (inserted)&#123; // è®¡ç®—å¤´éƒ¨çš„CRC rdata_crc = rechdr-&gt;xl_crc; COMP_CRC32C(rdata_crc, rechdr, offsetof(XLogRecord, xl_crc)); FIN_CRC32C(rdata_crc); rechdr-&gt;xl_crc = rdata_crc; // æ‰€æœ‰çš„æ•°æ®ï¼ŒåŒ…æ‹¬headerä¿¡æ¯ï¼Œå‡å¯ä»¥è¿›è¡Œæ’å…¥ CopyXLogRecordToWAL(rechdr-&gt;xl_tot_len, isLogSwitch, rdata, StartPos, EndPos); // æ›´æ–°æœ€åä¸€æ¡é‡è¦è®°å½•çš„LSNï¼Œå½“æŒæœ‰é”æ—¶ï¼Œåªæ›´æ–°ç¬¬ä¸€ä¸ª if ((flags &amp; XLog_MARK_UNIMPORTANT) == 0) &#123; int lockno = holdingAllLocks ? 0 : MyLockNo; WALInsertLocks[lockno].l.lastImportantAt = StartPos; &#125;&#125; PageSetLSN æ›´æ–°è¢«ä¿®æ”¹çš„Page LSN","categories":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/categories/PostgreSQL/"}],"tags":[{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/tags/PostgreSQL/"},{"name":"replication","slug":"replication","permalink":"https://spike1337.github.io/tags/replication/"},{"name":"WAL","slug":"WAL","permalink":"https://spike1337.github.io/tags/WAL/"}]}],"categories":[{"name":"demo","slug":"demo","permalink":"https://spike1337.github.io/categories/demo/"},{"name":"Linux","slug":"Linux","permalink":"https://spike1337.github.io/categories/Linux/"},{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/categories/PostgreSQL/"}],"tags":[{"name":"demo","slug":"demo","permalink":"https://spike1337.github.io/tags/demo/"},{"name":"Linux","slug":"Linux","permalink":"https://spike1337.github.io/tags/Linux/"},{"name":"libc","slug":"libc","permalink":"https://spike1337.github.io/tags/libc/"},{"name":"file access","slug":"file-access","permalink":"https://spike1337.github.io/tags/file-access/"},{"name":"PostgreSQL","slug":"PostgreSQL","permalink":"https://spike1337.github.io/tags/PostgreSQL/"},{"name":"storage","slug":"storage","permalink":"https://spike1337.github.io/tags/storage/"},{"name":"tools","slug":"tools","permalink":"https://spike1337.github.io/tags/tools/"},{"name":"transaction","slug":"transaction","permalink":"https://spike1337.github.io/tags/transaction/"},{"name":"MVCC","slug":"MVCC","permalink":"https://spike1337.github.io/tags/MVCC/"},{"name":"replication","slug":"replication","permalink":"https://spike1337.github.io/tags/replication/"},{"name":"WAL","slug":"WAL","permalink":"https://spike1337.github.io/tags/WAL/"}]}