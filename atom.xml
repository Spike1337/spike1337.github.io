<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Spike World</title>
  <icon>https://www.gravatar.com/avatar/e1307032b28045ba75cb8251865dfced</icon>
  
  <link href="https://spike1337.github.io/atom.xml" rel="self"/>
  
  <link href="https://spike1337.github.io/"/>
  <updated>2023-08-31T01:05:00.000Z</updated>
  <id>https://spike1337.github.io/</id>
  
  <author>
    <name>Spike1337</name>
    <email>spikeiwnl@foxmail.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>LeetCode åˆ·é¢˜æ—¥è®° Â· SQL</title>
    <link href="https://spike1337.github.io/2023/08/31/leetcode_sql/"/>
    <id>https://spike1337.github.io/2023/08/31/leetcode_sql/</id>
    <published>2023-08-31T01:05:00.000Z</published>
    <updated>2023-08-31T01:05:00.000Z</updated>
    
    
    <summary type="html">LeetCodeæ•°æ®åº“ç±»é¢˜ç›®è®°å½•</summary>
    
    
    
    <category term="practice" scheme="https://spike1337.github.io/categories/practice/"/>
    
    
    <category term="SQL" scheme="https://spike1337.github.io/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode åˆ·é¢˜æ—¥è®° Â· ç®—æ³•</title>
    <link href="https://spike1337.github.io/2023/08/31/leetcode_algorithms/"/>
    <id>https://spike1337.github.io/2023/08/31/leetcode_algorithms/</id>
    <published>2023-08-31T01:05:00.000Z</published>
    <updated>2023-08-31T01:05:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="8-å­—ç¬¦ä¸²è½¬æ¢æ•´æ•°">[#8] å­—ç¬¦ä¸²è½¬æ¢æ•´æ•°</h2><h3 id="é¢˜ç›®">é¢˜ç›®</h3><p><a href="https://leetcode.cn/problems/string-to-integer-atoi">https://leetcode.cn/problems/string-to-integer-atoi</a></p><h3 id="Solution1">Solution1</h3><p>æœ€ç›´è§‚çš„éå†å­—ç¬¦ä¸²æ–¹æ³•ï¼Œæ ¹æ®é¢˜ç›®è§„åˆ™åˆ¤æ–­å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸€ä¸ªå­—ç¬¦ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">myAtoi</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">        <span class="type">int</span> sign = <span class="number">1</span>;  <span class="comment">// sign flag</span></span><br><span class="line">        <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="type">bool</span> in_digit_range = <span class="literal">false</span>;  <span class="comment">// we are in digital range</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> element: s)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// skip space</span></span><br><span class="line">            <span class="keyword">if</span> (element == <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (in_digit_range)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (element == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (in_digit_range)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                sign = <span class="number">-1</span>;</span><br><span class="line">                in_digit_range = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (element == <span class="string">&#x27;+&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (in_digit_range)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    in_digit_range = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (element &gt;= <span class="string">&#x27;0&#x27;</span> &amp;&amp; element &lt;= <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                in_digit_range = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (sum &gt; INT_MAX / <span class="number">10</span> || (sum == INT_MAX / <span class="number">10</span> &amp;&amp; element &gt; <span class="string">&#x27;7&#x27;</span>))</span><br><span class="line">                    <span class="keyword">return</span> sign &gt; <span class="number">0</span> ? INT_MAX : INT_MIN;</span><br><span class="line">                </span><br><span class="line">                sum = sum * <span class="number">10</span> + (element - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sign * sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼šç›´è§‚æ˜“æ‡‚ç¼ºç‚¹ï¼šä»£ç è‡ƒè‚¿ç»“è®ºï¼šæ­£å¸¸æ€è·¯</p><h3 id="Solution2">Solution2</h3><p>æ¥è‡ªLeetCodeå®˜æ–¹çš„æ€è·¯ï¼šè‡ªåŠ¨æœº</p><blockquote><p>æˆ‘ä»¬çš„ç¨‹åºåœ¨æ¯ä¸ªæ—¶åˆ»æœ‰ä¸€ä¸ªçŠ¶æ€ sï¼Œæ¯æ¬¡ä»åºåˆ—ä¸­è¾“å…¥ä¸€ä¸ªå­—ç¬¦ cï¼Œå¹¶æ ¹æ®å­—ç¬¦ c è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€ sâ€™ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬åªéœ€è¦å»ºç«‹ä¸€ä¸ªè¦†ç›–æ‰€æœ‰æƒ…å†µçš„ä» s ä¸ c æ˜ å°„åˆ° sâ€™ çš„è¡¨æ ¼å³å¯è§£å†³é¢˜ç›®ä¸­çš„é—®é¢˜ã€‚</p></blockquote><p>TODO: å†™ä¸€ä¸‹è‡ªåŠ¨æœºæ–‡æ¡£ [ ]</p><p>è‡ªåŠ¨æœºçŠ¶æ€è¡¨æ ¼ï¼š</p><p>|            |  â€™ â€™ |   +/-  | number    | other |<br>| --------- | ----- | ------ | --------- | end  |<br>| start     | start | signed | in_number | end  |<br>| signed    | end   | end    | in_number | end  |<br>| in_number | end   | end    | in_number | end  |<br>| end       | end   | end    | end       | end  |</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Automaton class</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Automaton</span> &#123;</span><br><span class="line">    string state = <span class="string">&quot;start&quot;</span>;</span><br><span class="line">    unordered_map&lt;string, vector&lt;string&gt;&gt; table = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;start&quot;</span>, &#123;<span class="string">&quot;start&quot;</span>, <span class="string">&quot;signed&quot;</span>, <span class="string">&quot;in_number&quot;</span>, <span class="string">&quot;end&quot;</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;signed&quot;</span>, &#123;<span class="string">&quot;end&quot;</span>, <span class="string">&quot;end&quot;</span>, <span class="string">&quot;in_number&quot;</span>, <span class="string">&quot;end&quot;</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;in_number&quot;</span>, &#123;<span class="string">&quot;end&quot;</span>, <span class="string">&quot;end&quot;</span>, <span class="string">&quot;in_number&quot;</span>, <span class="string">&quot;end&quot;</span>&#125;&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;end&quot;</span>, &#123;<span class="string">&quot;end&quot;</span>, <span class="string">&quot;end&quot;</span>, <span class="string">&quot;end&quot;</span>, <span class="string">&quot;end&quot;</span>&#125;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get_col</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isspace</span>(c))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;+&#x27;</span> || c == <span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isdigit</span>(c))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> sign = <span class="number">1</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">get</span><span class="params">(<span class="type">char</span> c)</span> </span>&#123;</span><br><span class="line">        state = table[state][<span class="built_in">get_col</span>(c)];</span><br><span class="line">        <span class="keyword">if</span> (state == <span class="string">&quot;in_number&quot;</span>) &#123;</span><br><span class="line">            sum = sum * <span class="number">10</span> + (c - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            sum = sign == <span class="number">1</span> ? <span class="built_in">min</span>(sum, (<span class="type">long</span> <span class="type">long</span>)INT_MAX) : <span class="built_in">min</span>(sum, -(<span class="type">long</span> <span class="type">long</span>)INT_MIN);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (state == <span class="string">&quot;signed&quot;</span>) &#123;</span><br><span class="line">            sign = c == <span class="string">&#x27;+&#x27;</span> ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">myAtoi</span><span class="params">(string str)</span> </span>&#123;</span><br><span class="line">        Automaton automaton;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> c: str) &#123;</span><br><span class="line">            automaton.<span class="built_in">get</span>(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> automaton.sign * automaton.sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼šèƒ½ç®€å•ç»ƒä¹ ä¸‹è‡ªåŠ¨æœºï¼Œä»£ç æ›´å¥½çœ‹ä¸€ç‚¹ç¼ºç‚¹ï¼šé€»è¾‘æ›´å¤æ‚ï¼Œæ€§èƒ½æ›´æ…¢ï¼Œå†…å­˜å ç”¨æ›´å¤§ç»“è®ºï¼šå¦‚æœæ˜¯ç”Ÿäº§ä»£ç ï¼Œæˆ‘è‚¯å®šä¸ä¼šè¿™ä¹ˆå†™ã€‚ä½†æ˜¯ç»ƒä¹ ç®—æ³•æ—¶è¿˜æ˜¯å¯ä»¥è¯•è¯•çš„</p>]]></content>
    
    
    <summary type="html">LeetCodeç®—æ³•ç±»é¢˜ç›®è®°å½•</summary>
    
    
    
    <category term="practice" scheme="https://spike1337.github.io/categories/practice/"/>
    
    
    <category term="C++, Algorithm" scheme="https://spike1337.github.io/tags/C-Algorithm/"/>
    
  </entry>
  
  <entry>
    <title>LeetCode åˆ·é¢˜æ—¥è®° Â· æ•°æ®ç»“æ„</title>
    <link href="https://spike1337.github.io/2023/08/31/leetcode_struct/"/>
    <id>https://spike1337.github.io/2023/08/31/leetcode_struct/</id>
    <published>2023-08-31T01:05:00.000Z</published>
    <updated>2023-08-31T01:05:00.000Z</updated>
    
    
    <summary type="html">LeetCodeæ•°æ®ç»“æ„ç±»é¢˜ç›®è®°å½•</summary>
    
    
    
    <category term="practice" scheme="https://spike1337.github.io/categories/practice/"/>
    
    
    <category term="C++, Data Structure" scheme="https://spike1337.github.io/tags/C-Data-Structure/"/>
    
  </entry>
  
  <entry>
    <title>æˆ‘çš„C++æœ€ä½³å®è·µåŸåˆ™ï¼ˆæŒç»­æ›´æ–°ä¸­...</title>
    <link href="https://spike1337.github.io/2023/08/25/my_cxx_best_practice_nodes/"/>
    <id>https://spike1337.github.io/2023/08/25/my_cxx_best_practice_nodes/</id>
    <published>2023-08-25T07:51:00.000Z</published>
    <updated>2023-08-25T07:51:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1>å†™åœ¨å‰é¢</h1><p>è¿™ç¯‡æ–‡ç« ç®—æ˜¯æˆ‘åœ¨å­¦ä¹ ç°ä»£C++è·¯ä¸Šä¸­æ¡åˆ°çš„å„ç§é›¶é›¶æ•£æ•£çš„çŸ¥è¯†ç‚¹çš„åˆé›†ï¼Œæ€»ç»“åœ¨è¿™é‡Œæ–¹ä¾¿ä¹‹åä¸æ–­åœ°å›æ¥ç¿»é˜…ã€‚ä»¥é¡¹ç›®æ„å»ºçš„æµç¨‹è§’åº¦åˆ†ä¸ºä»¥ä¸‹ç±»</p><ul class="lvl-0"><li class="lvl-2"><p>ç¨‹åºæµ‹è¯•</p></li><li class="lvl-2"><p>ç¨‹åºè®¾è®¡</p></li><li class="lvl-2"><p>ä»£ç å®ç°</p></li></ul><p>è¿™äº›åŸåˆ™çš„æ¥æºåŒ…æ‹¬ä½†ä¸é™äºï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>Jason Turnerå¤§ä½¬çš„ã€ŠC++ Best Practices: 45ish Simple Rules with Specific Action Items for Better C++ã€‹</p></li><li class="lvl-2"><p>Pengbaå¤§ä½¬çš„<a href="http://mindhacks.cn/2012/08/27/modern-cpp-practices/">C<ins>11ï¼ˆåŠç°ä»£C</ins>é£æ ¼ï¼‰å’Œå¿«é€Ÿè¿­ä»£å¼å¼€å‘ </a></p></li><li class="lvl-2"><p>è‡ªå·±çš„ä¸€äº›æ€»ç»“</p></li><li class="lvl-2"><p>â€¦</p></li></ul><p>æ±‡æ€»åˆ°ä¸€èµ·ä½œä¸ºæœ¬äººå¼€å‘æ˜¯å‚è€ƒçš„å°æŠ„ï¼Œæ–¹ä¾¿æŸ¥é˜…</p><blockquote><p>PS: æœ‰å…³C++è¯­æ³•çš„å¥‡æŠ€æ·«å·§å’Œæœ€ä½³å®è·µï¼Œæˆ‘éƒ½æ˜¯ç»Ÿä¸€å‚è€ƒ<a href="google-styleguide.googlecode.com">Google Style Guide</a>ï¼Œå°±ä¸åœ¨è¿™é‡Œåšcopy pasteäº†</p></blockquote><h1>ç¨‹åºæµ‹è¯•</h1><h2 id="è‡ªåŠ¨æµ‹è¯•æ¡†æ¶">è‡ªåŠ¨æµ‹è¯•æ¡†æ¶</h2><p>æˆ‘ä»¬çš„ä»£ç é¦–å…ˆè¦å…·å¤‡çš„å°±æ˜¯ä¸€ä¸ªè‡ªåŠ¨æµ‹è¯•æ¡†æ¶ï¼Œå®ƒè¦åŒ…å«åŸºäºå®ç°é€»è¾‘çš„å•å…ƒæµ‹è¯•ï¼Œä»¥åŠåŸºäºç”¨æˆ·è¡Œä¸ºçš„BDDå›å½’æµ‹è¯•ã€‚ä¸€ä¸ªå¥½çš„è‡ªåŠ¨æµ‹è¯•å¯ä»¥è®©æˆ‘ä»¬æ”¾å¿ƒçš„é‡æ„ä»£ç ã€æ‰©å±•ä»£ç ã€‚ä»å¦ä¸€ä¸ªæ–¹é¢æ¥è¯´ï¼Œå¦‚ä½•æµ‹è¯•å¾ˆéš¾æ„å»ºï¼Œé‚£ä¹ˆè¿™æ®µä»£ç çš„è®¾è®¡å¾ˆå¯èƒ½å¹¶ä¸æ˜¯æœ€ä¼˜çš„</p><h2 id="æŒç»­æ„å»ºæµ‹è¯•">æŒç»­æ„å»ºæµ‹è¯•</h2><p>æˆ‘ä»¬éœ€è¦ä¸€äº›æŒç»­æ„å»ºçš„è‡ªåŠ¨æµ‹è¯•å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬ç¡®ä¿æ¯ä¸€æ¬¡æäº¤çš„å¯é æ€§ï¼Œä¸ç®¡æ˜¯gitlabçš„ciï¼Œè¿˜æ˜¯githubçš„workflowï¼Œæˆ–è€…å…¶ä»–çš„æŒç»­æ„å»ºå·¥å…·ã€‚</p><h2 id="ç¼–è¯‘å™¨è­¦å‘Š">ç¼–è¯‘å™¨è­¦å‘Š</h2><p>æˆ‘ä»¬éœ€è¦ç¼–è¯‘å™¨æ¥å‘Šè¯‰æˆ‘ä»¬ï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯å¦æ­£ç¡®ç¬¦åˆC++æ ‡å‡†ã€‚æ³¨æ„<code>-Wall</code>å¹¶ä¸æ˜¯GCCå’ŒClangæä¾›çš„æ‰€æœ‰warningï¼Œ<code>-Wextra</code>èƒ½æä¾›æ›´å¤šçš„ä¿¡æ¯ï¼Œä½†è¿˜æ˜¯å»ºè®®ä½¿ç”¨<code>-Wpedantic</code>è·å–gcc/clangæä¾›çš„ä»¥ANSI/ISO Cæ ‡å‡†åˆ—å‡ºçš„è­¦å‘Š</p><h2 id="é™æ€åˆ†æ">é™æ€åˆ†æ</h2><p>é™æ€åˆ†ææ˜¯æˆ‘ä»¬æ„å»ºä»£ç çš„ç¬¬ä¸€é“é˜²çº¿ã€‚ç°åœ¨æœ‰è®¸å¤šå…è´¹å¼€æºçš„é™æ€åˆ†æå·¥å…·ï¼Œå…¶ä¸­æ¨èCPPCHECKå’Œclang-tidy</p><h2 id="ä½¿ç”¨-Sanitizers">ä½¿ç”¨ Sanitizers</h2><p>Sanitizersæ˜¯ä¸€ä¸ªè¿è¡Œæ—¶åˆ†æå·¥å…·ï¼Œæ¨èåœ¨å¼€å‘æ—¶æ°¸è¿œå¼€å¯Address sanitizå’ŒUB Sanitizerï¼Œåœ¨åŒ…å«å¤šçº¿ç¨‹æ—¶å¼€å¯Thread sanitizer</p><h2 id="æ¨¡ç³Šæµ‹è¯•-Fuzzing-å’Œå˜å¼‚æµ‹è¯•-Mutating">æ¨¡ç³Šæµ‹è¯•(Fuzzing)å’Œå˜å¼‚æµ‹è¯•(Mutating)</h2><p>æˆ‘ä»¬å¼€å‘äººå‘˜è®¾è®¡çš„æµ‹è¯•ç”¨ä¾‹å¾€å¾€æ˜¯å¸¦æœ‰æ€ç»´æƒ¯æ€§çš„ï¼Œå¯¹äºæœ‰äº›æç«¯æˆ–è¯¯ç”¨çš„æƒ…å†µæµ‹è¯•ä¸åˆ°ï¼Œè¿™æ˜¯æˆ‘ä»¬éœ€è¦è¿™äº›å·¥å…·æ¥å¼¥è¡¥æˆ‘ä»¬çš„æ€ç»´æƒ¯æ€§</p><h3 id="Fuzzing">Fuzzing</h3><p>æ¨¡ç³Šæµ‹è¯•å·¥å…·èƒ½å¤Ÿç”Ÿæˆå„ç§é•¿åº¦çš„éšæœºå­—ç¬¦ä¸²ï¼Œè¿™ç§æµ‹è¯•èƒ½å¤Ÿçº¦æŸä½ ç”¨åˆé€‚çš„æ–¹æ³•å»å¤„ç†è¿™äº›æ•°æ®ï¼Œæ¨¡ç³Šæµ‹è¯•å·¥å…·åˆ†æé‚£äº›ä»ä½ çš„æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆå‡ºæ¥çš„è¦†ç›–ç‡æ•°æ®å¹¶ä¸”ä½¿ç”¨é‚£äº›ä¿¡æ¯å»åˆ é™¤å¤šä½™çš„æµ‹è¯•å¹¶ä¸”äº§ç”Ÿæ–°ä¸”ç‰¹æ®Šçš„æµ‹è¯•ç”¨ä¾‹ã€‚</p><p>å¯¹äºC++ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨American Fuzzy Lopï¼ˆAFLï¼‰æ¥è¿›è¡Œæ¨¡ç³Šæµ‹è¯•</p><h3 id="Mutating">Mutating</h3><p>ç¼–è¯‘æµ‹è¯•é€šè¿‡ä¿®æ”¹ä½ çš„ä»£ç æ¥å®Œæˆæµ‹è¯•ã€‚å®ƒä¿®æ”¹ä½ çš„ä»£ç é€»è¾‘ï¼Œä¹‹åä»»ä½•èƒ½é€šè¿‡çš„æµ‹è¯•ç”¨ä¾‹éƒ½æ„å‘³ç€è¦ä¹ˆä½ çš„ä»£ç å­˜åœ¨bugï¼Œè¦ä¹ˆæµ‹è¯•ç”¨ä¾‹æœ‰ç¼ºé™·ã€‚</p><p>ä¾‹å­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">greaterThanFive</span><span class="params">(<span class="type">const</span> <span class="type">int</span> value)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> value &gt; <span class="number">5</span>; <span class="comment">// comparison</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">tests</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">greaterThanFive</span>(<span class="number">6</span>));</span><br><span class="line">    <span class="built_in">assert</span>(!<span class="built_in">greaterThanFive</span>(<span class="number">4</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å˜å¼‚æµ‹è¯•ä¼šä¿®æ”¹ä½ çš„ä»£ç å¦‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">greaterThanFive</span><span class="params">(<span class="type">const</span> <span class="type">int</span> value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> value &lt; <span class="number">5</span>; <span class="comment">// mutated</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>ç¨‹åºè®¾è®¡</h1><h2 id="KISSåŸåˆ™">KISSåŸåˆ™</h2><p>è¿™æ˜¯ä¸€ä¸ªå·²ç»è¢«è¯´çƒ‚äº†çš„å…ƒç»„åŸåˆ™ï¼Œä¸åšä¸å¿…è¦çš„å®ç°ï¼Œæ˜¯ä½ çš„ä»£ç å°½å¯èƒ½ç®€æ´ã€ç®€å•çš„å®Œæˆã€‚ä½†æˆ‘æƒ³è¯´KISSä¸ä»…æ˜¯ç”¨åœ¨ç¨‹åºé€»è¾‘çš„å®ç°ä¸­ï¼Œæ›´åº”è¯¥ç”¨åœ¨è®¾è®¡å±‚é¢ä¸Šã€‚ä¸€ä¸ªå¥½çš„è®¾è®¡èƒ½è®©ä½ çš„ä»£ç å°‘èµ°20å¹´å¼¯è·¯ï¼Œä½¿å…¶ä»¥ä¸€ä¸ªå¥½çš„ä»£ç è´¨é‡å¼€å¤´ï¼Œè¿™æ— ç–‘å¯¹ä¹‹åçš„ç»´æŠ¤å’Œæ‰©å±•æ˜¯æ›´æœ‰å¸®åŠ©çš„ã€‚</p><h2 id="æŒç»­é‡æ„">æŒç»­é‡æ„</h2><p>å½“ç„¶æˆ‘ä»¬å¹¶ä¸æ˜¯å…¨çŸ¥å…¨èƒ½ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®å¼€å§‹è¿­ä»£ä¹‹åä¹Ÿä¸€å®šæœ‰å±‚å‡ºä¸ç©·çš„å¥‡å¦™æƒ³æ³•ï¼Œå¯èƒ½æ˜¯åœ¨æŸå¤©ç¡æ¢¦ä¸­ä½ å¯¹æŸä¸ªfeatureæœ‰äº†æ›´å¥½çš„è®¾è®¡æ–¹æ¡ˆï¼Œè¿™æ—¶ä¸è¦å®³æ€•å»é‡æ„ä»£ç ï¼Œåœ¨ä¿è¯æœ‰å®Œå¤‡çš„æµ‹è¯•ä½“ç³»ä¸‹ï¼Œä¸æ–­åœ°å»é‡æ„ä»£ç ï¼Œè¿™èƒ½æœ‰æ•ˆçš„é˜»æ­¢éšç€ä»£ç å¢é•¿å¸¦æ¥çš„æŠ€æœ¯å€ºæ»šé›ªçƒä¼¼çš„å †ç§¯ã€‚</p><h2 id="copy-paste">copy paste</h2><p>å½“ä½ åœ¨copy pasteæ—¶ï¼Œæƒ³æƒ³æ˜¯å¦å¯ä»¥æŠ½è±¡ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œæˆ–è€…ä¸€ä¸ªæ¨¡æ¿ï¼Ÿ</p><h1>ä»£ç å®ç°</h1><h2 id="ç”¨constä¿®é¥°ä¸€åˆ‡å¸¸é‡">ç”¨constä¿®é¥°ä¸€åˆ‡å¸¸é‡</h2><p>å¦‚æœå½¢å‚åœ¨å‡½æ•°å†…éƒ¨ä¸ä¼šæœ‰ä¿®æ”¹çš„è¡Œä¸ºï¼Œå°†å½¢å‚ä¹Ÿå£°æ˜ä¸º<code>const</code></p><h2 id="å–„ç”¨constexpr">å–„ç”¨constexpr</h2><p>å¦‚æœä¸€ä¸ªå¸¸é‡å€¼åœ¨ç¼–è¯‘æ—¶å·²ç»å¯ä»¥å¾—åˆ°ï¼Œä½¿ç”¨<code>constexpr</code>ã€‚ä¸è¦è®©<code>#define</code>æˆä¸ºä½ çš„é»˜è®¤é€‰æ‹©</p><h2 id="å¤šä½¿ç”¨auto">å¤šä½¿ç”¨auto</h2><p><code>auto</code>åœ¨æ³›å‹ç¼–ç¨‹æ—¶å¯ä»¥æå¤§çš„ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ï¼Œä¸è¦åœ¨èŠ±è´¹åŠŸå¤«å»çœ‹è¿™ä¸ªè¿”å›å€¼åº”è¯¥æ˜¯ä»€ä¹ˆç±»å‹äº†</p><h2 id="range-forå¾ªç¯">range-forå¾ªç¯</h2><p>å¯¹å®¹å™¨è¿›è¡Œéå†æ—¶ï¼Œä½¿ç”¨range-forå¾ªç¯</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;element : container) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä½†æ˜¯ä¸è¦åœ¨range-forå¾ªç¯æ—¶ä¿®æ”¹å®¹å™¨è‡ªèº«ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹ï¼Œä½¿ç”¨è€åŠæ³•å§</strong></p><h2 id="å–„ç”¨STLç®—æ³•">å–„ç”¨STLç®—æ³•</h2><p>ä¸€ä¸ªåœºæ™¯ï¼šæ£€æŸ¥ä¸€ä¸ªå®¹å™¨å†…æ˜¯å¦æœ‰å¤§äº42çš„æ•°</p><p>ä½¿ç”¨å¾ªç¯ï¼Œæˆ‘ä»¬éœ€è¦</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> has_value;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;element : container) &#123;</span><br><span class="line">    <span class="keyword">if</span> (element &gt; <span class="number">42</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        has_value = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å¾ªç¯</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="keyword">auto</span> has_value = std::<span class="built_in">any_of</span>(<span class="built_in">begin</span>(container), <span class="built_in">end</span>(container), <span class="built_in">greater_than</span>(<span class="number">12</span>));</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ç®—æ³•åœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½ä¼šä½¿ä½ çš„ä»£ç æ²¡æœ‰é‚£ä¹ˆæ˜“è¯»ï¼Œæ ¹æ®åœºæ™¯ä½¿ç”¨å®ƒ</strong></p><h2 id="ä½¿ç”¨æ¨¡æ¿">ä½¿ç”¨æ¨¡æ¿</h2><p>æ¨¡æ¿æ—¶DRYï¼ˆDont repeat yourselfï¼‰åŸåˆ™çš„å…¸å‹è®¾è®¡ï¼Œä¸è¦å®³æ€•å»ä½¿ç”¨å®ƒã€‚</p><p>å½“ç„¶ï¼Œä½¿ç”¨æ¨¡æ¿æ—¶ï¼Œç»™ä½ çš„ç±»å‹ä¸€ä¸ªæ›´æœ‰æ„ä¹‰çš„åå­—ï¼Œè€Œä¸æ˜¯ç”¨<code>T</code></p><h2 id="ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ">ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ</h2><p>å°½é‡é¿å…ä½¿ç”¨newï¼Œåœ¨ä½¿ç”¨åˆ°å †çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨<code>std::make_unique&lt;&gt;()</code>å’Œ<code>std::make_shared&lt;&gt;()</code>æ¥ç¡®ä¿å®‰å…¨çš„èµ„æºç®¡ç†</p><h2 id="è·³è¿‡C-11">è·³è¿‡C++11</h2><p>å¦‚æœä½ åœ¨æ­£åœ¨è½¬å‘â€ç°ä»£C++&quot;, è¯·è·³è¿‡Cpp11ç‰ˆæœ¬, Cpp14ä¿®å¤äº†è®¸å¤šCpp11çš„æ¼æ´ã€‚</p><p>å…¶ä¸­è¯­è¨€å±‚é¢çš„ç‰¹æ€§åŒ…æ‹¬ï¼š</p><ol><li class="lvl-3"><p>C<ins>11 ç‰ˆæœ¬çš„constexpr éšå¼åœ°æŒ‡å®šäº†æ‰€æœ‰æˆå‘˜å‡½æ•°ä¸ºconst(å³ä¸èƒ½ä¿®æ”¹this)ï¼Œ è¿™åœ¨C</ins>14å·²ç»è¢«æ”¹å˜ã€‚</p></li><li class="lvl-3"><p>C++11ç¼ºå°‘å¯¹å‡½æ•°å¯¹auto è¿”å›ç±»å‹çš„æ¨å¯¼(lambdasæœ‰)</p></li><li class="lvl-3"><p>C++11æ²¡æœ‰autoæˆ–è€…å¯å˜Lambdaå‚æ•°çš„</p></li><li class="lvl-3"><p>C++14æ–°å¢[[deprecated]]ç‰¹æ€§</p></li><li class="lvl-3"><p>C++14æ–°å¢äº†æ•°å­—åˆ†éš”ç¬¦ï¼Œ æ¯”å¦‚1â€™000â€™000</p></li><li class="lvl-3"><p>åœ¨C++14é‡Œconstexpr å‡½æ•°å¯ä»¥æœ‰å¤šä¸ªreturn</p></li></ol><p>åº“å±‚é¢ç‰¹æ€§åŒ…æ‹¬ï¼š</p><ol><li class="lvl-3"><p>std::make_unique åœ¨C++14ä¸­åŠ å…¥</p></li><li class="lvl-3"><p>C++11æ²¡æœ‰std::exchange</p></li><li class="lvl-3"><p>C++14æ–°å¢äº†å¯¹std::arrayçš„constexpræ”¯æŒ</p></li><li class="lvl-3"><p>cbegin, cend, crbegin, å’Œcrend è¿™äº›è‡ªç”±å‡½æ•°(free function ,æ²¡æœ‰å…¥å‚çš„å‡½æ•°ï¼‰ ä¸ºäº†å’Œbegin å’Œendè¿™äº›åœ¨C++11åŠ å…¥çš„æ ‡å‡†å®¹å™¨ä¸­çš„è‡ªç”±å‡½æ•°ä¿æŒä¸€è‡´è€Œè¢«åŠ å…¥äº†ã€‚</p></li></ol>]]></content>
    
    
    <summary type="html">C++ Best Practice Principle</summary>
    
    
    
    <category term="C++" scheme="https://spike1337.github.io/categories/C/"/>
    
    
    <category term="C++, develop" scheme="https://spike1337.github.io/tags/C-develop/"/>
    
  </entry>
  
  <entry>
    <title>Butterflyä¸»é¢˜Markdownæ ·å¼æµ‹è¯•</title>
    <link href="https://spike1337.github.io/2023/08/22/butterfly-test/"/>
    <id>https://spike1337.github.io/2023/08/22/butterfly-test/</id>
    <published>2023-08-22T06:37:00.000Z</published>
    <updated>2023-08-24T02:42:44.534Z</updated>
    
    <content type="html"><![CDATA[<h1>H1æ ‡é¢˜</h1><p>è¿™æ˜¯ä¸€äº›æ–‡å­—æ ·å¼ã€‚</p><p>Here are some text styles.</p><h2 id="H2æ ‡é¢˜">H2æ ‡é¢˜</h2><h3 id="H3æ ‡é¢˜">H3æ ‡é¢˜</h3><h4 id="H4æ ‡é¢˜">H4æ ‡é¢˜</h4><p><em>æ–œä½“</em></p><p><strong>ç²—ä½“</strong></p><h3 id="ä»£ç ">ä»£ç </h3><p>è¡Œå†…ä»£ç  <code>rm -rf /root/</code></p><p>ä»£ç é«˜äº®</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">foo</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    std::string text;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">print_text</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">fib</span>(<span class="params">n</span>):</span><br><span class="line">    a, b = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> a &lt; n:</span><br><span class="line">        <span class="built_in">print</span>(a, end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        a, b = b, a+b</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">fib(<span class="number">1000</span>)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FooBar</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="type">char</span> name_path[<span class="number">1024</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¡¨æ ¼">è¡¨æ ¼</h3><table><thead><tr><th>key</th><th>value</th><th>comment</th></tr></thead><tbody><tr><td>key1</td><td>value1</td><td>comment1</td></tr><tr><td>key2</td><td>value2</td><td>comment2</td></tr><tr><td>key3</td><td>value3</td><td>comment3</td></tr></tbody></table><h3 id="åˆ—è¡¨">åˆ—è¡¨</h3><h4 id="æœ‰åºåˆ—è¡¨">æœ‰åºåˆ—è¡¨</h4><ol><li class="lvl-3"><p>comment1</p></li><li class="lvl-3"><p>comment2</p></li><li class="lvl-3"><p>comment3</p></li></ol><h4 id="æ— åºåˆ—è¡¨">æ— åºåˆ—è¡¨</h4><ul class="lvl-0"><li class="lvl-2"><p>function1</p></li><li class="lvl-2"><p>function2</p><ul class="lvl-2"><li class="lvl-6">function3</li></ul></li><li class="lvl-2"><p>function4</p></li></ul><h3 id="å›¾ç‰‡">å›¾ç‰‡</h3><p><img src="/img/csgo1.png" alt="è¿™æ˜¯ä¸€å¼ å›¾ç‰‡"></p><h3 id="å‹¾é€‰æ¡†">å‹¾é€‰æ¡†</h3><ul class="lvl-0"><li class="lvl-2"><p><input type="checkbox" id="checkbox0"><label for="checkbox0"> todo 1</label></p></li><li class="lvl-2"><p><input type="checkbox" id="checkbox1" checked="true"><label for="checkbox1"> todo 2</label></p></li></ul><h3 id="emoji">emoji</h3><p>ğŸ˜¢ è¿™æ˜¯ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ï¼</p>]]></content>
    
    
    <summary type="html">ä¸€ä¸ªæµ‹è¯•Butterflyä¸»é¢˜å¯¹äºmarkdownæ ·å¼è§£æçš„æµ‹è¯•demo</summary>
    
    
    
    <category term="demo" scheme="https://spike1337.github.io/categories/demo/"/>
    
    
    <category term="demo" scheme="https://spike1337.github.io/tags/demo/"/>
    
  </entry>
  
  <entry>
    <title>Cæ ‡å‡†åº“ Â· æ–‡ä»¶è®¿é—® Â· statx</title>
    <link href="https://spike1337.github.io/2023/07/25/statx/"/>
    <id>https://spike1337.github.io/2023/07/25/statx/</id>
    <published>2023-07-25T06:41:21.000Z</published>
    <updated>2023-08-22T01:36:55.571Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å¼€å‘é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæƒ³è¦è·å–æŸä¸ªæ–‡ä»¶æ¯«ç§’çº§çš„ä¿®æ”¹æ—¶é—´ã€‚ä¼—æ‰€å‘¨çŸ¥Cæ ‡å‡†åº“ä¸­æä¾›çš„<code>stat</code>å‡½æ•°åªèƒ½è·å–åˆ°ç§’çº§çš„ä¿®æ”¹æ—¶é—´<code>st_mtime</code>ã€‚ç›¸å…³çš„ä¿¡æ¯ç¿»äº†ä¸ªéï¼Œæœ€ç»ˆè¿˜æ˜¯ç¥å¥‡çš„ChatGPTç»™æˆ‘äº†ç­”æ¡ˆï¼š</p><p>Linux 4.11åŠæ›´é«˜ç‰ˆæœ¬ï¼Œæ”¯æŒ<code>statx</code>æä¾›äº†æ¯«ç§’çº§çš„æ–‡ä»¶ä¿®æ”¹æ—¶é—´</p><h2 id="SYNOPSIS">SYNOPSIS</h2><p><strong>STRUCT</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">statx</span> &#123;</span><br><span class="line">    __u32 stx_mask;        <span class="comment">/* Mask of bits indicating</span></span><br><span class="line"><span class="comment">                                filled fields */</span></span><br><span class="line">    __u32 stx_blksize;     <span class="comment">/* Block size for filesystem I/O */</span></span><br><span class="line">    __u64 stx_attributes;  <span class="comment">/* Extra file attribute indicators */</span></span><br><span class="line">    __u32 stx_nlink;       <span class="comment">/* Number of hard links */</span></span><br><span class="line">    __u32 stx_uid;         <span class="comment">/* User ID of owner */</span></span><br><span class="line">    __u32 stx_gid;         <span class="comment">/* Group ID of owner */</span></span><br><span class="line">    __u16 stx_mode;        <span class="comment">/* File type and mode */</span></span><br><span class="line">    __u64 stx_ino;         <span class="comment">/* Inode number */</span></span><br><span class="line">    __u64 stx_size;        <span class="comment">/* Total size in bytes */</span></span><br><span class="line">    __u64 stx_blocks;      <span class="comment">/* Number of 512B blocks allocated */</span></span><br><span class="line">    __u64 stx_attributes_mask;</span><br><span class="line">                            <span class="comment">/* Mask to show what&#x27;s supported</span></span><br><span class="line"><span class="comment">                                in stx_attributes */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The following fields are file timestamps */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">statx_timestamp</span> stx_atime;  <span class="comment">/* Last access */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">statx_timestamp</span> stx_btime;  <span class="comment">/* Creation */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">statx_timestamp</span> stx_ctime;  <span class="comment">/* Last status change */</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">statx_timestamp</span> stx_mtime;  <span class="comment">/* Last modification */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If this file represents a device, then the next two</span></span><br><span class="line"><span class="comment">        fields contain the ID of the device */</span></span><br><span class="line">    __u32 stx_rdev_major;  <span class="comment">/* Major ID */</span></span><br><span class="line">    __u32 stx_rdev_minor;  <span class="comment">/* Minor ID */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The next two fields contain the ID of the device</span></span><br><span class="line"><span class="comment">        containing the filesystem where the file resides */</span></span><br><span class="line">    __u32 stx_dev_major;   <span class="comment">/* Major ID */</span></span><br><span class="line">    __u32 stx_dev_minor;   <span class="comment">/* Minor ID */</span></span><br><span class="line"></span><br><span class="line">    __u64 stx_mnt_id;      <span class="comment">/* Mount ID */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Direct I/O alignment restrictions */</span></span><br><span class="line">    __u32 stx_dio_mem_align;</span><br><span class="line">    __u32 stx_dio_offset_align;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å››ä¸ª<code>statx_timestamp</code>å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ¯«ç§’çº§æ—¶é—´æˆ³</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">statx_timestamp</span> &#123;</span><br><span class="line">    __s64   tv_sec;      <span class="comment">// ç§’æ•°æ—¶é—´æˆ³</span></span><br><span class="line">    __u32   tv_nsec;     <span class="comment">// tv_srchiå‘¨çš„çº³ç§’æ•°</span></span><br><span class="line">    __s32   __reserved;  <span class="comment">// ä¿ç•™ç²¾åº¦</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>FUNCTION</strong></p><p>å‡½æ•°statxä½äºCæ ‡å‡†åº“ Standard C library (libc, -lc)ï¼Œå‡½æ•°çš„å£°æ˜å’Œä½¿ç”¨å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">statx</span><span class="params">(<span class="type">int</span> dirfd, <span class="type">const</span> <span class="type">char</span> *restrict pathname, <span class="type">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">          <span class="type">unsigned</span> <span class="type">int</span> mask, <span class="keyword">struct</span> statx *restrict statxbuf)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>RETURN</strong></p><p>å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œè¿”å›0ï¼Œå¦åˆ™è¿”å›-1å¹¶è®¾ç½®errno</p><p>æ›´è¯¦ç»†çš„ä¿¡æ¯è¯·ç§»æ­¥ <a href="https://man7.org/linux/man-pages/man2/statx.2.html">LINUX MANUAL PAGE</a></p><h2 id="Example">Example</h2><p>æˆ‘è‡ªå·±æµ‹è¯•çš„ä¸€ä¸ªç®€å•ä¾‹å­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *filename = <span class="string">&quot;tmp_file&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// statx ç»“æ„ä½“</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">statx</span> buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AT_FDCWD    åœ¨å½“å‰ç›®å½•ä¸‹è¿è¡Œ</span></span><br><span class="line">    <span class="comment">// STATX_MTIME è·å–ä¿®æ”¹æ—¶é—´</span></span><br><span class="line">    <span class="comment">// AT_SYMLINK_NOFOLLOW å¦‚æœæ˜¯é“¾æ¥åˆ™è¿”å›é“¾æ¥æœ¬èº«ä¿¡æ¯</span></span><br><span class="line">    <span class="type">int</span> result =</span><br><span class="line">        <span class="built_in">statx</span>(AT_FDCWD, filename, AT_SYMLINK_NOFOLLOW, STATX_MTIME, &amp;buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Error: %m\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// buffer.stx_mtime è®°å½•æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´</span></span><br><span class="line">    <span class="comment">// tv_sec æ˜¯ç§’çº§, tv_nsec æ˜¯æ¯«ç§’çº§</span></span><br><span class="line">    <span class="type">int64_t</span> sec = buffer.stx_mtime.tv_sec;</span><br><span class="line">    <span class="type">int</span>     micro_sec = buffer.stx_mtime.tv_nsec / <span class="number">1000</span>;</span><br><span class="line">    <span class="type">char</span>    time_str[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strftime</span>(time_str, <span class="number">128</span>, <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, <span class="built_in">localtime</span>(&amp;sec));</span><br><span class="line">    <span class="built_in">fprintf</span>(stdout, <span class="string">&quot;Modification time of file %s is %s.%d\n&quot;</span>, filename,</span><br><span class="line">        time_str, micro_sec);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Linuxæµ‹è¯•ç”¨ä¾‹</p><p><a href="https://kgithub.com/torvalds/linux/blob/master/samples/vfs/test-statx.c">https://kgithub.com/torvalds/linux/blob/master/samples/vfs/test-statx.c</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ€è¿‘å¼€å‘é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæƒ³è¦è·å–æŸä¸ªæ–‡ä»¶æ¯«ç§’çº§çš„ä¿®æ”¹æ—¶é—´ã€‚ä¼—æ‰€å‘¨çŸ¥Cæ ‡å‡†åº“ä¸­æä¾›çš„&lt;code&gt;stat&lt;/code&gt;å‡½æ•°åªèƒ½è·å–åˆ°ç§’çº§çš„ä¿®æ”¹æ—¶é—´&lt;code&gt;st_mtime&lt;/code&gt;ã€‚ç›¸å…³çš„ä¿¡æ¯ç¿»äº†ä¸ªéï¼Œæœ€ç»ˆè¿˜æ˜¯ç¥å¥‡çš„ChatGPTç»™æˆ‘äº†ç­”æ¡ˆï¼š&lt;/p&gt;
&lt;p&gt;Linux </summary>
      
    
    
    
    <category term="Linux" scheme="https://spike1337.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://spike1337.github.io/tags/Linux/"/>
    
    <category term="libc" scheme="https://spike1337.github.io/tags/libc/"/>
    
    <category term="file access" scheme="https://spike1337.github.io/tags/file-access/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆä¸‰ï¼‰Â· å…ƒç»„çš„æ’å…¥</title>
    <link href="https://spike1337.github.io/2023/07/13/tuple_insert/"/>
    <id>https://spike1337.github.io/2023/07/13/tuple_insert/</id>
    <published>2023-07-13T11:02:08.000Z</published>
    <updated>2023-08-24T01:54:58.113Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å…ƒç»„æ’å…¥">å…ƒç»„æ’å…¥</h2><p>å…ƒç»„çš„æ’å…¥ä¸»è¦ç”±å‡½æ•°<code>heap_insert</code>æ¥å®Œæˆï¼Œä¸»è¦åˆ†ä¸ºå‡ æ­¥ï¼š</p><ol><li class="lvl-3"><p>åˆå§‹åŒ–å…ƒç»„å¤´ HeapTupleHeader</p></li><li class="lvl-3"><p>è·å–å¯ç”¨çš„page</p></li><li class="lvl-3"><p>åˆ¤æ–­å…ƒç»„å¯è§æ€§å’Œäº‹åŠ¡å†²çª</p></li><li class="lvl-3"><p>å°†å…ƒç»„å†™å…¥å¯ç”¨çš„pageï¼Œå¹¶æ ‡è®°page dirty</p></li><li class="lvl-3"><p>å†™wal</p></li></ol><h3 id="åˆå§‹åŒ–å…ƒç»„çš„å…ƒæ•°æ®">åˆå§‹åŒ–å…ƒç»„çš„å…ƒæ•°æ®</h3><p>åœ¨<code>heap_prepare_insert</code>ä¸­å®Œæˆï¼Œæ¥å£æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹æºç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> HeapTuple</span></span><br><span class="line"><span class="function"><span class="title">heap_prepare_insert</span><span class="params">(Relation relation, HeapTuple tup, TransactionId xid,</span></span></span><br><span class="line"><span class="params"><span class="function">                    CommandId cid, <span class="type">int</span> options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* è®¡ç®—å…ƒç»„çš„infomask &amp; infomask2 */</span></span><br><span class="line">    tup-&gt;t_data-&gt;t_infomask &amp;= ~(HEAP_XACT_MASK);</span><br><span class="line">    tup-&gt;t_data-&gt;t_infomask2 &amp;= ~(HEAP2_XACT_MASK);</span><br><span class="line">    tup-&gt;t_data-&gt;t_infomask |= HEAP_XMAX_INVALID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾ç½®xminï¼Œä¹Ÿå°±æ˜¯å…ƒç»„æ’å…¥çš„äº‹åŠ¡å· */</span></span><br><span class="line">    <span class="built_in">HeapTupleHeaderSetXmin</span>(tup-&gt;t_data, xid);</span><br><span class="line">    <span class="keyword">if</span> (options &amp; HEAP_INSERT_FROZEN)</span><br><span class="line">        <span class="built_in">HeapTupleHeaderSetXminFrozen</span>(tup-&gt;t_data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è®¾ç½®cidã€xmaxå’Œtableoidï¼Œç”±äºæ˜¯å…ƒç»„æ’å…¥ï¼Œåˆ™å°†xmaxè®¾ç½®ä¸º0 */</span></span><br><span class="line">    <span class="built_in">HeapTupleHeaderSetCmin</span>(tup-&gt;t_data, cid);</span><br><span class="line">    <span class="built_in">HeapTupleHeaderSetXmax</span>(tup-&gt;t_data, <span class="number">0</span>);</span><br><span class="line">    tup-&gt;t_tableOid = <span class="built_in">RelationGetRelid</span>(relation);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ¤æ–­æ˜¯å¦ä¸ºTOASTå…ƒç»„ */</span></span><br><span class="line">    <span class="keyword">if</span> (relation-&gt;rd_rel-&gt;relkind != RELKIND_RELATION &amp;&amp;</span><br><span class="line">        relation-&gt;rd_rel-&gt;relkind != RELKIND_MATVIEW)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">Assert</span>(!<span class="built_in">HeapTupleHasExternal</span>(tup));</span><br><span class="line">        <span class="keyword">return</span> tup;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">HeapTupleHasExternal</span>(tup) || tup-&gt;t_len &gt; TOAST_TUPLE_THRESHOLD)</span><br><span class="line">        <span class="comment">/* TOASTå…ƒç»„ï¼Œè°ƒç”¨ç›¸åº”çš„æ’å…¥æ¥å£ */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">heap_toast_insert_or_update</span>(relation, tup, <span class="literal">NULL</span>, options);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">/* å¦åˆ™ç›´æ¥è¿”å›å‡†å¤‡å¥½çš„tup */</span></span><br><span class="line">        <span class="keyword">return</span> tup;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è·å–å¯ç”¨çš„page">è·å–å¯ç”¨çš„page</h3><p>åœ¨<code>RelationGetBufferForTuple</code>ä¸­å®Œæˆã€‚</p><p>relationæ˜¯ç›®æ ‡è¡¨å¯¹è±¡ï¼Œlenæ˜¯tupleæ’å…¥éœ€è¦çš„é•¿åº¦ã€‚otherBufferç”¨äºå…ƒç»„updateæ—¶æ›¿æ¢æ—§çš„bufferï¼Œoptionsæ˜¯å†™å…¥çš„é€‰é¡¹ï¼Œbistateè¡¨ç¤ºæ‰¹é‡æ’å…¥å¯¹è±¡çš„çŠ¶æ€ï¼Œvmbufferå’Œvmbuffer_otherç”¨äºå¯è§æ€§æ˜ å°„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Buffer</span></span><br><span class="line"><span class="function"><span class="title">RelationGetBufferForTuple</span><span class="params">(Relation relation, Size len,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Buffer otherBuffer, <span class="type">int</span> options,</span></span></span><br><span class="line"><span class="params"><span class="function">                          BulkInsertState bistate,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Buffer *vmbuffer, Buffer *vmbuffer_other)</span></span></span><br></pre></td></tr></table></figure><ol><li class="lvl-3"><p>é€šè¿‡å¡«å……å› å­ï¼Œè®¡ç®—ç©ºé—²ç©ºé—´ã€‚</p></li></ol><p>å¡«å……å› å­<code>FillFactor</code>æ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”ï¼Œé™åˆ¶äº†æˆ‘ä»¬å¯¹äºpageçš„ä½¿ç”¨ç‡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œä½¿ç”¨äº†é»˜è®¤å¡«å……ç™¾åˆ†æ¯”, HEAP_DEFAULT_FILLFACTOR = 100, ä¹Ÿå°±æ˜¯å®Œå…¨å¡«å……</span></span><br><span class="line">saveFreeSpace = <span class="built_in">RelationGetTargetPageFreeSpace</span>(relation, HEAP_DEFAULT_FILLFACTOR);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ²¡æœ‰tupleçš„pageä¸­ä¹Ÿå¯èƒ½æœ‰line pointerï¼Œæ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªè¿‘ä¼¼å€¼</span></span><br><span class="line">nearlyEmptyFreeSpace = MaxHeapTupleSize -</span><br><span class="line">    (MaxHeapTuplesPerPage / <span class="number">8</span> * <span class="built_in">sizeof</span>(ItemIdData));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (len + saveFreeSpace &gt; nearlyEmptyFreeSpace)</span><br><span class="line">    targetFreeSpace = <span class="built_in">Max</span>(len, nearlyEmptyFreeSpace);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    targetFreeSpace = len + saveFreeSpace;</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>å°è¯•ä»cacheä¸­è·å–è¡¨æœ€è¿‘ä½¿ç”¨çš„pageï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•é€šè¿‡FSMè·å–æ»¡è¶³æ’å…¥æ¡ä»¶çš„page</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bistate &amp;&amp; bistate-&gt;current_buf != InvalidBuffer)</span><br><span class="line">    targetBlock = <span class="built_in">BufferGetBlockNumber</span>(bistate-&gt;current_buf);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    targetBlock = <span class="built_in">RelationGetTargetBlock</span>(relation);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (targetBlock == InvalidBlockNumber &amp;&amp; use_fsm)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// cacheä¸­æ²¡æœ‰ç›®æ ‡pageï¼Œè®©FSMæ¥æä¾›ä¸€ä¸ªåˆå§‹ç›®æ ‡page</span></span><br><span class="line">    targetBlock = <span class="built_in">GetPageWithFreeSpace</span>(relation, targetFreeSpace);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ‹¿ç€ä¹‹å‰è·å–åˆ°çš„blockï¼Œå»è·å–å¯¹åº”çš„buffer</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (otherBuffer == InvalidBuffer)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰otherbuffer, ç®€å•æ’å…¥è¯­å¥, è·å–buffer</span></span><br><span class="line">    buffer = <span class="built_in">ReadBufferBI</span>(relation, targetBlock, RBM_NORMAL, bistate);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PageIsAllVisible</span>(<span class="built_in">BufferGetPage</span>(buffer)))</span><br><span class="line">        <span class="built_in">visibilitymap_pin</span>(relation, targetBlock, vmbuffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((options &amp; HEAP_INSERT_FROZEN) &amp;&amp;</span><br><span class="line">        (<span class="built_in">PageGetMaxOffsetNumber</span>(<span class="built_in">BufferGetPage</span>(buffer)) == <span class="number">0</span>))</span><br><span class="line">        <span class="built_in">visibilitymap_pin</span>(relation, targetBlock, vmbuffer);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">LockBuffer</span>(buffer, BUFFER_LOCK_EXCLUSIVE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">page = <span class="built_in">BufferGetPage</span>(buffer);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœæ‹¿åˆ°çš„pageæœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†è·å–å¯ç”¨pageçš„æ­¥éª¤ï¼Œç›´æ¥è¿”å›å°±å¯ä»¥äº†</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æŸ¥pageæ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œå¦‚æœæœ‰åˆ™è¿”å›å½“å‰page</span></span><br><span class="line">pageFreeSpace = <span class="built_in">PageGetHeapFreeSpace</span>(page);</span><br><span class="line"><span class="keyword">if</span> (targetFreeSpace &lt;= pageFreeSpace)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* use this page as future insert target, too */</span></span><br><span class="line">    <span class="built_in">RelationSetTargetBlock</span>(relation, targetBlock);</span><br><span class="line">    <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œæˆ‘ä»¬éœ€è¦å»å¯»æ‰¾ä¸‹ä¸€ä¸ªblock</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„æ‰¹é‡æ“ä½œ, åˆ™è¿˜æœ‰å…¶ä»–çš„æœªä½¿ç”¨çš„page, æˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸‹ä¸€ä¸ªpage</span></span><br><span class="line"><span class="keyword">if</span> (bistate &amp;&amp; bistate-&gt;next_free != InvalidBlockNumber)</span><br><span class="line">&#123;</span><br><span class="line">    targetBlock = bistate-&gt;next_free;</span><br><span class="line">    <span class="keyword">if</span> (bistate-&gt;next_free &gt;= bistate-&gt;last_free)</span><br><span class="line">    &#123;</span><br><span class="line">        bistate-&gt;next_free = InvalidBlockNumber;</span><br><span class="line">        bistate-&gt;last_free = InvalidBlockNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        bistate-&gt;next_free++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœæ²¡æœ‰è¿›è¡Œæ‰¹é‡æ“ä½œ, è¿™ä¸ªæ—¶å€™å°±è¦é—®ä¸€é—®FSMçš„æ„è§</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!use_fsm)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰FSM, åªèƒ½è·³å‡ºå¾ªç¯å»æ‰©é¡µ</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡FSMå¯»æ‰¾ä¸‹ä¸€ä¸ªåˆé€‚çš„page</span></span><br><span class="line">    targetBlock = <span class="built_in">RecordAndGetPageWithFreeSpace</span>(relation,</span><br><span class="line">                                                targetBlock,</span><br><span class="line">                                                pageFreeSpace,</span><br><span class="line">                                                targetFreeSpace);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li class="lvl-3"><p>å¦‚æœä»¥ä¸Šå¾ªç¯ä¸­æ²¡æœ‰æ‰¾åˆ°ç©ºé—²bufferï¼Œæˆ‘ä»¬åªèƒ½è¿›å…¥æ‰©é¡µçš„é€»è¾‘æ¥æ–°å¢ä¸€ä¸ªpageç”¨æ¥æ’å…¥</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰©é¡µå¹¶è¿”å›æ–°å¢çš„page, æ‰©é¡µçš„å…·ä½“é€»è¾‘æˆ‘ä»¬åœ¨è¿™å°±ä¸è¯¦ç»†ä»‹ç»äº†</span></span><br><span class="line"><span class="comment">// ç®€å•æ¥è¯´å°±æ˜¯ç»™relationåŠ Exclusiveé”, ç„¶ååˆå§‹åŒ–ä¸€ä¸ªæ–°çš„pageè¿›å»</span></span><br><span class="line">buffer = <span class="built_in">RelationAddBlocks</span>(relation, bistate, num_pages, use_fsm,</span><br><span class="line">                           &amp;unlockedTargetBuffer);</span><br><span class="line"></span><br><span class="line">targetBlock = <span class="built_in">BufferGetBlockNumber</span>(buffer);</span><br><span class="line">page = <span class="built_in">BufferGetPage</span>(buffer);</span><br></pre></td></tr></table></figure><ol start="5"><li class="lvl-3"><p>æ–°å¢çš„é¡µæˆ‘ä»¬å†æ¥æ£€æŸ¥ä¸‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œå¦‚æœæœ‰çš„è¯å°±èƒ½è¿”å›ä½¿ç”¨äº†</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pageFreeSpace = <span class="built_in">PageGetHeapFreeSpace</span>(page);</span><br><span class="line"><span class="keyword">if</span> (len &gt; pageFreeSpace)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (unlockedTargetBuffer)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (otherBuffer != InvalidBuffer)</span><br><span class="line">            <span class="built_in">LockBuffer</span>(otherBuffer, BUFFER_LOCK_UNLOCK);</span><br><span class="line">        <span class="built_in">UnlockReleaseBuffer</span>(buffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> loop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">elog</span>(PANIC, <span class="string">&quot;tuple is too big: size %zu&quot;</span>, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">RelationSetTargetBlock</span>(relation, targetBlock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> buffer;</span><br></pre></td></tr></table></figure><h3 id="å†™å…¥æ•°æ®">å†™å…¥æ•°æ®</h3><p>å†™å…¥æ•°æ®æ˜¯ç”±æ¥å£<code>RelationPutHeapTuple</code>æ¥å®Œæˆ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">RelationPutHeapTuple</span><span class="params">(Relation relation,</span></span></span><br><span class="line"><span class="params"><span class="function">                     Buffer buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                     HeapTuple tuple,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">bool</span> token)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Page        pageHeader;</span><br><span class="line">    OffsetNumber offnum;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    pageHeader = <span class="built_in">BufferGetPage</span>(buffer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å…ƒç»„æ’å…¥åˆ°pageä¸­</span></span><br><span class="line">    offnum = <span class="built_in">PageAddItem</span>(pageHeader, (Item) tuple-&gt;t_data,</span><br><span class="line">                            tuple-&gt;t_len, InvalidOffsetNumber, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®°å½•å½“å‰çš„ä½ç½®åˆ°å…ƒç»„çš„t_selfä¸­</span></span><br><span class="line">    <span class="built_in">ItemPointerSet</span>(&amp;(tuple-&gt;t_self), <span class="built_in">BufferGetBlockNumber</span>(buffer), offnum);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†å½“å‰çš„ä½ç½®ä¹Ÿè®°å½•åˆ°å…ƒç»„çš„ctidä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (!token)</span><br><span class="line">    &#123;</span><br><span class="line">        ItemId        itemId = <span class="built_in">PageGetItemId</span>(pageHeader, offnum);</span><br><span class="line">        HeapTupleHeader item = (HeapTupleHeader) <span class="built_in">PageGetItem</span>(pageHeader, itemId);</span><br><span class="line"></span><br><span class="line">        item-&gt;t_ctid = tuple-&gt;t_self;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦çš„å·¥ä½œéƒ½æœ‰å‡½æ•°<code>PageAddItem</code>æ¥å®Œæˆï¼Œ<code>PageAddItem</code>æ˜¯ä¸€ä¸ªå®ï¼Œå†…éƒ¨è°ƒç”¨<code>PageAddItemExtended</code>ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹è¿™ä¸ªæ¥å£</p><p>pageæ˜¯æ’å…¥çš„é¡µé¢ï¼Œitemçš„æ’å…¥çš„æ•°æ®æŒ‡é’ˆï¼Œsizeçš„æ’å…¥æ•°æ®çš„å¤§å°ã€‚offsetNumberæ˜¯å…ƒç»„åœ¨é¡µé¢ä¸­çš„åç§»é‡ï¼Œå¦‚æœæ’å…¥æˆåŠŸåˆ™ä¼šè¢«è¿”å›ã€‚flagsæ˜¯æ’å…¥çš„é€‰é¡¹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">OffsetNumber</span></span><br><span class="line"><span class="function"><span class="title">PageAddItemExtended</span><span class="params">(Page page,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Item item,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Size size,</span></span></span><br><span class="line"><span class="params"><span class="function">                    OffsetNumber offsetNumber,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">int</span> flags)</span></span></span><br></pre></td></tr></table></figure><ol><li class="lvl-3"><p>é¦–å…ˆæˆ‘ä»¬åœ¨pageä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªslotçš„ä½ç½®ï¼Œå¦‚æœä¹‹åæ²¡æœ‰æ‰¾åˆ°ç©ºä½™çš„slotï¼Œæˆ‘ä»¬å°±ä¼šä½¿ç”¨è¿™ä¸ªä½ç½®æ¥æ’å…¥å…ƒç»„</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">limit = <span class="built_in">OffsetNumberNext</span>(<span class="built_in">PageGetMaxOffsetNumber</span>(page));</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœpageæœ‰free line pointer, ä¹Ÿå°±æ˜¯pd_flagsä¸­åŒ…å«PD_HAS_FREE_LINESæ ‡è®°</span></span><br><span class="line"><span class="comment">// åˆ™å»è¡ŒæŒ‡é’ˆæ•°ç»„ä¸­å¯»æ‰¾free slot</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">PageHasFreeLinePointers</span>(page))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ‰«æPageHeaderçš„è¡ŒæŒ‡é’ˆæ•°ç»„ï¼ŒæŸ¥æ‰¾æ ‡è®°ä¸º LP_UNUSEDçš„ itemId</span></span><br><span class="line">    <span class="keyword">for</span> (offsetNumber = FirstOffsetNumber;</span><br><span class="line">            offsetNumber &lt; limit;</span><br><span class="line">            offsetNumber++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">ItemIdIsUsed</span>(itemId) &amp;&amp; !<span class="built_in">ItemIdHasStorage</span>(itemId))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ²¡æœ‰free line pointer, ä½¿ç”¨limit</span></span><br><span class="line">    offsetNumber = limit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>æ¥ä¸‹æ¥æˆ‘ä»¬è®¡ç®—pageçš„pd_lowerå’Œpg_upperæŒ‡é’ˆæŒ‡å‘çš„offset</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (offsetNumber == limit || needshuffle)</span><br><span class="line">    lower = phdr-&gt;pd_lower + <span class="built_in">sizeof</span>(ItemIdData);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    lower = phdr-&gt;pd_lower;</span><br><span class="line"></span><br><span class="line">alignedSize = <span class="built_in">MAXALIGN</span>(size);</span><br><span class="line"></span><br><span class="line">upper = (<span class="type">int</span>) phdr-&gt;pd_upper - (<span class="type">int</span>) alignedSize;</span><br></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>æœ€åæˆ‘ä»¬å°±å¯ä»¥æŠŠå…ƒç»„æ’å…¥åˆ°pageä¸­äº†</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœå·²ç»æœ‰äº†å¯¹åº”çš„è¡ŒæŒ‡é’ˆ, åˆ™é‡æ–°è®¾ç½®è¡ŒæŒ‡é’ˆä¸­çš„å€¼å’Œæ ‡è®°</span></span><br><span class="line">itemId = <span class="built_in">PageGetItemId</span>(page, offsetNumber);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (needshuffle)</span><br><span class="line">    <span class="built_in">memmove</span>(itemId + <span class="number">1</span>, itemId,</span><br><span class="line">            (limit - offsetNumber) * <span class="built_in">sizeof</span>(ItemIdData));</span><br><span class="line"></span><br><span class="line"><span class="built_in">ItemIdSetNormal</span>(itemId, upper, size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†æ•°æ®æ’å…¥åˆ°å¯¹åº”çš„offset</span></span><br><span class="line"><span class="built_in">memcpy</span>((<span class="type">char</span> *) page + upper, item, size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ›´æ–°PageHeaderä¸­çš„upperå’ŒloweræŒ‡é’ˆ</span></span><br><span class="line">phdr-&gt;pd_lower = (LocationIndex) lower;</span><br><span class="line">phdr-&gt;pd_upper = (LocationIndex) upper;</span><br></pre></td></tr></table></figure><p>###WAL logå’Œç»Ÿè®¡ä¿¡æ¯</p><p>å°†å…ƒç»„çœŸæ­£æ’å…¥åˆ°pageä¹‹åï¼Œæˆ‘ä»¬ä¼šå†™WAL logå¹¶æ›´æ–°ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ã€‚è¿™ä¸¤å—æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œè¯¦ç»†çš„æè¿°äº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å…ƒç»„æ’å…¥&quot;&gt;å…ƒç»„æ’å…¥&lt;/h2&gt;
&lt;p&gt;å…ƒç»„çš„æ’å…¥ä¸»è¦ç”±å‡½æ•°&lt;code&gt;heap_insert&lt;/code&gt;æ¥å®Œæˆï¼Œä¸»è¦åˆ†ä¸ºå‡ æ­¥ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li class=&quot;lvl-3&quot;&gt;
&lt;p&gt;åˆå§‹åŒ–å…ƒç»„å¤´ HeapTupleHeader&lt;/p&gt;
&lt;/li&gt;
&lt;li</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="storage" scheme="https://spike1337.github.io/tags/storage/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆäºŒï¼‰Â· å…ƒç»„çš„ç»„ç»‡ç»“æ„</title>
    <link href="https://spike1337.github.io/2023/07/11/tuple_manager_2/"/>
    <id>https://spike1337.github.io/2023/07/11/tuple_manager_2/</id>
    <published>2023-07-11T10:35:06.000Z</published>
    <updated>2023-08-24T01:55:05.462Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šæ¬¡æˆ‘ä»¬ç®€å•çœ‹äº†ä¸‹PostgreSQLä¸­é¡µé¢çš„ç»„ç»‡ç»“æ„ï¼Œä»‹ç»äº†PageHeaderå’Œè¡ŒæŒ‡é’ˆçš„ç»“æ„ã€‚è¿™æ¬¡æˆ‘ä»¬æ¥çœ‹çœ‹å…ƒç»„çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯tupleçš„<code>æˆå‘˜å˜é‡</code></p><h2 id="Tupleçš„ç»“æ„">Tupleçš„ç»“æ„</h2><p>å…ƒç»„çš„ç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">HeapTupleData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    uint32          t_len;</span><br><span class="line">    ItemPointerData t_self;</span><br><span class="line">    Oid             t_tableOid;</span><br><span class="line">    HeapTupleHeader t_data;</span><br><span class="line">&#125; HeapTupleData;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>t_len</code>ï¼Œå…ƒç»„<code>t_data</code>å­—æ®µçš„é•¿åº¦</p></li><li class="lvl-2"><p><code>t_self</code>ï¼Œè®°å½•å…ƒç»„è‡ªå·±çš„ä½ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€åœ¨çš„blockä¿¡æ¯ï¼Œå’Œå…ƒç»„åœ¨é¡µé¢ä¸­çš„offset</p></li><li class="lvl-2"><p><code>t_tableOid</code>ï¼Œå…ƒç»„æ‰€åœ¨è¡¨çš„oid</p></li><li class="lvl-2"><p><code>t_data</code>ï¼Œå…ƒç»„çš„å…ƒæ•°æ®ä¿¡æ¯å’Œå…·ä½“å­˜å‚¨çš„æ•°æ®</p></li></ul><h3 id="HeapTupleHeader">HeapTupleHeader</h3><p>å­˜å‚¨å…ƒç»„çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HeapTupleHeaderData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        HeapTupleFields     t_heap;</span><br><span class="line">        DatumTupleFields    t_datum;</span><br><span class="line">    &#125; t_choice;</span><br><span class="line"></span><br><span class="line">    ItemPointerData t_ctid;</span><br><span class="line">    uint16      t_infomask2;</span><br><span class="line">    uint16      t_infomask;</span><br><span class="line">    uint8       t_hoff;</span><br><span class="line">    bits8       t_bits[FLEXIBLE_ARRAY_MEMBER];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>t_heap</code>ï¼Œå…ƒç»„äº‹åŠ¡ç›¸å…³çš„åŸŸ</p></li><li class="lvl-2"><p><code>t_datum</code>ï¼Œå…ƒç»„æ•°æ®ç›¸å…³çš„åŸŸ</p></li><li class="lvl-2"><p><code>t_cid</code>ï¼ŒHOTå…ƒç»„ä¼šæŒ‡å‘æœ€æ–°çš„å…ƒç»„ä½ç½®ï¼Œå¦åˆ™æŒ‡å‘è‡ªå·±çš„ä½ç½®</p></li><li class="lvl-2"><p><code>t_infomask2</code>ï¼Œå…ƒç»„çš„å±æ€§æ•°ï¼Œå’Œä¸€äº›æ ‡è®°ä½</p></li><li class="lvl-2"><p><code>t_infomask</code>ï¼Œå…ƒç»„çš„æ ‡è®°ä½ã€‚è¿™äº›æ ‡è®°æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œä»‹ç»äº†</p></li><li class="lvl-2"><p><code>t_hoff</code>ï¼Œheaderçš„æ•´ä½“å¤§å°</p></li><li class="lvl-2"><p><code>t_bits</code>ï¼ŒNULLå€¼åˆ—çš„æ•°ç»„</p></li></ul><p><code>t_bits</code>æ•°ç»„ä¹‹åå­˜æ”¾çš„å°±æ˜¯å…ƒç»„çš„æ•°æ®</p><h4 id="HeapTupleFields">HeapTupleFields</h4><p>å…ƒç»„äº‹åŠ¡ç›¸å…³çš„åŸŸ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">HeapTupleFields</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    TransactionId t_xmin;</span><br><span class="line">    TransactionId t_xmax;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        CommandId       t_cid;</span><br><span class="line">        TransactionId   t_xvac;</span><br><span class="line">    &#125; t_field3;</span><br><span class="line">&#125; HeapTupleFields;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>t_xmin</code>ï¼Œå…ƒç»„æ’å…¥çš„äº‹åŠ¡å·</p></li><li class="lvl-2"><p><code>t_xmax</code>ï¼Œå…ƒç»„åˆ é™¤çš„äº‹åŠ¡å·</p></li><li class="lvl-2"><p><code>t_cid</code>ï¼Œå‘½ä»¤idï¼Œè¡¨ç¤ºå½“å‰äº‹åŠ¡ä¸­æ‰§è¡Œçš„ä¿®æ”¹è¯¥å…ƒç»„çš„å‘½ä»¤çš„id</p></li><li class="lvl-2"><p><code>t_xvac</code>ï¼Œvacuum fullæ“ä½œçš„äº‹åŠ¡å·</p></li></ul><h4 id="DatumTupleFields">DatumTupleFields</h4><p>å…ƒç»„æ•°æ®ç›¸å…³çš„åŸŸ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DatumTupleFields</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    int32datum_len_;<span class="comment">/* varlena header (do not touch directly!) */</span></span><br><span class="line">    int32datum_typmod;<span class="comment">/* -1, or identifier of a record type */</span></span><br><span class="line">    Oiddatum_typeid;<span class="comment">/* composite type OID, or RECORDOID */</span></span><br><span class="line"></span><br><span class="line">&#125; DatumTupleFields;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>datum_len_</code>ï¼Œå˜é•¿æ•°æ®ç±»å‹çš„é•¿åº¦</p></li><li class="lvl-2"><p><code>datum_typmod</code>ï¼Œæ•°æ®ç±»å‹</p></li><li class="lvl-2"><p><code>datum_typeid</code>ï¼Œå¤åˆç±»å‹çš„ç±»å‹oid</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸Šæ¬¡æˆ‘ä»¬ç®€å•çœ‹äº†ä¸‹PostgreSQLä¸­é¡µé¢çš„ç»„ç»‡ç»“æ„ï¼Œä»‹ç»äº†PageHeaderå’Œè¡ŒæŒ‡é’ˆçš„ç»“æ„ã€‚è¿™æ¬¡æˆ‘ä»¬æ¥çœ‹çœ‹å…ƒç»„çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯tupleçš„&lt;code&gt;æˆå‘˜å˜é‡&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;Tupleçš„ç»“æ„&quot;&gt;Tupleçš„ç»“æ„&lt;/h2&gt;
&lt;p&gt;å…ƒç»„çš„ç»“æ„å¦‚ä¸‹&lt;/</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="storage" scheme="https://spike1337.github.io/tags/storage/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆä¸€ï¼‰Â· é¡µçš„ç»„ç»‡ç»“æ„</title>
    <link href="https://spike1337.github.io/2023/07/10/tuple_manager_1/"/>
    <id>https://spike1337.github.io/2023/07/10/tuple_manager_1/</id>
    <published>2023-07-10T09:47:33.000Z</published>
    <updated>2023-08-24T01:55:01.531Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€ä¸ªæ–°å‘ï¼Œç®€å•å†™ä¸€å†™PostgreSQLä¸­çš„å…ƒç»„ç®¡ç†ã€‚</p><p>å¯¹äºæ•´ä¸ªå­˜å‚¨æ¶æ„ï¼Œå„ç§PostgreSQLçš„ç›¸å…³ä¹¦ç±å·²ç»ä»‹ç»çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å†é‡å¤é€ è½®å­äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä¸»è¦åŸºäºé¢å‘å¯¹è±¡ï¼ˆå¤§é›¾ï¼‰ï¼Œæ¥çœ‹çœ‹å…ƒç»„è¿™ä¸ªå¯¹è±¡ï¼Œæœ‰å“ªäº›<code>æˆå‘˜å˜é‡</code>ï¼Œåˆæœ‰å“ªäº›<code>æˆå‘˜å‡½æ•°</code></p><hr><p>å…ƒç»„(Tuple)æ˜¯PostgreSQLä¸­æ•°æ®çš„åŸºæœ¬å­˜å‚¨å•å…ƒï¼ŒPageåˆæ˜¯å­˜å‚¨å…ƒç»„çš„åŸºæœ¬è½½ä½“ï¼Œæ‰€ä»¥è¿™ç¬¬ä¸€ç¯‡æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹Pageçš„ç»“æ„</p><h2 id="Pageçš„ç»“æ„">Pageçš„ç»“æ„</h2><p>Pageçš„ç»“æ„å¯ä»¥ç®€å•çœ‹ä¸‹å›¾æ‰€ç¤º</p><p><img src="/uploads/page_struct.png" alt="img"></p><p>pageçš„é»˜è®¤å¤§å°ä¸º8kã€‚æ¯ä¸ªé¡µé¢çš„èµ·å§‹ä½ç½®æœ‰å¤§å°ä¸º24ä¸ªå­—èŠ‚çš„PageHeaderï¼Œè®°å½•è¯¥pageç›¸å…³çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚PageHeaderä¸­çš„pd_lowerå’Œpd_upperåˆ†åˆ«æŒ‡å‘äº†é¡µé¢ç©ºé—²ç©ºé—´çš„é¦–å°¾ã€‚</p><p>è¿™é‡Œæ¯ä¸€ä¸ªtupleå­˜å‚¨ä¸€æ¡æ•°æ®è®°å½•ï¼Œä»æ•°æ®é¡µåº•éƒ¨å¼€å§‹å‘å‰ä¾æ¬¡å­˜å‚¨ã€‚è¿™äº›å…ƒç»„åœ¨é¡µé¢ä¸­çš„ä½ç½®å­˜å‚¨åœ¨è¡ŒæŒ‡é’ˆline pointerä¸­ï¼Œæ¯ä¸ªè¡ŒæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªtupleã€‚è¡ŒæŒ‡é’ˆä»å‰å‘åä¾æ¬¡å­˜å‚¨ï¼Œå½¢æˆä¸€ä¸ªç®€å•çš„æ•°æ®ã€‚è¡ŒæŒ‡é’ˆä¸­è¿˜å­˜æ”¾äº†å…ƒç»„çš„çŠ¶æ€å’Œå¤§å°ä¿¡æ¯ï¼Œæ‰®æ¼”å…ƒç»„åœ¨é¡µé¢ä¸­çš„ç´¢å¼•çš„è§’è‰²ã€‚è¡ŒæŒ‡é’ˆå’Œtupleä¸­é—´çš„éƒ¨åˆ†ä¸ºé¡µé¢çš„ç©ºé—²ç©ºé—´ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹PageHeaderå­˜å‚¨äº†ä»€ä¹ˆå…ƒæ•°æ®</p><h3 id="PageHeader">PageHeader</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">PageHeaderData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    PageXLogRecPtr  pd_lsn;</span><br><span class="line">    uint16          pd_checksum;</span><br><span class="line">    uint16          pd_flags;</span><br><span class="line">    LocationIndex   pd_lower;</span><br><span class="line">    LocationIndex   pd_upper;</span><br><span class="line">    LocationIndex   pd_special;</span><br><span class="line">    uint16          pd_pagesize_version;</span><br><span class="line">    TransactionId   pd_prune_xid;</span><br><span class="line">    ItemIdData      pd_linp[FLEXIBLE_ARRAY_MEMBER];</span><br><span class="line">&#125; PageHeaderData;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>pd_lsn</code>ï¼Œè®°å½•äº†è¯¥é¡µé¢æœ€åä¸€æ¬¡æ›´æ”¹çš„WAL logçš„lsn</p></li><li class="lvl-2"><p><code>pg_checksum</code>ï¼Œé¡µé¢æ ¡éªŒå’Œ</p></li><li class="lvl-2"><p><code>pd_flags</code>ï¼Œé¡µé¢çš„æ ‡è®°ä¸ºï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ ‡è®°</p><ul class="lvl-2"><li class="lvl-4"><code>PD_HAS_FREE_LINES</code>ï¼Œé¡µé¢ä¸­æ˜¯å¦æœ‰unused line pointer. è¿™ä¸ªunusedçš„æ¦‚å¿µæˆ‘ä»¬ä¹‹ååœ¨çœ‹åˆ°line pointeræ—¶ä¼šä»‹ç»</li><li class="lvl-4"><code>PD_PAGE_FULL</code>ï¼Œé¡µé¢æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ç»™æ–°çš„tuple</li><li class="lvl-4"><code>PD_ALL_VISIBLE</code>ï¼Œé¡µé¢ä¸­çš„æ‰€æœ‰å…ƒç»„æ˜¯å¦å¯¹<strong>å½“å‰å’Œä¹‹å</strong>çš„æ‰€æœ‰äº‹åŠ¡å¯è§</li></ul></li><li class="lvl-2"><p><code>pd_lower</code>ï¼ŒæŒ‡å‘ç©ºé—²ç©ºé—´çš„èµ·å§‹ä½ç½®</p></li><li class="lvl-2"><p><code>pd_upper</code>ï¼ŒæŒ‡å‘ç©ºé—²ç©ºé—´çš„ç»“æŸä½ç½®</p></li><li class="lvl-2"><p><code>pd_special</code>ï¼ŒæŒ‡å‘ç‰¹æ®Šç©ºé—´çš„èµ·å§‹ä½ç½®</p></li><li class="lvl-2"><p><code>pd_pagesize_version</code>ï¼Œé¡µé¢å¸ƒå±€çš„ç‰ˆæœ¬å·</p></li><li class="lvl-2"><p><code>pd_prune_xid</code>ï¼Œç”¨äºé¡µé¢å…ƒç»„æ¸…ç†æ—¶çš„æ ‡è®°ä½ï¼Œè®°å½•äº†æœ€æ—§çš„å¯æ¸…ç†çš„äº‹åŠ¡å·ã€‚æ²¡æœ‰åˆ™ä¸º0</p></li><li class="lvl-2"><p><code>pg_linp</code>ï¼Œé¡µé¢è¡ŒæŒ‡é’ˆæ•°ç»„</p></li></ul><h3 id="é¡µé¢çš„è¡ŒæŒ‡é’ˆç»“æ„">é¡µé¢çš„è¡ŒæŒ‡é’ˆç»“æ„</h3><p>è¡ŒæŒ‡é’ˆæ˜¯ä¸€ä¸ª32ä½å¤§å°çš„ç´¢å¼•ç»“æ„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ItemIdData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">unsigned</span>    lp_off:<span class="number">15</span>,</span><br><span class="line">                lp_flags:<span class="number">2</span>,</span><br><span class="line">                lp_len:<span class="number">15</span>;</span><br><span class="line">&#125; ItemIdData;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>lp_off</code>ï¼Œè®°å½•äº†tupleåœ¨é¡µé¢ä¸­çš„offset</p></li><li class="lvl-2"><p><code>lp_len</code>ï¼Œè®°å½•äº†tupleçš„size</p></li><li class="lvl-2"><p><code>lp_flags</code>ï¼Œæ˜¯ä¸€ä¸ªtupleçŠ¶æ€çš„ç®€å•æ ‡è®°ï¼Œæ–¹ä¾¿åœ¨æ‰«æå…ƒç»„æ—¶åšä¸€ä¸ªåˆæ­¥ç­›é€‰ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªæ ‡è®°</p><ul class="lvl-2"><li class="lvl-4"><code>LP_UNUSED</code>ï¼Œå…ƒç»„æœªä½¿ç”¨ï¼Œå¯ä»¥ç«‹åˆ»è¢«é‡ç”¨</li><li class="lvl-4"><code>LP_NORMAL</code>ï¼Œå…ƒç»„çŠ¶æ€æ­£å¸¸</li><li class="lvl-4"><code>LP_REDIRECT</code>ï¼Œå…ƒç»„è¢«é‡å®šå‘äº†ã€‚ç”¨äºPGçš„HOTé“¾çš„å¤´éƒ¨å’Œä¸­é—´å…ƒç»„</li><li class="lvl-4"><code>LP_DEAD</code>ï¼Œå…ƒç»„å·²æ­»ï¼Œä½†ç©ºé—´å¯èƒ½è¿˜æ²¡æœ‰å›æ”¶</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¼€ä¸ªæ–°å‘ï¼Œç®€å•å†™ä¸€å†™PostgreSQLä¸­çš„å…ƒç»„ç®¡ç†ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºæ•´ä¸ªå­˜å‚¨æ¶æ„ï¼Œå„ç§PostgreSQLçš„ç›¸å…³ä¹¦ç±å·²ç»ä»‹ç»çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å†é‡å¤é€ è½®å­äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä¸»è¦åŸºäºé¢å‘å¯¹è±¡ï¼ˆå¤§é›¾ï¼‰ï¼Œæ¥çœ‹çœ‹å…ƒç»„è¿™ä¸ªå¯¹è±¡ï¼Œæœ‰å“ªäº›&lt;code&gt;æˆå‘˜å˜é‡&lt;/code&gt;ï¼Œåˆæœ‰å“ªäº›&lt;</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="storage" scheme="https://spike1337.github.io/tags/storage/"/>
    
  </entry>
  
  <entry>
    <title>Linux Â· å·¥å…· Â· devtodo Â· ç®€æ´çš„ç»ˆç«¯todoå·¥å…·</title>
    <link href="https://spike1337.github.io/2023/02/07/devtodo-manual/"/>
    <id>https://spike1337.github.io/2023/02/07/devtodo-manual/</id>
    <published>2023-02-07T02:23:30.000Z</published>
    <updated>2023-08-22T06:03:21.632Z</updated>
    
    <content type="html"><![CDATA[<p>devtodoæ˜¯ä¸€æ¬¾è¿è¡Œäºç»ˆç«¯çš„todoå·¥å…·ï¼Œç®€æ´æ˜¯å®ƒçš„æœ€å¤§ä¼˜åŠ¿ã€‚devtodo ç›®å‰å·²è¢«è®¸å¤š Linux å‘è¡Œç‰ˆçš„è½¯ä»¶ä»“åº“æ”¶å½•ï¼Œå¯ä»¥ä»è½¯ä»¶ä»“åº“ä¸­å®‰è£…å®ƒï¼Œä¹Ÿå¯ä»¥ä»å®ƒçš„é¡¹ç›®ä¸»é¡µ<a href="https://github.com/alecthomas/devtodo">devtodo</a>ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ç¼–è¯‘å®‰è£…ã€‚</p><h2 id="å¿«é€Ÿä¸Šæ‰‹">å¿«é€Ÿä¸Šæ‰‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">todo          <span class="comment"># æ˜¾ç¤º todo list</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tda           <span class="comment"># æ·»åŠ ä¸€é¡¹ todoï¼Œä¹Ÿå¯ä»¥ç”¨ todo -a å‘½ä»¤</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tde  &lt;index&gt;  <span class="comment"># ä¿®æ”¹ç¬¬ index æ¡ todo</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tdd  &lt;index&gt;  <span class="comment"># æ ‡è®°ç¬¬ index æ¡ todo å·²ç»å®Œæˆ</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tdr  &lt;index&gt;  <span class="comment"># åˆ é™¤ç¬¬ index æ¡ todo</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">todo -A       <span class="comment"># æ˜¾ç¤ºæ‰€æœ‰çš„ todo æ¡ç›®ï¼ŒåŒ…æ‹¬å®Œæˆçš„ä»¥åŠæœªå®Œæˆçš„</span></span></span><br></pre></td></tr></table></figure><h2 id="å‘½ä»¤å±•ç¤º">å‘½ä»¤å±•ç¤º</h2><ul class="lvl-0"><li class="lvl-2"><p>todo</p></li></ul><p>æ˜¾ç¤ºtodo listã€‚æŒ‰ä¼˜å…ˆçº§é¡ºåºæ’åˆ—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">todo</span></span><br><span class="line"></span><br><span class="line">1.test 1</span><br><span class="line">2.test 2</span><br><span class="line">3.test 3</span><br><span class="line">4.test 4</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>tda</p></li></ul><p>æ·»åŠ ä¸€é¡¹todoã€‚è®¾å®štodoå†…å®¹ï¼Œå¹¶è®¾ç½®todoä¼˜å…ˆçº§</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tda</span></span><br><span class="line"></span><br><span class="line">Enter text for the item you are adding.</span><br><span class="line"><span class="meta prompt_">text&gt; </span><span class="language-bash"><span class="built_in">test</span> 1</span></span><br><span class="line">1. veryhigh   2. high   3. medium   4. low   5. verylow</span><br><span class="line">Enter a priority from those listed above.</span><br><span class="line"><span class="meta prompt_">priority&gt; </span><span class="language-bash">1</span></span><br><span class="line">Index of new item is 1</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>tde k</p></li></ul><p>ä¿®æ”¹ç¬¬ k æ¡ todoã€‚å¯ä»¥é‡æ–°ç¼–è¾‘todoå†…å®¹ï¼Œå¹¶è°ƒæ•´todoä¼˜å…ˆçº§</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tde 1</span></span><br><span class="line"></span><br><span class="line">Modify the text of the item you are editing.</span><br><span class="line"><span class="meta prompt_">text&gt; </span><span class="language-bash"><span class="built_in">test</span> modify 1</span></span><br><span class="line">1. veryhigh   2. high   3. medium   4. low   5. verylow</span><br><span class="line">Enter a priority from those listed above.</span><br><span class="line"><span class="meta prompt_">priority&gt; </span><span class="language-bash">1</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>tdd k</p></li></ul><p>æ ‡è®°ç¬¬ k æ¡ todo å·²å®Œæˆï¼Œå¯ä»¥è®¾å®šå®Œæˆçš„commentä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tdd 1</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">comment&gt; </span><span class="language-bash"><span class="keyword">done</span></span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>tdr k</p></li></ul><p>åˆ é™¤ç¬¬ k æ¡ todo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tdr k</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>todo -A</p></li></ul><p>æŸ¥çœ‹æ‰€æœ‰çš„ todo notesï¼Œä¸åŒ…æ‹¬è¢«åˆ é™¤é¡¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 2.test 2</span><br><span class="line">  3.test 3</span><br><span class="line">  4.test 4</span><br></pre></td></tr></table></figure><h2 id="è¿›é˜¶é…ç½®">è¿›é˜¶é…ç½®</h2><ol><li class="lvl-3"><p>å…¨å±€todo notsè®°å½•</p></li></ol><p>é»˜è®¤çš„devtodoæ˜¯åœ¨æ‰§è¡Œ<code>tda</code>æ—¶ï¼Œåœ¨æ‰§è¡Œç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶<code>.todo</code>æ¥è®°å½•todo notesï¼Œæ‰§è¡Œå…¶ä»–æ“ä½œæ—¶ä¹Ÿæ˜¯è¯»å–æ‰§è¡Œç›®å½•ä¸‹çš„<code>.todo</code>æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯æ¯ä¸ªæ‰§è¡Œç›®å½•æœ‰è‡ªå·±çš„todo listã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå…¨å±€çš„todo listï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>-G</code>å‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-G, --global            Use the database specified by the --global-database option. Defaults to ~/.todo_global.</span><br></pre></td></tr></table></figure><p><code>-G</code>å‚æ•°ä½¿ç”¨ <code>~/.todo_global</code>ä½œä¸ºå­˜å‚¨todo notesçš„æ•°æ®åº“ï¼Œè¿™æ ·æˆ‘ä»¬çš„todoå°±å¯ä»¥åœ¨å…¨å±€èŒƒå›´å†…ä½¿ç”¨ã€‚ä½œä¸ºæ‡’ç‹—æˆ‘å°±ç›´æ¥å°†<code>-G</code>å‚æ•°å†™å…¥äº†alias</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alias todo=&quot;todo -G&quot;</span><br><span class="line">alias tda=&quot;tda -G&quot;</span><br><span class="line">alias tdd=&quot;tdd -G&quot;</span><br><span class="line">alias tde=&quot;tde -G&quot;</span><br><span class="line">alias tdr=&quot;tdr -G&quot;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨é»˜è®¤çš„<code>~/.todo_global</code>æ–‡ä»¶ä½œä¸ºå…¨å±€æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>--global-database</code>æŒ‡å®šå…¨å±€æ•°æ®åº“çš„æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--global-database ARG   Specify the database to use if the -G (--global) parameter is used.</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä¸€æ¬¾è¿è¡Œäºç»ˆç«¯çš„todoç®¡ç†å·¥å…·</summary>
    
    
    
    <category term="Linux" scheme="https://spike1337.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://spike1337.github.io/tags/Linux/"/>
    
    <category term="tools" scheme="https://spike1337.github.io/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL Â· æºç è§£æ Â· MVCCæœºåˆ¶</title>
    <link href="https://spike1337.github.io/2023/02/06/mvcc-source-code/"/>
    <id>https://spike1337.github.io/2023/02/06/mvcc-source-code/</id>
    <published>2023-02-06T06:36:45.000Z</published>
    <updated>2023-08-24T01:54:42.631Z</updated>
    
    <content type="html"><![CDATA[<p>PostgreSQLé‡‡ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰æ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚æ£€ç´¢æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½åªæ˜¯ä¸€æ®µæ—¶é—´ä¹‹å‰çš„æ•°æ®å¿«ç…§ã€‚MVCCå¹¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„å¹¶å‘æ§åˆ¶æƒ…å†µï¼Œéœ€è¦ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“çš„é”æœºåˆ¶æ¥ä¿è¯äº‹åŠ¡çš„å¹¶å‘ï¼Œå› æ­¤åœ¨PostgreSQLé‡Œä¹Ÿæœ‰è¡¨å’Œè¡Œçº§åˆ«çš„é”å®šæœºåˆ¶ã€‚æ­¤å¤–PostgreSQLè¿˜æä¾›äº†ä¼šè¯é”æœºåˆ¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒä¸€æ¬¡å¯¹æŸä¸ªå¯¹è±¡åŠ é”ä¿è¯å¯¹äºå¤šä¸ªäº‹åŠ¡éƒ½æœ‰æ•ˆã€‚</p><h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«">äº‹åŠ¡éš”ç¦»çº§åˆ«</h2><h3 id="æ ‡å‡†äº‹åŠ¡éš”ç¦»çº§åˆ«">æ ‡å‡†äº‹åŠ¡éš”ç¦»çº§åˆ«</h3><p>ä¸‰ä¸ªå¿…é¡»åœ¨å¹¶è¡Œçš„äº‹åŠ¡ä¹‹é—´é¿å…çš„ç°è±¡ï¼š</p><ul class="lvl-0"><li class="lvl-4"><p>è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªæœªæäº¤çš„å¹¶è¡Œäº‹åŠ¡å†™çš„æ•°æ®</p></li><li class="lvl-4"><p>ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€ä¸ªæ•°æ®å‰åè¯»å–ä¸¤æ¬¡ï¼Œå‘ç°è¯¥æ•°æ®å·²ç»è¢«å¦ä¸€ä¸ªå·²æäº¤çš„æ•°æ®ä¿®æ”¹è¿‡</p></li><li class="lvl-4"><p>å¹»è¯»ï¼šäº‹åŠ¡Aè¯»å–æŸä¸€èŒƒå›´å†…çš„æ•°æ®è¡Œæ—¶ï¼Œäº‹åŠ¡Båœ¨è¯¥èŒƒå›´å†…æ’å…¥æ–°è¡Œï¼Œå½“äº‹åŠ¡Aå†æ¬¡è¯»å–è¯¥èŒƒå›´å†…çš„æ•°æ®æ—¶æ— æ³•æŸ¥è¯¢åˆ°æ–°å¢çš„æ•°æ®</p></li></ul><p>å››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š</p><table><thead><tr><th>éš”ç¦»çº§åˆ«</th><th>è„è¯»</th><th>ä¸å¯é‡å¤è¯»</th><th>å¹»è¯»</th></tr></thead><tbody><tr><td>è¯»æœªæäº¤</td><td>â­•</td><td>â­•</td><td>â­•</td></tr><tr><td>è¯»å·²æäº¤</td><td>âŒ</td><td>â­•</td><td>â­•</td></tr><tr><td>å¯é‡å¤è¯»</td><td>âŒ</td><td>âŒ</td><td>â­•</td></tr><tr><td>å¯ä¸²è¡ŒåŒ–</td><td>âŒ</td><td>âŒ</td><td>âŒ</td></tr></tbody></table><h3 id="PostgreSQLçš„éš”ç¦»çº§åˆ«">PostgreSQLçš„éš”ç¦»çº§åˆ«</h3><p>åœ¨PostgreSQLä¸­ï¼Œå¯ä»¥è¯·æ±‚ä»¥ä¸Šå››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„ä»»æ„ä¸€ç§ã€‚ä½†æ˜¯åœ¨å†…éƒ¨ï¼Œåªæœ‰ä¸¤ç§ç‹¬ç«‹çš„éš”ç¦»çº§åˆ«ï¼šè¯»å·²æäº¤å’Œå¯ä¸²è¡ŒåŒ–ã€‚å³é€‰æ‹©è¯»æœªæäº¤çš„éš”ç¦»çº§åˆ«ï¼Œå®é™…ç”¨çš„æ˜¯è¯»å·²æäº¤ã€‚ä¸‹é¢ä»‹ç»PostgreSQLå®šä¹‰çš„ä¸¤ç§éš”ç¦»çº§åˆ«ï¼š</p><ul class="lvl-0"><li class="lvl-4"><p><strong>è¯»å·²æäº¤</strong>ï¼šç¼ºçœéš”ç¦»çº§åˆ«ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è¿è¡Œåœ¨è¿™ä¸ªéš”ç¦»çº§åˆ«æ—¶ï¼Œä¸€ä¸ª<code>SELECT</code>æŸ¥è¯¢åªèƒ½çœ‹åˆ°æŸ¥è¯¢å¼€å§‹ä¹‹å‰æäº¤çš„æ•°æ®ã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡åœ¨å¯¹åŒä¸€å…ƒç»„è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡å›æ»šï¼Œåˆ™å¿½ç•¥å…¶ä½œç”¨ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ç»§ç»­æ›´æ–°è¯¥å…ƒç»„ï¼›ç¬¬äºŒä¸ªäº‹åŠ¡åˆ™ç­‰å¾…ç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤æˆ–å›æ»šã€‚å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤ï¼Œç³»ç»Ÿé‡æ–°è®¡ç®—æŸ¥è¯¢æ¡ä»¶ï¼Œå¦‚æœç¬¦åˆåˆ™ç»§ç»­æ›´æ–°æ“ä½œã€‚</p></li><li class="lvl-4"><p><strong>å¯ä¸²è¡ŒåŒ–</strong>ï¼šæä¾›äº†æœ€ä¸¥æ ¼çš„äº‹åŠ¡éš”ç¦»ã€‚æ¨¡æ‹Ÿä¸²è¡Œçš„äº‹åŠ¡æ‰§è¡Œã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡åœ¨å¯¹åŒä¸€å…ƒç»„è¿›è¡Œæ›´æ–°ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡åˆ™ç­‰å¾…ç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤æˆ–å›æ»šã€‚å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡å›æ»šï¼Œåˆ™å¿½ç•¥å…¶ä½œç”¨ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ç»§ç»­æ›´æ–°è¯¥å…ƒç»„ï¼›å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆå¯ä¸²è¡ŒåŒ–äº‹åŠ¡å›æ»šï¼Œä»å¤´å¼€å§‹è¿›è¡Œæ•´ä¸ªäº‹åŠ¡ã€‚</p></li></ul><p>åœ¨PostgreSQLç³»ç»Ÿä¸­ï¼Œäº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ‰€æ¶‰åŠçš„æœ€å°å¯¹è±¡æ˜¯å…ƒç»„ï¼Œæ‰€ä»¥å¯¹å…ƒç»„çš„æ“ä½œéœ€è¦å®æ–½è®¿é—®æ§åˆ¶ã€‚è¿™ä¸ªæ“ä½œæ˜¯é€šè¿‡é”æ“ä½œä»¥åŠMVCCç›¸å…³çš„æ“ä½œæ¥å®ç°çš„</p><h2 id="MVCCæ¶æ„">MVCCæ¶æ„</h2><p>åœ¨å†…éƒ¨ï¼ŒPostgreSQLåˆ©ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼ŒMultiVersion Concurrency Controlï¼‰æ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚å³å½“æ£€ç´¢æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„åªæ˜¯ä¸€æ®µæ—¶é—´ä¹‹å‰çš„äº‹åŠ¡å¿«ç…§ï¼Œè€Œä¸æ˜¯æ•°æ®çš„å½“å‰çŠ¶æ€ã€‚è¿™æ ·å¯¹æ¯ä¸ªæ•°æ®åº“ä¼šè¯è¿›è¡Œäº‹åŠ¡éš”ç¦»ï¼Œå°±å¯ä»¥é¿å…ä¸€ä¸ªäº‹åŠ¡çœ‹åˆ°å…¶ä»–å¹¶å‘æ—¶çš„æ›´æ–°å¯¼è‡´ä¸ä¸€è‡´çš„æ•°æ®</p><h3 id="å…ƒç»„ç›¸å…³æ•°æ®ç»“æ„">å…ƒç»„ç›¸å…³æ•°æ®ç»“æ„</h3><p>åœ¨PostgreSQLç³»ç»Ÿä¸­ï¼Œæ›´æ–°æ•°æ®å¹¶ä¸æ˜¯ç”¨æ–°å€¼è¦†ç›–æ—§å€¼ï¼Œè€Œæ˜¯åœ¨è¡¨ä¸­å¼€è¾Ÿä¸€ç‰‡ç©ºé—´æ¥å­˜æ”¾æ–°çš„å…ƒç»„ï¼Œæ–°å€¼ä¸æ—§å€¼åŒæ—¶å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œåªæ˜¯é€šè¿‡è®¾ç½®ä¸€äº›å‚æ•°è®©ç³»ç»Ÿå¯ä»¥è¯†åˆ«ä»–ä»¬</p><p>å…ƒç»„çš„äº‹åŠ¡å’Œå‘½ä»¤æ§åˆ¶ä¿¡æ¯å­˜å‚¨åœ¨<code>HeapTupleFields</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">HeapTupleFields</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    TransactionId t_xmin;<span class="comment">// åˆ›å»ºæ­¤tupleçš„XID</span></span><br><span class="line">    TransactionId t_xmax;<span class="comment">// åˆ é™¤æ­¤tupleçš„XID</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        CommandIdt_cid;<span class="comment">// åˆ›å»ºæˆ–åˆ é™¤tupleçš„CIDï¼Œä¹Ÿå¯èƒ½äºŒè€…éƒ½ä¿å­˜</span></span><br><span class="line">        TransactionId t_xvac;<span class="comment">// æ¸…ç†æ“ä½œçš„äº‹åŠ¡ID</span></span><br><span class="line">    &#125;t_field3;</span><br><span class="line">&#125; HeapTupleFields;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä¸€ä¸ªäº‹åŠ¡ç¡®å®åˆ›å»ºå¹¶åˆ é™¤äº†åŒä¸€ä¸ªå…ƒç»„ï¼Œåˆ™ä½¿ç”¨ä¸€ä¸ªCombo Command ID æ¥ä¿å­˜Cminå’ŒCmax</p></li></ul><p>å…ƒç»„çš„ç›¸å…³æ§åˆ¶ä¿¡æ¯å­˜å‚¨åœ¨å…ƒç»„çš„å¤´éƒ¨<code>HeapTupleHeaderData</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">HeapTupleHeaderData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">HeapTupleFields t_heap;</span><br><span class="line">DatumTupleFields t_datum;</span><br><span class="line">&#125;t_choice;</span><br><span class="line"></span><br><span class="line">ItemPointerData t_ctid;<span class="comment">// æœ¬å…ƒç»„æˆ–æ›´æ–°å…ƒç»„çš„å½“å‰TID</span></span><br><span class="line">uint16t_infomask2;<span class="comment">// å±æ€§ã€æ ‡è®°ä½æ•°é‡æ ‡è®°ä½</span></span><br><span class="line">uint16t_infomask;<span class="comment">// å…ƒç»„äº‹åŠ¡ä¿¡æ¯æ ‡è®°ä½</span></span><br><span class="line">uint8t_hoff;<span class="comment">// å¤´éƒ¨é•¿åº¦</span></span><br><span class="line">bits8t_bits[FLEXIBLE_ARRAY_MEMBER];<span class="comment">// æ ‡è®°ä½œç”¨çš„å¡«å……ä½</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å…¶ä¸­ï¼Œ<code>t_ctid</code>å½“å…ƒç»„è¢«ä¿å­˜åœ¨ç£ç›˜ä¸­æ—¶è¢«åˆå§‹åŒ–ä¸ºè‡ªå·±çš„å®é™…å­˜å‚¨ä½ç½®ã€‚å¦‚æœå…ƒç»„è¢«æ›´æ–°ï¼Œ<code>t_cid</code>æŒ‡å‘æ›´æ–°åçš„æ–°å…ƒç»„ã€‚å¦‚æœè¦æ‰¾åˆ°æŸä¸ªå…ƒç»„çš„æœ€æ–°ç‰ˆæœ¬ï¼Œåªéœ€éå†ç”±<code>t_ctid</code>æ„æˆçš„é“¾è¡¨å³å¯</p></li><li class="lvl-2"><p><code>t_infomask</code>å­—æ®µè¡¨ç¤ºå½“å‰å…ƒç»„çš„äº‹åŠ¡ä¿¡æ¯</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_HASNULL0x0001<span class="comment">// ç©ºå­—æ®µæ ‡è®°ä½</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_HASVARWIDTH0x0002<span class="comment">// å˜é•¿å­—æ®µæ ‡è®°ä½</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_HASEXTERNAL0x0004<span class="comment">// å¤–éƒ¨å­˜å‚¨å­—æ®µæ ‡è®°ä½</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_HASOID_OLD0x0008<span class="comment">// æœ‰OIDå­—æ®µ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMAX_KEYSHR_LOCK0x0010<span class="comment">// xmaxæ˜¯å…±äº«é”</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_COMBOCID0x0020<span class="comment">// t_cidæ˜¯combo cid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMAX_EXCL_LOCK0x0040<span class="comment">// xmaxæ˜¯æ’ä»–é”</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMAX_LOCK_ONLY0x0080<span class="comment">// xmaxå¦‚æœæœ‰æ•ˆåˆ™åªæ˜¯ä¸€ä¸ªé”</span></span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// xmax is a shared locker</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMAX_SHR_LOCK(HEAP_XMAX_EXCL_LOCK | HEAP_XMAX_KEYSHR_LOCK)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_LOCK_MASK(HEAP_XMAX_SHR_LOCK | HEAP_XMAX_EXCL_LOCK | \</span></span><br><span class="line"><span class="meta"> HEAP_XMAX_KEYSHR_LOCK)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMIN_COMMITTED0x0100<span class="comment">// t_xminå·²æäº¤</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMIN_INVALID0x0200<span class="comment">// t_xminæ— æ•ˆ/ä¸­æ–­</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMIN_FROZEN(HEAP_XMIN_COMMITTED|HEAP_XMIN_INVALID)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMAX_COMMITTED0x0400<span class="comment">// t_xmaxå·²æäº¤</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMAX_INVALID0x0800<span class="comment">// t_xmaxæ— æ•ˆ/ä¸­æ–­</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XMAX_IS_MULTI0x1000<span class="comment">// t_xmaxæ˜¯ç»„åˆäº‹åŠ¡</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_UPDATED0x2000<span class="comment">// æ›´æ–°åçš„æ–°å…ƒç»„</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_MOVED_OFF0x4000<span class="comment">// è¢«ä¹‹å‰ç‰ˆæœ¬çš„VACUUM FULLç§»åˆ°å…¶ä»–åœ°æ–¹ï¼Œç”¨ä»¥å…¼å®¹äºŒè¿›åˆ¶å‡çº§</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_MOVED_IN0x8000<span class="comment">// è¢«ä¹‹å‰ç‰ˆæœ¬çš„VACUUM FULLä»å…¶ä»–åœ°æ–¹ç§»å…¥ï¼Œç”¨ä»¥å…¼å®¹äºŒè¿›åˆ¶å‡çº§</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_MOVED (HEAP_MOVED_OFF | HEAP_MOVED_IN)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEAP_XACT_MASK0xFFF0<span class="comment">// å¯è§æ€§ç›¸å…³æ ‡è®°</span></span></span><br></pre></td></tr></table></figure><h3 id="MVCC">MVCC</h3><p>MVCCåŸºæœ¬åŸç†å¦‚å›¾ã€‚æœ‰ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡T1ï¼ŒT2ï¼ŒT1å°†å…ƒç»„Cæ›´æ–°ä¸ºCâ€˜ï¼Œä½†å¹¶æ²¡æœ‰æäº¤ã€‚æ­¤æ—¶T2è¦å¯¹è¯¥å…ƒç»„è¿›è¡ŒæŸ¥è¯¢ï¼Œä¼šé€šè¿‡Cå’ŒCâ€™çš„å¤´éƒ¨ä¿¡æ¯çš„Xminå’ŒXmaxä»¥åŠt_infomaskæ¥åˆ¤æ–­å“ªä¸ªä¸ºå¯¹å½“å‰äº‹åŠ¡çš„æœ‰æ•ˆç‰ˆæœ¬</p><p><img src="/uploads/pg_mvcc_base.png" alt="MVCCåŸºæœ¬åŸç†"></p><h4 id="MVCCä¸å¿«ç…§">MVCCä¸å¿«ç…§</h4><p>è®¨è®ºMVCCçš„åˆ¤æ–­é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å¿«ç…§ï¼ˆsnapshotï¼‰</p><p>å¿«ç…§ï¼ˆsnapshotï¼‰è®°å½•äº†æ•°æ®åº“å½“å‰æŸä¸ªæ—¶åˆ»çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼Œé€šè¿‡å¿«ç…§ç¡®å®šæŸä¸ªå…ƒç»„çš„ç‰ˆæœ¬å¯¹äºå½“å‰å¿«ç…§æ˜¯å¦å¯è§ã€‚å¿«ç…§å®šä¹‰åœ¨<code>SnapshotData</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">SnapshotData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    SnapshotType snapshot_type; <span class="comment">// å¿«ç…§ç±»å‹</span></span><br><span class="line"></span><br><span class="line">    TransactionId xmin;         <span class="comment">// æ‰€æœ‰XID &lt; xminå¯¹å½“å‰å¿«ç…§å¯è§</span></span><br><span class="line">    TransactionId xmax;         <span class="comment">// æ‰€æœ‰XID &gt;= xmaxå¯¹å½“å‰å¿«ç…§å¯è§</span></span><br><span class="line"></span><br><span class="line">    TransactionId *xip;         <span class="comment">// å½“å‰æ´»è·ƒäº‹åŠ¡çš„é“¾è¡¨</span></span><br><span class="line">    uint32      xcnt;           <span class="comment">// å½“å‰æ´»è·ƒäº‹åŠ¡é“¾è¡¨é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">    TransactionId *subxip;      <span class="comment">// å½“å‰æ´»è·ƒå­äº‹åŠ¡é“¾è¡¨</span></span><br><span class="line">    int32       subxcnt;        <span class="comment">// å½“å‰æ´»è·ƒå­äº‹åŠ¡é“¾è¡¨çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">bool</span>        suboverflowed;  <span class="comment">// æ´»è·ƒå­äº‹åŠ¡æ•°ç»„æ˜¯å¦ç§»é™¤</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span>        takenDuringRecovery;    <span class="comment">// æ˜¯å¦æ˜¯åœ¨Recoveryä¸­çš„å¿«ç…§</span></span><br><span class="line">    <span class="type">bool</span>        copied;         <span class="comment">// é™æ€å¿«ç…§åˆ™ä¸ºfalse</span></span><br><span class="line"></span><br><span class="line">    CommandId   curcid;         <span class="comment">// æ‰€æœ‰CID &lt; curcidæ˜¯å¯è§çš„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// HeapTupleSatisfiesDirtyä¸­çš„é¢å¤–è¿”å›å€¼ï¼Œå¹¶æ²¡æœ‰åœ¨MVCCå¿«ç…§ä¸­ä½¿ç”¨</span></span><br><span class="line">    uint32      speculativeToken;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”±å¿«ç…§ç®¡ç†å™¨ä½¿ç”¨çš„ä¿¡æ¯</span></span><br><span class="line">    uint32      active_count;   <span class="comment">// åœ¨æ´»è·ƒå¿«ç…§é“¾è¡¨é‡Œçš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    uint32      regd_count;     <span class="comment">// åœ¨å·²æ³¨å†Œçš„å¿«ç…§é“¾è¡¨é‡Œçš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    pairingheap_node ph_node;   <span class="comment">// å·²æ³¨å†Œçš„å¿«ç…§é“¾è¡¨</span></span><br><span class="line"></span><br><span class="line">    TimestampTz whenTaken;      <span class="comment">// è®°å½•å¿«ç…§çš„æ—¶é—´æˆ³</span></span><br><span class="line">    XLogRecPtr  lsn;            <span class="comment">// è®°å½•å¿«ç…§æ—¶åœ¨WALä¸­çš„ä½ç½®</span></span><br><span class="line">&#125; SnapshotData;</span><br></pre></td></tr></table></figure><p>åœ¨PostgreSQLä¸­æœ‰é»˜è®¤çš„7ç§å½¢å¼å¿«ç…§ï¼ˆ15.1ï¼‰ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">SnapshotType</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// å…ƒç»„å¯¹äºç»™å®šçš„MVCCå¿«ç…§æœ‰æ•ˆ</span></span><br><span class="line">    SNAPSHOT_MVCC = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…ƒç»„å¯¹äºè‡ªèº«æœ‰æ•ˆ</span></span><br><span class="line">    SNAPSHOT_SELF,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»»ä½•å…ƒç»„éƒ½æ˜¯å¯è§çš„</span></span><br><span class="line">    SNAPSHOT_ANY,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…ƒç»„ä½œä¸ºTOASTè¡Œ æœ‰æ•ˆ</span></span><br><span class="line">    SNAPSHOT_TOAST,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢ä¸‰ä¸ªä¸å¤ªå¥½è§£é‡Šï¼Œç›´æ¥è´´åŸæ–‡</span></span><br><span class="line">    <span class="comment">/*-------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">     * A tuple is visible iff the tuple is valid including effects of open</span></span><br><span class="line"><span class="comment">     * transactions.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Here, we consider the effects of:</span></span><br><span class="line"><span class="comment">     * - all committed and in-progress transactions (as of the current instant)</span></span><br><span class="line"><span class="comment">     * - previous commands of this transaction</span></span><br><span class="line"><span class="comment">     * - changes made by the current command</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * This is essentially like SNAPSHOT_SELF as far as effects of the current</span></span><br><span class="line"><span class="comment">     * transaction and committed/aborted xacts are concerned.  However, it</span></span><br><span class="line"><span class="comment">     * also includes the effects of other xacts still in progress.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * A special hack is that when a snapshot of this type is used to</span></span><br><span class="line"><span class="comment">     * determine tuple visibility, the passed-in snapshot struct is used as an</span></span><br><span class="line"><span class="comment">     * output argument to return the xids of concurrent xacts that affected</span></span><br><span class="line"><span class="comment">     * the tuple.  snapshot-&gt;xmin is set to the tuple&#x27;s xmin if that is</span></span><br><span class="line"><span class="comment">     * another transaction that&#x27;s still in progress; or to</span></span><br><span class="line"><span class="comment">     * InvalidTransactionId if the tuple&#x27;s xmin is committed good, committed</span></span><br><span class="line"><span class="comment">     * dead, or my own xact.  Similarly for snapshot-&gt;xmax and the tuple&#x27;s</span></span><br><span class="line"><span class="comment">     * xmax.  If the tuple was inserted speculatively, meaning that the</span></span><br><span class="line"><span class="comment">     * inserter might still back down on the insertion without aborting the</span></span><br><span class="line"><span class="comment">     * whole transaction, the associated token is also returned in</span></span><br><span class="line"><span class="comment">     * snapshot-&gt;speculativeToken.  See also InitDirtySnapshot().</span></span><br><span class="line"><span class="comment">     * -------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SNAPSHOT_DIRTY,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * A tuple is visible iff it follows the rules of SNAPSHOT_MVCC, but</span></span><br><span class="line"><span class="comment">     * supports being called in timetravel context (for decoding catalog</span></span><br><span class="line"><span class="comment">     * contents in the context of logical decoding).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// å…ƒç»„å¯¹MVCCå¿«ç…§æœ‰æ•ˆï¼Œä¸”æ”¯æŒé€»è¾‘å¤åˆ¶</span></span><br><span class="line">    SNAPSHOT_HISTORIC_MVCC,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * A tuple is visible iff the tuple might be visible to some transaction;</span></span><br><span class="line"><span class="comment">     * false if it&#x27;s surely dead to everyone, i.e., vacuumable.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * For visibility checks snapshot-&gt;min must have been set up with the xmin</span></span><br><span class="line"><span class="comment">     * horizon to use.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// å…ƒç»„å¯¹æŸäº›äº‹åŠ¡å¯è§ï¼Œå¦‚æœå¯¹æ‰€æœ‰äº‹åŠ¡éƒ½æ˜¯dead tupleï¼Œä¹Ÿå°±æ˜¯vacuumableï¼Œåˆ™è¿”å›false</span></span><br><span class="line">    SNAPSHOT_NON_VACUUMABLE</span><br><span class="line">&#125; SnapshotType;</span><br></pre></td></tr></table></figure><h3 id="MVCCæœºåˆ¶çš„å®ç°">MVCCæœºåˆ¶çš„å®ç°</h3><p>ä»¥å‡½æ•°<code>HeapTupleSatisfiesSelf</code>ä¸ºä¾‹ï¼Œä¸‹é¢ä»‹ç»MVCCæœºåˆ¶çš„å…·ä½“å®ç°ã€‚å¦‚æœè¿”å›å€¼ä¸ºTrueï¼Œåˆ™è¯¥å…ƒç»„æ˜¯å¯è§çš„ã€‚åˆ¤æ–­æ—¶ä¼šè€ƒè™‘ä¸‰ä¸ªæ–¹é¢çš„å› ç´ ï¼šæ‰€æœ‰å·²æäº¤çš„äº‹åŠ¡ï¼Œå½“å‰äº‹åŠ¡å‰çš„æ‰€æœ‰å‘½ä»¤ä»¥åŠå½“å‰å‘½ä»¤å‰çš„æ‰€æœ‰æ“ä½œã€‚æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>æ£€æŸ¥Xminæ˜¯å¦ä¸ºå·²æäº¤ï¼Œå¦‚æœå…ƒç»„çš„Xminè¿˜æœªæäº¤</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Xminæœªæäº¤</span></span><br><span class="line"><span class="keyword">if</span> (!HeapTupleHeaderXminCommitted(tuple))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Xminæ— æ•ˆï¼Œå…ƒç»„ä¸å¯è§</span></span><br><span class="line">    <span class="keyword">if</span> (HeapTupleHeaderXminInvalid(tuple))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¼å®¹äºŒè¿›åˆ¶å‡çº§</span></span><br><span class="line">    <span class="keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_MOVED_OFF)</span><br><span class="line">    &#123;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¼å®¹äºŒè¿›åˆ¶å‡çº§</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_MOVED_IN)</span><br><span class="line">    &#123;</span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Xminä¸ºå½“å‰äº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmin(tuple)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Xmaxæ— æ•ˆï¼Œåˆ™XIDæ— æ•ˆï¼Œå¯è§</span></span><br><span class="line">        <span class="keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_INVALID)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Xmaxè¢«é”å®šï¼Œå³å…ƒç»„è¢«é”å®šï¼Œå¯è§</span></span><br><span class="line">        <span class="keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Xmaxæ˜¯ç»„åˆäº‹åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_IS_MULTI)</span><br><span class="line">        &#123;</span><br><span class="line">            xmax = HeapTupleGetUpdateXid(tuple);</span><br><span class="line">            <span class="comment">// æ›´æ–°å­äº‹åŠ¡å¿…é¡»å·²å›æ»šï¼Œå› ä¸ºå‰ææ˜¯Xminæœªæäº¤</span></span><br><span class="line">            <span class="keyword">if</span> (!TransactionIdIsCurrentTransactionId(xmax))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Xmaxä¸ºå½“å‰äº‹åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (!TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmax(tuple)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// åˆ é™¤å­äº‹åŠ¡å¿…é¡»å·²ç»ˆæ­¢</span></span><br><span class="line">            SetHintBits(tuple, buffer, HEAP_XMAX_INVALID,</span><br><span class="line">                        InvalidTransactionId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Xminæ­£åœ¨æŸä¸ªåç«¯è¿›ç¨‹ä¸­è¿è¡Œ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (TransactionIdIsInProgress(HeapTupleHeaderGetRawXmin(tuple)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// Xminå·²ç»è¢«æäº¤</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (TransactionIdDidCommit(HeapTupleHeaderGetRawXmin(tuple)))</span><br><span class="line">        SetHintBits(tuple, buffer, HEAP_XMIN_COMMITTED,</span><br><span class="line">                    HeapTupleHeaderGetRawXmin(tuple));</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å¦åˆ™ä¸€å®šæ˜¯ä¸­æ­¢æˆ–å´©æºƒ</span></span><br><span class="line">        SetHintBits(tuple, buffer, HEAP_XMIN_INVALID,</span><br><span class="line">                    InvalidTransactionId);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Xminå·²æäº¤ã€‚å¦‚æœXmaxæ— æ•ˆæˆ–ä¸­æ–­ï¼Œå…ƒç»„å¯è§</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_INVALID)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Xminå·²æäº¤ï¼ŒXmaxå·²æäº¤</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_COMMITTED)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœXmaxè¢«é”å®šï¼Œå¯è§</span></span><br><span class="line">    <span class="keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Xminå·²æäº¤ï¼ŒXmaxä¸ºç»„åˆäº‹åŠ¡</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_IS_MULTI)</span><br><span class="line">&#123;</span><br><span class="line">    TransactionId xmax;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Xmaxè¢«é”å®šï¼Œå¯è§</span></span><br><span class="line">    <span class="keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    xmax = HeapTupleGetUpdateXid(tuple);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Xmaxæ˜¯å½“å‰äº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (TransactionIdIsCurrentTransactionId(xmax))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// Xmaxæ­£åœ¨è¢«æŸä¸ªåç«¯è¿›ç¨‹æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (TransactionIdIsInProgress(xmax))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// Xmaxå·²ç»è¢«æäº¤</span></span><br><span class="line">    <span class="keyword">if</span> (TransactionIdDidCommit(xmax))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// å¦åˆ™äº‹åŠ¡è¢«ä¸­æ–­æˆ–å´©æºƒ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Xminå·²æäº¤ï¼ŒXmaxä¸æ˜¯ç»„åˆäº‹åŠ¡</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Xmaxæ˜¯å½“å‰äº‹åŠ¡</span></span><br><span class="line"><span class="keyword">if</span> (TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmax(tuple)))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Xmaxæ­£åœ¨è¢«æŸä¸ªåç«¯è¿›ç¨‹æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">if</span> (TransactionIdIsInProgress(HeapTupleHeaderGetRawXmax(tuple)))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// Xmaxå·²ç»è¢«æäº¤</span></span><br><span class="line"><span class="keyword">if</span> (!TransactionIdDidCommit(HeapTupleHeaderGetRawXmax(tuple)))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// it must have aborted or crashed</span></span><br><span class="line">    SetHintBits(tuple, buffer, HEAP_XMAX_INVALID,</span><br><span class="line">                InvalidTransactionId);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Xmaxè¢«é”å®š</span></span><br><span class="line"><span class="keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))</span><br><span class="line">&#123;</span><br><span class="line">    SetHintBits(tuple, buffer, HEAP_XMAX_INVALID,</span><br><span class="line">                InvalidTransactionId);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SNAPSHOT_SELF</code>æ‰€å¯¹åº”çš„MVCCåˆ¤æ–­æœºåˆ¶å¦‚ä¸Šï¼Œå…¶ä»–snapshotç±»å‹å¯¹åº”çš„åˆ¤æ–­é€»è¾‘ç±»ä¼¼ï¼Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;PostgreSQLé‡‡ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰æ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚æ£€ç´¢æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½åªæ˜¯ä¸€æ®µæ—¶é—´ä¹‹å‰çš„æ•°æ®å¿«ç…§ã€‚MVCCå¹¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„å¹¶å‘æ§åˆ¶æƒ…å†µï¼Œéœ€è¦ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“çš„é”æœºåˆ¶æ¥ä¿è¯äº‹åŠ¡çš„å¹¶å‘ï¼Œå› æ­¤åœ¨PostgreSQLé‡Œä¹Ÿæœ‰è¡¨å’Œè¡Œçº§åˆ«çš„é”å®šæœºåˆ¶ã€‚æ­¤å¤–Post</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="transaction" scheme="https://spike1337.github.io/tags/transaction/"/>
    
    <category term="MVCC" scheme="https://spike1337.github.io/tags/MVCC/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL Â· æºç è§£æ Â· WALæ—¥å¿—</title>
    <link href="https://spike1337.github.io/2023/02/03/pg-wal-source-code/"/>
    <id>https://spike1337.github.io/2023/02/03/pg-wal-source-code/</id>
    <published>2023-02-03T05:44:58.000Z</published>
    <updated>2023-08-24T01:54:50.544Z</updated>
    
    <content type="html"><![CDATA[<p>Postgresql ä½¿ç”¨ wal æ—¥å¿—ä¿å­˜æ¯ä¸€æ¬¡çš„æ•°æ®ä¿®æ”¹ï¼Œè¿™æ ·ä¿è¯äº†æ•°æ®åº“å³ä½¿æ„å¤–å®•æœºï¼Œä¹Ÿèƒ½åˆ©ç”¨å®ƒå‡†ç¡®çš„æ¢å¤æ•°æ®ã€‚wal æ—¥å¿—ä¹Ÿå«åš xlogï¼Œåœ¨ 9.4 ç‰ˆæœ¬ä¹‹åä½œäº†é‡å¤§æ›´æ–°ï¼Œæœ¬ç¯‡åªè®²è§£æœ€æ–°ç‰ˆçš„æ ¼å¼ã€‚wal æ—¥å¿—è¢«ç”¨äºå¤šä¸ªæ–¹é¢ï¼Œæ¯”å¦‚ä¿®æ”¹æ•°æ®ï¼Œä¿®æ”¹ç´¢å¼•ç­‰ï¼Œæ¯ç§ç”¨é€”çš„æ ¼å¼éƒ½ä¸ç›¸åŒï¼Œä½†æ˜¯æ„å»ºæ–¹å¼æ˜¯ç›¸åŒçš„ã€‚</p><h2 id="WALæ—¥å¿—æ–‡ä»¶">WALæ—¥å¿—æ–‡ä»¶</h2><h3 id="WALæ®µæ–‡ä»¶">WALæ®µæ–‡ä»¶</h3><p>WALæ—¥å¿—æ–‡ä»¶å­˜æ”¾åœ¨sd_walç›®å½•ä¸‹ï¼Œæ¯ä¸ªæ–‡ä»¶å¤§å°é»˜è®¤ä¸º16Mï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000B6</span><br><span class="line">-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000B7</span><br><span class="line">-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000B8</span><br><span class="line">-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000B9</span><br><span class="line">-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000BA</span><br><span class="line">-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000BB</span><br><span class="line">drwx------  2 zhangze  zhangze        68 Oct  8 10:53 archive_status</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶åç”±16è¿›åˆ¶çš„24ä¸ªå­—ç¬¦ç»„æˆï¼Œæ¯8ä¸ªå­—ç¬¦ä¸ºä¸€ç»„ï¼Œæ¯ç»„æ„ä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">00000001 00000000 000000B6</span><br><span class="line"> æ—¶é—´çº¿    LogID    LogSeg</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><strong>æ—¶é—´çº¿</strong>ï¼šæ—¶é—´çº¿IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0xFFFFFFFFã€‚æ•°æ®åº“å»ºå¥½åçš„ç¬¬ä¸€ä¸ªWALæ—¥å¿—æ–‡ä»¶çš„æ—¶é—´çº¿IDä»1å¼€å§‹</p></li><li class="lvl-2"><p><strong>LogID</strong>ï¼šé€»è¾‘æ–‡ä»¶IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0xFFFFFFFF</p></li><li class="lvl-2"><p><strong>LogSeg</strong>ï¼šç‰©ç†æ–‡ä»¶IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0x000000FFã€‚æ•°æ®åº“å»ºå¥½åçš„ç¬¬ä¸€ä¸ªWALæ—¥å¿—æ–‡ä»¶çš„LogSegä»1å¼€å§‹ï¼Œè¾¾åˆ°æœ€å¤§å€¼ï¼ˆ0xFFï¼‰åä»0å¼€å§‹ã€‚</p></li></ul><p><strong>LSN</strong>å³æ—¥å¿—åºåˆ—å·ï¼Œè¡¨ç¤ºXLogè®°å½•åœ¨äº‹åŠ¡æ—¥å¿—æ–‡ä»¶ä¸­çš„åç§»ï¼Œä¸ºuint64å€¼ã€‚LSNç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯é€»è¾‘æ–‡ä»¶IDï¼Œç‰©ç†æ–‡ä»¶IDå’Œæ–‡ä»¶å†…åç§»é‡ã€‚LSNæ‰“å°å‡ºæ¥æ˜¯ä¸¤ä¸ª8ä½çš„åå…­è¿›åˆ¶æ•°ï¼Œå¦‚16/B374D848ã€‚ç”±ä¸“é—¨çš„ç±»å‹<code>pg_lsn</code>æ¥å­˜æ”¾LSNæ•°æ®</p><p>PG WALæ–‡ä»¶åå­—çš„å‘½åæ–¹æ³•æ˜¯åœ¨XLogFileNameå®é‡Œå®šä¹‰çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> XLogSegmentsPerXLogId(wal_segsz_bytes)  \</span></span><br><span class="line"><span class="meta">    (UINT64CONST(0x100000000) / (wal_segsz_bytes))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XLogFileName(fname, tli, logSegNo, wal_segsz_bytes) \</span></span><br><span class="line"><span class="meta">    snprintf(fname, MAXFNAMELEN, <span class="string">&quot;%08X%08X%08X&quot;</span>, tli,       \</span></span><br><span class="line"><span class="meta">             (uint32) ((logSegNo) / XLogSegmentsPerXLogId(wal_segsz_bytes)), \</span></span><br><span class="line"><span class="meta">             (uint32) ((logSegNo) % XLogSegmentsPerXLogId(wal_segsz_bytes)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XLogFileNameById(fname, tli, log, seg)  \</span></span><br><span class="line"><span class="meta">    snprintf(fname, MAXFNAMELEN, <span class="string">&quot;%08X%08X%08X&quot;</span>, tli, log, seg)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IsXLogFileName(fname) \</span></span><br><span class="line"><span class="meta">    (strlen(fname) == XLOG_FNAME_LEN &amp;&amp; \</span></span><br><span class="line"><span class="meta">     strspn(fname, <span class="string">&quot;0123456789ABCDEF&quot;</span>) == XLOG_FNAME_LEN)</span></span><br></pre></td></tr></table></figure><h3 id="WALæ–‡ä»¶å†…éƒ¨ç»“æ„">WALæ–‡ä»¶å†…éƒ¨ç»“æ„</h3><p>æ¯ä¸ªWALæ®µæ–‡ä»¶ç”±å¤šä¸ª8kbå¤§å°çš„pageç»„æˆï¼Œæ¯ä¸ªPageä¸­å­˜æ”¾ç€PageHeaderä¿¡æ¯ï¼Œä»¥åŠå¤šæ¡WAL Record</p><h4 id="Pageç»“æ„">Pageç»“æ„</h4><p>æ¯ä¸ªpageçš„ç»„ç»‡æ–¹å¼å¦‚ä¸‹å›¾ï¼š</p><p><img src="/uploads/WALPage.png" alt="WALçš„pageç»“æ„"></p><ul class="lvl-0"><li class="lvl-2"><p><strong>PageHeader</strong>ï¼šåœ¨wal pageçš„ç»„æˆä¸­æœ‰ä¸¤ç§pageheaderç»“æ„ï¼Œ<code>XLogPageHeaderData</code>å’Œ<code>XLogLongPageHeaderData</code>ã€‚æ¯ä¸ªWALæ®µçš„ç¬¬ä¸€ä¸ªPageçš„Headeråº”ä¸ºLongHeader</p></li><li class="lvl-2"><p><strong>Remain data</strong>ï¼šå­˜å‚¨ç€ä¸Šä¸€ä¸ªpageä¸­æœ€åä¸€ä¸ªRecordæ²¡æœ‰å­˜å®Œçš„æ•°æ®ï¼Œå¤§å°ä¸º<code>xlp_rem_len</code>ï¼Œå¯¹åº”pageçš„ä¸å®Œæ•´Record</p></li><li class="lvl-2"><p><strong>Record</strong>ï¼šå­˜å‚¨å…·ä½“çš„WAL Record</p></li><li class="lvl-2"><p><strong>æ— æ•°æ®åŒºåŸŸ</strong>ï¼šä¸€ä¸ªWAL Recordçš„å¤´éƒ¨ä¿¡æ¯ä¸å…è®¸è·¨é¡µï¼Œå¦‚æœå‰©ä½™ç©ºé—´ä¸å¤Ÿå­˜å‚¨å¤´éƒ¨ä¿¡æ¯ï¼Œåˆ™èˆå¼ƒè¿™éƒ¨åˆ†ç©ºé—´</p></li></ul><h4 id="Recordç»“æ„">Recordç»“æ„</h4><p>æ¯ä¸ªWAL Recordçš„ç»“æ„å¦‚ä¸‹å›¾ï¼Œç»¿è‰²éƒ¨åˆ†ä¸ºæ•°æ®æè¿°ç»“æ„ï¼Œé»„è‰²éƒ¨åˆ†æ˜¯å®é™…ä¿å­˜çš„æ•°æ®</p><p><img src="/uploads/wal_write.png" alt="WAL_Record"></p><ul class="lvl-0"><li class="lvl-2"><p><strong>XLogRecord</strong>ï¼šä¸€ä¸ªWALè®°å½•çš„å…¥å£ï¼Œè§£æWALæ—¶ï¼Œä»è¿™ä¸ªç»“æ„ä½“å…¥æ‰‹</p></li><li class="lvl-2"><p><strong>Block</strong>ï¼šç¬¬ä¸€ä¸ªè™šçº¿æ¡†ç§°ä¸ºä¸€ä¸ªBLOCKï¼Œç”¨ä»¥æè¿°Bufferç›¸å…³çš„æ•°æ®ç»“æ„ã€‚é€šè¿‡<code>XLogRegisterBuffer()</code>å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ä¸­</p><ul class="lvl-2"><li class="lvl-6"><strong>XLogRecordBlockHeader</strong>ï¼šä¸€ä¸ªBLOCKçš„å¤´éƒ¨ä¿¡æ¯</li><li class="lvl-6"><strong>XLogRecordBlockImageHeader</strong>ï¼šå¦‚æœè¯¥WALæ˜¯fpwè®°å½•ï¼Œè¯¥ç»“æ„å­˜æ”¾fpwç›¸å…³ä¿¡æ¯<ul class="lvl-4"><li class="lvl-10">fpwï¼šFull_page_writeï¼Œå…·ä½“è§<a href="#%E6%95%B4%E9%A1%B5%E5%86%99%E5%85%A5full_write_page">æ•´é¡µå†™å…¥</a></li></ul></li><li class="lvl-6"><strong>XLogRecordBlockCompressHeader</strong>ï¼šè®°å½•holeçš„å¤§å°<ul class="lvl-4"><li class="lvl-10">holeï¼šæ•°æ®æ–‡ä»¶çš„pageä¸­ï¼Œå¯èƒ½ä¼šæœ‰ä¸€å—ç©ºç™½åŒºåŸŸï¼Œå³pointerå’Œtupleä¹‹é—´çš„åŒºåŸŸï¼Œç§°ä¸ºhole</li></ul></li><li class="lvl-6"><strong>RelFilenode</strong>ï¼šæ­¤ç»“æ„è®°å½•äº†æ­¤blockæ‰€å±çš„å…³ç³»</li><li class="lvl-6"><strong>BlockNumber</strong>ï¼šæ­¤blockè®°å½•çš„pageçš„å—å·</li></ul></li><li class="lvl-2"><p><strong>XLogRecordDataHeader(Long/short)</strong>ï¼šå½“main dataçš„å¤§å°å¤§äº255æ—¶ï¼Œä½¿ç”¨Long Header</p></li><li class="lvl-2"><p><strong>buffer data</strong>ï¼šç¬¬äºŒä¸ªè™šçº¿æ¡†éƒ¨åˆ†ï¼ŒåŒ…æ‹¬page dataå’Œtuple data</p><ul class="lvl-2"><li class="lvl-6"><strong>page data</strong>ï¼šç”±<code>XLogRegisterBuffer()</code>å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ï¼Œå­˜æ”¾buffer pageä¿¡æ¯</li><li class="lvl-6"><strong>tuple data</strong>ï¼šç”±<code>XLogRegisterBufData()</code>å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ï¼Œå­˜å‚¨äº†å®é™…çš„buffæ•°æ®å’Œå˜æ›´æ•°æ®ã€‚</li></ul></li><li class="lvl-2"><p><strong>main data</strong>ï¼šä¿å­˜ébufferæ€§çš„æ•°æ®ï¼Œç”±<code>XLogRegisterData()</code>å‡½æ•°åˆ°WALè®°å½•ï¼Œä¾‹å¦‚ç‰¹æ®Šç»“æ„ä½“ï¼Œæ—§å…ƒç»„æˆ–key</p></li></ul><h2 id="WALæ—¥å¿—å†™å…¥å®ç°">WALæ—¥å¿—å†™å…¥å®ç°</h2><p>å½“æ•°æ®åº“æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>changeå‘ç”Ÿæ—¶ï¼šå…ˆè¦å°†å˜æ›´åå†…å®¹è®¡å…¥wal bufferä¸­ï¼Œå†å°†å˜æ›´åçš„æ•°æ®å†™å…¥data bufferï¼›</p></li><li class="lvl-2"><p>commitå‘ç”Ÿæ—¶ï¼šwal bufferä¸­æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ï¼›</p></li><li class="lvl-2"><p>checkpointå‘ç”Ÿæ—¶ï¼šå°†æ‰€æœ‰data bufferåˆ·æ–°çš„ç£ç›˜ã€‚</p></li></ul><p>WALæ—¥å¿—æœºåˆ¶å°±æ˜¯å…ˆå°†å˜æ›´å†…å®¹å­˜æ”¾åˆ°wal bufferï¼Œcommitåå°†wal bufferåˆ·å…¥ç£ç›˜çš„è¿‡ç¨‹ã€‚è¿‡ç¨‹ä¸­ä¸»è¦çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">XLogBeginInsert();        <span class="comment">// è¡¨ç¤ºå¼€å§‹æ„å»º xlog</span></span><br><span class="line">XLogRegisterData();       <span class="comment">// å°†WALè®°å½•çš„ç‰¹æ®Šç»“æ„ä½“æ•°æ®æ³¨å†Œåˆ°WALï¼Œæ¯”å¦‚heap_insertä¸­çš„xl_heap_insertç»“æ„ä½“</span></span><br><span class="line">XLogRegisterBuffer();     <span class="comment">// å°†æ¶‰åŠåˆ°çš„bufæ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚heap_insertä¸­pageé¡µèµ‹äºˆregbuf-&gt;page</span></span><br><span class="line">XLogRegisterBufData();    <span class="comment">// å°†å…ƒç»„å†…å®¹æ³¨å†Œåˆ°WALè®°å½•ï¼Œæ¯”å¦‚insertè¯­å¥çš„å…ƒç»„æ•°æ®ç­‰</span></span><br><span class="line">XLogSetRecordFlags();</span><br><span class="line">XLogInsert();</span><br><span class="line">    XLogRecordAssemble();</span><br><span class="line">    XLogInsertRecord();   <span class="comment">// æ ¹æ®å½“å‰çš„æ•°æ®åº“çŠ¶æ€ï¼ŒæŠŠä¸Šè¿°å‡½æ•°æ³¨å†Œçš„æ•°æ®è¿›è¡Œç­›é€‰ç»„è£…ï¼Œæœ€ç»ˆå½¢æˆå®Œæ•´çš„walè®°å½•å¹¶å†™å…¥åˆ°walbuff</span></span><br><span class="line">PageSetLSN</span><br></pre></td></tr></table></figure><p><img src="/uploads/wal_process.png" alt="WALå®ç°è¿‡ç¨‹"></p><h3 id="æ•´é¡µå†™å…¥-Full-Write-Page">æ•´é¡µå†™å…¥(Full_Write_Page)</h3><p>å¦‚æœæ•°æ®åº“ç³»ç»Ÿåœ¨å†™å…¥è„é¡µçš„è¿‡ç¨‹ä¸­å‡ºç°æ•…éšœï¼Œä¼šå¯¼è‡´ç£ç›˜ä¸Šçš„é¡µé¢æ•°æ®æŸåï¼Œè€ŒXLOGæ˜¯æ— æ³•åœ¨æŸåçš„é¡µé¢ä¸Šé‡æ”¾çš„ï¼Œéœ€è¦æ•´é¡µå†™å…¥æ¥æ¢å¤ã€‚</p><p>å¦‚æœå¯ç”¨æ•´é¡µå†™å…¥ï¼ŒPostgreSQLä¼šåœ¨æ¯ä¸ªæ£€æŸ¥ç‚¹åï¼Œæ¯ä¸ªé¡µé¢ç¬¬ä¸€æ¬¡å˜æ›´å‘ç”Ÿå‰ï¼Œå°†æ•´ä¸ªé¡µé¢ä»¥åŠHeaderä¿¡æ¯ä½œä¸ºä¸€æ¡XLogå†™å…¥ï¼Œè¿™ä¸ªåŠŸèƒ½é»˜è®¤å¼€å¯ã€‚åœ¨æ•°æ®åº“æ¢å¤è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ£€æŸ¥åˆ°ä¸€æ¡XLogæ˜¯ä¸€ä¸ªç”¨æ¥æ•´é¡µå†™å…¥çš„å¤‡ä»½åŒºå—ï¼Œä¼šä½¿ç”¨å¦ä¸€æ¡é‡æ”¾è§„åˆ™ï¼šXLogä¼šç›´æ¥è¦†ç›–å½“å‰é¡µé¢ï¼Œæ— è§†é¡µé¢å’ŒXLogè®°å½•ä¸­çš„LSNï¼Œç„¶åå°†é¡µé¢çš„LSNæ›´æ–°ä¸ºXLogè®°å½•çš„LSN</p><h3 id="å…·ä½“æ•°æ®ç»“æ„">å…·ä½“æ•°æ®ç»“æ„</h3><h4 id="XLog-Page">XLog Page</h4><h5 id="XLogPageHeaderData">XLogPageHeaderData</h5><p>XLogæ—¥å¿—åˆ†ä¸ºå¾ˆå¤šé€»è¾‘æ®µæ–‡ä»¶ï¼Œæ¯ä¸ªæ®µæ–‡ä»¶åˆ†æˆè®¸å¤šä¸ªé¡µé¢ï¼Œæ¯ä¸ªé¡µé¢çš„å¤§å°ä¸ºä¸€ä¸ªå—çš„å¤§å°ã€‚æ¯ä¸ªæ—¥å¿—é¡µé¢éƒ½æœ‰ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogPageHeaderData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    uint16xlp_magic;<span class="comment">// æ ¡éªŒä½ï¼Œæ£€éªŒWALçš„ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line">    uint16xlp_info;<span class="comment">// æ ‡è®°ä½</span></span><br><span class="line">    TimeLineIDxlp_tli;<span class="comment">// é¡µé¢ç¬¬ä¸€æ¡è®°å½•çš„æ—¶é—´åºåˆ—</span></span><br><span class="line">    XLogRecPtrxlp_pageaddr;<span class="comment">// XLogé¡µé¢çš„åœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰é¡µé¢æ²¡æœ‰è¶³å¤Ÿç©ºé—´ç”¨äºè®°å½•æ—¶ï¼Œç»§ç»­åœ¨ä¸‹ä¸€é¡µè®°å½•</span></span><br><span class="line">    <span class="comment">// è®°å½•äº†å‰ä¸€é¡µçš„å‰©ä½™å­—èŠ‚æ•°ï¼ŒåŒ…æ‹¬å¤‡ä»½å—æ•°æ®ï¼Œå³è¯¥è®°å½•åœ¨æœ¬é¡µç»§ç»­å­˜å‚¨å ç”¨çš„ç©ºé—´å¤§å°</span></span><br><span class="line">    uint32xlp_rem_len;</span><br><span class="line">&#125; XLogPageHeaderData;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å…¶ä¸­ï¼Œæ ‡è®°ä½<code>xlp_info</code>åªä½¿ç”¨æœ€ä½ä¸¤ä½ï¼Œ0è¡¨æ˜è¯¥é¡µçš„ç¬¬ä¸€ä¸ªXLogè®°å½•æ¥ç€ä¸Šä¸€é¡µçš„æœ€åä¸€ä¸ªXLogè®°å½•ï¼Œ1è¡¨ç¤ºè¯¥é¡µæ˜¯è¯¥XLogæ–‡ä»¶çš„é¦–é¡µ</p></li></ul><h5 id="XLogLongPageHeaderData">XLogLongPageHeaderData</h5><p>å¦‚æœé¡µé¢æ˜¯è¯¥æ—¥å¿—æ–‡ä»¶çš„é¦–é¡µï¼Œé‚£ä¹ˆåœ¨åŸå¤´éƒ¨ä¿¡æ¯çš„åŸºç¡€ä¸Šä¼šä½¿ç”¨ä¸€ä¸ªé•¿çš„å¤´éƒ¨ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogLongPageHeaderData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XLogPageHeaderData <span class="built_in">std</span>;<span class="comment">// æ ‡å‡†çš„å¤´éƒ¨ä¿¡æ¯ï¼Œå³ XLogPageHeaderData</span></span><br><span class="line">    uint64xlp_sysid;<span class="comment">// pg_controlä¸­çš„ç³»ç»Ÿæ ‡è¯†ç¬¦</span></span><br><span class="line">    uint32xlp_seg_size;<span class="comment">// æ ¡éªŒä½ï¼Œæ®µçš„å¤§å°</span></span><br><span class="line">    uint32xlp_XLog_blcksz;<span class="comment">// æ ¡éªŒä½ï¼Œå—çš„å¤§å°</span></span><br><span class="line">&#125; XLogLongPageHeaderData;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¯¹äºé•¿çš„XLogæ—¥å¿—è®°å½•ï¼Œå…è®¸å°†æ²¡æœ‰è¶³å¤Ÿç©ºé—´å­˜å‚¨çš„æ•°æ®å­˜å‚¨åˆ°ä¸‹ä¸€ä¸ªé¡µé¢ï¼Œä½†ä¸å…è®¸Recordå¤´éƒ¨ä¿¡æ¯è¢«åˆ†å¼€å­˜å‚¨åˆ°ä¸¤ä¸ªä¸åŒé¡µé¢ã€‚å¦‚æœå‰©ä½™ç©ºé—´å·²ç»ä¸è¶³ä»¥å­˜å‚¨ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼Œé‚£ä¹ˆå‰©ä½™ç©ºé—´å°†è¢«èˆå¼ƒï¼Œå°†è¿™ä¸ªXLogè®°å½•å­˜å‚¨åˆ°æ–°çš„ä¸‹ä¸€ä¸ªé¡µé¢ä¸­</p></li></ul><h4 id="XLog-Record">XLog Record</h4><h5 id="XLogRecord">XLogRecord</h5><p>ç»“æ„<code>XLogRecord</code>è®°å½•äº†XLogçš„ç›¸å…³æ§åˆ¶ä¿¡æ¯ï¼Œä¸€ä¸ªXLogè®°å½•æœ€å¤šå¯ä»¥é™„3ä¸ªå¤‡ä»½å—ï¼Œ æ¯ä¸ªå—å¯¹åº”ä¸€ä¸ªç£ç›˜å¤§å°çš„æ•°æ®ï¼Œé•¿åº¦ä¸º8kb</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecord</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">uint32xl_tot_len;<span class="comment">// æ•´æ¡è®°å½•çš„é•¿åº¦</span></span><br><span class="line">TransactionId xl_xid;<span class="comment">// äº‹åŠ¡ID</span></span><br><span class="line">XLogRecPtrxl_prev;<span class="comment">// æŒ‡å‘æ—¥å¿—ä¸­çš„å‰ä¸€ä¸ªè®°å½•</span></span><br><span class="line">uint8xl_info;<span class="comment">// ä¿¡æ¯æ ‡è®°ä½</span></span><br><span class="line">RmgrIdxl_rmid;<span class="comment">// èµ„æºç®¡ç†å™¨</span></span><br><span class="line"></span><br><span class="line">pg_crc32cxl_crc;<span class="comment">// æœ¬è®°å½•çš„CRCæ ¡éªŒç </span></span><br><span class="line">&#125; XLogRecord;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å…¶ä¸­ï¼Œèµ„æºç®¡ç†å™¨å·ä¸»è¦ç”¨äºæ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ•°æ®åº“ç³»ç»Ÿéœ€è¦å°†è®°å½•çš„æ—¥å¿—æ•°æ®åˆ†ç±»ï¼Œä¸ºå®ƒä»¬åˆ†é…å¯¹åº”çš„èµ„æºç®¡ç†å™¨å·ã€‚è¯»å–æ—¥å¿—è®°å½•æ—¶ï¼Œç»“åˆèµ„æºç®¡ç†å™¨å·å’Œä¿¡æ¯æ ‡å¿—ä½ï¼Œèƒ½å¤Ÿç›´åˆ°æ•°æ®åº“å¯¹æºæ•°æ®åšçš„æ˜¯å“ªç§æ“ä½œï¼Œä»è€Œè¿…é€Ÿæ­£ç¡®çš„è°ƒç”¨å¯¹åº”çš„å‡½æ•°ã€‚å…±æœ‰16ç§èµ„æº</p></li><li class="lvl-2"><p>ä¿¡æ¯æ ‡å¿—ä½çš„é«˜4ä½ç”±èµ„æºç®¡ç†å™¨ä½¿ç”¨ï¼Œæ ‡è¯†è¯¥æ—¥å¿—æ˜¯å“ªç§ç±»å‹çš„æ—¥å¿—ã€‚ä½4ä½è¡¨ç¤ºå¯¹åº”çš„å—æ˜¯å¦éœ€è¦å¤‡ä»½</p></li></ul><h5 id="XLogRecordBlockHeader">XLogRecordBlockHeader</h5><p>å­˜æ”¾blockçš„ç›¸å…³ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecordBlockHeader</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    uint8       id;             <span class="comment">// å—å¼•ç”¨ID</span></span><br><span class="line">    uint8       fork_flags;     <span class="comment">// åœ¨å…³ç³»ä¸­ä½¿ç”¨çš„forkå’Œflags</span></span><br><span class="line">    uint16      data_length;    <span class="comment">// payloadå­—èŠ‚å¤§å°</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å¦‚æœè®¾ç½®äº† BKPBLOCK_HAS_IMAGE,åç»­ä¸ºXLogRecordBlockImageHeaderç»“æ„ä½“ï¼Œå¦åˆ™ä¸ºRelFileNode</span></span><br><span class="line">    <span class="comment">//ä¹‹åä¸ºBlockNumber</span></span><br><span class="line">&#125; XLogRecordBlockHeader;</span><br></pre></td></tr></table></figure><h5 id="XLogRecordBlockImageHeader">XLogRecordBlockImageHeader</h5><p>å­˜æ”¾æ•´é¡µå†™å…¥çš„ç›¸å…³ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecordBlockImageHeader</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">uint16length;<span class="comment">// pageå¤§å°</span></span><br><span class="line">uint16hole_offset;<span class="comment">// holeä¹‹å‰çš„é•¿åº¦</span></span><br><span class="line">uint8bimg_info;<span class="comment">// æ ‡è®°ä½ï¼Œæ˜¯å¦å‹ç¼©</span></span><br><span class="line">&#125; XLogRecordBlockImageHeader;</span><br></pre></td></tr></table></figure><h5 id="XLogRecordBlockCompressHeader">XLogRecordBlockCompressHeader</h5><p>å­˜æ”¾pageä¸­çš„holeå¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecordBlockCompressHeader</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">uint16hole_length;<span class="comment">// holeå¤§å°</span></span><br><span class="line">&#125; XLogRecordBlockCompressHeader;</span><br></pre></td></tr></table></figure><h4 id="XLog-Data">XLog Data</h4><h5 id="XLogRecordDataHeader">XLogRecordDataHeader</h5><p>WAL Recordçš„æ•°æ®éƒ¨åˆ†çš„headerä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecordDataHeaderShort</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    uint8       id;</span><br><span class="line">    uint8       data_length;</span><br><span class="line">&#125;XLogRecordDataHeaderShort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecordDataHeaderLong</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    uint8       id;</span><br><span class="line">&#125;XLogRecordDataHeaderLong;</span><br></pre></td></tr></table></figure><h5 id="XLogRecData">XLogRecData</h5><p>XLogæ—¥å¿—è®°å½•ä¸­çš„æ•°æ®ä¿¡æ¯å­˜å‚¨åœ¨ç»“æ„<code>XLogRecData</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogRecData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">XLogRecData</span> *<span class="title">next</span>;</span><span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="type">char</span>    *data;<span class="comment">// æ•°æ®</span></span><br><span class="line">uint32len;<span class="comment">// æ•°æ®é•¿åº¦</span></span><br><span class="line">&#125; XLogRecData;</span><br></pre></td></tr></table></figure><h4 id="XLogæ§åˆ¶ç»“æ„">XLogæ§åˆ¶ç»“æ„</h4><h5 id="XLogCtlData">XLogCtlData</h5><p>åœ¨å…±äº«å†…å­˜ä¸­ç”¨ç»“æ„<code>XLogCtlData</code>ä¿å­˜XLogä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">XLogCtlData</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    XLogCtlInsert Insert;<span class="comment">// æ’å…¥ä¸€æ¡æ—¥å¿—åï¼Œæœ€æ–°çš„ç›¸å…³ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥ä¸‹å—info_lckä¿æŠ¤</span></span><br><span class="line">    XLogwrtRqst LogwrtRqst;<span class="comment">// å°†æ—¥å¿—å†™å…¥å’ŒåŒæ­¥çš„ä½ç½®</span></span><br><span class="line">    XLogRecPtrRedoRecPtr;<span class="comment">// æœ€è¿‘çš„ Insert-&gt;RedoRecPtr å‰¯æœ¬</span></span><br><span class="line">    FullTransactionId ckptFullXid;<span class="comment">// æœ€æ–°æ£€æŸ¥ç‚¹çš„nextXID</span></span><br><span class="line">    XLogRecPtrasyncXactLSN;<span class="comment">// æœ€æ–°å¼‚æ­¥æäº¤/ä¸­æ–­çš„LSN</span></span><br><span class="line">    XLogRecPtrreplicationSlotMinLSN;<span class="comment">// æ‰€æœ‰ç¼“å†²åŒºæ‰€éœ€çš„æœ€è€çš„LSN</span></span><br><span class="line"></span><br><span class="line">    XLogSegNolastRemovedSegNo;<span class="comment">// æœ€åçš„åˆ é™¤/å›æ”¶çš„XLogæ®µ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºä¸éœ€è¦è®°å½•æ—¥å¿—çš„å…³ç³»çš„å‡çš„LSN</span></span><br><span class="line">    XLogRecPtrunloggedLSN;</span><br><span class="line">    <span class="type">slock_t</span>ulsn_lck;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ‡æ¢åæœ€æ–°çš„XLogçš„æ—¶é—´å’ŒLSNï¼Œå—XLogWriteLockä¿æŠ¤</span></span><br><span class="line">    <span class="type">pg_time_t</span>lastSegSwitchTime;</span><br><span class="line">    XLogRecPtrlastSegSwitchLSN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å·²ç»å†™å…¥å’ŒåŒæ­¥çš„ä½ç½®ï¼Œå—info_lckæˆ–XLogWriteLockä¿æŠ¤</span></span><br><span class="line">    XLogwrtResult LogwrtResult;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸­çš„æœ€ååˆå§‹åŒ–é¡µé¢ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚ä½ç½®+1</span></span><br><span class="line">    XLogRecPtrInitializedUpTo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™äº›å€¼åœ¨å¯åŠ¨åä¸ä¼šä¿®æ”¹ï¼Œå°½ç®¡æŒ‡å‘çš„é¡µé¢å’Œxlblocksé€šå¸¸ä¼šæ”¹å˜</span></span><br><span class="line">    <span class="comment">// xlblockså— XLogBufMappingLock ä¿æŠ¤</span></span><br><span class="line">    <span class="type">char</span>   *pages;<span class="comment">// æœªå†™å…¥XLogé¡µé¢çš„ç¼“å†²åŒº</span></span><br><span class="line">    XLogRecPtr *xlblocks;<span class="comment">// ç¼“å†²åŒºå†…å®¹å¯¹åº”çš„XLogæ–‡ä»¶çš„å†…éƒ¨æŒ‡é’ˆ</span></span><br><span class="line">    <span class="type">int</span>XLogCacheBlck;<span class="comment">// XLogæœ€å¤§ç¼“å†²åŒºçš„ä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ThisTimeLineID çš„å…±äº«å‰¯æœ¬ï¼Œåœ¨å®Œæˆæ¢å¤åä¸è¦ä¿®æ”¹</span></span><br><span class="line">    TimeLineIDThisTimeLineID;</span><br><span class="line">    TimeLineIDPrevTimeLineID;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°æˆ‘ä»¬æ˜¯å¦å¤„äºå´©æºƒæˆ–æ¢å¤çŠ¶æ€ï¼Œå—info_lockä¿æŠ¤</span></span><br><span class="line">    RecoveryState SharedRecoveryState;</span><br><span class="line">    <span class="type">bool</span>SharedHotStandbyActive;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡ç¤ºXLogå†™å…¥æ˜¯å¦å¤„äºèŠ‚èƒ½æ¨¡å¼ï¼Œå—info_lockä¿æŠ¤</span></span><br><span class="line">    <span class="type">bool</span>XLogWriterSleeping;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…å”¤é†’ï¼Œå¦‚æœå‡ºç°å‡ºå‘æ–‡ä»¶ï¼Œåˆ™å”¤é†’å¯åŠ¨è¿›ç¨‹ä»¥ç»§ç»­æ‰§è¡ŒXLogé‡æ”¾</span></span><br><span class="line">    LatchrecoveryWakeupLatch;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æ¢å¤æœŸé—´ä¿ç•™æœ€åæ£€æŸ¥ç‚¹è®°å½•çš„å‰¯æœ¬ï¼Œå—info_lckä¿æŠ¤</span></span><br><span class="line">    XLogRecPtrlastCheckPointRecPtr;</span><br><span class="line">    XLogRecPtrlastCheckPointEndPtr;</span><br><span class="line">    CheckPointlastCheckPoint;</span><br><span class="line"></span><br><span class="line">    XLogRecPtrlastReplayedEndRecPtr;<span class="comment">// æŒ‡å‘æˆåŠŸé‡æ”¾çš„æœ€åä¸€æ¡è®°å½•çš„ç»“å°¾+1</span></span><br><span class="line">    TimeLineIDlastReplayedTLI;</span><br><span class="line">    XLogRecPtrreplayEndRecPtr;<span class="comment">// å¦‚æœæ­£å¤„äºredoå‡½æ•°å›æ”¾è®°å½•æœŸé—´ï¼Œåˆ™æŒ‡å‘æ­£åœ¨æ¢å¤è®°å½•çš„ç»“å°¾+1</span></span><br><span class="line">    <span class="comment">// å¦åˆ™ç­‰äºlastReplayedEndRecPtr</span></span><br><span class="line">    TimeLineIDreplayEndTLI;</span><br><span class="line">    TimestampTz recoveryLastXTime;<span class="comment">// é‡æ”¾ï¼ˆæ­£åœ¨é‡æ”¾ï¼‰çš„æœ€åä¸€ä¸ªCOMMIT/ABORTè®°å½•çš„æ—¶é—´æˆ³</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹é‡æ”¾å½“å‰XLogæ•°æ®å—çš„æ—¶é—´æˆ³</span></span><br><span class="line">    TimestampTz currentChunkStartTime;</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span>recoveryPause;<span class="comment">// æ˜¯å¦æš‚åœæ¢å¤</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒ‡å‘æœ€åé‡æ”¾çš„XLog_FPW_CHANGEè®°å½•çš„èµ·å§‹ç‚¹</span></span><br><span class="line">    <span class="comment">// ç”¨äºç¦ç”¨full_page_writes</span></span><br><span class="line">    XLogRecPtrlastFpwDisableRecPtr;</span><br><span class="line"></span><br><span class="line">    <span class="type">slock_t</span>info_lck;<span class="comment">// å…±äº«é”</span></span><br><span class="line">&#125; XLogCtlData;</span><br></pre></td></tr></table></figure><h5 id="Register-buffer">Register_buffer</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">bool</span>in_use;<span class="comment">// is this slot in use?</span></span><br><span class="line">uint8flags;<span class="comment">// REGBUF_* flags</span></span><br><span class="line">RelFileNode rnode;<span class="comment">// æŒ‡å®šæ‰€å±è¡¨çš„å­˜å‚¨ç›®å½•</span></span><br><span class="line">ForkNumberforkno;         <span class="comment">// å“ªç§æ–‡ä»¶ç±»å‹</span></span><br><span class="line">BlockNumber block;          <span class="comment">// å—ç¼–å·</span></span><br><span class="line">Pagepage;<span class="comment">// å¯¹åº”çš„åŸå§‹æ•°æ®é¡µ</span></span><br><span class="line"></span><br><span class="line">uint32rdata_len;<span class="comment">// ç§æœ‰æ•°æ®é“¾è¡¨çš„é•¿åº¦æ€»å’Œ</span></span><br><span class="line">XLogRecData *rdata_head;<span class="comment">// ç§æœ‰æ•°æ®é“¾è¡¨å¤´éƒ¨èŠ‚ç‚¹</span></span><br><span class="line">XLogRecData *rdata_tail;<span class="comment">// ç§æœ‰æ•°æ®é“¾è¡¨å°¾éƒ¨èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">XLogRecData bkp_rdatas[<span class="number">2</span>];<span class="comment">// å­˜å‚¨ç€å‹ç¼©åæˆ–å¿½ç•¥ç©ºé—²æ•°æ®çš„æ•°æ®ï¼Œå¦‚æœæœ‰ç©ºé—²ä½ç½®ä¸”æ²¡æœ‰å‹ç¼©ï¼Œé‚£ä¹ˆæ•°æ®ä¼šè¢«åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œå­˜å‚¨åœ¨ä¸¤ä¸ªæ•°ç»„å…ƒç´ é‡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span>compressed_page[PGLZ_MAX_BLCKSZ]; <span class="comment">// å¦‚æœå¼€å¯äº†å‹ç¼©ï¼Œé‚£ä¹ˆå­˜å‚¨ç€å‹ç¼©åçš„æ•°æ®</span></span><br><span class="line">&#125; registered_buffer;</span><br></pre></td></tr></table></figure><h4 id="é‡è¦å…¨å±€å˜é‡">é‡è¦å…¨å±€å˜é‡</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> XLogRecData *mainrdata_head;</span><br><span class="line"><span class="type">static</span> XLogRecData *mainrdata_last = (XLogRecData *) &amp;mainrdata_head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*ä½¿ç”¨XLogRegisterBufferæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°registered_buffersæ•°ç»„é‡Œ*/</span></span><br><span class="line"><span class="type">static</span> registered_buffer *registered_buffers;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨XLogRegisterBufDataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œå¹¶é“¾æ¥ä¸ºé“¾è¡¨ï¼Œä½¿ç”¨registered_bufferç»“æ„é‡Œçš„rdata_headå’Œ</span></span><br><span class="line"><span class="comment"> * rdata_tailä½œä¸ºé“¾è¡¨çš„é¦–å°¾ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨XLogRegisterDataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œå¹¶ä½¿ç”¨mainrdata_headå’Œmainrdata_lastataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œ</span></span><br><span class="line"><span class="comment"> * å¹¶é“¾æ¥ä¸ºé“¾è¡¨ï¼Œä½¿ç”¨registered_bufferç»“æ„é‡Œçš„rdata_headå’Œrdata_tailä½œä¸ºé“¾è¡¨çš„é¦–å°¾ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> XLogRecData *rdatas;</span><br></pre></td></tr></table></figure><h3 id="å…·ä½“å‡½æ•°ä»£ç ">å…·ä½“å‡½æ•°ä»£ç </h3><h4 id="XLogBeginInsert">XLogBeginInsert</h4><p>å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯æ£€éªŒè°ƒç”¨ç¯å¢ƒæ˜¯å¦æ­£ç¡®ï¼Œåˆ¤æ–­å½“å‰æ˜¯å¦å¯ä»¥æ‰§è¡Œxlogæ’å…¥ï¼Œå¹¶è®¾ç½®å¼€å§‹æ„é€ WALè®°å½•çš„æ ‡è®°ï¼Œæ ‡å¿—walæ’å…¥å¼€å§‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Assert(max_registered_block_id == <span class="number">0</span>);</span><br><span class="line">Assert(mainrdata_last == (XLogRecData *) &amp;mainrdata_head);</span><br><span class="line">Assert(mainrdata_len == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!XLogInsertAllowed())</span><br><span class="line">    elog(ERROR, <span class="string">&quot;cannot make new WAL entries during recovery&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (begininsert_called)</span><br><span class="line">    elog(ERROR, <span class="string">&quot;XLogBeginInsert was already called&quot;</span>);</span><br><span class="line"></span><br><span class="line">begininsert_called = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><h4 id="XLogRegisterData">XLogRegisterData</h4><ol><li class="lvl-3"><p>å°†æœ¬æ¡walè®°å½•çš„ç‰¹æ®Šç»“æ„ä½“æ•°æ®æ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚XLOG_HEAP_INSERTå­ç±»å‹çš„xl_heap_insertç»“æ„ä½“ã€‚</p></li><li class="lvl-3"><p>å°†ä¸€äº›æ—§å…ƒç»„æ•°æ®æ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚æ‰§è¡Œupdateè¯­å¥çš„æ—§å…ƒç»„æ•°æ®ã€deleteè¯­å¥çš„æ—§å…ƒç»„æ•°æ®ã€‚</p></li></ol><p><img src="/uploads/xlog_register_data.jpg" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»å¼€å§‹æ„é€ WAL</span></span><br><span class="line">Assert(begininsert_called);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥æ•°æ®é‡æ˜¯å¦è¶…è¿‡é™åˆ¶å€¼</span></span><br><span class="line"><span class="keyword">if</span> (num_rdatas &gt;= max_rdatas)</span><br><span class="line">    elog(ERROR, <span class="string">&quot;too much WAL data&quot;</span>);</span><br><span class="line">rdata = &amp;rdatas[num_rdatas++];</span><br><span class="line"></span><br><span class="line">rdata-&gt;data = data;</span><br><span class="line">rdata-&gt;len = len;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ mainrdata_last æŒ‡é’ˆè·Ÿè¸ªé“¾æ¡çš„ç»“æŸç‚¹,åœ¨è¿™é‡Œä¸éœ€è¦æ¸…é™¤nextå˜é‡</span></span><br><span class="line">mainrdata_last-&gt;next = rdata;</span><br><span class="line">mainrdata_last = rdata;</span><br><span class="line"></span><br><span class="line">mainrdata_len += len;</span><br></pre></td></tr></table></figure><h4 id="XLogRegisterBuffer">XLogRegisterBuffer</h4><p>å°†æ¶‰åŠåˆ°çš„buffæ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚insertè¯­å¥çš„ç›®æ ‡buffã€updateè¯­å¥çš„ç›®æ ‡buffå’Œæºbuff</p><p><img src="/uploads/xlog_register_buf.jpg" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰¾åˆ°registered_bufferæ•°ç»„ä¸­ç¬¬ä¸€ä¸ªç©ºçš„çš„ä½ç½®</span></span><br><span class="line"><span class="keyword">if</span> (block_id &gt;= max_registered_block_id)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (block_id &gt;= max_registered_buffers)</span><br><span class="line">        elog(ERROR, <span class="string">&quot;too many registered buffers&quot;</span>);</span><br><span class="line">    max_registered_block_id = block_id + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†è¿™ä¸ªbufferçš„æ•°æ®å¡«å……</span></span><br><span class="line">regbuf = &amp;registered_buffers[block_id];</span><br><span class="line"></span><br><span class="line">BufferGetTag(buffer, &amp;regbuf-&gt;rnode, &amp;regbuf-&gt;forkno, &amp;regbuf-&gt;block);</span><br><span class="line">regbuf-&gt;page = BufferGetPage(buffer);</span><br><span class="line">regbuf-&gt;flags = flags;</span><br><span class="line">regbuf-&gt;rdata_tail = (XLogRecData *) &amp;regbuf-&gt;rdata_head;</span><br><span class="line">regbuf-&gt;rdata_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†ç¼“å†²åŒºæ ‡è®°ä¸ºå·²ä½¿ç”¨</span></span><br><span class="line">regbuf-&gt;in_use = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><h4 id="XLogRegisterBufData">XLogRegisterBufData</h4><p>å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯å°†å…ƒç»„å†…å®¹æ³¨å†Œåˆ°WALè®°å½•ä¸­ã€‚éœ€è¦å‚æ•°block idï¼Œè¿™ä¸ªidå¿…é¡»æ˜¯å·²ç»é€šè¿‡<code>XLogRegisterBuffer</code>æ³¨å†Œçš„block</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–å·²ç»æ³¨å†Œçš„ç¼“å†²åŒºç»“æ„</span></span><br><span class="line">regbuf = &amp;registered_buffers[block_id];</span><br><span class="line"><span class="keyword">if</span> (!regbuf-&gt;in_use)</span><br><span class="line">    elog(ERROR, <span class="string">&quot;no block with id %d registered with WAL insertion&quot;</span>,</span><br><span class="line">         block_id);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–bufferæ•°æ®</span></span><br><span class="line"><span class="keyword">if</span> (num_rdatas &gt;= max_rdatas)</span><br><span class="line">    elog(ERROR, <span class="string">&quot;too much WAL data&quot;</span>);</span><br><span class="line">rdata = &amp;rdatas[num_rdatas++];</span><br><span class="line"></span><br><span class="line">rdata-&gt;data = data;</span><br><span class="line">rdata-&gt;len = len;</span><br><span class="line"></span><br><span class="line">regbuf-&gt;rdata_tail-&gt;next = rdata;</span><br><span class="line">regbuf-&gt;rdata_tail = rdata;</span><br><span class="line">regbuf-&gt;rdata_len += len;</span><br></pre></td></tr></table></figure><h4 id="XLogInsert">XLogInsert</h4><p>æ’å…¥WALçš„æ“ä½œç”±å‡½æ•°<code>XLogInsert</code>å®Œæˆï¼Œæ ¹æ®Rdataé“¾è¡¨å’Œç›¸åº”çš„èµ„æºç®¡ç†å™¨infoå‘WALæ—¥å¿—æ–‡ä»¶ä¸­æ’å…¥ä¸€æ¡WALè®°å½•ã€‚äº‹åŠ¡æ‰§è¡Œæ’å…¥ï¼Œåˆ é™¤ï¼Œæ›´æ–°ï¼Œæäº¤ï¼Œç»ˆæ­¢æˆ–å›æ»šå‘½ä»¤æ—¶éƒ½éœ€è¦è°ƒç”¨æ­¤å‡½æ•°</p><ul class="lvl-0"><li class="lvl-2"><p>åˆ¤æ–­è°ƒç”¨æ—¶æ˜¯å¦è®¾ç½®äº†rmgræ ‡è®°ä½ï¼š</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((info &amp; ~(XLR_RMGR_INFO_MASK |</span><br><span class="line">              XLR_SPECIAL_REL_UPDATE |</span><br><span class="line">              XLR_CHECK_CONSISTENCY)) != <span class="number">0</span>)</span><br><span class="line">    elog(PANIC, <span class="string">&quot;invalid xlog info mask %02X&quot;</span>, info);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœå¤„äºbootstrapæ¨¡å¼ï¼Œé™¤äº†XLogèµ„æºå¤–ï¼Œä¸éœ€è¦å®é™…è®°å½•å†…å®¹ï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªæ£€æŸ¥ç‚¹çš„æŒ‡é’ˆ</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (IsBootstrapProcessingMode() &amp;&amp; rmid != RM_XLog_ID)</span><br><span class="line">&#123;</span><br><span class="line">    XLogResetInsertion();</span><br><span class="line">    EndPos = SizeOfXLogLongPHD;</span><br><span class="line">    <span class="keyword">return</span> EndPos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç»„åˆæˆå®Œæ•´çš„WALè®°å½•å¹¶å†™å…¥WALæ—¥å¿—</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">    XLogRecPtrRedoRecPtr;</span><br><span class="line">    <span class="type">bool</span>doPageWrites;</span><br><span class="line">    XLogRecPtrfpw_lsn;</span><br><span class="line">    XLogRecData *rdt;</span><br><span class="line"></span><br><span class="line">    GetFullPageWriteInfo(&amp;RedoRecPtr, &amp;doPageWrites);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨å‡½æ•°ç»„è£…æ³¨å†Œçš„æ•°æ®</span></span><br><span class="line">    rdt = XLogRecordAssemble(rmid, info, RedoRecPtr, doPageWrites,</span><br><span class="line">                             &amp;fpw_lsn);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†ç»„è£…å¥½çš„æ•°æ®å†™å…¥åˆ°WALå†…å­˜ä¸­</span></span><br><span class="line">    EndPos = XLogInsertRecord(rdt, fpw_lsn, curinsert_flags);</span><br><span class="line">&#125; <span class="keyword">while</span> (EndPos == InvalidXLogRecPtr);</span><br></pre></td></tr></table></figure><h4 id="XLogRecordAssemble">XLogRecordAssemble</h4><p>å‡½æ•°ç”¨äºå°†å·²æ³¨å†Œçš„æ•°æ®å’Œç¼“å†²åŒºé¡µé¢æ•°æ®ç»„è£…æˆä¸€æ¡WALè®°å½•ï¼Œå°†å…¶å†™å…¥åˆ°<code>XLogRecData</code>é“¾è¡¨ä¸­ã€‚</p><p>æ‰§è¡Œåˆ°è¿™ä¸ªé˜¶æ®µï¼Œwalè®°å½•çš„æ•°æ®å­˜å‚¨åœ¨ï¼š</p><ol><li class="lvl-3"><p>mainrdata_head</p></li><li class="lvl-3"><p>æ¯ä¸€ä¸ªæ³¨å†Œçš„buffçš„rdata_head</p></li><li class="lvl-3"><p>æ¯ä¸€ä¸ªæ³¨å†Œçš„buffçš„pageå­—æ®µä¸­</p></li></ol><p>å‡½æ•°æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>ä¿å­˜å¤´éƒ¨ä¿¡æ¯</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">XLogRecData *rdt;<span class="comment">// XLogRecDataé“¾è¡¨æŒ‡é’ˆ</span></span><br><span class="line">uint32total_len = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span>block_id;</span><br><span class="line">pg_crc32crdata_crc;</span><br><span class="line">registered_buffer *prev_regbuf = <span class="literal">NULL</span>;</span><br><span class="line">XLogRecData *rdt_datas_last;</span><br><span class="line">XLogRecord *rechdr;</span><br><span class="line"><span class="type">char</span>   *scratch = hdr_scratch;</span><br><span class="line"></span><br><span class="line">rechdr = (XLogRecord *) scratch;</span><br><span class="line">scratch += SizeOfXLogRecord;</span><br><span class="line"></span><br><span class="line">hdr_rdt.next = <span class="literal">NULL</span>;</span><br><span class="line">rdt_datas_last = &amp;hdr_rdt;</span><br><span class="line">hdr_rdt.data = hdr_scratch;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-3"><p>æ„é€ ä¿å­˜æ‰€æœ‰å—å…¬ç”¨çš„æ•°æ®éƒ¨åˆ†çš„rdataé“¾</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line">*fpw_lsn = InvalidXLogRecPtr;</span><br><span class="line"><span class="keyword">for</span> (block_id = <span class="number">0</span>; block_id &lt; max_registered_block_id; block_id++)</span><br><span class="line">&#123;</span><br><span class="line">    registered_buffer *regbuf = &amp;registered_buffers[block_id];</span><br><span class="line">    XLogRecordBlockHeader bkpb;</span><br><span class="line">    XLogRecordBlockImageHeader bimg;</span><br><span class="line">    XLogRecordBlockCompressHeader cbimg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">bool</span>samerel;</span><br><span class="line">    <span class="type">bool</span>is_compressed = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span>include_image;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®blockå¤´éƒ¨ä¿¡æ¯</span></span><br><span class="line">    bkpb.id = block_id;</span><br><span class="line">    bkpb.fork_flags = regbuf-&gt;forkno;</span><br><span class="line">    bkpb.data_length = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// è®¾ç½®æ ‡è®°ä½</span></span><br><span class="line">    <span class="keyword">if</span> ((regbuf-&gt;flags &amp; REGBUF_WILL_INIT) == REGBUF_WILL_INIT)</span><br><span class="line">        bkpb.fork_flags |= BKPBLOCK_WILL_INIT;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡Œfull_page_writeï¼Œå†™å…¥XLogRecordBlockImageHeader</span></span><br><span class="line">    <span class="keyword">if</span> (include_image)</span><br><span class="line">    &#123;</span><br><span class="line">        Page        page = regbuf-&gt;page;<span class="comment">// è·å–å¯¹åº”çš„page</span></span><br><span class="line">        uint16      compressed_len = <span class="number">0</span>;<span class="comment">// å‹ç¼©åçš„å¤§å°</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// pageéœ€è¦å¤‡ä»½ï¼Œè®¡ç®—ç©ºé—²ç©ºé—´å¤§å°å’Œåç§»</span></span><br><span class="line">        <span class="comment">// &quot;hole&quot;æŒ‡çš„æ˜¯pageä¸­çš„ç©ºç™½åŒºåŸŸ</span></span><br><span class="line">        <span class="keyword">if</span> (regbuf-&gt;flags &amp; REGBUF_STANDARD)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœé¡µé¢éµå¾ªæ ‡å‡†å¸ƒå±€ï¼Œlowerå’ŒupperæŒ‡é’ˆå°†è¢«è·³è¿‡</span></span><br><span class="line">            uint16      lower = ((PageHeader) page)-&gt;pd_lower;<span class="comment">// è·å–lower</span></span><br><span class="line">            uint16      upper = ((PageHeader) page)-&gt;pd_upper;<span class="comment">// è·å–upper</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ¤æ–­pageä¸­æ˜¯å¦å­˜åœ¨&quot;hole&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (lower &gt;= SizeOfPageHeaderData &amp;&amp;</span><br><span class="line">                upper &gt; lower &amp;&amp;</span><br><span class="line">                upper &lt;= BLCKSZ)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// è®¡ç®—â€œholeâ€çš„é•¿åº¦çš„åç§»é‡</span></span><br><span class="line">                bimg.hole_offset = lower;</span><br><span class="line">                cbimg.hole_length = upper - lower;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// æ²¡æœ‰å¯ä»¥ç§»é™¤çš„&quot;hole&quot;</span></span><br><span class="line">                bimg.hole_offset = <span class="number">0</span>;</span><br><span class="line">                cbimg.hole_length = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ä¸æ˜¯æ ‡å‡†çš„é¡µé¢å¸ƒå±€ï¼Œæ— æ³•å°è¯•ä¼°ç®—&quot;hole&quot;</span></span><br><span class="line">            bimg.hole_offset = <span class="number">0</span>;</span><br><span class="line">            cbimg.hole_length = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯ç”¨WALå‹ç¼©</span></span><br><span class="line">        <span class="keyword">if</span> (wal_compression)</span><br><span class="line">        &#123;</span><br><span class="line">            is_compressed =</span><br><span class="line">                XLogCompressBackupBlock(page, bimg.hole_offset,</span><br><span class="line">                                        cbimg.hole_length,</span><br><span class="line">                                        regbuf-&gt;compressed_page,</span><br><span class="line">                                        &amp;compressed_len);<span class="comment">// è°ƒç”¨XLogCompressBackupBlockå‹ç¼©</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¡«å……XLogRecordBlockHeaderç»“æ„ä½“çš„å‰©ä½™å­—æ®µ</span></span><br><span class="line">        bkpb.fork_flags |= BKPBLOCK_HAS_IMAGE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä¸ºpageå†…å®¹æ„é€ XLogRecDataå…¥å£</span></span><br><span class="line">        rdt_datas_last-&gt;next = &amp;regbuf-&gt;bkp_rdatas[<span class="number">0</span>];</span><br><span class="line">        rdt_datas_last = rdt_datas_last-&gt;next;</span><br><span class="line">        <span class="comment">// è®¾ç½®æ ‡è®°</span></span><br><span class="line">        bimg.bimg_info = (cbimg.hole_length == <span class="number">0</span>) ? <span class="number">0</span> : BKPIMAGE_HAS_HOLE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨redoæœŸé—´,åœ¨è®¾ç½®äº†BKPIMAGE_APPLYæ ‡è®°çš„æƒ…å†µä¸‹full-pageæ‰ä¼šå›æ”¾.</span></span><br><span class="line">        <span class="keyword">if</span> (needs_backup)</span><br><span class="line">            bimg.bimg_info |= BKPIMAGE_APPLY;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éœ€è¦å‹ç¼©</span></span><br><span class="line">        <span class="keyword">if</span> (is_compressed)</span><br><span class="line">        &#123;</span><br><span class="line">            bimg.length = compressed_len;<span class="comment">// å‹ç¼©åçš„ç©ºé—´</span></span><br><span class="line">            bimg.bimg_info |= BKPIMAGE_IS_COMPRESSED;<span class="comment">// å‹ç¼©æ ‡è®°</span></span><br><span class="line"></span><br><span class="line">            rdt_datas_last-&gt;data = regbuf-&gt;compressed_page;<span class="comment">// æ”¾åœ¨registered_bufferä¸­</span></span><br><span class="line">            rdt_datas_last-&gt;len = compressed_len;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰å‹ç¼©ï¼Œè®¡ç®—imageçš„å¤§å°</span></span><br><span class="line">            bimg.length = BLCKSZ - cbimg.hole_length;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æœ‰&quot;hole&quot;å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">if</span> (cbimg.hole_length == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                rdt_datas_last-&gt;data = page;<span class="comment">// æ•°æ®æŒ‡é’ˆç›´æ¥æŒ‡å‘page</span></span><br><span class="line">                rdt_datas_last-&gt;len = BLCKSZ;<span class="comment">// å¤§å°ä¸ºblock size</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// è·³è¿‡hole</span></span><br><span class="line">                rdt_datas_last-&gt;data = page;<span class="comment">// æ•°æ®æŒ‡é’ˆ</span></span><br><span class="line">                rdt_datas_last-&gt;len = bimg.hole_offset;<span class="comment">// è·å–holeçš„åç§»</span></span><br><span class="line"></span><br><span class="line">                rdt_datas_last-&gt;next = &amp;regbuf-&gt;bkp_rdatas[<span class="number">1</span>];<span class="comment">// ç¬¬2éƒ¨åˆ†</span></span><br><span class="line">                rdt_datas_last = rdt_datas_last-&gt;next;</span><br><span class="line"></span><br><span class="line">                rdt_datas_last-&gt;data =</span><br><span class="line">                    page + (bimg.hole_offset + cbimg.hole_length);<span class="comment">// æŒ‡é’ˆæŒ‡å‘ç¬¬äºŒéƒ¨åˆ†</span></span><br><span class="line">                rdt_datas_last-&gt;len =</span><br><span class="line">                    BLCKSZ - (bimg.hole_offset + cbimg.hole_length);<span class="comment">// è®¾ç½®é•¿åº¦</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        total_len += bimg.length;<span class="comment">// è°ƒæ•´æ€»é•¿åº¦</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦åŒ…å«æ•°æ®</span></span><br><span class="line">    <span class="keyword">if</span> (needs_data)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// æŠŠè¯¥ç¼“å†²åŒºé“¾æ¥åˆ°è°ƒç”¨è€…æä¾›çš„rdataé“¾ä¸­ï¼Œæ„æˆä¸€ä¸ªæ•´ä½“çš„é“¾è¡¨</span></span><br><span class="line">        bkpb.fork_flags |= BKPBLOCK_HAS_DATA;</span><br><span class="line">        bkpb.data_length = regbuf-&gt;rdata_len;</span><br><span class="line">        total_len += regbuf-&gt;rdata_len;</span><br><span class="line"></span><br><span class="line">        rdt_datas_last-&gt;next = regbuf-&gt;rdata_head;</span><br><span class="line">        rdt_datas_last = regbuf-&gt;rdata_tail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨ä¸Šä¸€ä¸ªæ³¨å†Œçš„bufï¼Œè€Œä¸”RefFileNodeç›¸åŒ</span></span><br><span class="line">    <span class="keyword">if</span> (prev_regbuf &amp;&amp; RelFileNodeEquals(regbuf-&gt;rnode, prev_regbuf-&gt;rnode))</span><br><span class="line">    &#123;</span><br><span class="line">        samerel = <span class="literal">true</span>;</span><br><span class="line">        bkpb.fork_flags |= BKPBLOCK_SAME_REL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        samerel = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// åˆ‡æ¢ä¸ºå½“å‰çš„æ³¨å†Œçš„buf</span></span><br><span class="line">    prev_regbuf = regbuf;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‹·è´å¤´éƒ¨ä¿¡æ¯åˆ°scratchç¼“å†²åŒºä¸­</span></span><br><span class="line">    <span class="built_in">memcpy</span>(scratch, &amp;bkpb, SizeOfXLogRecordBlockHeader);</span><br><span class="line">    scratch += SizeOfXLogRecordBlockHeader;</span><br><span class="line">    <span class="keyword">if</span> (include_image)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(scratch, &amp;bimg, SizeOfXLogRecordBlockImageHeader);</span><br><span class="line">        scratch += SizeOfXLogRecordBlockImageHeader;</span><br><span class="line">        <span class="comment">// å‹ç¼©å­˜å‚¨,è¿½åŠ SizeOfXLogRecordBlockCompressHeader</span></span><br><span class="line">        <span class="keyword">if</span> (cbimg.hole_length != <span class="number">0</span> &amp;&amp; is_compressed)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(scratch, &amp;cbimg,</span><br><span class="line">                   SizeOfXLogRecordBlockCompressHeader);</span><br><span class="line">            scratch += SizeOfXLogRecordBlockCompressHeader;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸æ˜¯åŒä¸€ä¸ªRELï¼Œè¿½åŠ RelFileNode</span></span><br><span class="line">    <span class="keyword">if</span> (!samerel)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(scratch, &amp;regbuf-&gt;rnode, <span class="keyword">sizeof</span>(RelFileNode));</span><br><span class="line">        scratch += <span class="keyword">sizeof</span>(RelFileNode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿½åŠ BlockNumber</span></span><br><span class="line">    <span class="built_in">memcpy</span>(scratch, &amp;regbuf-&gt;block, <span class="keyword">sizeof</span>(BlockNumber));</span><br><span class="line">    scratch += <span class="keyword">sizeof</span>(BlockNumber);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ¥ä¸‹æ¥ç»„è£…XLog Record originæ ‡è®°</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((curinsert_flags &amp; XLog_INCLUDE_ORIGIN) &amp;&amp;</span><br><span class="line">    replorigin_session_origin != InvalidRepOriginId)</span><br><span class="line">&#123;</span><br><span class="line">    *(scratch++) = (<span class="type">char</span>) XLR_BLOCK_ID_ORIGIN;</span><br><span class="line">    <span class="built_in">memcpy</span>(scratch, &amp;replorigin_session_origin, <span class="keyword">sizeof</span>(replorigin_session_origin));</span><br><span class="line">    scratch += <span class="keyword">sizeof</span>(replorigin_session_origin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ¥ä¸‹æ¥ç»„è£…æ•°æ®ï¼ˆmain dataï¼‰</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mainrdata_len &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// é•¿åº¦è¶…è¿‡255ï¼Œåˆ™ä½¿ç”¨Longæ ¼å¼</span></span><br><span class="line">    <span class="keyword">if</span> (mainrdata_len &gt; <span class="number">255</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        *(scratch++) = (<span class="type">char</span>) XLR_BLOCK_ID_DATA_LONG;</span><br><span class="line">        <span class="built_in">memcpy</span>(scratch, &amp;mainrdata_len, <span class="keyword">sizeof</span>(uint32));</span><br><span class="line">        scratch += <span class="keyword">sizeof</span>(uint32);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        *(scratch++) = (<span class="type">char</span>) XLR_BLOCK_ID_DATA_SHORT;</span><br><span class="line">        *(scratch++) = (uint8) mainrdata_len;</span><br><span class="line">    &#125;</span><br><span class="line">    rdt_datas_last-&gt;next = mainrdata_head;</span><br><span class="line">    rdt_datas_last = mainrdata_last;</span><br><span class="line">    total_len += mainrdata_len;</span><br><span class="line">&#125;</span><br><span class="line">rdt_datas_last-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">hdr_rdt.len = (scratch - hdr_scratch);<span class="comment">// å¤´éƒ¨å¤§å°</span></span><br><span class="line">total_len += hdr_rdt.len;<span class="comment">// æ€»é•¿åº¦</span></span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è®¡ç®—æ•°æ®çš„CRC</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INIT_CRC32C(rdata_crc);</span><br><span class="line">COMP_CRC32C(rdata_crc, hdr_scratch + SizeOfXLogRecord, hdr_rdt.len - SizeOfXLogRecord);</span><br><span class="line"><span class="keyword">for</span> (rdt = hdr_rdt.next; rdt != <span class="literal">NULL</span>; rdt = rdt-&gt;next)</span><br><span class="line">    COMP_CRC32C(rdata_crc, rdt-&gt;data, rdt-&gt;len);</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æœ€åå¡«å……è®°å½•å¤´éƒ¨ä¿¡æ¯çš„å…¶ä»–åŸŸå­—æ®µ</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rechdr-&gt;xl_xid = GetCurrentTransactionIdIfAny();</span><br><span class="line">rechdr-&gt;xl_tot_len = total_len;</span><br><span class="line">rechdr-&gt;xl_info = info;</span><br><span class="line">rechdr-&gt;xl_rmid = rmid;</span><br><span class="line">rechdr-&gt;xl_prev = InvalidXLogRecPtr;</span><br><span class="line">rechdr-&gt;xl_crc = rdata_crc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;hdr_rdt;</span><br></pre></td></tr></table></figure><h4 id="XLogInsertRecord">XLogInsertRecord</h4><p>å°†<code>XLogRecordAssemble</code>ç»„è£…å¥½çš„è®°å½•æ’å…¥åˆ°WALå†…å­˜ä¸­ã€‚è¿‡ç¨‹åˆ†ä¸¤æ­¥ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>åœ¨å†…å­˜ä¸­ä¸ºWALè®°å½•ä¿ç•™è¶³å¤Ÿçš„ç©ºé—´</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isLogSwitch)</span><br><span class="line">    inserted = ReserveXLogSwitch(&amp;StartPos, &amp;EndPos, &amp;rechdr-&gt;xl_prev);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    ReserveXLogInsertLocation(rechdr-&gt;xl_tot_len, &amp;StartPos, &amp;EndPos,</span><br><span class="line">                              &amp;rechdr-&gt;xl_prev);</span><br><span class="line">    inserted = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å°†è®°å½•å¤åˆ¶åˆ°WALå†…å­˜ä¸­</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (inserted)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—å¤´éƒ¨çš„CRC</span></span><br><span class="line">    rdata_crc = rechdr-&gt;xl_crc;</span><br><span class="line">    COMP_CRC32C(rdata_crc, rechdr, offsetof(XLogRecord, xl_crc));</span><br><span class="line">    FIN_CRC32C(rdata_crc);</span><br><span class="line">    rechdr-&gt;xl_crc = rdata_crc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰€æœ‰çš„æ•°æ®ï¼ŒåŒ…æ‹¬headerä¿¡æ¯ï¼Œå‡å¯ä»¥è¿›è¡Œæ’å…¥</span></span><br><span class="line">    CopyXLogRecordToWAL(rechdr-&gt;xl_tot_len, isLogSwitch, rdata,</span><br><span class="line">                        StartPos, EndPos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ›´æ–°æœ€åä¸€æ¡é‡è¦è®°å½•çš„LSNï¼Œå½“æŒæœ‰é”æ—¶ï¼Œåªæ›´æ–°ç¬¬ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; XLog_MARK_UNIMPORTANT) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span>lockno = holdingAllLocks ? <span class="number">0</span> : MyLockNo;</span><br><span class="line"></span><br><span class="line">        WALInsertLocks[lockno].l.lastImportantAt = StartPos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="PageSetLSN">PageSetLSN</h4><p>æ›´æ–°è¢«ä¿®æ”¹çš„Page LSN</p><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Postgresql ä½¿ç”¨ wal æ—¥å¿—ä¿å­˜æ¯ä¸€æ¬¡çš„æ•°æ®ä¿®æ”¹ï¼Œè¿™æ ·ä¿è¯äº†æ•°æ®åº“å³ä½¿æ„å¤–å®•æœºï¼Œä¹Ÿèƒ½åˆ©ç”¨å®ƒå‡†ç¡®çš„æ¢å¤æ•°æ®ã€‚wal æ—¥å¿—ä¹Ÿå«åš xlogï¼Œåœ¨ 9.4 ç‰ˆæœ¬ä¹‹åä½œäº†é‡å¤§æ›´æ–°ï¼Œæœ¬ç¯‡åªè®²è§£æœ€æ–°ç‰ˆçš„æ ¼å¼ã€‚wal æ—¥å¿—è¢«ç”¨äºå¤šä¸ªæ–¹é¢ï¼Œæ¯”å¦‚ä¿®æ”¹æ•°æ®ï¼Œä¿®æ”¹ç´¢å¼•ç­‰ï¼Œæ¯ç§ç”¨é€”çš„æ ¼å¼</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="replication" scheme="https://spike1337.github.io/tags/replication/"/>
    
    <category term="WAL" scheme="https://spike1337.github.io/tags/WAL/"/>
    
  </entry>
  
</feed>
