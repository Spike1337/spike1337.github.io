<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Spike World</title>
  
  
  <link href="https://spike1337.github.io/atom.xml" rel="self"/>
  
  <link href="https://spike1337.github.io/"/>
  <updated>2023-08-24T01:24:06.741Z</updated>
  <id>https://spike1337.github.io/</id>
  
  <author>
    <name>Spike1337</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Butterflyä¸»é¢˜Markdownæ ·å¼æµ‹è¯•</title>
    <link href="https://spike1337.github.io/2023/08/22/butterfly-test/"/>
    <id>https://spike1337.github.io/2023/08/22/butterfly-test/</id>
    <published>2023-08-22T06:37:00.000Z</published>
    <updated>2023-08-24T01:24:06.741Z</updated>
    
    <content type="html"><![CDATA[<h1>H1æ ‡é¢˜</h1><p>è¿™æ˜¯ä¸€äº›æ–‡å­—æ ·å¼ã€‚</p><p>Here are some text styles.</p><h2 id="H2æ ‡é¢˜">H2æ ‡é¢˜</h2><h3 id="H3æ ‡é¢˜">H3æ ‡é¢˜</h3><h4 id="H4æ ‡é¢˜">H4æ ‡é¢˜</h4><p><em>æ–œä½“</em></p><p><strong>ç²—ä½“</strong></p><h3 id="ä»£ç ">ä»£ç </h3><p>è¡Œå†…ä»£ç  <code>rm -rf /root/</code></p><p>ä»£ç é«˜äº®</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">foo</span><br>&#123;<br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> id;<br>    std::string text;<br><br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print_text</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">fib</span>(<span class="hljs-params">n</span>):<br>    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> a &lt; n:<br>        <span class="hljs-built_in">print</span>(a, end=<span class="hljs-string">&#x27; &#x27;</span>)<br>        a, b = b, a+b<br>    <span class="hljs-built_in">print</span>()<br>fib(<span class="hljs-number">1000</span>)<br></code></pre></td></tr></table></figure><h3 id="è¡¨æ ¼">è¡¨æ ¼</h3><table><thead><tr><th>key</th><th>value</th><th>comment</th></tr></thead><tbody><tr><td>key1</td><td>value1</td><td>comment1</td></tr><tr><td>key2</td><td>value2</td><td>comment2</td></tr><tr><td>key3</td><td>value3</td><td>comment3</td></tr></tbody></table><h3 id="åˆ—è¡¨">åˆ—è¡¨</h3><h4 id="æœ‰åºåˆ—è¡¨">æœ‰åºåˆ—è¡¨</h4><ol><li class="lvl-3"><p>comment1</p></li><li class="lvl-3"><p>comment2</p></li><li class="lvl-3"><p>comment3</p></li></ol><h4 id="æ— åºåˆ—è¡¨">æ— åºåˆ—è¡¨</h4><ul class="lvl-0"><li class="lvl-2"><p>function1</p></li><li class="lvl-2"><p>function2</p><ul class="lvl-2"><li class="lvl-6">function3</li></ul></li><li class="lvl-2"><p>function4</p></li></ul><h3 id="å›¾ç‰‡">å›¾ç‰‡</h3><p><img src="/img/csgo1.png" alt="è¿™æ˜¯ä¸€å¼ å›¾ç‰‡"></p><h3 id="å‹¾é€‰æ¡†">å‹¾é€‰æ¡†</h3><ul class="lvl-0"><li class="lvl-2"><p><input type="checkbox" id="checkbox0"><label for="checkbox0"> todo 1</label></p></li><li class="lvl-2"><p><input type="checkbox" id="checkbox1" checked="true"><label for="checkbox1"> todo 2</label></p></li></ul><h3 id="emoji">emoji</h3><p>ğŸ˜¢ è¿™æ˜¯ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ï¼</p><h3 id="ä¾¿ç­¾">ä¾¿ç­¾</h3><div class="tips"><p><strong>æç¤º</strong><br>è¿™æ˜¯ä¸€ä¸ªæç¤º</p></div><div class="warning"><p><strong>æ³¨æ„</strong><br>è¿™æ˜¯ä¸€ä¸ªè­¦å‘Š</p></div><div class="danger"><p><strong>è­¦å‘Š</strong><br>è¿™æ˜¯ä¸€ä¸ªå±é™©ä¿¡å·</p></div><div class="success"><p><strong>æˆåŠŸ</strong><br>è¿™æ˜¯ä¸€ä¸ªæˆåŠŸä¿¡å·</p></div>]]></content>
    
    
    <summary type="html">ä¸€ä¸ªæµ‹è¯•Butterflyä¸»é¢˜å¯¹äºmarkdownæ ·å¼è§£æçš„æµ‹è¯•demo</summary>
    
    
    
    <category term="demo" scheme="https://spike1337.github.io/categories/demo/"/>
    
    
    <category term="demo" scheme="https://spike1337.github.io/tags/demo/"/>
    
  </entry>
  
  <entry>
    <title>Cæ ‡å‡†åº“ Â· æ–‡ä»¶è®¿é—® Â· statx</title>
    <link href="https://spike1337.github.io/2023/07/25/statx/"/>
    <id>https://spike1337.github.io/2023/07/25/statx/</id>
    <published>2023-07-25T06:41:21.000Z</published>
    <updated>2023-08-22T01:36:55.571Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å¼€å‘é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæƒ³è¦è·å–æŸä¸ªæ–‡ä»¶æ¯«ç§’çº§çš„ä¿®æ”¹æ—¶é—´ã€‚ä¼—æ‰€å‘¨çŸ¥Cæ ‡å‡†åº“ä¸­æä¾›çš„<code>stat</code>å‡½æ•°åªèƒ½è·å–åˆ°ç§’çº§çš„ä¿®æ”¹æ—¶é—´<code>st_mtime</code>ã€‚ç›¸å…³çš„ä¿¡æ¯ç¿»äº†ä¸ªéï¼Œæœ€ç»ˆè¿˜æ˜¯ç¥å¥‡çš„ChatGPTç»™æˆ‘äº†ç­”æ¡ˆï¼š</p><p>Linux 4.11åŠæ›´é«˜ç‰ˆæœ¬ï¼Œæ”¯æŒ<code>statx</code>æä¾›äº†æ¯«ç§’çº§çš„æ–‡ä»¶ä¿®æ”¹æ—¶é—´</p><h2 id="SYNOPSIS">SYNOPSIS</h2><p><strong>STRUCT</strong></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">statx</span> &#123;<br>    __u32 stx_mask;        <span class="hljs-comment">/* Mask of bits indicating</span><br><span class="hljs-comment">                                filled fields */</span><br>    __u32 stx_blksize;     <span class="hljs-comment">/* Block size for filesystem I/O */</span><br>    __u64 stx_attributes;  <span class="hljs-comment">/* Extra file attribute indicators */</span><br>    __u32 stx_nlink;       <span class="hljs-comment">/* Number of hard links */</span><br>    __u32 stx_uid;         <span class="hljs-comment">/* User ID of owner */</span><br>    __u32 stx_gid;         <span class="hljs-comment">/* Group ID of owner */</span><br>    __u16 stx_mode;        <span class="hljs-comment">/* File type and mode */</span><br>    __u64 stx_ino;         <span class="hljs-comment">/* Inode number */</span><br>    __u64 stx_size;        <span class="hljs-comment">/* Total size in bytes */</span><br>    __u64 stx_blocks;      <span class="hljs-comment">/* Number of 512B blocks allocated */</span><br>    __u64 stx_attributes_mask;<br>                            <span class="hljs-comment">/* Mask to show what&#x27;s supported</span><br><span class="hljs-comment">                                in stx_attributes */</span><br><br>    <span class="hljs-comment">/* The following fields are file timestamps */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">statx_timestamp</span> stx_atime;  <span class="hljs-comment">/* Last access */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">statx_timestamp</span> stx_btime;  <span class="hljs-comment">/* Creation */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">statx_timestamp</span> stx_ctime;  <span class="hljs-comment">/* Last status change */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">statx_timestamp</span> stx_mtime;  <span class="hljs-comment">/* Last modification */</span><br><br>    <span class="hljs-comment">/* If this file represents a device, then the next two</span><br><span class="hljs-comment">        fields contain the ID of the device */</span><br>    __u32 stx_rdev_major;  <span class="hljs-comment">/* Major ID */</span><br>    __u32 stx_rdev_minor;  <span class="hljs-comment">/* Minor ID */</span><br><br>    <span class="hljs-comment">/* The next two fields contain the ID of the device</span><br><span class="hljs-comment">        containing the filesystem where the file resides */</span><br>    __u32 stx_dev_major;   <span class="hljs-comment">/* Major ID */</span><br>    __u32 stx_dev_minor;   <span class="hljs-comment">/* Minor ID */</span><br><br>    __u64 stx_mnt_id;      <span class="hljs-comment">/* Mount ID */</span><br><br>    <span class="hljs-comment">/* Direct I/O alignment restrictions */</span><br>    __u32 stx_dio_mem_align;<br>    __u32 stx_dio_offset_align;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­å››ä¸ª<code>statx_timestamp</code>å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„æ¯«ç§’çº§æ—¶é—´æˆ³</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">statx_timestamp</span> &#123;<br>    __s64   tv_sec;      <span class="hljs-comment">// ç§’æ•°æ—¶é—´æˆ³</span><br>    __u32   tv_nsec;     <span class="hljs-comment">// tv_srchiå‘¨çš„çº³ç§’æ•°</span><br>    __s32   __reserved;  <span class="hljs-comment">// ä¿ç•™ç²¾åº¦</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>FUNCTION</strong></p><p>å‡½æ•°statxä½äºCæ ‡å‡†åº“ Standard C library (libc, -lc)ï¼Œå‡½æ•°çš„å£°æ˜å’Œä½¿ç”¨å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">statx</span><span class="hljs-params">(<span class="hljs-type">int</span> dirfd, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *restrict pathname, <span class="hljs-type">int</span> flags,</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mask, <span class="hljs-keyword">struct</span> statx *restrict statxbuf)</span></span>;<br></code></pre></td></tr></table></figure><p><strong>RETURN</strong></p><p>å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œè¿”å›0ï¼Œå¦åˆ™è¿”å›-1å¹¶è®¾ç½®errno</p><p>æ›´è¯¦ç»†çš„ä¿¡æ¯è¯·ç§»æ­¥ <a href="https://man7.org/linux/man-pages/man2/statx.2.html">LINUX MANUAL PAGE</a></p><h2 id="Example">Example</h2><p>æˆ‘è‡ªå·±æµ‹è¯•çš„ä¸€ä¸ªç®€å•ä¾‹å­</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;error.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename = <span class="hljs-string">&quot;tmp_file&quot;</span>;<br><br>    <span class="hljs-comment">// statx ç»“æ„ä½“</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">statx</span> buffer;<br><br>    <span class="hljs-comment">// AT_FDCWD    åœ¨å½“å‰ç›®å½•ä¸‹è¿è¡Œ</span><br>    <span class="hljs-comment">// STATX_MTIME è·å–ä¿®æ”¹æ—¶é—´</span><br>    <span class="hljs-comment">// AT_SYMLINK_NOFOLLOW å¦‚æœæ˜¯é“¾æ¥åˆ™è¿”å›é“¾æ¥æœ¬èº«ä¿¡æ¯</span><br>    <span class="hljs-type">int</span> result =<br>        <span class="hljs-built_in">statx</span>(AT_FDCWD, filename, AT_SYMLINK_NOFOLLOW, STATX_MTIME, &amp;buffer);<br><br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-number">-1</span>) &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Error: %m\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// buffer.stx_mtime è®°å½•æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´</span><br>    <span class="hljs-comment">// tv_sec æ˜¯ç§’çº§, tv_nsec æ˜¯æ¯«ç§’çº§</span><br>    <span class="hljs-type">int64_t</span> sec = buffer.stx_mtime.tv_sec;<br>    <span class="hljs-type">int</span>     micro_sec = buffer.stx_mtime.tv_nsec / <span class="hljs-number">1000</span>;<br>    <span class="hljs-type">char</span>    time_str[<span class="hljs-number">128</span>];<br><br>    <span class="hljs-built_in">strftime</span>(time_str, <span class="hljs-number">128</span>, <span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, <span class="hljs-built_in">localtime</span>(&amp;sec));<br>    <span class="hljs-built_in">fprintf</span>(stdout, <span class="hljs-string">&quot;Modification time of file %s is %s.%d\n&quot;</span>, filename,<br>        time_str, micro_sec);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Linuxæµ‹è¯•ç”¨ä¾‹</p><p><a href="https://kgithub.com/torvalds/linux/blob/master/samples/vfs/test-statx.c">https://kgithub.com/torvalds/linux/blob/master/samples/vfs/test-statx.c</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;æœ€è¿‘å¼€å‘é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæƒ³è¦è·å–æŸä¸ªæ–‡ä»¶æ¯«ç§’çº§çš„ä¿®æ”¹æ—¶é—´ã€‚ä¼—æ‰€å‘¨çŸ¥Cæ ‡å‡†åº“ä¸­æä¾›çš„&lt;code&gt;stat&lt;/code&gt;å‡½æ•°åªèƒ½è·å–åˆ°ç§’çº§çš„ä¿®æ”¹æ—¶é—´&lt;code&gt;st_mtime&lt;/code&gt;ã€‚ç›¸å…³çš„ä¿¡æ¯ç¿»äº†ä¸ªéï¼Œæœ€ç»ˆè¿˜æ˜¯ç¥å¥‡çš„ChatGPTç»™æˆ‘äº†ç­”æ¡ˆï¼š&lt;/p&gt;
&lt;p&gt;Linux </summary>
      
    
    
    
    <category term="Linux" scheme="https://spike1337.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://spike1337.github.io/tags/Linux/"/>
    
    <category term="libc" scheme="https://spike1337.github.io/tags/libc/"/>
    
    <category term="file access" scheme="https://spike1337.github.io/tags/file-access/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆä¸‰ï¼‰Â· å…ƒç»„çš„æ’å…¥</title>
    <link href="https://spike1337.github.io/2023/07/13/tuple_insert/"/>
    <id>https://spike1337.github.io/2023/07/13/tuple_insert/</id>
    <published>2023-07-13T11:02:08.000Z</published>
    <updated>2023-08-24T01:54:58.113Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å…ƒç»„æ’å…¥">å…ƒç»„æ’å…¥</h2><p>å…ƒç»„çš„æ’å…¥ä¸»è¦ç”±å‡½æ•°<code>heap_insert</code>æ¥å®Œæˆï¼Œä¸»è¦åˆ†ä¸ºå‡ æ­¥ï¼š</p><ol><li class="lvl-3"><p>åˆå§‹åŒ–å…ƒç»„å¤´ HeapTupleHeader</p></li><li class="lvl-3"><p>è·å–å¯ç”¨çš„page</p></li><li class="lvl-3"><p>åˆ¤æ–­å…ƒç»„å¯è§æ€§å’Œäº‹åŠ¡å†²çª</p></li><li class="lvl-3"><p>å°†å…ƒç»„å†™å…¥å¯ç”¨çš„pageï¼Œå¹¶æ ‡è®°page dirty</p></li><li class="lvl-3"><p>å†™wal</p></li></ol><h3 id="åˆå§‹åŒ–å…ƒç»„çš„å…ƒæ•°æ®">åˆå§‹åŒ–å…ƒç»„çš„å…ƒæ•°æ®</h3><p>åœ¨<code>heap_prepare_insert</code>ä¸­å®Œæˆï¼Œæ¥å£æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹æºç </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">static</span> HeapTuple</span><br><span class="hljs-function"><span class="hljs-title">heap_prepare_insert</span><span class="hljs-params">(Relation relation, HeapTuple tup, TransactionId xid,</span></span><br><span class="hljs-params"><span class="hljs-function">                    CommandId cid, <span class="hljs-type">int</span> options)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">/* è®¡ç®—å…ƒç»„çš„infomask &amp; infomask2 */</span><br>    tup-&gt;t_data-&gt;t_infomask &amp;= ~(HEAP_XACT_MASK);<br>    tup-&gt;t_data-&gt;t_infomask2 &amp;= ~(HEAP2_XACT_MASK);<br>    tup-&gt;t_data-&gt;t_infomask |= HEAP_XMAX_INVALID;<br><br>    <span class="hljs-comment">/* è®¾ç½®xminï¼Œä¹Ÿå°±æ˜¯å…ƒç»„æ’å…¥çš„äº‹åŠ¡å· */</span><br>    <span class="hljs-built_in">HeapTupleHeaderSetXmin</span>(tup-&gt;t_data, xid);<br>    <span class="hljs-keyword">if</span> (options &amp; HEAP_INSERT_FROZEN)<br>        <span class="hljs-built_in">HeapTupleHeaderSetXminFrozen</span>(tup-&gt;t_data);<br><br>    <span class="hljs-comment">/* è®¾ç½®cidã€xmaxå’Œtableoidï¼Œç”±äºæ˜¯å…ƒç»„æ’å…¥ï¼Œåˆ™å°†xmaxè®¾ç½®ä¸º0 */</span><br>    <span class="hljs-built_in">HeapTupleHeaderSetCmin</span>(tup-&gt;t_data, cid);<br>    <span class="hljs-built_in">HeapTupleHeaderSetXmax</span>(tup-&gt;t_data, <span class="hljs-number">0</span>);<br>    tup-&gt;t_tableOid = <span class="hljs-built_in">RelationGetRelid</span>(relation);<br><br>    <span class="hljs-comment">/* åˆ¤æ–­æ˜¯å¦ä¸ºTOASTå…ƒç»„ */</span><br>    <span class="hljs-keyword">if</span> (relation-&gt;rd_rel-&gt;relkind != RELKIND_RELATION &amp;&amp;<br>        relation-&gt;rd_rel-&gt;relkind != RELKIND_MATVIEW)<br>    &#123;<br>        <span class="hljs-built_in">Assert</span>(!<span class="hljs-built_in">HeapTupleHasExternal</span>(tup));<br>        <span class="hljs-keyword">return</span> tup;<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HeapTupleHasExternal</span>(tup) || tup-&gt;t_len &gt; TOAST_TUPLE_THRESHOLD)<br>        <span class="hljs-comment">/* TOASTå…ƒç»„ï¼Œè°ƒç”¨ç›¸åº”çš„æ’å…¥æ¥å£ */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">heap_toast_insert_or_update</span>(relation, tup, <span class="hljs-literal">NULL</span>, options);<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">/* å¦åˆ™ç›´æ¥è¿”å›å‡†å¤‡å¥½çš„tup */</span><br>        <span class="hljs-keyword">return</span> tup;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è·å–å¯ç”¨çš„page">è·å–å¯ç”¨çš„page</h3><p>åœ¨<code>RelationGetBufferForTuple</code>ä¸­å®Œæˆã€‚</p><p>relationæ˜¯ç›®æ ‡è¡¨å¯¹è±¡ï¼Œlenæ˜¯tupleæ’å…¥éœ€è¦çš„é•¿åº¦ã€‚otherBufferç”¨äºå…ƒç»„updateæ—¶æ›¿æ¢æ—§çš„bufferï¼Œoptionsæ˜¯å†™å…¥çš„é€‰é¡¹ï¼Œbistateè¡¨ç¤ºæ‰¹é‡æ’å…¥å¯¹è±¡çš„çŠ¶æ€ï¼Œvmbufferå’Œvmbuffer_otherç”¨äºå¯è§æ€§æ˜ å°„</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">Buffer</span><br><span class="hljs-function"><span class="hljs-title">RelationGetBufferForTuple</span><span class="hljs-params">(Relation relation, Size len,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Buffer otherBuffer, <span class="hljs-type">int</span> options,</span></span><br><span class="hljs-params"><span class="hljs-function">                          BulkInsertState bistate,</span></span><br><span class="hljs-params"><span class="hljs-function">                          Buffer *vmbuffer, Buffer *vmbuffer_other)</span></span><br></code></pre></td></tr></table></figure><ol><li class="lvl-3"><p>é€šè¿‡å¡«å……å› å­ï¼Œè®¡ç®—ç©ºé—²ç©ºé—´ã€‚</p></li></ol><p>å¡«å……å› å­<code>FillFactor</code>æ˜¯ä¸€ä¸ªç™¾åˆ†æ¯”ï¼Œé™åˆ¶äº†æˆ‘ä»¬å¯¹äºpageçš„ä½¿ç”¨ç‡</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// è¿™é‡Œä½¿ç”¨äº†é»˜è®¤å¡«å……ç™¾åˆ†æ¯”, HEAP_DEFAULT_FILLFACTOR = 100, ä¹Ÿå°±æ˜¯å®Œå…¨å¡«å……</span><br>saveFreeSpace = <span class="hljs-built_in">RelationGetTargetPageFreeSpace</span>(relation, HEAP_DEFAULT_FILLFACTOR);<br><br><span class="hljs-comment">// æ²¡æœ‰tupleçš„pageä¸­ä¹Ÿå¯èƒ½æœ‰line pointerï¼Œæ‰€ä»¥ä½¿ç”¨ä¸€ä¸ªè¿‘ä¼¼å€¼</span><br>nearlyEmptyFreeSpace = MaxHeapTupleSize -<br>    (MaxHeapTuplesPerPage / <span class="hljs-number">8</span> * <span class="hljs-built_in">sizeof</span>(ItemIdData));<br><br><span class="hljs-keyword">if</span> (len + saveFreeSpace &gt; nearlyEmptyFreeSpace)<br>    targetFreeSpace = <span class="hljs-built_in">Max</span>(len, nearlyEmptyFreeSpace);<br><span class="hljs-keyword">else</span><br>    targetFreeSpace = len + saveFreeSpace;<br></code></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>å°è¯•ä»cacheä¸­è·å–è¡¨æœ€è¿‘ä½¿ç”¨çš„pageï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•é€šè¿‡FSMè·å–æ»¡è¶³æ’å…¥æ¡ä»¶çš„page</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (bistate &amp;&amp; bistate-&gt;current_buf != InvalidBuffer)<br>    targetBlock = <span class="hljs-built_in">BufferGetBlockNumber</span>(bistate-&gt;current_buf);<br><span class="hljs-keyword">else</span><br>    targetBlock = <span class="hljs-built_in">RelationGetTargetBlock</span>(relation);<br><br><span class="hljs-keyword">if</span> (targetBlock == InvalidBlockNumber &amp;&amp; use_fsm)<br>&#123;<br>    <span class="hljs-comment">// cacheä¸­æ²¡æœ‰ç›®æ ‡pageï¼Œè®©FSMæ¥æä¾›ä¸€ä¸ªåˆå§‹ç›®æ ‡page</span><br>    targetBlock = <span class="hljs-built_in">GetPageWithFreeSpace</span>(relation, targetFreeSpace);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ‹¿ç€ä¹‹å‰è·å–åˆ°çš„blockï¼Œå»è·å–å¯¹åº”çš„buffer</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (otherBuffer == InvalidBuffer)<br>&#123;<br>    <span class="hljs-comment">// æ²¡æœ‰otherbuffer, ç®€å•æ’å…¥è¯­å¥, è·å–buffer</span><br>    buffer = <span class="hljs-built_in">ReadBufferBI</span>(relation, targetBlock, RBM_NORMAL, bistate);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">PageIsAllVisible</span>(<span class="hljs-built_in">BufferGetPage</span>(buffer)))<br>        <span class="hljs-built_in">visibilitymap_pin</span>(relation, targetBlock, vmbuffer);<br><br>    <span class="hljs-keyword">if</span> ((options &amp; HEAP_INSERT_FROZEN) &amp;&amp;<br>        (<span class="hljs-built_in">PageGetMaxOffsetNumber</span>(<span class="hljs-built_in">BufferGetPage</span>(buffer)) == <span class="hljs-number">0</span>))<br>        <span class="hljs-built_in">visibilitymap_pin</span>(relation, targetBlock, vmbuffer);<br><br>    <span class="hljs-built_in">LockBuffer</span>(buffer, BUFFER_LOCK_EXCLUSIVE);<br>&#125;<br><br>page = <span class="hljs-built_in">BufferGetPage</span>(buffer);<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœæ‹¿åˆ°çš„pageæœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†è·å–å¯ç”¨pageçš„æ­¥éª¤ï¼Œç›´æ¥è¿”å›å°±å¯ä»¥äº†</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// æ£€æŸ¥pageæ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œå¦‚æœæœ‰åˆ™è¿”å›å½“å‰page</span><br>pageFreeSpace = <span class="hljs-built_in">PageGetHeapFreeSpace</span>(page);<br><span class="hljs-keyword">if</span> (targetFreeSpace &lt;= pageFreeSpace)<br>&#123;<br>    <span class="hljs-comment">/* use this page as future insert target, too */</span><br>    <span class="hljs-built_in">RelationSetTargetBlock</span>(relation, targetBlock);<br>    <span class="hljs-keyword">return</span> buffer;<br>&#125;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œæˆ‘ä»¬éœ€è¦å»å¯»æ‰¾ä¸‹ä¸€ä¸ªblock</p></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„æ‰¹é‡æ“ä½œ, åˆ™è¿˜æœ‰å…¶ä»–çš„æœªä½¿ç”¨çš„page, æˆ‘ä»¬å°è¯•ä½¿ç”¨ä¸‹ä¸€ä¸ªpage</span><br><span class="hljs-keyword">if</span> (bistate &amp;&amp; bistate-&gt;next_free != InvalidBlockNumber)<br>&#123;<br>    targetBlock = bistate-&gt;next_free;<br>    <span class="hljs-keyword">if</span> (bistate-&gt;next_free &gt;= bistate-&gt;last_free)<br>    &#123;<br>        bistate-&gt;next_free = InvalidBlockNumber;<br>        bistate-&gt;last_free = InvalidBlockNumber;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        bistate-&gt;next_free++;<br>&#125;<br><br><span class="hljs-comment">// å¦‚æœæ²¡æœ‰è¿›è¡Œæ‰¹é‡æ“ä½œ, è¿™ä¸ªæ—¶å€™å°±è¦é—®ä¸€é—®FSMçš„æ„è§</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!use_fsm)<br>&#123;<br>    <span class="hljs-comment">// æ²¡æœ‰FSM, åªèƒ½è·³å‡ºå¾ªç¯å»æ‰©é¡µ</span><br>    <span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-comment">// é€šè¿‡FSMå¯»æ‰¾ä¸‹ä¸€ä¸ªåˆé€‚çš„page</span><br>    targetBlock = <span class="hljs-built_in">RecordAndGetPageWithFreeSpace</span>(relation,<br>                                                targetBlock,<br>                                                pageFreeSpace,<br>                                                targetFreeSpace);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li class="lvl-3"><p>å¦‚æœä»¥ä¸Šå¾ªç¯ä¸­æ²¡æœ‰æ‰¾åˆ°ç©ºé—²bufferï¼Œæˆ‘ä»¬åªèƒ½è¿›å…¥æ‰©é¡µçš„é€»è¾‘æ¥æ–°å¢ä¸€ä¸ªpageç”¨æ¥æ’å…¥</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-comment">// æ‰©é¡µå¹¶è¿”å›æ–°å¢çš„page, æ‰©é¡µçš„å…·ä½“é€»è¾‘æˆ‘ä»¬åœ¨è¿™å°±ä¸è¯¦ç»†ä»‹ç»äº†</span><br><span class="hljs-comment">// ç®€å•æ¥è¯´å°±æ˜¯ç»™relationåŠ Exclusiveé”, ç„¶ååˆå§‹åŒ–ä¸€ä¸ªæ–°çš„pageè¿›å»</span><br>buffer = <span class="hljs-built_in">RelationAddBlocks</span>(relation, bistate, num_pages, use_fsm,<br>                           &amp;unlockedTargetBuffer);<br><br>targetBlock = <span class="hljs-built_in">BufferGetBlockNumber</span>(buffer);<br>page = <span class="hljs-built_in">BufferGetPage</span>(buffer);<br></code></pre></td></tr></table></figure><ol start="5"><li class="lvl-3"><p>æ–°å¢çš„é¡µæˆ‘ä»¬å†æ¥æ£€æŸ¥ä¸‹æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ï¼Œå¦‚æœæœ‰çš„è¯å°±èƒ½è¿”å›ä½¿ç”¨äº†</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C++">pageFreeSpace = <span class="hljs-built_in">PageGetHeapFreeSpace</span>(page);<br><span class="hljs-keyword">if</span> (len &gt; pageFreeSpace)<br>&#123;<br>    <span class="hljs-keyword">if</span> (unlockedTargetBuffer)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (otherBuffer != InvalidBuffer)<br>            <span class="hljs-built_in">LockBuffer</span>(otherBuffer, BUFFER_LOCK_UNLOCK);<br>        <span class="hljs-built_in">UnlockReleaseBuffer</span>(buffer);<br><br>        <span class="hljs-keyword">goto</span> loop;<br>    &#125;<br>    <span class="hljs-built_in">elog</span>(PANIC, <span class="hljs-string">&quot;tuple is too big: size %zu&quot;</span>, len);<br>&#125;<br><br><span class="hljs-built_in">RelationSetTargetBlock</span>(relation, targetBlock);<br><br><span class="hljs-keyword">return</span> buffer;<br></code></pre></td></tr></table></figure><h3 id="å†™å…¥æ•°æ®">å†™å…¥æ•°æ®</h3><p>å†™å…¥æ•°æ®æ˜¯ç”±æ¥å£<code>RelationPutHeapTuple</code>æ¥å®Œæˆ</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span></span><br><span class="hljs-function"><span class="hljs-title">RelationPutHeapTuple</span><span class="hljs-params">(Relation relation,</span></span><br><span class="hljs-params"><span class="hljs-function">                     Buffer buffer,</span></span><br><span class="hljs-params"><span class="hljs-function">                     HeapTuple tuple,</span></span><br><span class="hljs-params"><span class="hljs-function">                     <span class="hljs-type">bool</span> token)</span></span><br><span class="hljs-function"></span>&#123;<br>    Page        pageHeader;<br>    OffsetNumber offnum;<br><br>    ...<br>    pageHeader = <span class="hljs-built_in">BufferGetPage</span>(buffer);<br><br>    <span class="hljs-comment">// å°†å…ƒç»„æ’å…¥åˆ°pageä¸­</span><br>    offnum = <span class="hljs-built_in">PageAddItem</span>(pageHeader, (Item) tuple-&gt;t_data,<br>                            tuple-&gt;t_len, InvalidOffsetNumber, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// è®°å½•å½“å‰çš„ä½ç½®åˆ°å…ƒç»„çš„t_selfä¸­</span><br>    <span class="hljs-built_in">ItemPointerSet</span>(&amp;(tuple-&gt;t_self), <span class="hljs-built_in">BufferGetBlockNumber</span>(buffer), offnum);<br><br>    <span class="hljs-comment">// å°†å½“å‰çš„ä½ç½®ä¹Ÿè®°å½•åˆ°å…ƒç»„çš„ctidä¸­</span><br>    <span class="hljs-keyword">if</span> (!token)<br>    &#123;<br>        ItemId        itemId = <span class="hljs-built_in">PageGetItemId</span>(pageHeader, offnum);<br>        HeapTupleHeader item = (HeapTupleHeader) <span class="hljs-built_in">PageGetItem</span>(pageHeader, itemId);<br><br>        item-&gt;t_ctid = tuple-&gt;t_self;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦çš„å·¥ä½œéƒ½æœ‰å‡½æ•°<code>PageAddItem</code>æ¥å®Œæˆï¼Œ<code>PageAddItem</code>æ˜¯ä¸€ä¸ªå®ï¼Œå†…éƒ¨è°ƒç”¨<code>PageAddItemExtended</code>ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹è¿™ä¸ªæ¥å£</p><p>pageæ˜¯æ’å…¥çš„é¡µé¢ï¼Œitemçš„æ’å…¥çš„æ•°æ®æŒ‡é’ˆï¼Œsizeçš„æ’å…¥æ•°æ®çš„å¤§å°ã€‚offsetNumberæ˜¯å…ƒç»„åœ¨é¡µé¢ä¸­çš„åç§»é‡ï¼Œå¦‚æœæ’å…¥æˆåŠŸåˆ™ä¼šè¢«è¿”å›ã€‚flagsæ˜¯æ’å…¥çš„é€‰é¡¹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">OffsetNumber</span><br><span class="hljs-function"><span class="hljs-title">PageAddItemExtended</span><span class="hljs-params">(Page page,</span></span><br><span class="hljs-params"><span class="hljs-function">                    Item item,</span></span><br><span class="hljs-params"><span class="hljs-function">                    Size size,</span></span><br><span class="hljs-params"><span class="hljs-function">                    OffsetNumber offsetNumber,</span></span><br><span class="hljs-params"><span class="hljs-function">                    <span class="hljs-type">int</span> flags)</span></span><br></code></pre></td></tr></table></figure><ol><li class="lvl-3"><p>é¦–å…ˆæˆ‘ä»¬åœ¨pageä¸­å¯»æ‰¾ä¸‹ä¸€ä¸ªslotçš„ä½ç½®ï¼Œå¦‚æœä¹‹åæ²¡æœ‰æ‰¾åˆ°ç©ºä½™çš„slotï¼Œæˆ‘ä»¬å°±ä¼šä½¿ç”¨è¿™ä¸ªä½ç½®æ¥æ’å…¥å…ƒç»„</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C++">limit = <span class="hljs-built_in">OffsetNumberNext</span>(<span class="hljs-built_in">PageGetMaxOffsetNumber</span>(page));<br><br><span class="hljs-comment">// å¦‚æœpageæœ‰free line pointer, ä¹Ÿå°±æ˜¯pd_flagsä¸­åŒ…å«PD_HAS_FREE_LINESæ ‡è®°</span><br><span class="hljs-comment">// åˆ™å»è¡ŒæŒ‡é’ˆæ•°ç»„ä¸­å¯»æ‰¾free slot</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">PageHasFreeLinePointers</span>(page))<br>&#123;<br>    <span class="hljs-comment">// æ‰«æPageHeaderçš„è¡ŒæŒ‡é’ˆæ•°ç»„ï¼ŒæŸ¥æ‰¾æ ‡è®°ä¸º LP_UNUSEDçš„ itemId</span><br>    <span class="hljs-keyword">for</span> (offsetNumber = FirstOffsetNumber;<br>            offsetNumber &lt; limit;<br>            offsetNumber++)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">ItemIdIsUsed</span>(itemId) &amp;&amp; !<span class="hljs-built_in">ItemIdHasStorage</span>(itemId))<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>    <span class="hljs-comment">// æ²¡æœ‰free line pointer, ä½¿ç”¨limit</span><br>    offsetNumber = limit;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li class="lvl-3"><p>æ¥ä¸‹æ¥æˆ‘ä»¬è®¡ç®—pageçš„pd_lowerå’Œpg_upperæŒ‡é’ˆæŒ‡å‘çš„offset</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">if</span> (offsetNumber == limit || needshuffle)<br>    lower = phdr-&gt;pd_lower + <span class="hljs-built_in">sizeof</span>(ItemIdData);<br><span class="hljs-keyword">else</span><br>    lower = phdr-&gt;pd_lower;<br><br>alignedSize = <span class="hljs-built_in">MAXALIGN</span>(size);<br><br>upper = (<span class="hljs-type">int</span>) phdr-&gt;pd_upper - (<span class="hljs-type">int</span>) alignedSize;<br></code></pre></td></tr></table></figure><ol start="3"><li class="lvl-3"><p>æœ€åæˆ‘ä»¬å°±å¯ä»¥æŠŠå…ƒç»„æ’å…¥åˆ°pageä¸­äº†</p></li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C++"><br><span class="hljs-comment">// å¦‚æœå·²ç»æœ‰äº†å¯¹åº”çš„è¡ŒæŒ‡é’ˆ, åˆ™é‡æ–°è®¾ç½®è¡ŒæŒ‡é’ˆä¸­çš„å€¼å’Œæ ‡è®°</span><br>itemId = <span class="hljs-built_in">PageGetItemId</span>(page, offsetNumber);<br><br><span class="hljs-keyword">if</span> (needshuffle)<br>    <span class="hljs-built_in">memmove</span>(itemId + <span class="hljs-number">1</span>, itemId,<br>            (limit - offsetNumber) * <span class="hljs-built_in">sizeof</span>(ItemIdData));<br><br><span class="hljs-built_in">ItemIdSetNormal</span>(itemId, upper, size);<br><br><span class="hljs-comment">// å°†æ•°æ®æ’å…¥åˆ°å¯¹åº”çš„offset</span><br><span class="hljs-built_in">memcpy</span>((<span class="hljs-type">char</span> *) page + upper, item, size);<br><br><span class="hljs-comment">// æ›´æ–°PageHeaderä¸­çš„upperå’ŒloweræŒ‡é’ˆ</span><br>phdr-&gt;pd_lower = (LocationIndex) lower;<br>phdr-&gt;pd_upper = (LocationIndex) upper;<br></code></pre></td></tr></table></figure><p>###WAL logå’Œç»Ÿè®¡ä¿¡æ¯</p><p>å°†å…ƒç»„çœŸæ­£æ’å…¥åˆ°pageä¹‹åï¼Œæˆ‘ä»¬ä¼šå†™WAL logå¹¶æ›´æ–°ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ã€‚è¿™ä¸¤å—æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œè¯¦ç»†çš„æè¿°äº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;å…ƒç»„æ’å…¥&quot;&gt;å…ƒç»„æ’å…¥&lt;/h2&gt;
&lt;p&gt;å…ƒç»„çš„æ’å…¥ä¸»è¦ç”±å‡½æ•°&lt;code&gt;heap_insert&lt;/code&gt;æ¥å®Œæˆï¼Œä¸»è¦åˆ†ä¸ºå‡ æ­¥ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li class=&quot;lvl-3&quot;&gt;
&lt;p&gt;åˆå§‹åŒ–å…ƒç»„å¤´ HeapTupleHeader&lt;/p&gt;
&lt;/li&gt;
&lt;li</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="storage" scheme="https://spike1337.github.io/tags/storage/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆäºŒï¼‰Â· å…ƒç»„çš„ç»„ç»‡ç»“æ„</title>
    <link href="https://spike1337.github.io/2023/07/11/tuple_manager_2/"/>
    <id>https://spike1337.github.io/2023/07/11/tuple_manager_2/</id>
    <published>2023-07-11T10:35:06.000Z</published>
    <updated>2023-08-24T01:55:05.462Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šæ¬¡æˆ‘ä»¬ç®€å•çœ‹äº†ä¸‹PostgreSQLä¸­é¡µé¢çš„ç»„ç»‡ç»“æ„ï¼Œä»‹ç»äº†PageHeaderå’Œè¡ŒæŒ‡é’ˆçš„ç»“æ„ã€‚è¿™æ¬¡æˆ‘ä»¬æ¥çœ‹çœ‹å…ƒç»„çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯tupleçš„<code>æˆå‘˜å˜é‡</code></p><h2 id="Tupleçš„ç»“æ„">Tupleçš„ç»“æ„</h2><p>å…ƒç»„çš„ç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HeapTupleData</span></span><br><span class="hljs-class">&#123;</span><br>    uint32          t_len;<br>    ItemPointerData t_self;<br>    Oid             t_tableOid;<br>    HeapTupleHeader t_data;<br>&#125; HeapTupleData;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>t_len</code>ï¼Œå…ƒç»„<code>t_data</code>å­—æ®µçš„é•¿åº¦</p></li><li class="lvl-2"><p><code>t_self</code>ï¼Œè®°å½•å…ƒç»„è‡ªå·±çš„ä½ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€åœ¨çš„blockä¿¡æ¯ï¼Œå’Œå…ƒç»„åœ¨é¡µé¢ä¸­çš„offset</p></li><li class="lvl-2"><p><code>t_tableOid</code>ï¼Œå…ƒç»„æ‰€åœ¨è¡¨çš„oid</p></li><li class="lvl-2"><p><code>t_data</code>ï¼Œå…ƒç»„çš„å…ƒæ•°æ®ä¿¡æ¯å’Œå…·ä½“å­˜å‚¨çš„æ•°æ®</p></li></ul><h3 id="HeapTupleHeader">HeapTupleHeader</h3><p>å­˜å‚¨å…ƒç»„çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œç»“æ„å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HeapTupleHeaderData</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>        HeapTupleFields     t_heap;<br>        DatumTupleFields    t_datum;<br>    &#125; t_choice;<br><br>    ItemPointerData t_ctid;<br>    uint16      t_infomask2;<br>    uint16      t_infomask;<br>    uint8       t_hoff;<br>    bits8       t_bits[FLEXIBLE_ARRAY_MEMBER];<br>&#125;;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>t_heap</code>ï¼Œå…ƒç»„äº‹åŠ¡ç›¸å…³çš„åŸŸ</p></li><li class="lvl-2"><p><code>t_datum</code>ï¼Œå…ƒç»„æ•°æ®ç›¸å…³çš„åŸŸ</p></li><li class="lvl-2"><p><code>t_cid</code>ï¼ŒHOTå…ƒç»„ä¼šæŒ‡å‘æœ€æ–°çš„å…ƒç»„ä½ç½®ï¼Œå¦åˆ™æŒ‡å‘è‡ªå·±çš„ä½ç½®</p></li><li class="lvl-2"><p><code>t_infomask2</code>ï¼Œå…ƒç»„çš„å±æ€§æ•°ï¼Œå’Œä¸€äº›æ ‡è®°ä½</p></li><li class="lvl-2"><p><code>t_infomask</code>ï¼Œå…ƒç»„çš„æ ‡è®°ä½ã€‚è¿™äº›æ ‡è®°æˆ‘ä»¬å°±ä¸åœ¨è¿™é‡Œä»‹ç»äº†</p></li><li class="lvl-2"><p><code>t_hoff</code>ï¼Œheaderçš„æ•´ä½“å¤§å°</p></li><li class="lvl-2"><p><code>t_bits</code>ï¼ŒNULLå€¼åˆ—çš„æ•°ç»„</p></li></ul><p><code>t_bits</code>æ•°ç»„ä¹‹åå­˜æ”¾çš„å°±æ˜¯å…ƒç»„çš„æ•°æ®</p><h4 id="HeapTupleFields">HeapTupleFields</h4><p>å…ƒç»„äº‹åŠ¡ç›¸å…³çš„åŸŸ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HeapTupleFields</span></span><br><span class="hljs-class">&#123;</span><br>    TransactionId t_xmin;<br>    TransactionId t_xmax;<br><br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>        CommandId       t_cid;<br>        TransactionId   t_xvac;<br>    &#125; t_field3;<br>&#125; HeapTupleFields;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>t_xmin</code>ï¼Œå…ƒç»„æ’å…¥çš„äº‹åŠ¡å·</p></li><li class="lvl-2"><p><code>t_xmax</code>ï¼Œå…ƒç»„åˆ é™¤çš„äº‹åŠ¡å·</p></li><li class="lvl-2"><p><code>t_cid</code>ï¼Œå‘½ä»¤idï¼Œè¡¨ç¤ºå½“å‰äº‹åŠ¡ä¸­æ‰§è¡Œçš„ä¿®æ”¹è¯¥å…ƒç»„çš„å‘½ä»¤çš„id</p></li><li class="lvl-2"><p><code>t_xvac</code>ï¼Œvacuum fullæ“ä½œçš„äº‹åŠ¡å·</p></li></ul><h4 id="DatumTupleFields">DatumTupleFields</h4><p>å…ƒç»„æ•°æ®ç›¸å…³çš„åŸŸ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">DatumTupleFields</span></span><br><span class="hljs-class">&#123;</span><br>    int32datum_len_;<span class="hljs-comment">/* varlena header (do not touch directly!) */</span><br>    int32datum_typmod;<span class="hljs-comment">/* -1, or identifier of a record type */</span><br>    Oiddatum_typeid;<span class="hljs-comment">/* composite type OID, or RECORDOID */</span><br><br>&#125; DatumTupleFields;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>datum_len_</code>ï¼Œå˜é•¿æ•°æ®ç±»å‹çš„é•¿åº¦</p></li><li class="lvl-2"><p><code>datum_typmod</code>ï¼Œæ•°æ®ç±»å‹</p></li><li class="lvl-2"><p><code>datum_typeid</code>ï¼Œå¤åˆç±»å‹çš„ç±»å‹oid</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä¸Šæ¬¡æˆ‘ä»¬ç®€å•çœ‹äº†ä¸‹PostgreSQLä¸­é¡µé¢çš„ç»„ç»‡ç»“æ„ï¼Œä»‹ç»äº†PageHeaderå’Œè¡ŒæŒ‡é’ˆçš„ç»“æ„ã€‚è¿™æ¬¡æˆ‘ä»¬æ¥çœ‹çœ‹å…ƒç»„çš„ç»“æ„ï¼Œä¹Ÿå°±æ˜¯tupleçš„&lt;code&gt;æˆå‘˜å˜é‡&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&quot;Tupleçš„ç»“æ„&quot;&gt;Tupleçš„ç»“æ„&lt;/h2&gt;
&lt;p&gt;å…ƒç»„çš„ç»“æ„å¦‚ä¸‹&lt;/</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="storage" scheme="https://spike1337.github.io/tags/storage/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQLæºç  Â· å…ƒç»„ç®¡ç†ï¼ˆä¸€ï¼‰Â· é¡µçš„ç»„ç»‡ç»“æ„</title>
    <link href="https://spike1337.github.io/2023/07/10/tuple_manager_1/"/>
    <id>https://spike1337.github.io/2023/07/10/tuple_manager_1/</id>
    <published>2023-07-10T09:47:33.000Z</published>
    <updated>2023-08-24T01:55:01.531Z</updated>
    
    <content type="html"><![CDATA[<p>å¼€ä¸ªæ–°å‘ï¼Œç®€å•å†™ä¸€å†™PostgreSQLä¸­çš„å…ƒç»„ç®¡ç†ã€‚</p><p>å¯¹äºæ•´ä¸ªå­˜å‚¨æ¶æ„ï¼Œå„ç§PostgreSQLçš„ç›¸å…³ä¹¦ç±å·²ç»ä»‹ç»çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å†é‡å¤é€ è½®å­äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä¸»è¦åŸºäºé¢å‘å¯¹è±¡ï¼ˆå¤§é›¾ï¼‰ï¼Œæ¥çœ‹çœ‹å…ƒç»„è¿™ä¸ªå¯¹è±¡ï¼Œæœ‰å“ªäº›<code>æˆå‘˜å˜é‡</code>ï¼Œåˆæœ‰å“ªäº›<code>æˆå‘˜å‡½æ•°</code></p><hr><p>å…ƒç»„(Tuple)æ˜¯PostgreSQLä¸­æ•°æ®çš„åŸºæœ¬å­˜å‚¨å•å…ƒï¼ŒPageåˆæ˜¯å­˜å‚¨å…ƒç»„çš„åŸºæœ¬è½½ä½“ï¼Œæ‰€ä»¥è¿™ç¬¬ä¸€ç¯‡æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹Pageçš„ç»“æ„</p><h2 id="Pageçš„ç»“æ„">Pageçš„ç»“æ„</h2><p>Pageçš„ç»“æ„å¯ä»¥ç®€å•çœ‹ä¸‹å›¾æ‰€ç¤º</p><p><img src="/uploads/page_struct.png" alt="img"></p><p>pageçš„é»˜è®¤å¤§å°ä¸º8kã€‚æ¯ä¸ªé¡µé¢çš„èµ·å§‹ä½ç½®æœ‰å¤§å°ä¸º24ä¸ªå­—èŠ‚çš„PageHeaderï¼Œè®°å½•è¯¥pageç›¸å…³çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚PageHeaderä¸­çš„pd_lowerå’Œpd_upperåˆ†åˆ«æŒ‡å‘äº†é¡µé¢ç©ºé—²ç©ºé—´çš„é¦–å°¾ã€‚</p><p>è¿™é‡Œæ¯ä¸€ä¸ªtupleå­˜å‚¨ä¸€æ¡æ•°æ®è®°å½•ï¼Œä»æ•°æ®é¡µåº•éƒ¨å¼€å§‹å‘å‰ä¾æ¬¡å­˜å‚¨ã€‚è¿™äº›å…ƒç»„åœ¨é¡µé¢ä¸­çš„ä½ç½®å­˜å‚¨åœ¨è¡ŒæŒ‡é’ˆline pointerä¸­ï¼Œæ¯ä¸ªè¡ŒæŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªtupleã€‚è¡ŒæŒ‡é’ˆä»å‰å‘åä¾æ¬¡å­˜å‚¨ï¼Œå½¢æˆä¸€ä¸ªç®€å•çš„æ•°æ®ã€‚è¡ŒæŒ‡é’ˆä¸­è¿˜å­˜æ”¾äº†å…ƒç»„çš„çŠ¶æ€å’Œå¤§å°ä¿¡æ¯ï¼Œæ‰®æ¼”å…ƒç»„åœ¨é¡µé¢ä¸­çš„ç´¢å¼•çš„è§’è‰²ã€‚è¡ŒæŒ‡é’ˆå’Œtupleä¸­é—´çš„éƒ¨åˆ†ä¸ºé¡µé¢çš„ç©ºé—²ç©ºé—´ã€‚</p><p>æˆ‘ä»¬é¦–å…ˆæ¥çœ‹çœ‹PageHeaderå­˜å‚¨äº†ä»€ä¹ˆå…ƒæ•°æ®</p><h3 id="PageHeader">PageHeader</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">PageHeaderData</span></span><br><span class="hljs-class">&#123;</span><br>    PageXLogRecPtr  pd_lsn;<br>    uint16          pd_checksum;<br>    uint16          pd_flags;<br>    LocationIndex   pd_lower;<br>    LocationIndex   pd_upper;<br>    LocationIndex   pd_special;<br>    uint16          pd_pagesize_version;<br>    TransactionId   pd_prune_xid;<br>    ItemIdData      pd_linp[FLEXIBLE_ARRAY_MEMBER];<br>&#125; PageHeaderData;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>pd_lsn</code>ï¼Œè®°å½•äº†è¯¥é¡µé¢æœ€åä¸€æ¬¡æ›´æ”¹çš„WAL logçš„lsn</p></li><li class="lvl-2"><p><code>pg_checksum</code>ï¼Œé¡µé¢æ ¡éªŒå’Œ</p></li><li class="lvl-2"><p><code>pd_flags</code>ï¼Œé¡µé¢çš„æ ‡è®°ä¸ºï¼ŒåŒ…æ‹¬ä»¥ä¸‹æ ‡è®°</p><ul class="lvl-2"><li class="lvl-4"><code>PD_HAS_FREE_LINES</code>ï¼Œé¡µé¢ä¸­æ˜¯å¦æœ‰unused line pointer. è¿™ä¸ªunusedçš„æ¦‚å¿µæˆ‘ä»¬ä¹‹ååœ¨çœ‹åˆ°line pointeræ—¶ä¼šä»‹ç»</li><li class="lvl-4"><code>PD_PAGE_FULL</code>ï¼Œé¡µé¢æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—²ç©ºé—´ç»™æ–°çš„tuple</li><li class="lvl-4"><code>PD_ALL_VISIBLE</code>ï¼Œé¡µé¢ä¸­çš„æ‰€æœ‰å…ƒç»„æ˜¯å¦å¯¹<strong>å½“å‰å’Œä¹‹å</strong>çš„æ‰€æœ‰äº‹åŠ¡å¯è§</li></ul></li><li class="lvl-2"><p><code>pd_lower</code>ï¼ŒæŒ‡å‘ç©ºé—²ç©ºé—´çš„èµ·å§‹ä½ç½®</p></li><li class="lvl-2"><p><code>pd_upper</code>ï¼ŒæŒ‡å‘ç©ºé—²ç©ºé—´çš„ç»“æŸä½ç½®</p></li><li class="lvl-2"><p><code>pd_special</code>ï¼ŒæŒ‡å‘ç‰¹æ®Šç©ºé—´çš„èµ·å§‹ä½ç½®</p></li><li class="lvl-2"><p><code>pd_pagesize_version</code>ï¼Œé¡µé¢å¸ƒå±€çš„ç‰ˆæœ¬å·</p></li><li class="lvl-2"><p><code>pd_prune_xid</code>ï¼Œç”¨äºé¡µé¢å…ƒç»„æ¸…ç†æ—¶çš„æ ‡è®°ä½ï¼Œè®°å½•äº†æœ€æ—§çš„å¯æ¸…ç†çš„äº‹åŠ¡å·ã€‚æ²¡æœ‰åˆ™ä¸º0</p></li><li class="lvl-2"><p><code>pg_linp</code>ï¼Œé¡µé¢è¡ŒæŒ‡é’ˆæ•°ç»„</p></li></ul><h3 id="é¡µé¢çš„è¡ŒæŒ‡é’ˆç»“æ„">é¡µé¢çš„è¡ŒæŒ‡é’ˆç»“æ„</h3><p>è¡ŒæŒ‡é’ˆæ˜¯ä¸€ä¸ª32ä½å¤§å°çš„ç´¢å¼•ç»“æ„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ItemIdData</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">unsigned</span>    lp_off:<span class="hljs-number">15</span>,<br>                lp_flags:<span class="hljs-number">2</span>,<br>                lp_len:<span class="hljs-number">15</span>;<br>&#125; ItemIdData;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><code>lp_off</code>ï¼Œè®°å½•äº†tupleåœ¨é¡µé¢ä¸­çš„offset</p></li><li class="lvl-2"><p><code>lp_len</code>ï¼Œè®°å½•äº†tupleçš„size</p></li><li class="lvl-2"><p><code>lp_flags</code>ï¼Œæ˜¯ä¸€ä¸ªtupleçŠ¶æ€çš„ç®€å•æ ‡è®°ï¼Œæ–¹ä¾¿åœ¨æ‰«æå…ƒç»„æ—¶åšä¸€ä¸ªåˆæ­¥ç­›é€‰ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªæ ‡è®°</p><ul class="lvl-2"><li class="lvl-4"><code>LP_UNUSED</code>ï¼Œå…ƒç»„æœªä½¿ç”¨ï¼Œå¯ä»¥ç«‹åˆ»è¢«é‡ç”¨</li><li class="lvl-4"><code>LP_NORMAL</code>ï¼Œå…ƒç»„çŠ¶æ€æ­£å¸¸</li><li class="lvl-4"><code>LP_REDIRECT</code>ï¼Œå…ƒç»„è¢«é‡å®šå‘äº†ã€‚ç”¨äºPGçš„HOTé“¾çš„å¤´éƒ¨å’Œä¸­é—´å…ƒç»„</li><li class="lvl-4"><code>LP_DEAD</code>ï¼Œå…ƒç»„å·²æ­»ï¼Œä½†ç©ºé—´å¯èƒ½è¿˜æ²¡æœ‰å›æ”¶</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¼€ä¸ªæ–°å‘ï¼Œç®€å•å†™ä¸€å†™PostgreSQLä¸­çš„å…ƒç»„ç®¡ç†ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºæ•´ä¸ªå­˜å‚¨æ¶æ„ï¼Œå„ç§PostgreSQLçš„ç›¸å…³ä¹¦ç±å·²ç»ä»‹ç»çš„å¾ˆè¯¦ç»†äº†ï¼Œè¿™é‡Œä¹Ÿå°±ä¸å†é‡å¤é€ è½®å­äº†ã€‚ä¸‹é¢æˆ‘ä»¬ä¸»è¦åŸºäºé¢å‘å¯¹è±¡ï¼ˆå¤§é›¾ï¼‰ï¼Œæ¥çœ‹çœ‹å…ƒç»„è¿™ä¸ªå¯¹è±¡ï¼Œæœ‰å“ªäº›&lt;code&gt;æˆå‘˜å˜é‡&lt;/code&gt;ï¼Œåˆæœ‰å“ªäº›&lt;</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="storage" scheme="https://spike1337.github.io/tags/storage/"/>
    
  </entry>
  
  <entry>
    <title>Linux Â· å·¥å…· Â· devtodo Â· ç®€æ´çš„ç»ˆç«¯todoå·¥å…·</title>
    <link href="https://spike1337.github.io/2023/02/07/devtodo-manual/"/>
    <id>https://spike1337.github.io/2023/02/07/devtodo-manual/</id>
    <published>2023-02-07T02:23:30.000Z</published>
    <updated>2023-08-22T06:03:21.632Z</updated>
    
    <content type="html"><![CDATA[<p>devtodoæ˜¯ä¸€æ¬¾è¿è¡Œäºç»ˆç«¯çš„todoå·¥å…·ï¼Œç®€æ´æ˜¯å®ƒçš„æœ€å¤§ä¼˜åŠ¿ã€‚devtodo ç›®å‰å·²è¢«è®¸å¤š Linux å‘è¡Œç‰ˆçš„è½¯ä»¶ä»“åº“æ”¶å½•ï¼Œå¯ä»¥ä»è½¯ä»¶ä»“åº“ä¸­å®‰è£…å®ƒï¼Œä¹Ÿå¯ä»¥ä»å®ƒçš„é¡¹ç›®ä¸»é¡µ<a href="https://github.com/alecthomas/devtodo">devtodo</a>ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ç¼–è¯‘å®‰è£…ã€‚</p><h2 id="å¿«é€Ÿä¸Šæ‰‹">å¿«é€Ÿä¸Šæ‰‹</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">todo          <span class="hljs-comment"># æ˜¾ç¤º todo list</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tda           <span class="hljs-comment"># æ·»åŠ ä¸€é¡¹ todoï¼Œä¹Ÿå¯ä»¥ç”¨ todo -a å‘½ä»¤</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tde  &lt;index&gt;  <span class="hljs-comment"># ä¿®æ”¹ç¬¬ index æ¡ todo</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tdd  &lt;index&gt;  <span class="hljs-comment"># æ ‡è®°ç¬¬ index æ¡ todo å·²ç»å®Œæˆ</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">tdr  &lt;index&gt;  <span class="hljs-comment"># åˆ é™¤ç¬¬ index æ¡ todo</span></span><br><span class="hljs-meta prompt_">$ </span><span class="language-bash">todo -A       <span class="hljs-comment"># æ˜¾ç¤ºæ‰€æœ‰çš„ todo æ¡ç›®ï¼ŒåŒ…æ‹¬å®Œæˆçš„ä»¥åŠæœªå®Œæˆçš„</span></span><br></code></pre></td></tr></table></figure><h2 id="å‘½ä»¤å±•ç¤º">å‘½ä»¤å±•ç¤º</h2><ul class="lvl-0"><li class="lvl-2"><p>todo</p></li></ul><p>æ˜¾ç¤ºtodo listã€‚æŒ‰ä¼˜å…ˆçº§é¡ºåºæ’åˆ—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">todo</span><br><br>1.test 1<br>2.test 2<br>3.test 3<br>4.test 4<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>tda</p></li></ul><p>æ·»åŠ ä¸€é¡¹todoã€‚è®¾å®štodoå†…å®¹ï¼Œå¹¶è®¾ç½®todoä¼˜å…ˆçº§</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tda</span><br><br>Enter text for the item you are adding.<br><span class="hljs-meta prompt_">text&gt; </span><span class="language-bash"><span class="hljs-built_in">test</span> 1</span><br>1. veryhigh   2. high   3. medium   4. low   5. verylow<br>Enter a priority from those listed above.<br><span class="hljs-meta prompt_">priority&gt; </span><span class="language-bash">1</span><br>Index of new item is 1<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>tde k</p></li></ul><p>ä¿®æ”¹ç¬¬ k æ¡ todoã€‚å¯ä»¥é‡æ–°ç¼–è¾‘todoå†…å®¹ï¼Œå¹¶è°ƒæ•´todoä¼˜å…ˆçº§</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tde 1</span><br><br>Modify the text of the item you are editing.<br><span class="hljs-meta prompt_">text&gt; </span><span class="language-bash"><span class="hljs-built_in">test</span> modify 1</span><br>1. veryhigh   2. high   3. medium   4. low   5. verylow<br>Enter a priority from those listed above.<br><span class="hljs-meta prompt_">priority&gt; </span><span class="language-bash">1</span><br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>tdd k</p></li></ul><p>æ ‡è®°ç¬¬ k æ¡ todo å·²å®Œæˆï¼Œå¯ä»¥è®¾å®šå®Œæˆçš„commentä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tdd 1</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">comment&gt; </span><span class="language-bash"><span class="hljs-keyword">done</span></span><br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>tdr k</p></li></ul><p>åˆ é™¤ç¬¬ k æ¡ todo</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">$ </span><span class="language-bash">tdr k</span><br><br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>todo -A</p></li></ul><p>æŸ¥çœ‹æ‰€æœ‰çš„ todo notesï¼Œä¸åŒ…æ‹¬è¢«åˆ é™¤é¡¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">- 2.test 2<br>  3.test 3<br>  4.test 4<br></code></pre></td></tr></table></figure><h2 id="è¿›é˜¶é…ç½®">è¿›é˜¶é…ç½®</h2><ol><li class="lvl-3"><p>å…¨å±€todo notsè®°å½•</p></li></ol><p>é»˜è®¤çš„devtodoæ˜¯åœ¨æ‰§è¡Œ<code>tda</code>æ—¶ï¼Œåœ¨æ‰§è¡Œç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶<code>.todo</code>æ¥è®°å½•todo notesï¼Œæ‰§è¡Œå…¶ä»–æ“ä½œæ—¶ä¹Ÿæ˜¯è¯»å–æ‰§è¡Œç›®å½•ä¸‹çš„<code>.todo</code>æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯æ¯ä¸ªæ‰§è¡Œç›®å½•æœ‰è‡ªå·±çš„todo listã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå…¨å±€çš„todo listï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code>-G</code>å‚æ•°ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">-G, --global            Use the database specified by the --global-database option. Defaults to ~/.todo_global.<br></code></pre></td></tr></table></figure><p><code>-G</code>å‚æ•°ä½¿ç”¨ <code>~/.todo_global</code>ä½œä¸ºå­˜å‚¨todo notesçš„æ•°æ®åº“ï¼Œè¿™æ ·æˆ‘ä»¬çš„todoå°±å¯ä»¥åœ¨å…¨å±€èŒƒå›´å†…ä½¿ç”¨ã€‚ä½œä¸ºæ‡’ç‹—æˆ‘å°±ç›´æ¥å°†<code>-G</code>å‚æ•°å†™å…¥äº†alias</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">alias todo=&quot;todo -G&quot;<br>alias tda=&quot;tda -G&quot;<br>alias tdd=&quot;tdd -G&quot;<br>alias tde=&quot;tde -G&quot;<br>alias tdr=&quot;tdr -G&quot;<br></code></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨é»˜è®¤çš„<code>~/.todo_global</code>æ–‡ä»¶ä½œä¸ºå…¨å±€æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>--global-database</code>æŒ‡å®šå…¨å±€æ•°æ®åº“çš„æ–‡ä»¶ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">--global-database ARG   Specify the database to use if the -G (--global) parameter is used.<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">ä¸€æ¬¾è¿è¡Œäºç»ˆç«¯çš„todoç®¡ç†å·¥å…·</summary>
    
    
    
    <category term="Linux" scheme="https://spike1337.github.io/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://spike1337.github.io/tags/Linux/"/>
    
    <category term="tools" scheme="https://spike1337.github.io/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL Â· æºç è§£æ Â· MVCCæœºåˆ¶</title>
    <link href="https://spike1337.github.io/2023/02/06/mvcc-source-code/"/>
    <id>https://spike1337.github.io/2023/02/06/mvcc-source-code/</id>
    <published>2023-02-06T06:36:45.000Z</published>
    <updated>2023-08-24T01:54:42.631Z</updated>
    
    <content type="html"><![CDATA[<p>PostgreSQLé‡‡ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰æ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚æ£€ç´¢æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½åªæ˜¯ä¸€æ®µæ—¶é—´ä¹‹å‰çš„æ•°æ®å¿«ç…§ã€‚MVCCå¹¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„å¹¶å‘æ§åˆ¶æƒ…å†µï¼Œéœ€è¦ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“çš„é”æœºåˆ¶æ¥ä¿è¯äº‹åŠ¡çš„å¹¶å‘ï¼Œå› æ­¤åœ¨PostgreSQLé‡Œä¹Ÿæœ‰è¡¨å’Œè¡Œçº§åˆ«çš„é”å®šæœºåˆ¶ã€‚æ­¤å¤–PostgreSQLè¿˜æä¾›äº†ä¼šè¯é”æœºåˆ¶ï¼Œå¯ä»¥åˆ©ç”¨å®ƒä¸€æ¬¡å¯¹æŸä¸ªå¯¹è±¡åŠ é”ä¿è¯å¯¹äºå¤šä¸ªäº‹åŠ¡éƒ½æœ‰æ•ˆã€‚</p><h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«">äº‹åŠ¡éš”ç¦»çº§åˆ«</h2><h3 id="æ ‡å‡†äº‹åŠ¡éš”ç¦»çº§åˆ«">æ ‡å‡†äº‹åŠ¡éš”ç¦»çº§åˆ«</h3><p>ä¸‰ä¸ªå¿…é¡»åœ¨å¹¶è¡Œçš„äº‹åŠ¡ä¹‹é—´é¿å…çš„ç°è±¡ï¼š</p><ul class="lvl-0"><li class="lvl-4"><p>è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªæœªæäº¤çš„å¹¶è¡Œäº‹åŠ¡å†™çš„æ•°æ®</p></li><li class="lvl-4"><p>ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€ä¸ªæ•°æ®å‰åè¯»å–ä¸¤æ¬¡ï¼Œå‘ç°è¯¥æ•°æ®å·²ç»è¢«å¦ä¸€ä¸ªå·²æäº¤çš„æ•°æ®ä¿®æ”¹è¿‡</p></li><li class="lvl-4"><p>å¹»è¯»ï¼šäº‹åŠ¡Aè¯»å–æŸä¸€èŒƒå›´å†…çš„æ•°æ®è¡Œæ—¶ï¼Œäº‹åŠ¡Båœ¨è¯¥èŒƒå›´å†…æ’å…¥æ–°è¡Œï¼Œå½“äº‹åŠ¡Aå†æ¬¡è¯»å–è¯¥èŒƒå›´å†…çš„æ•°æ®æ—¶æ— æ³•æŸ¥è¯¢åˆ°æ–°å¢çš„æ•°æ®</p></li></ul><p>å››ä¸ªäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š</p><table><thead><tr><th>éš”ç¦»çº§åˆ«</th><th>è„è¯»</th><th>ä¸å¯é‡å¤è¯»</th><th>å¹»è¯»</th></tr></thead><tbody><tr><td>è¯»æœªæäº¤</td><td>â­•</td><td>â­•</td><td>â­•</td></tr><tr><td>è¯»å·²æäº¤</td><td>âŒ</td><td>â­•</td><td>â­•</td></tr><tr><td>å¯é‡å¤è¯»</td><td>âŒ</td><td>âŒ</td><td>â­•</td></tr><tr><td>å¯ä¸²è¡ŒåŒ–</td><td>âŒ</td><td>âŒ</td><td>âŒ</td></tr></tbody></table><h3 id="PostgreSQLçš„éš”ç¦»çº§åˆ«">PostgreSQLçš„éš”ç¦»çº§åˆ«</h3><p>åœ¨PostgreSQLä¸­ï¼Œå¯ä»¥è¯·æ±‚ä»¥ä¸Šå››ç§äº‹åŠ¡éš”ç¦»çº§åˆ«çš„ä»»æ„ä¸€ç§ã€‚ä½†æ˜¯åœ¨å†…éƒ¨ï¼Œåªæœ‰ä¸¤ç§ç‹¬ç«‹çš„éš”ç¦»çº§åˆ«ï¼šè¯»å·²æäº¤å’Œå¯ä¸²è¡ŒåŒ–ã€‚å³é€‰æ‹©è¯»æœªæäº¤çš„éš”ç¦»çº§åˆ«ï¼Œå®é™…ç”¨çš„æ˜¯è¯»å·²æäº¤ã€‚ä¸‹é¢ä»‹ç»PostgreSQLå®šä¹‰çš„ä¸¤ç§éš”ç¦»çº§åˆ«ï¼š</p><ul class="lvl-0"><li class="lvl-4"><p><strong>è¯»å·²æäº¤</strong>ï¼šç¼ºçœéš”ç¦»çº§åˆ«ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è¿è¡Œåœ¨è¿™ä¸ªéš”ç¦»çº§åˆ«æ—¶ï¼Œä¸€ä¸ª<code>SELECT</code>æŸ¥è¯¢åªèƒ½çœ‹åˆ°æŸ¥è¯¢å¼€å§‹ä¹‹å‰æäº¤çš„æ•°æ®ã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡åœ¨å¯¹åŒä¸€å…ƒç»„è¿›è¡Œæ›´æ–°ï¼Œå¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡å›æ»šï¼Œåˆ™å¿½ç•¥å…¶ä½œç”¨ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ç»§ç»­æ›´æ–°è¯¥å…ƒç»„ï¼›ç¬¬äºŒä¸ªäº‹åŠ¡åˆ™ç­‰å¾…ç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤æˆ–å›æ»šã€‚å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤ï¼Œç³»ç»Ÿé‡æ–°è®¡ç®—æŸ¥è¯¢æ¡ä»¶ï¼Œå¦‚æœç¬¦åˆåˆ™ç»§ç»­æ›´æ–°æ“ä½œã€‚</p></li><li class="lvl-4"><p><strong>å¯ä¸²è¡ŒåŒ–</strong>ï¼šæä¾›äº†æœ€ä¸¥æ ¼çš„äº‹åŠ¡éš”ç¦»ã€‚æ¨¡æ‹Ÿä¸²è¡Œçš„äº‹åŠ¡æ‰§è¡Œã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡åœ¨å¯¹åŒä¸€å…ƒç»„è¿›è¡Œæ›´æ–°ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡åˆ™ç­‰å¾…ç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤æˆ–å›æ»šã€‚å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡å›æ»šï¼Œåˆ™å¿½ç•¥å…¶ä½œç”¨ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ç»§ç»­æ›´æ–°è¯¥å…ƒç»„ï¼›å¦‚æœç¬¬ä¸€ä¸ªäº‹åŠ¡æäº¤ï¼Œé‚£ä¹ˆå¯ä¸²è¡ŒåŒ–äº‹åŠ¡å›æ»šï¼Œä»å¤´å¼€å§‹è¿›è¡Œæ•´ä¸ªäº‹åŠ¡ã€‚</p></li></ul><p>åœ¨PostgreSQLç³»ç»Ÿä¸­ï¼Œäº‹åŠ¡çš„éš”ç¦»çº§åˆ«æ‰€æ¶‰åŠçš„æœ€å°å¯¹è±¡æ˜¯å…ƒç»„ï¼Œæ‰€ä»¥å¯¹å…ƒç»„çš„æ“ä½œéœ€è¦å®æ–½è®¿é—®æ§åˆ¶ã€‚è¿™ä¸ªæ“ä½œæ˜¯é€šè¿‡é”æ“ä½œä»¥åŠMVCCç›¸å…³çš„æ“ä½œæ¥å®ç°çš„</p><h2 id="MVCCæ¶æ„">MVCCæ¶æ„</h2><p>åœ¨å†…éƒ¨ï¼ŒPostgreSQLåˆ©ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼ŒMultiVersion Concurrency Controlï¼‰æ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚å³å½“æ£€ç´¢æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„åªæ˜¯ä¸€æ®µæ—¶é—´ä¹‹å‰çš„äº‹åŠ¡å¿«ç…§ï¼Œè€Œä¸æ˜¯æ•°æ®çš„å½“å‰çŠ¶æ€ã€‚è¿™æ ·å¯¹æ¯ä¸ªæ•°æ®åº“ä¼šè¯è¿›è¡Œäº‹åŠ¡éš”ç¦»ï¼Œå°±å¯ä»¥é¿å…ä¸€ä¸ªäº‹åŠ¡çœ‹åˆ°å…¶ä»–å¹¶å‘æ—¶çš„æ›´æ–°å¯¼è‡´ä¸ä¸€è‡´çš„æ•°æ®</p><h3 id="å…ƒç»„ç›¸å…³æ•°æ®ç»“æ„">å…ƒç»„ç›¸å…³æ•°æ®ç»“æ„</h3><p>åœ¨PostgreSQLç³»ç»Ÿä¸­ï¼Œæ›´æ–°æ•°æ®å¹¶ä¸æ˜¯ç”¨æ–°å€¼è¦†ç›–æ—§å€¼ï¼Œè€Œæ˜¯åœ¨è¡¨ä¸­å¼€è¾Ÿä¸€ç‰‡ç©ºé—´æ¥å­˜æ”¾æ–°çš„å…ƒç»„ï¼Œæ–°å€¼ä¸æ—§å€¼åŒæ—¶å­˜åœ¨äºæ•°æ®åº“ä¸­ï¼Œåªæ˜¯é€šè¿‡è®¾ç½®ä¸€äº›å‚æ•°è®©ç³»ç»Ÿå¯ä»¥è¯†åˆ«ä»–ä»¬</p><p>å…ƒç»„çš„äº‹åŠ¡å’Œå‘½ä»¤æ§åˆ¶ä¿¡æ¯å­˜å‚¨åœ¨<code>HeapTupleFields</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HeapTupleFields</span></span><br><span class="hljs-class">&#123;</span><br>    TransactionId t_xmin;<span class="hljs-comment">// åˆ›å»ºæ­¤tupleçš„XID</span><br>    TransactionId t_xmax;<span class="hljs-comment">// åˆ é™¤æ­¤tupleçš„XID</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>        CommandIdt_cid;<span class="hljs-comment">// åˆ›å»ºæˆ–åˆ é™¤tupleçš„CIDï¼Œä¹Ÿå¯èƒ½äºŒè€…éƒ½ä¿å­˜</span><br>        TransactionId t_xvac;<span class="hljs-comment">// æ¸…ç†æ“ä½œçš„äº‹åŠ¡ID</span><br>    &#125;t_field3;<br>&#125; HeapTupleFields;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœä¸€ä¸ªäº‹åŠ¡ç¡®å®åˆ›å»ºå¹¶åˆ é™¤äº†åŒä¸€ä¸ªå…ƒç»„ï¼Œåˆ™ä½¿ç”¨ä¸€ä¸ªCombo Command ID æ¥ä¿å­˜Cminå’ŒCmax</p></li></ul><p>å…ƒç»„çš„ç›¸å…³æ§åˆ¶ä¿¡æ¯å­˜å‚¨åœ¨å…ƒç»„çš„å¤´éƒ¨<code>HeapTupleHeaderData</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">HeapTupleHeaderData</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">&#123;</span><br>HeapTupleFields t_heap;<br>DatumTupleFields t_datum;<br>&#125;t_choice;<br><br>ItemPointerData t_ctid;<span class="hljs-comment">// æœ¬å…ƒç»„æˆ–æ›´æ–°å…ƒç»„çš„å½“å‰TID</span><br>uint16t_infomask2;<span class="hljs-comment">// å±æ€§ã€æ ‡è®°ä½æ•°é‡æ ‡è®°ä½</span><br>uint16t_infomask;<span class="hljs-comment">// å…ƒç»„äº‹åŠ¡ä¿¡æ¯æ ‡è®°ä½</span><br>uint8t_hoff;<span class="hljs-comment">// å¤´éƒ¨é•¿åº¦</span><br>bits8t_bits[FLEXIBLE_ARRAY_MEMBER];<span class="hljs-comment">// æ ‡è®°ä½œç”¨çš„å¡«å……ä½</span><br>&#125;;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å…¶ä¸­ï¼Œ<code>t_ctid</code>å½“å…ƒç»„è¢«ä¿å­˜åœ¨ç£ç›˜ä¸­æ—¶è¢«åˆå§‹åŒ–ä¸ºè‡ªå·±çš„å®é™…å­˜å‚¨ä½ç½®ã€‚å¦‚æœå…ƒç»„è¢«æ›´æ–°ï¼Œ<code>t_cid</code>æŒ‡å‘æ›´æ–°åçš„æ–°å…ƒç»„ã€‚å¦‚æœè¦æ‰¾åˆ°æŸä¸ªå…ƒç»„çš„æœ€æ–°ç‰ˆæœ¬ï¼Œåªéœ€éå†ç”±<code>t_ctid</code>æ„æˆçš„é“¾è¡¨å³å¯</p></li><li class="lvl-2"><p><code>t_infomask</code>å­—æ®µè¡¨ç¤ºå½“å‰å…ƒç»„çš„äº‹åŠ¡ä¿¡æ¯</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_HASNULL0x0001<span class="hljs-comment">// ç©ºå­—æ®µæ ‡è®°ä½</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_HASVARWIDTH0x0002<span class="hljs-comment">// å˜é•¿å­—æ®µæ ‡è®°ä½</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_HASEXTERNAL0x0004<span class="hljs-comment">// å¤–éƒ¨å­˜å‚¨å­—æ®µæ ‡è®°ä½</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_HASOID_OLD0x0008<span class="hljs-comment">// æœ‰OIDå­—æ®µ</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMAX_KEYSHR_LOCK0x0010<span class="hljs-comment">// xmaxæ˜¯å…±äº«é”</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_COMBOCID0x0020<span class="hljs-comment">// t_cidæ˜¯combo cid</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMAX_EXCL_LOCK0x0040<span class="hljs-comment">// xmaxæ˜¯æ’ä»–é”</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMAX_LOCK_ONLY0x0080<span class="hljs-comment">// xmaxå¦‚æœæœ‰æ•ˆåˆ™åªæ˜¯ä¸€ä¸ªé”</span></span><br><br> <span class="hljs-comment">// xmax is a shared locker</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMAX_SHR_LOCK(HEAP_XMAX_EXCL_LOCK | HEAP_XMAX_KEYSHR_LOCK)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_LOCK_MASK(HEAP_XMAX_SHR_LOCK | HEAP_XMAX_EXCL_LOCK | \</span><br><span class="hljs-meta"> HEAP_XMAX_KEYSHR_LOCK)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMIN_COMMITTED0x0100<span class="hljs-comment">// t_xminå·²æäº¤</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMIN_INVALID0x0200<span class="hljs-comment">// t_xminæ— æ•ˆ/ä¸­æ–­</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMIN_FROZEN(HEAP_XMIN_COMMITTED|HEAP_XMIN_INVALID)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMAX_COMMITTED0x0400<span class="hljs-comment">// t_xmaxå·²æäº¤</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMAX_INVALID0x0800<span class="hljs-comment">// t_xmaxæ— æ•ˆ/ä¸­æ–­</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XMAX_IS_MULTI0x1000<span class="hljs-comment">// t_xmaxæ˜¯ç»„åˆäº‹åŠ¡</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_UPDATED0x2000<span class="hljs-comment">// æ›´æ–°åçš„æ–°å…ƒç»„</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_MOVED_OFF0x4000<span class="hljs-comment">// è¢«ä¹‹å‰ç‰ˆæœ¬çš„VACUUM FULLç§»åˆ°å…¶ä»–åœ°æ–¹ï¼Œç”¨ä»¥å…¼å®¹äºŒè¿›åˆ¶å‡çº§</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_MOVED_IN0x8000<span class="hljs-comment">// è¢«ä¹‹å‰ç‰ˆæœ¬çš„VACUUM FULLä»å…¶ä»–åœ°æ–¹ç§»å…¥ï¼Œç”¨ä»¥å…¼å®¹äºŒè¿›åˆ¶å‡çº§</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_MOVED (HEAP_MOVED_OFF | HEAP_MOVED_IN)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HEAP_XACT_MASK0xFFF0<span class="hljs-comment">// å¯è§æ€§ç›¸å…³æ ‡è®°</span></span><br></code></pre></td></tr></table></figure><h3 id="MVCC">MVCC</h3><p>MVCCåŸºæœ¬åŸç†å¦‚å›¾ã€‚æœ‰ä¸¤ä¸ªå¹¶å‘äº‹åŠ¡T1ï¼ŒT2ï¼ŒT1å°†å…ƒç»„Cæ›´æ–°ä¸ºCâ€˜ï¼Œä½†å¹¶æ²¡æœ‰æäº¤ã€‚æ­¤æ—¶T2è¦å¯¹è¯¥å…ƒç»„è¿›è¡ŒæŸ¥è¯¢ï¼Œä¼šé€šè¿‡Cå’ŒCâ€™çš„å¤´éƒ¨ä¿¡æ¯çš„Xminå’ŒXmaxä»¥åŠt_infomaskæ¥åˆ¤æ–­å“ªä¸ªä¸ºå¯¹å½“å‰äº‹åŠ¡çš„æœ‰æ•ˆç‰ˆæœ¬</p><p><img src="/uploads/pg_mvcc_base.png" alt="MVCCåŸºæœ¬åŸç†"></p><h4 id="MVCCä¸å¿«ç…§">MVCCä¸å¿«ç…§</h4><p>è®¨è®ºMVCCçš„åˆ¤æ–­é€»è¾‘ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£å¿«ç…§ï¼ˆsnapshotï¼‰</p><p>å¿«ç…§ï¼ˆsnapshotï¼‰è®°å½•äº†æ•°æ®åº“å½“å‰æŸä¸ªæ—¶åˆ»çš„æ´»è·ƒäº‹åŠ¡åˆ—è¡¨ï¼Œé€šè¿‡å¿«ç…§ç¡®å®šæŸä¸ªå…ƒç»„çš„ç‰ˆæœ¬å¯¹äºå½“å‰å¿«ç…§æ˜¯å¦å¯è§ã€‚å¿«ç…§å®šä¹‰åœ¨<code>SnapshotData</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SnapshotData</span></span><br><span class="hljs-class">&#123;</span><br>    SnapshotType snapshot_type; <span class="hljs-comment">// å¿«ç…§ç±»å‹</span><br><br>    TransactionId xmin;         <span class="hljs-comment">// æ‰€æœ‰XID &lt; xminå¯¹å½“å‰å¿«ç…§å¯è§</span><br>    TransactionId xmax;         <span class="hljs-comment">// æ‰€æœ‰XID &gt;= xmaxå¯¹å½“å‰å¿«ç…§å¯è§</span><br><br>    TransactionId *xip;         <span class="hljs-comment">// å½“å‰æ´»è·ƒäº‹åŠ¡çš„é“¾è¡¨</span><br>    uint32      xcnt;           <span class="hljs-comment">// å½“å‰æ´»è·ƒäº‹åŠ¡é“¾è¡¨é•¿åº¦</span><br><br>    TransactionId *subxip;      <span class="hljs-comment">// å½“å‰æ´»è·ƒå­äº‹åŠ¡é“¾è¡¨</span><br>    int32       subxcnt;        <span class="hljs-comment">// å½“å‰æ´»è·ƒå­äº‹åŠ¡é“¾è¡¨çš„é•¿åº¦</span><br>    <span class="hljs-type">bool</span>        suboverflowed;  <span class="hljs-comment">// æ´»è·ƒå­äº‹åŠ¡æ•°ç»„æ˜¯å¦ç§»é™¤</span><br><br>    <span class="hljs-type">bool</span>        takenDuringRecovery;    <span class="hljs-comment">// æ˜¯å¦æ˜¯åœ¨Recoveryä¸­çš„å¿«ç…§</span><br>    <span class="hljs-type">bool</span>        copied;         <span class="hljs-comment">// é™æ€å¿«ç…§åˆ™ä¸ºfalse</span><br><br>    CommandId   curcid;         <span class="hljs-comment">// æ‰€æœ‰CID &lt; curcidæ˜¯å¯è§çš„</span><br><br>    <span class="hljs-comment">// HeapTupleSatisfiesDirtyä¸­çš„é¢å¤–è¿”å›å€¼ï¼Œå¹¶æ²¡æœ‰åœ¨MVCCå¿«ç…§ä¸­ä½¿ç”¨</span><br>    uint32      speculativeToken;<br><br>    <span class="hljs-comment">// ç”±å¿«ç…§ç®¡ç†å™¨ä½¿ç”¨çš„ä¿¡æ¯</span><br>    uint32      active_count;   <span class="hljs-comment">// åœ¨æ´»è·ƒå¿«ç…§é“¾è¡¨é‡Œçš„å¼•ç”¨è®¡æ•°</span><br>    uint32      regd_count;     <span class="hljs-comment">// åœ¨å·²æ³¨å†Œçš„å¿«ç…§é“¾è¡¨é‡Œçš„å¼•ç”¨è®¡æ•°</span><br>    pairingheap_node ph_node;   <span class="hljs-comment">// å·²æ³¨å†Œçš„å¿«ç…§é“¾è¡¨</span><br><br>    TimestampTz whenTaken;      <span class="hljs-comment">// è®°å½•å¿«ç…§çš„æ—¶é—´æˆ³</span><br>    XLogRecPtr  lsn;            <span class="hljs-comment">// è®°å½•å¿«ç…§æ—¶åœ¨WALä¸­çš„ä½ç½®</span><br>&#125; SnapshotData;<br></code></pre></td></tr></table></figure><p>åœ¨PostgreSQLä¸­æœ‰é»˜è®¤çš„7ç§å½¢å¼å¿«ç…§ï¼ˆ15.1ï¼‰ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">SnapshotType</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-comment">// å…ƒç»„å¯¹äºç»™å®šçš„MVCCå¿«ç…§æœ‰æ•ˆ</span><br>    SNAPSHOT_MVCC = <span class="hljs-number">0</span>,<br><br>    <span class="hljs-comment">// å…ƒç»„å¯¹äºè‡ªèº«æœ‰æ•ˆ</span><br>    SNAPSHOT_SELF,<br><br>    <span class="hljs-comment">// ä»»ä½•å…ƒç»„éƒ½æ˜¯å¯è§çš„</span><br>    SNAPSHOT_ANY,<br><br>    <span class="hljs-comment">// å…ƒç»„ä½œä¸ºTOASTè¡Œ æœ‰æ•ˆ</span><br>    SNAPSHOT_TOAST,<br><br>    <span class="hljs-comment">// ä¸‹é¢ä¸‰ä¸ªä¸å¤ªå¥½è§£é‡Šï¼Œç›´æ¥è´´åŸæ–‡</span><br>    <span class="hljs-comment">/*-------------------------------------------------------------------------</span><br><span class="hljs-comment">     * A tuple is visible iff the tuple is valid including effects of open</span><br><span class="hljs-comment">     * transactions.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * Here, we consider the effects of:</span><br><span class="hljs-comment">     * - all committed and in-progress transactions (as of the current instant)</span><br><span class="hljs-comment">     * - previous commands of this transaction</span><br><span class="hljs-comment">     * - changes made by the current command</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * This is essentially like SNAPSHOT_SELF as far as effects of the current</span><br><span class="hljs-comment">     * transaction and committed/aborted xacts are concerned.  However, it</span><br><span class="hljs-comment">     * also includes the effects of other xacts still in progress.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * A special hack is that when a snapshot of this type is used to</span><br><span class="hljs-comment">     * determine tuple visibility, the passed-in snapshot struct is used as an</span><br><span class="hljs-comment">     * output argument to return the xids of concurrent xacts that affected</span><br><span class="hljs-comment">     * the tuple.  snapshot-&gt;xmin is set to the tuple&#x27;s xmin if that is</span><br><span class="hljs-comment">     * another transaction that&#x27;s still in progress; or to</span><br><span class="hljs-comment">     * InvalidTransactionId if the tuple&#x27;s xmin is committed good, committed</span><br><span class="hljs-comment">     * dead, or my own xact.  Similarly for snapshot-&gt;xmax and the tuple&#x27;s</span><br><span class="hljs-comment">     * xmax.  If the tuple was inserted speculatively, meaning that the</span><br><span class="hljs-comment">     * inserter might still back down on the insertion without aborting the</span><br><span class="hljs-comment">     * whole transaction, the associated token is also returned in</span><br><span class="hljs-comment">     * snapshot-&gt;speculativeToken.  See also InitDirtySnapshot().</span><br><span class="hljs-comment">     * -------------------------------------------------------------------------</span><br><span class="hljs-comment">     */</span><br>    SNAPSHOT_DIRTY,<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * A tuple is visible iff it follows the rules of SNAPSHOT_MVCC, but</span><br><span class="hljs-comment">     * supports being called in timetravel context (for decoding catalog</span><br><span class="hljs-comment">     * contents in the context of logical decoding).</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// å…ƒç»„å¯¹MVCCå¿«ç…§æœ‰æ•ˆï¼Œä¸”æ”¯æŒé€»è¾‘å¤åˆ¶</span><br>    SNAPSHOT_HISTORIC_MVCC,<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * A tuple is visible iff the tuple might be visible to some transaction;</span><br><span class="hljs-comment">     * false if it&#x27;s surely dead to everyone, i.e., vacuumable.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * For visibility checks snapshot-&gt;min must have been set up with the xmin</span><br><span class="hljs-comment">     * horizon to use.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// å…ƒç»„å¯¹æŸäº›äº‹åŠ¡å¯è§ï¼Œå¦‚æœå¯¹æ‰€æœ‰äº‹åŠ¡éƒ½æ˜¯dead tupleï¼Œä¹Ÿå°±æ˜¯vacuumableï¼Œåˆ™è¿”å›false</span><br>    SNAPSHOT_NON_VACUUMABLE<br>&#125; SnapshotType;<br></code></pre></td></tr></table></figure><h3 id="MVCCæœºåˆ¶çš„å®ç°">MVCCæœºåˆ¶çš„å®ç°</h3><p>ä»¥å‡½æ•°<code>HeapTupleSatisfiesSelf</code>ä¸ºä¾‹ï¼Œä¸‹é¢ä»‹ç»MVCCæœºåˆ¶çš„å…·ä½“å®ç°ã€‚å¦‚æœè¿”å›å€¼ä¸ºTrueï¼Œåˆ™è¯¥å…ƒç»„æ˜¯å¯è§çš„ã€‚åˆ¤æ–­æ—¶ä¼šè€ƒè™‘ä¸‰ä¸ªæ–¹é¢çš„å› ç´ ï¼šæ‰€æœ‰å·²æäº¤çš„äº‹åŠ¡ï¼Œå½“å‰äº‹åŠ¡å‰çš„æ‰€æœ‰å‘½ä»¤ä»¥åŠå½“å‰å‘½ä»¤å‰çš„æ‰€æœ‰æ“ä½œã€‚æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>æ£€æŸ¥Xminæ˜¯å¦ä¸ºå·²æäº¤ï¼Œå¦‚æœå…ƒç»„çš„Xminè¿˜æœªæäº¤</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Xminæœªæäº¤</span><br><span class="hljs-keyword">if</span> (!HeapTupleHeaderXminCommitted(tuple))<br>&#123;<br>    <span class="hljs-comment">// Xminæ— æ•ˆï¼Œå…ƒç»„ä¸å¯è§</span><br>    <span class="hljs-keyword">if</span> (HeapTupleHeaderXminInvalid(tuple))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-comment">// å…¼å®¹äºŒè¿›åˆ¶å‡çº§</span><br>    <span class="hljs-keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_MOVED_OFF)<br>    &#123;<br>...<br>    &#125;<br>    <span class="hljs-comment">// å…¼å®¹äºŒè¿›åˆ¶å‡çº§</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_MOVED_IN)<br>    &#123;<br>...<br>    &#125;<br>    <span class="hljs-comment">// Xminä¸ºå½“å‰äº‹åŠ¡</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmin(tuple)))<br>    &#123;<br>        <span class="hljs-comment">// Xmaxæ— æ•ˆï¼Œåˆ™XIDæ— æ•ˆï¼Œå¯è§</span><br>        <span class="hljs-keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_INVALID)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-comment">// Xmaxè¢«é”å®šï¼Œå³å…ƒç»„è¢«é”å®šï¼Œå¯è§</span><br>        <span class="hljs-keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-comment">// Xmaxæ˜¯ç»„åˆäº‹åŠ¡</span><br>        <span class="hljs-keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_IS_MULTI)<br>        &#123;<br>            xmax = HeapTupleGetUpdateXid(tuple);<br>            <span class="hljs-comment">// æ›´æ–°å­äº‹åŠ¡å¿…é¡»å·²å›æ»šï¼Œå› ä¸ºå‰ææ˜¯Xminæœªæäº¤</span><br>            <span class="hljs-keyword">if</span> (!TransactionIdIsCurrentTransactionId(xmax))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Xmaxä¸ºå½“å‰äº‹åŠ¡</span><br>        <span class="hljs-keyword">if</span> (!TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmax(tuple)))<br>        &#123;<br>            <span class="hljs-comment">// åˆ é™¤å­äº‹åŠ¡å¿…é¡»å·²ç»ˆæ­¢</span><br>            SetHintBits(tuple, buffer, HEAP_XMAX_INVALID,<br>                        InvalidTransactionId);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">// Xminæ­£åœ¨æŸä¸ªåç«¯è¿›ç¨‹ä¸­è¿è¡Œ</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (TransactionIdIsInProgress(HeapTupleHeaderGetRawXmin(tuple)))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// Xminå·²ç»è¢«æäº¤</span><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (TransactionIdDidCommit(HeapTupleHeaderGetRawXmin(tuple)))<br>        SetHintBits(tuple, buffer, HEAP_XMIN_COMMITTED,<br>                    HeapTupleHeaderGetRawXmin(tuple));<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-comment">// å¦åˆ™ä¸€å®šæ˜¯ä¸­æ­¢æˆ–å´©æºƒ</span><br>        SetHintBits(tuple, buffer, HEAP_XMIN_INVALID,<br>                    InvalidTransactionId);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Xminå·²æäº¤ã€‚å¦‚æœXmaxæ— æ•ˆæˆ–ä¸­æ–­ï¼Œå…ƒç»„å¯è§</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_INVALID)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Xminå·²æäº¤ï¼ŒXmaxå·²æäº¤</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_COMMITTED)<br>&#123;<br>    <span class="hljs-comment">// å¦‚æœXmaxè¢«é”å®šï¼Œå¯è§</span><br>    <span class="hljs-keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Xminå·²æäº¤ï¼ŒXmaxä¸ºç»„åˆäº‹åŠ¡</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (tuple-&gt;t_infomask &amp; HEAP_XMAX_IS_MULTI)<br>&#123;<br>    TransactionId xmax;<br><br>    <span class="hljs-comment">// Xmaxè¢«é”å®šï¼Œå¯è§</span><br>    <span class="hljs-keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br>    xmax = HeapTupleGetUpdateXid(tuple);<br><br>    <span class="hljs-comment">// Xmaxæ˜¯å½“å‰äº‹åŠ¡</span><br>    <span class="hljs-keyword">if</span> (TransactionIdIsCurrentTransactionId(xmax))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// Xmaxæ­£åœ¨è¢«æŸä¸ªåç«¯è¿›ç¨‹æ‰§è¡Œ</span><br>    <span class="hljs-keyword">if</span> (TransactionIdIsInProgress(xmax))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-comment">// Xmaxå·²ç»è¢«æäº¤</span><br>    <span class="hljs-keyword">if</span> (TransactionIdDidCommit(xmax))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// å¦åˆ™äº‹åŠ¡è¢«ä¸­æ–­æˆ–å´©æºƒ</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>Xminå·²æäº¤ï¼ŒXmaxä¸æ˜¯ç»„åˆäº‹åŠ¡</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// Xmaxæ˜¯å½“å‰äº‹åŠ¡</span><br><span class="hljs-keyword">if</span> (TransactionIdIsCurrentTransactionId(HeapTupleHeaderGetRawXmax(tuple)))<br>&#123;<br>    <span class="hljs-keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-comment">// Xmaxæ­£åœ¨è¢«æŸä¸ªåç«¯è¿›ç¨‹æ‰§è¡Œ</span><br><span class="hljs-keyword">if</span> (TransactionIdIsInProgress(HeapTupleHeaderGetRawXmax(tuple)))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><span class="hljs-comment">// Xmaxå·²ç»è¢«æäº¤</span><br><span class="hljs-keyword">if</span> (!TransactionIdDidCommit(HeapTupleHeaderGetRawXmax(tuple)))<br>&#123;<br>    <span class="hljs-comment">// it must have aborted or crashed</span><br>    SetHintBits(tuple, buffer, HEAP_XMAX_INVALID,<br>                InvalidTransactionId);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-comment">// Xmaxè¢«é”å®š</span><br><span class="hljs-keyword">if</span> (HEAP_XMAX_IS_LOCKED_ONLY(tuple-&gt;t_infomask))<br>&#123;<br>    SetHintBits(tuple, buffer, HEAP_XMAX_INVALID,<br>                InvalidTransactionId);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>SNAPSHOT_SELF</code>æ‰€å¯¹åº”çš„MVCCåˆ¤æ–­æœºåˆ¶å¦‚ä¸Šï¼Œå…¶ä»–snapshotç±»å‹å¯¹åº”çš„åˆ¤æ–­é€»è¾‘ç±»ä¼¼ï¼Œå°±ä¸å†è¯¦ç»†ä»‹ç»äº†</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;PostgreSQLé‡‡ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰æ¥ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚æ£€ç´¢æ•°æ®æ—¶ï¼Œæ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„éƒ½åªæ˜¯ä¸€æ®µæ—¶é—´ä¹‹å‰çš„æ•°æ®å¿«ç…§ã€‚MVCCå¹¶ä¸èƒ½è§£å†³æ‰€æœ‰çš„å¹¶å‘æ§åˆ¶æƒ…å†µï¼Œéœ€è¦ä½¿ç”¨ä¼ ç»Ÿæ•°æ®åº“çš„é”æœºåˆ¶æ¥ä¿è¯äº‹åŠ¡çš„å¹¶å‘ï¼Œå› æ­¤åœ¨PostgreSQLé‡Œä¹Ÿæœ‰è¡¨å’Œè¡Œçº§åˆ«çš„é”å®šæœºåˆ¶ã€‚æ­¤å¤–Post</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="transaction" scheme="https://spike1337.github.io/tags/transaction/"/>
    
    <category term="MVCC" scheme="https://spike1337.github.io/tags/MVCC/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL Â· æºç è§£æ Â· WALæ—¥å¿—</title>
    <link href="https://spike1337.github.io/2023/02/03/pg-wal-source-code/"/>
    <id>https://spike1337.github.io/2023/02/03/pg-wal-source-code/</id>
    <published>2023-02-03T05:44:58.000Z</published>
    <updated>2023-08-24T01:54:50.544Z</updated>
    
    <content type="html"><![CDATA[<p>Postgresql ä½¿ç”¨ wal æ—¥å¿—ä¿å­˜æ¯ä¸€æ¬¡çš„æ•°æ®ä¿®æ”¹ï¼Œè¿™æ ·ä¿è¯äº†æ•°æ®åº“å³ä½¿æ„å¤–å®•æœºï¼Œä¹Ÿèƒ½åˆ©ç”¨å®ƒå‡†ç¡®çš„æ¢å¤æ•°æ®ã€‚wal æ—¥å¿—ä¹Ÿå«åš xlogï¼Œåœ¨ 9.4 ç‰ˆæœ¬ä¹‹åä½œäº†é‡å¤§æ›´æ–°ï¼Œæœ¬ç¯‡åªè®²è§£æœ€æ–°ç‰ˆçš„æ ¼å¼ã€‚wal æ—¥å¿—è¢«ç”¨äºå¤šä¸ªæ–¹é¢ï¼Œæ¯”å¦‚ä¿®æ”¹æ•°æ®ï¼Œä¿®æ”¹ç´¢å¼•ç­‰ï¼Œæ¯ç§ç”¨é€”çš„æ ¼å¼éƒ½ä¸ç›¸åŒï¼Œä½†æ˜¯æ„å»ºæ–¹å¼æ˜¯ç›¸åŒçš„ã€‚</p><h2 id="WALæ—¥å¿—æ–‡ä»¶">WALæ—¥å¿—æ–‡ä»¶</h2><h3 id="WALæ®µæ–‡ä»¶">WALæ®µæ–‡ä»¶</h3><p>WALæ—¥å¿—æ–‡ä»¶å­˜æ”¾åœ¨sd_walç›®å½•ä¸‹ï¼Œæ¯ä¸ªæ–‡ä»¶å¤§å°é»˜è®¤ä¸º16Mï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000B6<br>-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000B7<br>-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000B8<br>-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000B9<br>-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000BA<br>-rw-------  1 zhangze  zhangze  16777216 Oct  8 10:57 0000000100000000000000BB<br>drwx------  2 zhangze  zhangze        68 Oct  8 10:53 archive_status<br></code></pre></td></tr></table></figure><p>æ–‡ä»¶åç”±16è¿›åˆ¶çš„24ä¸ªå­—ç¬¦ç»„æˆï¼Œæ¯8ä¸ªå­—ç¬¦ä¸ºä¸€ç»„ï¼Œæ¯ç»„æ„ä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">00000001 00000000 000000B6<br> æ—¶é—´çº¿    LogID    LogSeg<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p><strong>æ—¶é—´çº¿</strong>ï¼šæ—¶é—´çº¿IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0xFFFFFFFFã€‚æ•°æ®åº“å»ºå¥½åçš„ç¬¬ä¸€ä¸ªWALæ—¥å¿—æ–‡ä»¶çš„æ—¶é—´çº¿IDä»1å¼€å§‹</p></li><li class="lvl-2"><p><strong>LogID</strong>ï¼šé€»è¾‘æ–‡ä»¶IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0xFFFFFFFF</p></li><li class="lvl-2"><p><strong>LogSeg</strong>ï¼šç‰©ç†æ–‡ä»¶IDï¼Œå–å€¼èŒƒå›´ä¸º 0x00000000 -&gt; 0x000000FFã€‚æ•°æ®åº“å»ºå¥½åçš„ç¬¬ä¸€ä¸ªWALæ—¥å¿—æ–‡ä»¶çš„LogSegä»1å¼€å§‹ï¼Œè¾¾åˆ°æœ€å¤§å€¼ï¼ˆ0xFFï¼‰åä»0å¼€å§‹ã€‚</p></li></ul><p><strong>LSN</strong>å³æ—¥å¿—åºåˆ—å·ï¼Œè¡¨ç¤ºXLogè®°å½•åœ¨äº‹åŠ¡æ—¥å¿—æ–‡ä»¶ä¸­çš„åç§»ï¼Œä¸ºuint64å€¼ã€‚LSNç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯é€»è¾‘æ–‡ä»¶IDï¼Œç‰©ç†æ–‡ä»¶IDå’Œæ–‡ä»¶å†…åç§»é‡ã€‚LSNæ‰“å°å‡ºæ¥æ˜¯ä¸¤ä¸ª8ä½çš„åå…­è¿›åˆ¶æ•°ï¼Œå¦‚16/B374D848ã€‚ç”±ä¸“é—¨çš„ç±»å‹<code>pg_lsn</code>æ¥å­˜æ”¾LSNæ•°æ®</p><p>PG WALæ–‡ä»¶åå­—çš„å‘½åæ–¹æ³•æ˜¯åœ¨XLogFileNameå®é‡Œå®šä¹‰çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> XLogSegmentsPerXLogId(wal_segsz_bytes)  \</span><br><span class="hljs-meta">    (UINT64CONST(0x100000000) / (wal_segsz_bytes))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XLogFileName(fname, tli, logSegNo, wal_segsz_bytes) \</span><br><span class="hljs-meta">    snprintf(fname, MAXFNAMELEN, <span class="hljs-string">&quot;%08X%08X%08X&quot;</span>, tli,       \</span><br><span class="hljs-meta">             (uint32) ((logSegNo) / XLogSegmentsPerXLogId(wal_segsz_bytes)), \</span><br><span class="hljs-meta">             (uint32) ((logSegNo) % XLogSegmentsPerXLogId(wal_segsz_bytes)))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> XLogFileNameById(fname, tli, log, seg)  \</span><br><span class="hljs-meta">    snprintf(fname, MAXFNAMELEN, <span class="hljs-string">&quot;%08X%08X%08X&quot;</span>, tli, log, seg)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IsXLogFileName(fname) \</span><br><span class="hljs-meta">    (strlen(fname) == XLOG_FNAME_LEN &amp;&amp; \</span><br><span class="hljs-meta">     strspn(fname, <span class="hljs-string">&quot;0123456789ABCDEF&quot;</span>) == XLOG_FNAME_LEN)</span><br></code></pre></td></tr></table></figure><h3 id="WALæ–‡ä»¶å†…éƒ¨ç»“æ„">WALæ–‡ä»¶å†…éƒ¨ç»“æ„</h3><p>æ¯ä¸ªWALæ®µæ–‡ä»¶ç”±å¤šä¸ª8kbå¤§å°çš„pageç»„æˆï¼Œæ¯ä¸ªPageä¸­å­˜æ”¾ç€PageHeaderä¿¡æ¯ï¼Œä»¥åŠå¤šæ¡WAL Record</p><h4 id="Pageç»“æ„">Pageç»“æ„</h4><p>æ¯ä¸ªpageçš„ç»„ç»‡æ–¹å¼å¦‚ä¸‹å›¾ï¼š</p><p><img src="/uploads/WALPage.png" alt="WALçš„pageç»“æ„"></p><ul class="lvl-0"><li class="lvl-2"><p><strong>PageHeader</strong>ï¼šåœ¨wal pageçš„ç»„æˆä¸­æœ‰ä¸¤ç§pageheaderç»“æ„ï¼Œ<code>XLogPageHeaderData</code>å’Œ<code>XLogLongPageHeaderData</code>ã€‚æ¯ä¸ªWALæ®µçš„ç¬¬ä¸€ä¸ªPageçš„Headeråº”ä¸ºLongHeader</p></li><li class="lvl-2"><p><strong>Remain data</strong>ï¼šå­˜å‚¨ç€ä¸Šä¸€ä¸ªpageä¸­æœ€åä¸€ä¸ªRecordæ²¡æœ‰å­˜å®Œçš„æ•°æ®ï¼Œå¤§å°ä¸º<code>xlp_rem_len</code>ï¼Œå¯¹åº”pageçš„ä¸å®Œæ•´Record</p></li><li class="lvl-2"><p><strong>Record</strong>ï¼šå­˜å‚¨å…·ä½“çš„WAL Record</p></li><li class="lvl-2"><p><strong>æ— æ•°æ®åŒºåŸŸ</strong>ï¼šä¸€ä¸ªWAL Recordçš„å¤´éƒ¨ä¿¡æ¯ä¸å…è®¸è·¨é¡µï¼Œå¦‚æœå‰©ä½™ç©ºé—´ä¸å¤Ÿå­˜å‚¨å¤´éƒ¨ä¿¡æ¯ï¼Œåˆ™èˆå¼ƒè¿™éƒ¨åˆ†ç©ºé—´</p></li></ul><h4 id="Recordç»“æ„">Recordç»“æ„</h4><p>æ¯ä¸ªWAL Recordçš„ç»“æ„å¦‚ä¸‹å›¾ï¼Œç»¿è‰²éƒ¨åˆ†ä¸ºæ•°æ®æè¿°ç»“æ„ï¼Œé»„è‰²éƒ¨åˆ†æ˜¯å®é™…ä¿å­˜çš„æ•°æ®</p><p><img src="/uploads/wal_write.png" alt="WAL_Record"></p><ul class="lvl-0"><li class="lvl-2"><p><strong>XLogRecord</strong>ï¼šä¸€ä¸ªWALè®°å½•çš„å…¥å£ï¼Œè§£æWALæ—¶ï¼Œä»è¿™ä¸ªç»“æ„ä½“å…¥æ‰‹</p></li><li class="lvl-2"><p><strong>Block</strong>ï¼šç¬¬ä¸€ä¸ªè™šçº¿æ¡†ç§°ä¸ºä¸€ä¸ªBLOCKï¼Œç”¨ä»¥æè¿°Bufferç›¸å…³çš„æ•°æ®ç»“æ„ã€‚é€šè¿‡<code>XLogRegisterBuffer()</code>å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ä¸­</p><ul class="lvl-2"><li class="lvl-6"><strong>XLogRecordBlockHeader</strong>ï¼šä¸€ä¸ªBLOCKçš„å¤´éƒ¨ä¿¡æ¯</li><li class="lvl-6"><strong>XLogRecordBlockImageHeader</strong>ï¼šå¦‚æœè¯¥WALæ˜¯fpwè®°å½•ï¼Œè¯¥ç»“æ„å­˜æ”¾fpwç›¸å…³ä¿¡æ¯<ul class="lvl-4"><li class="lvl-10">fpwï¼šFull_page_writeï¼Œå…·ä½“è§<a href="#%E6%95%B4%E9%A1%B5%E5%86%99%E5%85%A5full_write_page">æ•´é¡µå†™å…¥</a></li></ul></li><li class="lvl-6"><strong>XLogRecordBlockCompressHeader</strong>ï¼šè®°å½•holeçš„å¤§å°<ul class="lvl-4"><li class="lvl-10">holeï¼šæ•°æ®æ–‡ä»¶çš„pageä¸­ï¼Œå¯èƒ½ä¼šæœ‰ä¸€å—ç©ºç™½åŒºåŸŸï¼Œå³pointerå’Œtupleä¹‹é—´çš„åŒºåŸŸï¼Œç§°ä¸ºhole</li></ul></li><li class="lvl-6"><strong>RelFilenode</strong>ï¼šæ­¤ç»“æ„è®°å½•äº†æ­¤blockæ‰€å±çš„å…³ç³»</li><li class="lvl-6"><strong>BlockNumber</strong>ï¼šæ­¤blockè®°å½•çš„pageçš„å—å·</li></ul></li><li class="lvl-2"><p><strong>XLogRecordDataHeader(Long/short)</strong>ï¼šå½“main dataçš„å¤§å°å¤§äº255æ—¶ï¼Œä½¿ç”¨Long Header</p></li><li class="lvl-2"><p><strong>buffer data</strong>ï¼šç¬¬äºŒä¸ªè™šçº¿æ¡†éƒ¨åˆ†ï¼ŒåŒ…æ‹¬page dataå’Œtuple data</p><ul class="lvl-2"><li class="lvl-6"><strong>page data</strong>ï¼šç”±<code>XLogRegisterBuffer()</code>å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ï¼Œå­˜æ”¾buffer pageä¿¡æ¯</li><li class="lvl-6"><strong>tuple data</strong>ï¼šç”±<code>XLogRegisterBufData()</code>å‡½æ•°æ³¨å†Œåˆ°walè®°å½•ï¼Œå­˜å‚¨äº†å®é™…çš„buffæ•°æ®å’Œå˜æ›´æ•°æ®ã€‚</li></ul></li><li class="lvl-2"><p><strong>main data</strong>ï¼šä¿å­˜ébufferæ€§çš„æ•°æ®ï¼Œç”±<code>XLogRegisterData()</code>å‡½æ•°åˆ°WALè®°å½•ï¼Œä¾‹å¦‚ç‰¹æ®Šç»“æ„ä½“ï¼Œæ—§å…ƒç»„æˆ–key</p></li></ul><h2 id="WALæ—¥å¿—å†™å…¥å®ç°">WALæ—¥å¿—å†™å…¥å®ç°</h2><p>å½“æ•°æ®åº“æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>changeå‘ç”Ÿæ—¶ï¼šå…ˆè¦å°†å˜æ›´åå†…å®¹è®¡å…¥wal bufferä¸­ï¼Œå†å°†å˜æ›´åçš„æ•°æ®å†™å…¥data bufferï¼›</p></li><li class="lvl-2"><p>commitå‘ç”Ÿæ—¶ï¼šwal bufferä¸­æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ï¼›</p></li><li class="lvl-2"><p>checkpointå‘ç”Ÿæ—¶ï¼šå°†æ‰€æœ‰data bufferåˆ·æ–°çš„ç£ç›˜ã€‚</p></li></ul><p>WALæ—¥å¿—æœºåˆ¶å°±æ˜¯å…ˆå°†å˜æ›´å†…å®¹å­˜æ”¾åˆ°wal bufferï¼Œcommitåå°†wal bufferåˆ·å…¥ç£ç›˜çš„è¿‡ç¨‹ã€‚è¿‡ç¨‹ä¸­ä¸»è¦çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">XLogBeginInsert();        <span class="hljs-comment">// è¡¨ç¤ºå¼€å§‹æ„å»º xlog</span><br>XLogRegisterData();       <span class="hljs-comment">// å°†WALè®°å½•çš„ç‰¹æ®Šç»“æ„ä½“æ•°æ®æ³¨å†Œåˆ°WALï¼Œæ¯”å¦‚heap_insertä¸­çš„xl_heap_insertç»“æ„ä½“</span><br>XLogRegisterBuffer();     <span class="hljs-comment">// å°†æ¶‰åŠåˆ°çš„bufæ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚heap_insertä¸­pageé¡µèµ‹äºˆregbuf-&gt;page</span><br>XLogRegisterBufData();    <span class="hljs-comment">// å°†å…ƒç»„å†…å®¹æ³¨å†Œåˆ°WALè®°å½•ï¼Œæ¯”å¦‚insertè¯­å¥çš„å…ƒç»„æ•°æ®ç­‰</span><br>XLogSetRecordFlags();<br>XLogInsert();<br>    XLogRecordAssemble();<br>    XLogInsertRecord();   <span class="hljs-comment">// æ ¹æ®å½“å‰çš„æ•°æ®åº“çŠ¶æ€ï¼ŒæŠŠä¸Šè¿°å‡½æ•°æ³¨å†Œçš„æ•°æ®è¿›è¡Œç­›é€‰ç»„è£…ï¼Œæœ€ç»ˆå½¢æˆå®Œæ•´çš„walè®°å½•å¹¶å†™å…¥åˆ°walbuff</span><br>PageSetLSN<br></code></pre></td></tr></table></figure><p><img src="/uploads/wal_process.png" alt="WALå®ç°è¿‡ç¨‹"></p><h3 id="æ•´é¡µå†™å…¥-Full-Write-Page">æ•´é¡µå†™å…¥(Full_Write_Page)</h3><p>å¦‚æœæ•°æ®åº“ç³»ç»Ÿåœ¨å†™å…¥è„é¡µçš„è¿‡ç¨‹ä¸­å‡ºç°æ•…éšœï¼Œä¼šå¯¼è‡´ç£ç›˜ä¸Šçš„é¡µé¢æ•°æ®æŸåï¼Œè€ŒXLOGæ˜¯æ— æ³•åœ¨æŸåçš„é¡µé¢ä¸Šé‡æ”¾çš„ï¼Œéœ€è¦æ•´é¡µå†™å…¥æ¥æ¢å¤ã€‚</p><p>å¦‚æœå¯ç”¨æ•´é¡µå†™å…¥ï¼ŒPostgreSQLä¼šåœ¨æ¯ä¸ªæ£€æŸ¥ç‚¹åï¼Œæ¯ä¸ªé¡µé¢ç¬¬ä¸€æ¬¡å˜æ›´å‘ç”Ÿå‰ï¼Œå°†æ•´ä¸ªé¡µé¢ä»¥åŠHeaderä¿¡æ¯ä½œä¸ºä¸€æ¡XLogå†™å…¥ï¼Œè¿™ä¸ªåŠŸèƒ½é»˜è®¤å¼€å¯ã€‚åœ¨æ•°æ®åº“æ¢å¤è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ£€æŸ¥åˆ°ä¸€æ¡XLogæ˜¯ä¸€ä¸ªç”¨æ¥æ•´é¡µå†™å…¥çš„å¤‡ä»½åŒºå—ï¼Œä¼šä½¿ç”¨å¦ä¸€æ¡é‡æ”¾è§„åˆ™ï¼šXLogä¼šç›´æ¥è¦†ç›–å½“å‰é¡µé¢ï¼Œæ— è§†é¡µé¢å’ŒXLogè®°å½•ä¸­çš„LSNï¼Œç„¶åå°†é¡µé¢çš„LSNæ›´æ–°ä¸ºXLogè®°å½•çš„LSN</p><h3 id="å…·ä½“æ•°æ®ç»“æ„">å…·ä½“æ•°æ®ç»“æ„</h3><h4 id="XLog-Page">XLog Page</h4><h5 id="XLogPageHeaderData">XLogPageHeaderData</h5><p>XLogæ—¥å¿—åˆ†ä¸ºå¾ˆå¤šé€»è¾‘æ®µæ–‡ä»¶ï¼Œæ¯ä¸ªæ®µæ–‡ä»¶åˆ†æˆè®¸å¤šä¸ªé¡µé¢ï¼Œæ¯ä¸ªé¡µé¢çš„å¤§å°ä¸ºä¸€ä¸ªå—çš„å¤§å°ã€‚æ¯ä¸ªæ—¥å¿—é¡µé¢éƒ½æœ‰ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogPageHeaderData</span></span><br><span class="hljs-class">&#123;</span><br>    uint16xlp_magic;<span class="hljs-comment">// æ ¡éªŒä½ï¼Œæ£€éªŒWALçš„ç‰ˆæœ¬ä¿¡æ¯</span><br>    uint16xlp_info;<span class="hljs-comment">// æ ‡è®°ä½</span><br>    TimeLineIDxlp_tli;<span class="hljs-comment">// é¡µé¢ç¬¬ä¸€æ¡è®°å½•çš„æ—¶é—´åºåˆ—</span><br>    XLogRecPtrxlp_pageaddr;<span class="hljs-comment">// XLogé¡µé¢çš„åœ°å€</span><br><br>    <span class="hljs-comment">// å½“å‰é¡µé¢æ²¡æœ‰è¶³å¤Ÿç©ºé—´ç”¨äºè®°å½•æ—¶ï¼Œç»§ç»­åœ¨ä¸‹ä¸€é¡µè®°å½•</span><br>    <span class="hljs-comment">// è®°å½•äº†å‰ä¸€é¡µçš„å‰©ä½™å­—èŠ‚æ•°ï¼ŒåŒ…æ‹¬å¤‡ä»½å—æ•°æ®ï¼Œå³è¯¥è®°å½•åœ¨æœ¬é¡µç»§ç»­å­˜å‚¨å ç”¨çš„ç©ºé—´å¤§å°</span><br>    uint32xlp_rem_len;<br>&#125; XLogPageHeaderData;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å…¶ä¸­ï¼Œæ ‡è®°ä½<code>xlp_info</code>åªä½¿ç”¨æœ€ä½ä¸¤ä½ï¼Œ0è¡¨æ˜è¯¥é¡µçš„ç¬¬ä¸€ä¸ªXLogè®°å½•æ¥ç€ä¸Šä¸€é¡µçš„æœ€åä¸€ä¸ªXLogè®°å½•ï¼Œ1è¡¨ç¤ºè¯¥é¡µæ˜¯è¯¥XLogæ–‡ä»¶çš„é¦–é¡µ</p></li></ul><h5 id="XLogLongPageHeaderData">XLogLongPageHeaderData</h5><p>å¦‚æœé¡µé¢æ˜¯è¯¥æ—¥å¿—æ–‡ä»¶çš„é¦–é¡µï¼Œé‚£ä¹ˆåœ¨åŸå¤´éƒ¨ä¿¡æ¯çš„åŸºç¡€ä¸Šä¼šä½¿ç”¨ä¸€ä¸ªé•¿çš„å¤´éƒ¨ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogLongPageHeaderData</span></span><br><span class="hljs-class">&#123;</span><br>    XLogPageHeaderData <span class="hljs-built_in">std</span>;<span class="hljs-comment">// æ ‡å‡†çš„å¤´éƒ¨ä¿¡æ¯ï¼Œå³ XLogPageHeaderData</span><br>    uint64xlp_sysid;<span class="hljs-comment">// pg_controlä¸­çš„ç³»ç»Ÿæ ‡è¯†ç¬¦</span><br>    uint32xlp_seg_size;<span class="hljs-comment">// æ ¡éªŒä½ï¼Œæ®µçš„å¤§å°</span><br>    uint32xlp_XLog_blcksz;<span class="hljs-comment">// æ ¡éªŒä½ï¼Œå—çš„å¤§å°</span><br>&#125; XLogLongPageHeaderData;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¯¹äºé•¿çš„XLogæ—¥å¿—è®°å½•ï¼Œå…è®¸å°†æ²¡æœ‰è¶³å¤Ÿç©ºé—´å­˜å‚¨çš„æ•°æ®å­˜å‚¨åˆ°ä¸‹ä¸€ä¸ªé¡µé¢ï¼Œä½†ä¸å…è®¸Recordå¤´éƒ¨ä¿¡æ¯è¢«åˆ†å¼€å­˜å‚¨åˆ°ä¸¤ä¸ªä¸åŒé¡µé¢ã€‚å¦‚æœå‰©ä½™ç©ºé—´å·²ç»ä¸è¶³ä»¥å­˜å‚¨ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯ï¼Œé‚£ä¹ˆå‰©ä½™ç©ºé—´å°†è¢«èˆå¼ƒï¼Œå°†è¿™ä¸ªXLogè®°å½•å­˜å‚¨åˆ°æ–°çš„ä¸‹ä¸€ä¸ªé¡µé¢ä¸­</p></li></ul><h4 id="XLog-Record">XLog Record</h4><h5 id="XLogRecord">XLogRecord</h5><p>ç»“æ„<code>XLogRecord</code>è®°å½•äº†XLogçš„ç›¸å…³æ§åˆ¶ä¿¡æ¯ï¼Œä¸€ä¸ªXLogè®°å½•æœ€å¤šå¯ä»¥é™„3ä¸ªå¤‡ä»½å—ï¼Œ æ¯ä¸ªå—å¯¹åº”ä¸€ä¸ªç£ç›˜å¤§å°çš„æ•°æ®ï¼Œé•¿åº¦ä¸º8kb</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogRecord</span></span><br><span class="hljs-class">&#123;</span><br>uint32xl_tot_len;<span class="hljs-comment">// æ•´æ¡è®°å½•çš„é•¿åº¦</span><br>TransactionId xl_xid;<span class="hljs-comment">// äº‹åŠ¡ID</span><br>XLogRecPtrxl_prev;<span class="hljs-comment">// æŒ‡å‘æ—¥å¿—ä¸­çš„å‰ä¸€ä¸ªè®°å½•</span><br>uint8xl_info;<span class="hljs-comment">// ä¿¡æ¯æ ‡è®°ä½</span><br>RmgrIdxl_rmid;<span class="hljs-comment">// èµ„æºç®¡ç†å™¨</span><br><br>pg_crc32cxl_crc;<span class="hljs-comment">// æœ¬è®°å½•çš„CRCæ ¡éªŒç </span><br>&#125; XLogRecord;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å…¶ä¸­ï¼Œèµ„æºç®¡ç†å™¨å·ä¸»è¦ç”¨äºæ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ•°æ®åº“ç³»ç»Ÿéœ€è¦å°†è®°å½•çš„æ—¥å¿—æ•°æ®åˆ†ç±»ï¼Œä¸ºå®ƒä»¬åˆ†é…å¯¹åº”çš„èµ„æºç®¡ç†å™¨å·ã€‚è¯»å–æ—¥å¿—è®°å½•æ—¶ï¼Œç»“åˆèµ„æºç®¡ç†å™¨å·å’Œä¿¡æ¯æ ‡å¿—ä½ï¼Œèƒ½å¤Ÿç›´åˆ°æ•°æ®åº“å¯¹æºæ•°æ®åšçš„æ˜¯å“ªç§æ“ä½œï¼Œä»è€Œè¿…é€Ÿæ­£ç¡®çš„è°ƒç”¨å¯¹åº”çš„å‡½æ•°ã€‚å…±æœ‰16ç§èµ„æº</p></li><li class="lvl-2"><p>ä¿¡æ¯æ ‡å¿—ä½çš„é«˜4ä½ç”±èµ„æºç®¡ç†å™¨ä½¿ç”¨ï¼Œæ ‡è¯†è¯¥æ—¥å¿—æ˜¯å“ªç§ç±»å‹çš„æ—¥å¿—ã€‚ä½4ä½è¡¨ç¤ºå¯¹åº”çš„å—æ˜¯å¦éœ€è¦å¤‡ä»½</p></li></ul><h5 id="XLogRecordBlockHeader">XLogRecordBlockHeader</h5><p>å­˜æ”¾blockçš„ç›¸å…³ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogRecordBlockHeader</span></span><br><span class="hljs-class">&#123;</span><br>    uint8       id;             <span class="hljs-comment">// å—å¼•ç”¨ID</span><br>    uint8       fork_flags;     <span class="hljs-comment">// åœ¨å…³ç³»ä¸­ä½¿ç”¨çš„forkå’Œflags</span><br>    uint16      data_length;    <span class="hljs-comment">// payloadå­—èŠ‚å¤§å°</span><br><br>    <span class="hljs-comment">//å¦‚æœè®¾ç½®äº† BKPBLOCK_HAS_IMAGE,åç»­ä¸ºXLogRecordBlockImageHeaderç»“æ„ä½“ï¼Œå¦åˆ™ä¸ºRelFileNode</span><br>    <span class="hljs-comment">//ä¹‹åä¸ºBlockNumber</span><br>&#125; XLogRecordBlockHeader;<br></code></pre></td></tr></table></figure><h5 id="XLogRecordBlockImageHeader">XLogRecordBlockImageHeader</h5><p>å­˜æ”¾æ•´é¡µå†™å…¥çš„ç›¸å…³ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogRecordBlockImageHeader</span></span><br><span class="hljs-class">&#123;</span><br>uint16length;<span class="hljs-comment">// pageå¤§å°</span><br>uint16hole_offset;<span class="hljs-comment">// holeä¹‹å‰çš„é•¿åº¦</span><br>uint8bimg_info;<span class="hljs-comment">// æ ‡è®°ä½ï¼Œæ˜¯å¦å‹ç¼©</span><br>&#125; XLogRecordBlockImageHeader;<br></code></pre></td></tr></table></figure><h5 id="XLogRecordBlockCompressHeader">XLogRecordBlockCompressHeader</h5><p>å­˜æ”¾pageä¸­çš„holeå¤§å°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogRecordBlockCompressHeader</span></span><br><span class="hljs-class">&#123;</span><br>uint16hole_length;<span class="hljs-comment">// holeå¤§å°</span><br>&#125; XLogRecordBlockCompressHeader;<br></code></pre></td></tr></table></figure><h4 id="XLog-Data">XLog Data</h4><h5 id="XLogRecordDataHeader">XLogRecordDataHeader</h5><p>WAL Recordçš„æ•°æ®éƒ¨åˆ†çš„headerä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogRecordDataHeaderShort</span></span><br><span class="hljs-class">&#123;</span><br>    uint8       id;<br>    uint8       data_length;<br>&#125;XLogRecordDataHeaderShort;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogRecordDataHeaderLong</span></span><br><span class="hljs-class">&#123;</span><br>    uint8       id;<br>&#125;XLogRecordDataHeaderLong;<br></code></pre></td></tr></table></figure><h5 id="XLogRecData">XLogRecData</h5><p>XLogæ—¥å¿—è®°å½•ä¸­çš„æ•°æ®ä¿¡æ¯å­˜å‚¨åœ¨ç»“æ„<code>XLogRecData</code>ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogRecData</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogRecData</span> *<span class="hljs-title">next</span>;</span><span class="hljs-comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="hljs-type">char</span>    *data;<span class="hljs-comment">// æ•°æ®</span><br>uint32len;<span class="hljs-comment">// æ•°æ®é•¿åº¦</span><br>&#125; XLogRecData;<br></code></pre></td></tr></table></figure><h4 id="XLogæ§åˆ¶ç»“æ„">XLogæ§åˆ¶ç»“æ„</h4><h5 id="XLogCtlData">XLogCtlData</h5><p>åœ¨å…±äº«å†…å­˜ä¸­ç”¨ç»“æ„<code>XLogCtlData</code>ä¿å­˜XLogä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">XLogCtlData</span></span><br><span class="hljs-class">&#123;</span><br>    XLogCtlInsert Insert;<span class="hljs-comment">// æ’å…¥ä¸€æ¡æ—¥å¿—åï¼Œæœ€æ–°çš„ç›¸å…³ä¿¡æ¯</span><br><br>    <span class="hljs-comment">// ä»¥ä¸‹å—info_lckä¿æŠ¤</span><br>    XLogwrtRqst LogwrtRqst;<span class="hljs-comment">// å°†æ—¥å¿—å†™å…¥å’ŒåŒæ­¥çš„ä½ç½®</span><br>    XLogRecPtrRedoRecPtr;<span class="hljs-comment">// æœ€è¿‘çš„ Insert-&gt;RedoRecPtr å‰¯æœ¬</span><br>    FullTransactionId ckptFullXid;<span class="hljs-comment">// æœ€æ–°æ£€æŸ¥ç‚¹çš„nextXID</span><br>    XLogRecPtrasyncXactLSN;<span class="hljs-comment">// æœ€æ–°å¼‚æ­¥æäº¤/ä¸­æ–­çš„LSN</span><br>    XLogRecPtrreplicationSlotMinLSN;<span class="hljs-comment">// æ‰€æœ‰ç¼“å†²åŒºæ‰€éœ€çš„æœ€è€çš„LSN</span><br><br>    XLogSegNolastRemovedSegNo;<span class="hljs-comment">// æœ€åçš„åˆ é™¤/å›æ”¶çš„XLogæ®µ</span><br><br>    <span class="hljs-comment">// ç”¨äºä¸éœ€è¦è®°å½•æ—¥å¿—çš„å…³ç³»çš„å‡çš„LSN</span><br>    XLogRecPtrunloggedLSN;<br>    <span class="hljs-type">slock_t</span>ulsn_lck;<br><br>    <span class="hljs-comment">// åˆ‡æ¢åæœ€æ–°çš„XLogçš„æ—¶é—´å’ŒLSNï¼Œå—XLogWriteLockä¿æŠ¤</span><br>    <span class="hljs-type">pg_time_t</span>lastSegSwitchTime;<br>    XLogRecPtrlastSegSwitchLSN;<br><br>    <span class="hljs-comment">// å·²ç»å†™å…¥å’ŒåŒæ­¥çš„ä½ç½®ï¼Œå—info_lckæˆ–XLogWriteLockä¿æŠ¤</span><br>    XLogwrtResult LogwrtResult;<br><br>    <span class="hljs-comment">// ç¼“å­˜ä¸­çš„æœ€ååˆå§‹åŒ–é¡µé¢ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚ä½ç½®+1</span><br>    XLogRecPtrInitializedUpTo;<br><br>    <span class="hljs-comment">// è¿™äº›å€¼åœ¨å¯åŠ¨åä¸ä¼šä¿®æ”¹ï¼Œå°½ç®¡æŒ‡å‘çš„é¡µé¢å’Œxlblocksé€šå¸¸ä¼šæ”¹å˜</span><br>    <span class="hljs-comment">// xlblockså— XLogBufMappingLock ä¿æŠ¤</span><br>    <span class="hljs-type">char</span>   *pages;<span class="hljs-comment">// æœªå†™å…¥XLogé¡µé¢çš„ç¼“å†²åŒº</span><br>    XLogRecPtr *xlblocks;<span class="hljs-comment">// ç¼“å†²åŒºå†…å®¹å¯¹åº”çš„XLogæ–‡ä»¶çš„å†…éƒ¨æŒ‡é’ˆ</span><br>    <span class="hljs-type">int</span>XLogCacheBlck;<span class="hljs-comment">// XLogæœ€å¤§ç¼“å†²åŒºçš„ä¸‹æ ‡</span><br><br>    <span class="hljs-comment">// ThisTimeLineID çš„å…±äº«å‰¯æœ¬ï¼Œåœ¨å®Œæˆæ¢å¤åä¸è¦ä¿®æ”¹</span><br>    TimeLineIDThisTimeLineID;<br>    TimeLineIDPrevTimeLineID;<br><br>    <span class="hljs-comment">// æ ‡è®°æˆ‘ä»¬æ˜¯å¦å¤„äºå´©æºƒæˆ–æ¢å¤çŠ¶æ€ï¼Œå—info_lockä¿æŠ¤</span><br>    RecoveryState SharedRecoveryState;<br>    <span class="hljs-type">bool</span>SharedHotStandbyActive;<br><br>    <span class="hljs-comment">// æŒ‡ç¤ºXLogå†™å…¥æ˜¯å¦å¤„äºèŠ‚èƒ½æ¨¡å¼ï¼Œå—info_lockä¿æŠ¤</span><br>    <span class="hljs-type">bool</span>XLogWriterSleeping;<br><br>    <span class="hljs-comment">// ç­‰å¾…å”¤é†’ï¼Œå¦‚æœå‡ºç°å‡ºå‘æ–‡ä»¶ï¼Œåˆ™å”¤é†’å¯åŠ¨è¿›ç¨‹ä»¥ç»§ç»­æ‰§è¡ŒXLogé‡æ”¾</span><br>    LatchrecoveryWakeupLatch;<br><br>    <span class="hljs-comment">// åœ¨æ¢å¤æœŸé—´ä¿ç•™æœ€åæ£€æŸ¥ç‚¹è®°å½•çš„å‰¯æœ¬ï¼Œå—info_lckä¿æŠ¤</span><br>    XLogRecPtrlastCheckPointRecPtr;<br>    XLogRecPtrlastCheckPointEndPtr;<br>    CheckPointlastCheckPoint;<br><br>    XLogRecPtrlastReplayedEndRecPtr;<span class="hljs-comment">// æŒ‡å‘æˆåŠŸé‡æ”¾çš„æœ€åä¸€æ¡è®°å½•çš„ç»“å°¾+1</span><br>    TimeLineIDlastReplayedTLI;<br>    XLogRecPtrreplayEndRecPtr;<span class="hljs-comment">// å¦‚æœæ­£å¤„äºredoå‡½æ•°å›æ”¾è®°å½•æœŸé—´ï¼Œåˆ™æŒ‡å‘æ­£åœ¨æ¢å¤è®°å½•çš„ç»“å°¾+1</span><br>    <span class="hljs-comment">// å¦åˆ™ç­‰äºlastReplayedEndRecPtr</span><br>    TimeLineIDreplayEndTLI;<br>    TimestampTz recoveryLastXTime;<span class="hljs-comment">// é‡æ”¾ï¼ˆæ­£åœ¨é‡æ”¾ï¼‰çš„æœ€åä¸€ä¸ªCOMMIT/ABORTè®°å½•çš„æ—¶é—´æˆ³</span><br><br>    <span class="hljs-comment">// å¼€å§‹é‡æ”¾å½“å‰XLogæ•°æ®å—çš„æ—¶é—´æˆ³</span><br>    TimestampTz currentChunkStartTime;<br><br>    <span class="hljs-type">bool</span>recoveryPause;<span class="hljs-comment">// æ˜¯å¦æš‚åœæ¢å¤</span><br><br>    <span class="hljs-comment">// æŒ‡å‘æœ€åé‡æ”¾çš„XLog_FPW_CHANGEè®°å½•çš„èµ·å§‹ç‚¹</span><br>    <span class="hljs-comment">// ç”¨äºç¦ç”¨full_page_writes</span><br>    XLogRecPtrlastFpwDisableRecPtr;<br><br>    <span class="hljs-type">slock_t</span>info_lck;<span class="hljs-comment">// å…±äº«é”</span><br>&#125; XLogCtlData;<br></code></pre></td></tr></table></figure><h5 id="Register-buffer">Register_buffer</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">bool</span>in_use;<span class="hljs-comment">// is this slot in use?</span><br>uint8flags;<span class="hljs-comment">// REGBUF_* flags</span><br>RelFileNode rnode;<span class="hljs-comment">// æŒ‡å®šæ‰€å±è¡¨çš„å­˜å‚¨ç›®å½•</span><br>ForkNumberforkno;         <span class="hljs-comment">// å“ªç§æ–‡ä»¶ç±»å‹</span><br>BlockNumber block;          <span class="hljs-comment">// å—ç¼–å·</span><br>Pagepage;<span class="hljs-comment">// å¯¹åº”çš„åŸå§‹æ•°æ®é¡µ</span><br><br>uint32rdata_len;<span class="hljs-comment">// ç§æœ‰æ•°æ®é“¾è¡¨çš„é•¿åº¦æ€»å’Œ</span><br>XLogRecData *rdata_head;<span class="hljs-comment">// ç§æœ‰æ•°æ®é“¾è¡¨å¤´éƒ¨èŠ‚ç‚¹</span><br>XLogRecData *rdata_tail;<span class="hljs-comment">// ç§æœ‰æ•°æ®é“¾è¡¨å°¾éƒ¨èŠ‚ç‚¹</span><br><br>XLogRecData bkp_rdatas[<span class="hljs-number">2</span>];<span class="hljs-comment">// å­˜å‚¨ç€å‹ç¼©åæˆ–å¿½ç•¥ç©ºé—²æ•°æ®çš„æ•°æ®ï¼Œå¦‚æœæœ‰ç©ºé—²ä½ç½®ä¸”æ²¡æœ‰å‹ç¼©ï¼Œé‚£ä¹ˆæ•°æ®ä¼šè¢«åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œå­˜å‚¨åœ¨ä¸¤ä¸ªæ•°ç»„å…ƒç´ é‡Œ</span><br><br><span class="hljs-type">char</span>compressed_page[PGLZ_MAX_BLCKSZ]; <span class="hljs-comment">// å¦‚æœå¼€å¯äº†å‹ç¼©ï¼Œé‚£ä¹ˆå­˜å‚¨ç€å‹ç¼©åçš„æ•°æ®</span><br>&#125; registered_buffer;<br></code></pre></td></tr></table></figure><h4 id="é‡è¦å…¨å±€å˜é‡">é‡è¦å…¨å±€å˜é‡</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> XLogRecData *mainrdata_head;<br><span class="hljs-type">static</span> XLogRecData *mainrdata_last = (XLogRecData *) &amp;mainrdata_head;<br><br><span class="hljs-comment">/*ä½¿ç”¨XLogRegisterBufferæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°registered_buffersæ•°ç»„é‡Œ*/</span><br><span class="hljs-type">static</span> registered_buffer *registered_buffers;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * ä½¿ç”¨XLogRegisterBufDataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œå¹¶é“¾æ¥ä¸ºé“¾è¡¨ï¼Œä½¿ç”¨registered_bufferç»“æ„é‡Œçš„rdata_headå’Œ</span><br><span class="hljs-comment"> * rdata_tailä½œä¸ºé“¾è¡¨çš„é¦–å°¾ã€‚</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * ä½¿ç”¨XLogRegisterDataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œå¹¶ä½¿ç”¨mainrdata_headå’Œmainrdata_lastataæ³¨å†Œçš„æ•°æ®å­˜å‚¨åˆ°rdatasæ•°ç»„é‡Œï¼Œ</span><br><span class="hljs-comment"> * å¹¶é“¾æ¥ä¸ºé“¾è¡¨ï¼Œä½¿ç”¨registered_bufferç»“æ„é‡Œçš„rdata_headå’Œrdata_tailä½œä¸ºé“¾è¡¨çš„é¦–å°¾ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> XLogRecData *rdatas;<br></code></pre></td></tr></table></figure><h3 id="å…·ä½“å‡½æ•°ä»£ç ">å…·ä½“å‡½æ•°ä»£ç </h3><h4 id="XLogBeginInsert">XLogBeginInsert</h4><p>å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯æ£€éªŒè°ƒç”¨ç¯å¢ƒæ˜¯å¦æ­£ç¡®ï¼Œåˆ¤æ–­å½“å‰æ˜¯å¦å¯ä»¥æ‰§è¡Œxlogæ’å…¥ï¼Œå¹¶è®¾ç½®å¼€å§‹æ„é€ WALè®°å½•çš„æ ‡è®°ï¼Œæ ‡å¿—walæ’å…¥å¼€å§‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">Assert(max_registered_block_id == <span class="hljs-number">0</span>);<br>Assert(mainrdata_last == (XLogRecData *) &amp;mainrdata_head);<br>Assert(mainrdata_len == <span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">if</span> (!XLogInsertAllowed())<br>    elog(ERROR, <span class="hljs-string">&quot;cannot make new WAL entries during recovery&quot;</span>);<br><br><span class="hljs-keyword">if</span> (begininsert_called)<br>    elog(ERROR, <span class="hljs-string">&quot;XLogBeginInsert was already called&quot;</span>);<br><br>begininsert_called = <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure><h4 id="XLogRegisterData">XLogRegisterData</h4><ol><li class="lvl-3"><p>å°†æœ¬æ¡walè®°å½•çš„ç‰¹æ®Šç»“æ„ä½“æ•°æ®æ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚XLOG_HEAP_INSERTå­ç±»å‹çš„xl_heap_insertç»“æ„ä½“ã€‚</p></li><li class="lvl-3"><p>å°†ä¸€äº›æ—§å…ƒç»„æ•°æ®æ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚æ‰§è¡Œupdateè¯­å¥çš„æ—§å…ƒç»„æ•°æ®ã€deleteè¯­å¥çš„æ—§å…ƒç»„æ•°æ®ã€‚</p></li></ol><p><img src="/uploads/xlog_register_data.jpg" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å·²ç»å¼€å§‹æ„é€ WAL</span><br>Assert(begininsert_called);<br><br><span class="hljs-comment">// æ£€æŸ¥æ•°æ®é‡æ˜¯å¦è¶…è¿‡é™åˆ¶å€¼</span><br><span class="hljs-keyword">if</span> (num_rdatas &gt;= max_rdatas)<br>    elog(ERROR, <span class="hljs-string">&quot;too much WAL data&quot;</span>);<br>rdata = &amp;rdatas[num_rdatas++];<br><br>rdata-&gt;data = data;<br>rdata-&gt;len = len;<br><br><span class="hljs-comment">// ä½¿ç”¨ mainrdata_last æŒ‡é’ˆè·Ÿè¸ªé“¾æ¡çš„ç»“æŸç‚¹,åœ¨è¿™é‡Œä¸éœ€è¦æ¸…é™¤nextå˜é‡</span><br>mainrdata_last-&gt;next = rdata;<br>mainrdata_last = rdata;<br><br>mainrdata_len += len;<br></code></pre></td></tr></table></figure><h4 id="XLogRegisterBuffer">XLogRegisterBuffer</h4><p>å°†æ¶‰åŠåˆ°çš„buffæ³¨å†Œåˆ°walè®°å½•ï¼Œæ¯”å¦‚insertè¯­å¥çš„ç›®æ ‡buffã€updateè¯­å¥çš„ç›®æ ‡buffå’Œæºbuff</p><p><img src="/uploads/xlog_register_buf.jpg" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// æ‰¾åˆ°registered_bufferæ•°ç»„ä¸­ç¬¬ä¸€ä¸ªç©ºçš„çš„ä½ç½®</span><br><span class="hljs-keyword">if</span> (block_id &gt;= max_registered_block_id)<br>&#123;<br>    <span class="hljs-keyword">if</span> (block_id &gt;= max_registered_buffers)<br>        elog(ERROR, <span class="hljs-string">&quot;too many registered buffers&quot;</span>);<br>    max_registered_block_id = block_id + <span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-comment">// å°†è¿™ä¸ªbufferçš„æ•°æ®å¡«å……</span><br>regbuf = &amp;registered_buffers[block_id];<br><br>BufferGetTag(buffer, &amp;regbuf-&gt;rnode, &amp;regbuf-&gt;forkno, &amp;regbuf-&gt;block);<br>regbuf-&gt;page = BufferGetPage(buffer);<br>regbuf-&gt;flags = flags;<br>regbuf-&gt;rdata_tail = (XLogRecData *) &amp;regbuf-&gt;rdata_head;<br>regbuf-&gt;rdata_len = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">// å°†ç¼“å†²åŒºæ ‡è®°ä¸ºå·²ä½¿ç”¨</span><br>regbuf-&gt;in_use = <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure><h4 id="XLogRegisterBufData">XLogRegisterBufData</h4><p>å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯å°†å…ƒç»„å†…å®¹æ³¨å†Œåˆ°WALè®°å½•ä¸­ã€‚éœ€è¦å‚æ•°block idï¼Œè¿™ä¸ªidå¿…é¡»æ˜¯å·²ç»é€šè¿‡<code>XLogRegisterBuffer</code>æ³¨å†Œçš„block</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// è¯»å–å·²ç»æ³¨å†Œçš„ç¼“å†²åŒºç»“æ„</span><br>regbuf = &amp;registered_buffers[block_id];<br><span class="hljs-keyword">if</span> (!regbuf-&gt;in_use)<br>    elog(ERROR, <span class="hljs-string">&quot;no block with id %d registered with WAL insertion&quot;</span>,<br>         block_id);<br><br><span class="hljs-comment">// è¯»å–bufferæ•°æ®</span><br><span class="hljs-keyword">if</span> (num_rdatas &gt;= max_rdatas)<br>    elog(ERROR, <span class="hljs-string">&quot;too much WAL data&quot;</span>);<br>rdata = &amp;rdatas[num_rdatas++];<br><br>rdata-&gt;data = data;<br>rdata-&gt;len = len;<br><br>regbuf-&gt;rdata_tail-&gt;next = rdata;<br>regbuf-&gt;rdata_tail = rdata;<br>regbuf-&gt;rdata_len += len;<br></code></pre></td></tr></table></figure><h4 id="XLogInsert">XLogInsert</h4><p>æ’å…¥WALçš„æ“ä½œç”±å‡½æ•°<code>XLogInsert</code>å®Œæˆï¼Œæ ¹æ®Rdataé“¾è¡¨å’Œç›¸åº”çš„èµ„æºç®¡ç†å™¨infoå‘WALæ—¥å¿—æ–‡ä»¶ä¸­æ’å…¥ä¸€æ¡WALè®°å½•ã€‚äº‹åŠ¡æ‰§è¡Œæ’å…¥ï¼Œåˆ é™¤ï¼Œæ›´æ–°ï¼Œæäº¤ï¼Œç»ˆæ­¢æˆ–å›æ»šå‘½ä»¤æ—¶éƒ½éœ€è¦è°ƒç”¨æ­¤å‡½æ•°</p><ul class="lvl-0"><li class="lvl-2"><p>åˆ¤æ–­è°ƒç”¨æ—¶æ˜¯å¦è®¾ç½®äº†rmgræ ‡è®°ä½ï¼š</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((info &amp; ~(XLR_RMGR_INFO_MASK |<br>              XLR_SPECIAL_REL_UPDATE |<br>              XLR_CHECK_CONSISTENCY)) != <span class="hljs-number">0</span>)<br>    elog(PANIC, <span class="hljs-string">&quot;invalid xlog info mask %02X&quot;</span>, info);<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å¦‚æœå¤„äºbootstrapæ¨¡å¼ï¼Œé™¤äº†XLogèµ„æºå¤–ï¼Œä¸éœ€è¦å®é™…è®°å½•å†…å®¹ï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªæ£€æŸ¥ç‚¹çš„æŒ‡é’ˆ</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (IsBootstrapProcessingMode() &amp;&amp; rmid != RM_XLog_ID)<br>&#123;<br>    XLogResetInsertion();<br>    EndPos = SizeOfXLogLongPHD;<br>    <span class="hljs-keyword">return</span> EndPos;<br>&#125;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>ç»„åˆæˆå®Œæ•´çš„WALè®°å½•å¹¶å†™å…¥WALæ—¥å¿—</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">do</span><br>&#123;<br>    XLogRecPtrRedoRecPtr;<br>    <span class="hljs-type">bool</span>doPageWrites;<br>    XLogRecPtrfpw_lsn;<br>    XLogRecData *rdt;<br><br>    GetFullPageWriteInfo(&amp;RedoRecPtr, &amp;doPageWrites);<br><br>    <span class="hljs-comment">// è°ƒç”¨å‡½æ•°ç»„è£…æ³¨å†Œçš„æ•°æ®</span><br>    rdt = XLogRecordAssemble(rmid, info, RedoRecPtr, doPageWrites,<br>                             &amp;fpw_lsn);<br><br>    <span class="hljs-comment">// å°†ç»„è£…å¥½çš„æ•°æ®å†™å…¥åˆ°WALå†…å­˜ä¸­</span><br>    EndPos = XLogInsertRecord(rdt, fpw_lsn, curinsert_flags);<br>&#125; <span class="hljs-keyword">while</span> (EndPos == InvalidXLogRecPtr);<br></code></pre></td></tr></table></figure><h4 id="XLogRecordAssemble">XLogRecordAssemble</h4><p>å‡½æ•°ç”¨äºå°†å·²æ³¨å†Œçš„æ•°æ®å’Œç¼“å†²åŒºé¡µé¢æ•°æ®ç»„è£…æˆä¸€æ¡WALè®°å½•ï¼Œå°†å…¶å†™å…¥åˆ°<code>XLogRecData</code>é“¾è¡¨ä¸­ã€‚</p><p>æ‰§è¡Œåˆ°è¿™ä¸ªé˜¶æ®µï¼Œwalè®°å½•çš„æ•°æ®å­˜å‚¨åœ¨ï¼š</p><ol><li class="lvl-3"><p>mainrdata_head</p></li><li class="lvl-3"><p>æ¯ä¸€ä¸ªæ³¨å†Œçš„buffçš„rdata_head</p></li><li class="lvl-3"><p>æ¯ä¸€ä¸ªæ³¨å†Œçš„buffçš„pageå­—æ®µä¸­</p></li></ol><p>å‡½æ•°æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>ä¿å­˜å¤´éƒ¨ä¿¡æ¯</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">XLogRecData *rdt;<span class="hljs-comment">// XLogRecDataé“¾è¡¨æŒ‡é’ˆ</span><br>uint32total_len = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span>block_id;<br>pg_crc32crdata_crc;<br>registered_buffer *prev_regbuf = <span class="hljs-literal">NULL</span>;<br>XLogRecData *rdt_datas_last;<br>XLogRecord *rechdr;<br><span class="hljs-type">char</span>   *scratch = hdr_scratch;<br><br>rechdr = (XLogRecord *) scratch;<br>scratch += SizeOfXLogRecord;<br><br>hdr_rdt.next = <span class="hljs-literal">NULL</span>;<br>rdt_datas_last = &amp;hdr_rdt;<br>hdr_rdt.data = hdr_scratch;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-3"><p>æ„é€ ä¿å­˜æ‰€æœ‰å—å…¬ç”¨çš„æ•°æ®éƒ¨åˆ†çš„rdataé“¾</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><code class="hljs C">*fpw_lsn = InvalidXLogRecPtr;<br><span class="hljs-keyword">for</span> (block_id = <span class="hljs-number">0</span>; block_id &lt; max_registered_block_id; block_id++)<br>&#123;<br>    registered_buffer *regbuf = &amp;registered_buffers[block_id];<br>    XLogRecordBlockHeader bkpb;<br>    XLogRecordBlockImageHeader bimg;<br>    XLogRecordBlockCompressHeader cbimg = &#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">bool</span>samerel;<br>    <span class="hljs-type">bool</span>is_compressed = <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">bool</span>include_image;<br><br>    <span class="hljs-comment">// è®¾ç½®blockå¤´éƒ¨ä¿¡æ¯</span><br>    bkpb.id = block_id;<br>    bkpb.fork_flags = regbuf-&gt;forkno;<br>    bkpb.data_length = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// è®¾ç½®æ ‡è®°ä½</span><br>    <span class="hljs-keyword">if</span> ((regbuf-&gt;flags &amp; REGBUF_WILL_INIT) == REGBUF_WILL_INIT)<br>        bkpb.fork_flags |= BKPBLOCK_WILL_INIT;<br><br>    <span class="hljs-comment">// æ‰§è¡Œfull_page_writeï¼Œå†™å…¥XLogRecordBlockImageHeader</span><br>    <span class="hljs-keyword">if</span> (include_image)<br>    &#123;<br>        Page        page = regbuf-&gt;page;<span class="hljs-comment">// è·å–å¯¹åº”çš„page</span><br>        uint16      compressed_len = <span class="hljs-number">0</span>;<span class="hljs-comment">// å‹ç¼©åçš„å¤§å°</span><br><br>        <span class="hljs-comment">// pageéœ€è¦å¤‡ä»½ï¼Œè®¡ç®—ç©ºé—²ç©ºé—´å¤§å°å’Œåç§»</span><br>        <span class="hljs-comment">// &quot;hole&quot;æŒ‡çš„æ˜¯pageä¸­çš„ç©ºç™½åŒºåŸŸ</span><br>        <span class="hljs-keyword">if</span> (regbuf-&gt;flags &amp; REGBUF_STANDARD)<br>        &#123;<br>            <span class="hljs-comment">// å¦‚æœé¡µé¢éµå¾ªæ ‡å‡†å¸ƒå±€ï¼Œlowerå’ŒupperæŒ‡é’ˆå°†è¢«è·³è¿‡</span><br>            uint16      lower = ((PageHeader) page)-&gt;pd_lower;<span class="hljs-comment">// è·å–lower</span><br>            uint16      upper = ((PageHeader) page)-&gt;pd_upper;<span class="hljs-comment">// è·å–upper</span><br><br>            <span class="hljs-comment">// åˆ¤æ–­pageä¸­æ˜¯å¦å­˜åœ¨&quot;hole&quot;</span><br>            <span class="hljs-keyword">if</span> (lower &gt;= SizeOfPageHeaderData &amp;&amp;<br>                upper &gt; lower &amp;&amp;<br>                upper &lt;= BLCKSZ)<br>            &#123;<br>                <span class="hljs-comment">// è®¡ç®—â€œholeâ€çš„é•¿åº¦çš„åç§»é‡</span><br>                bimg.hole_offset = lower;<br>                cbimg.hole_length = upper - lower;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-comment">// æ²¡æœ‰å¯ä»¥ç§»é™¤çš„&quot;hole&quot;</span><br>                bimg.hole_offset = <span class="hljs-number">0</span>;<br>                cbimg.hole_length = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">// ä¸æ˜¯æ ‡å‡†çš„é¡µé¢å¸ƒå±€ï¼Œæ— æ³•å°è¯•ä¼°ç®—&quot;hole&quot;</span><br>            bimg.hole_offset = <span class="hljs-number">0</span>;<br>            cbimg.hole_length = <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// å¯ç”¨WALå‹ç¼©</span><br>        <span class="hljs-keyword">if</span> (wal_compression)<br>        &#123;<br>            is_compressed =<br>                XLogCompressBackupBlock(page, bimg.hole_offset,<br>                                        cbimg.hole_length,<br>                                        regbuf-&gt;compressed_page,<br>                                        &amp;compressed_len);<span class="hljs-comment">// è°ƒç”¨XLogCompressBackupBlockå‹ç¼©</span><br>        &#125;<br><br>        <span class="hljs-comment">// å¡«å……XLogRecordBlockHeaderç»“æ„ä½“çš„å‰©ä½™å­—æ®µ</span><br>        bkpb.fork_flags |= BKPBLOCK_HAS_IMAGE;<br><br>        <span class="hljs-comment">// ä¸ºpageå†…å®¹æ„é€ XLogRecDataå…¥å£</span><br>        rdt_datas_last-&gt;next = &amp;regbuf-&gt;bkp_rdatas[<span class="hljs-number">0</span>];<br>        rdt_datas_last = rdt_datas_last-&gt;next;<br>        <span class="hljs-comment">// è®¾ç½®æ ‡è®°</span><br>        bimg.bimg_info = (cbimg.hole_length == <span class="hljs-number">0</span>) ? <span class="hljs-number">0</span> : BKPIMAGE_HAS_HOLE;<br><br>        <span class="hljs-comment">// åœ¨redoæœŸé—´,åœ¨è®¾ç½®äº†BKPIMAGE_APPLYæ ‡è®°çš„æƒ…å†µä¸‹full-pageæ‰ä¼šå›æ”¾.</span><br>        <span class="hljs-keyword">if</span> (needs_backup)<br>            bimg.bimg_info |= BKPIMAGE_APPLY;<br><br>        <span class="hljs-comment">// éœ€è¦å‹ç¼©</span><br>        <span class="hljs-keyword">if</span> (is_compressed)<br>        &#123;<br>            bimg.length = compressed_len;<span class="hljs-comment">// å‹ç¼©åçš„ç©ºé—´</span><br>            bimg.bimg_info |= BKPIMAGE_IS_COMPRESSED;<span class="hljs-comment">// å‹ç¼©æ ‡è®°</span><br><br>            rdt_datas_last-&gt;data = regbuf-&gt;compressed_page;<span class="hljs-comment">// æ”¾åœ¨registered_bufferä¸­</span><br>            rdt_datas_last-&gt;len = compressed_len;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">// æ²¡æœ‰å‹ç¼©ï¼Œè®¡ç®—imageçš„å¤§å°</span><br>            bimg.length = BLCKSZ - cbimg.hole_length;<br><br>            <span class="hljs-comment">// å¦‚æœæ²¡æœ‰&quot;hole&quot;å­˜åœ¨</span><br>            <span class="hljs-keyword">if</span> (cbimg.hole_length == <span class="hljs-number">0</span>)<br>            &#123;<br>                rdt_datas_last-&gt;data = page;<span class="hljs-comment">// æ•°æ®æŒ‡é’ˆç›´æ¥æŒ‡å‘page</span><br>                rdt_datas_last-&gt;len = BLCKSZ;<span class="hljs-comment">// å¤§å°ä¸ºblock size</span><br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-comment">// è·³è¿‡hole</span><br>                rdt_datas_last-&gt;data = page;<span class="hljs-comment">// æ•°æ®æŒ‡é’ˆ</span><br>                rdt_datas_last-&gt;len = bimg.hole_offset;<span class="hljs-comment">// è·å–holeçš„åç§»</span><br><br>                rdt_datas_last-&gt;next = &amp;regbuf-&gt;bkp_rdatas[<span class="hljs-number">1</span>];<span class="hljs-comment">// ç¬¬2éƒ¨åˆ†</span><br>                rdt_datas_last = rdt_datas_last-&gt;next;<br><br>                rdt_datas_last-&gt;data =<br>                    page + (bimg.hole_offset + cbimg.hole_length);<span class="hljs-comment">// æŒ‡é’ˆæŒ‡å‘ç¬¬äºŒéƒ¨åˆ†</span><br>                rdt_datas_last-&gt;len =<br>                    BLCKSZ - (bimg.hole_offset + cbimg.hole_length);<span class="hljs-comment">// è®¾ç½®é•¿åº¦</span><br>            &#125;<br>        &#125;<br><br>        total_len += bimg.length;<span class="hljs-comment">// è°ƒæ•´æ€»é•¿åº¦</span><br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœéœ€è¦åŒ…å«æ•°æ®</span><br>    <span class="hljs-keyword">if</span> (needs_data)<br>    &#123;<br>        <span class="hljs-comment">// æŠŠè¯¥ç¼“å†²åŒºé“¾æ¥åˆ°è°ƒç”¨è€…æä¾›çš„rdataé“¾ä¸­ï¼Œæ„æˆä¸€ä¸ªæ•´ä½“çš„é“¾è¡¨</span><br>        bkpb.fork_flags |= BKPBLOCK_HAS_DATA;<br>        bkpb.data_length = regbuf-&gt;rdata_len;<br>        total_len += regbuf-&gt;rdata_len;<br><br>        rdt_datas_last-&gt;next = regbuf-&gt;rdata_head;<br>        rdt_datas_last = regbuf-&gt;rdata_tail;<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœå­˜åœ¨ä¸Šä¸€ä¸ªæ³¨å†Œçš„bufï¼Œè€Œä¸”RefFileNodeç›¸åŒ</span><br>    <span class="hljs-keyword">if</span> (prev_regbuf &amp;&amp; RelFileNodeEquals(regbuf-&gt;rnode, prev_regbuf-&gt;rnode))<br>    &#123;<br>        samerel = <span class="hljs-literal">true</span>;<br>        bkpb.fork_flags |= BKPBLOCK_SAME_REL;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>        samerel = <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">// åˆ‡æ¢ä¸ºå½“å‰çš„æ³¨å†Œçš„buf</span><br>    prev_regbuf = regbuf;<br><br>    <span class="hljs-comment">// æ‹·è´å¤´éƒ¨ä¿¡æ¯åˆ°scratchç¼“å†²åŒºä¸­</span><br>    <span class="hljs-built_in">memcpy</span>(scratch, &amp;bkpb, SizeOfXLogRecordBlockHeader);<br>    scratch += SizeOfXLogRecordBlockHeader;<br>    <span class="hljs-keyword">if</span> (include_image)<br>    &#123;<br>        <span class="hljs-built_in">memcpy</span>(scratch, &amp;bimg, SizeOfXLogRecordBlockImageHeader);<br>        scratch += SizeOfXLogRecordBlockImageHeader;<br>        <span class="hljs-comment">// å‹ç¼©å­˜å‚¨,è¿½åŠ SizeOfXLogRecordBlockCompressHeader</span><br>        <span class="hljs-keyword">if</span> (cbimg.hole_length != <span class="hljs-number">0</span> &amp;&amp; is_compressed)<br>        &#123;<br>            <span class="hljs-built_in">memcpy</span>(scratch, &amp;cbimg,<br>                   SizeOfXLogRecordBlockCompressHeader);<br>            scratch += SizeOfXLogRecordBlockCompressHeader;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// ä¸æ˜¯åŒä¸€ä¸ªRELï¼Œè¿½åŠ RelFileNode</span><br>    <span class="hljs-keyword">if</span> (!samerel)<br>    &#123;<br>        <span class="hljs-built_in">memcpy</span>(scratch, &amp;regbuf-&gt;rnode, <span class="hljs-keyword">sizeof</span>(RelFileNode));<br>        scratch += <span class="hljs-keyword">sizeof</span>(RelFileNode);<br>    &#125;<br>    <span class="hljs-comment">// è¿½åŠ BlockNumber</span><br>    <span class="hljs-built_in">memcpy</span>(scratch, &amp;regbuf-&gt;block, <span class="hljs-keyword">sizeof</span>(BlockNumber));<br>    scratch += <span class="hljs-keyword">sizeof</span>(BlockNumber);<br>&#125;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ¥ä¸‹æ¥ç»„è£…XLog Record originæ ‡è®°</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((curinsert_flags &amp; XLog_INCLUDE_ORIGIN) &amp;&amp;<br>    replorigin_session_origin != InvalidRepOriginId)<br>&#123;<br>    *(scratch++) = (<span class="hljs-type">char</span>) XLR_BLOCK_ID_ORIGIN;<br>    <span class="hljs-built_in">memcpy</span>(scratch, &amp;replorigin_session_origin, <span class="hljs-keyword">sizeof</span>(replorigin_session_origin));<br>    scratch += <span class="hljs-keyword">sizeof</span>(replorigin_session_origin);<br>&#125;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æ¥ä¸‹æ¥ç»„è£…æ•°æ®ï¼ˆmain dataï¼‰</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (mainrdata_len &gt; <span class="hljs-number">0</span>)<br>&#123;<br>    <span class="hljs-comment">// é•¿åº¦è¶…è¿‡255ï¼Œåˆ™ä½¿ç”¨Longæ ¼å¼</span><br>    <span class="hljs-keyword">if</span> (mainrdata_len &gt; <span class="hljs-number">255</span>)<br>    &#123;<br>        *(scratch++) = (<span class="hljs-type">char</span>) XLR_BLOCK_ID_DATA_LONG;<br>        <span class="hljs-built_in">memcpy</span>(scratch, &amp;mainrdata_len, <span class="hljs-keyword">sizeof</span>(uint32));<br>        scratch += <span class="hljs-keyword">sizeof</span>(uint32);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        *(scratch++) = (<span class="hljs-type">char</span>) XLR_BLOCK_ID_DATA_SHORT;<br>        *(scratch++) = (uint8) mainrdata_len;<br>    &#125;<br>    rdt_datas_last-&gt;next = mainrdata_head;<br>    rdt_datas_last = mainrdata_last;<br>    total_len += mainrdata_len;<br>&#125;<br>rdt_datas_last-&gt;next = <span class="hljs-literal">NULL</span>;<br><br>hdr_rdt.len = (scratch - hdr_scratch);<span class="hljs-comment">// å¤´éƒ¨å¤§å°</span><br>total_len += hdr_rdt.len;<span class="hljs-comment">// æ€»é•¿åº¦</span><br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>è®¡ç®—æ•°æ®çš„CRC</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">INIT_CRC32C(rdata_crc);<br>COMP_CRC32C(rdata_crc, hdr_scratch + SizeOfXLogRecord, hdr_rdt.len - SizeOfXLogRecord);<br><span class="hljs-keyword">for</span> (rdt = hdr_rdt.next; rdt != <span class="hljs-literal">NULL</span>; rdt = rdt-&gt;next)<br>    COMP_CRC32C(rdata_crc, rdt-&gt;data, rdt-&gt;len);<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>æœ€åå¡«å……è®°å½•å¤´éƒ¨ä¿¡æ¯çš„å…¶ä»–åŸŸå­—æ®µ</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">rechdr-&gt;xl_xid = GetCurrentTransactionIdIfAny();<br>rechdr-&gt;xl_tot_len = total_len;<br>rechdr-&gt;xl_info = info;<br>rechdr-&gt;xl_rmid = rmid;<br>rechdr-&gt;xl_prev = InvalidXLogRecPtr;<br>rechdr-&gt;xl_crc = rdata_crc;<br><br><span class="hljs-keyword">return</span> &amp;hdr_rdt;<br></code></pre></td></tr></table></figure><h4 id="XLogInsertRecord">XLogInsertRecord</h4><p>å°†<code>XLogRecordAssemble</code>ç»„è£…å¥½çš„è®°å½•æ’å…¥åˆ°WALå†…å­˜ä¸­ã€‚è¿‡ç¨‹åˆ†ä¸¤æ­¥ï¼š</p><ul class="lvl-0"><li class="lvl-2"><p>åœ¨å†…å­˜ä¸­ä¸ºWALè®°å½•ä¿ç•™è¶³å¤Ÿçš„ç©ºé—´</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (isLogSwitch)<br>    inserted = ReserveXLogSwitch(&amp;StartPos, &amp;EndPos, &amp;rechdr-&gt;xl_prev);<br><span class="hljs-keyword">else</span><br>&#123;<br>    ReserveXLogInsertLocation(rechdr-&gt;xl_tot_len, &amp;StartPos, &amp;EndPos,<br>                              &amp;rechdr-&gt;xl_prev);<br>    inserted = <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>å°†è®°å½•å¤åˆ¶åˆ°WALå†…å­˜ä¸­</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (inserted)<br>&#123;<br>    <span class="hljs-comment">// è®¡ç®—å¤´éƒ¨çš„CRC</span><br>    rdata_crc = rechdr-&gt;xl_crc;<br>    COMP_CRC32C(rdata_crc, rechdr, offsetof(XLogRecord, xl_crc));<br>    FIN_CRC32C(rdata_crc);<br>    rechdr-&gt;xl_crc = rdata_crc;<br><br>    <span class="hljs-comment">// æ‰€æœ‰çš„æ•°æ®ï¼ŒåŒ…æ‹¬headerä¿¡æ¯ï¼Œå‡å¯ä»¥è¿›è¡Œæ’å…¥</span><br>    CopyXLogRecordToWAL(rechdr-&gt;xl_tot_len, isLogSwitch, rdata,<br>                        StartPos, EndPos);<br><br>    <span class="hljs-comment">// æ›´æ–°æœ€åä¸€æ¡é‡è¦è®°å½•çš„LSNï¼Œå½“æŒæœ‰é”æ—¶ï¼Œåªæ›´æ–°ç¬¬ä¸€ä¸ª</span><br>    <span class="hljs-keyword">if</span> ((flags &amp; XLog_MARK_UNIMPORTANT) == <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-type">int</span>lockno = holdingAllLocks ? <span class="hljs-number">0</span> : MyLockNo;<br><br>        WALInsertLocks[lockno].l.lastImportantAt = StartPos;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PageSetLSN">PageSetLSN</h4><p>æ›´æ–°è¢«ä¿®æ”¹çš„Page LSN</p><br>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Postgresql ä½¿ç”¨ wal æ—¥å¿—ä¿å­˜æ¯ä¸€æ¬¡çš„æ•°æ®ä¿®æ”¹ï¼Œè¿™æ ·ä¿è¯äº†æ•°æ®åº“å³ä½¿æ„å¤–å®•æœºï¼Œä¹Ÿèƒ½åˆ©ç”¨å®ƒå‡†ç¡®çš„æ¢å¤æ•°æ®ã€‚wal æ—¥å¿—ä¹Ÿå«åš xlogï¼Œåœ¨ 9.4 ç‰ˆæœ¬ä¹‹åä½œäº†é‡å¤§æ›´æ–°ï¼Œæœ¬ç¯‡åªè®²è§£æœ€æ–°ç‰ˆçš„æ ¼å¼ã€‚wal æ—¥å¿—è¢«ç”¨äºå¤šä¸ªæ–¹é¢ï¼Œæ¯”å¦‚ä¿®æ”¹æ•°æ®ï¼Œä¿®æ”¹ç´¢å¼•ç­‰ï¼Œæ¯ç§ç”¨é€”çš„æ ¼å¼</summary>
      
    
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/categories/PostgreSQL/"/>
    
    
    <category term="PostgreSQL" scheme="https://spike1337.github.io/tags/PostgreSQL/"/>
    
    <category term="replication" scheme="https://spike1337.github.io/tags/replication/"/>
    
    <category term="WAL" scheme="https://spike1337.github.io/tags/WAL/"/>
    
  </entry>
  
</feed>
